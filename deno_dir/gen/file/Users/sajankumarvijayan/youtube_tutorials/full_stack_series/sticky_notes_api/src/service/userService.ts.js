import { Bson } from '../deps.ts';
import userModel from '../model/userModel.ts';
import ConflictException from '../errors/conflict.ts';
import AuthenticationFailed from '../errors/authenticationFailed.ts';
import NotFoundException from '../errors/notfound.ts';
import Hash from '../utils/hash.ts';
import Token from '../utils/token.ts';
class UserService {
    static #us;
    static getInstance = () => {
        if (this.#us)
            return this.#us;
        this.#us = new UserService();
        return this.#us;
    };
    signup = async (dto) => {
        const user = userModel();
        try {
            await user.insertOne({
                ...dto,
                password: await new Hash().text(dto.password),
                createdAt: new Date().toISOString(),
                active: true
            });
        }
        catch (e) {
            throw new ConflictException(JSON.stringify(e.message));
        }
    };
    signin = async (dto) => {
        const user = userModel();
        try {
            const hasUser = await user.findOne({ emailAddress: dto.emailAddress });
            if (!hasUser)
                throw new AuthenticationFailed('Your credential details are invalid');
            const hasValidPassword = await new Hash().verify(dto.password, hasUser.password);
            if (!hasValidPassword)
                throw new AuthenticationFailed('Your credential details are invalid');
            const { emailAddress, _id, firstName, lastName } = hasUser;
            return await new Token().create({ emailAddress, _id, firstName, lastName });
        }
        catch (e) {
            throw e;
        }
    };
    updatePassword = async (dto, userId) => {
        const user = userModel();
        try {
            const hasUser = await this.getUserById(userId);
            const hasValidPassword = await new Hash().verify(dto.currentPassword, hasUser.password);
            if (!hasValidPassword)
                throw new AuthenticationFailed(`The user id ${userId}'s current password doesn't seems right. Please check again`);
            const id = { _id: new Bson.ObjectId(userId) };
            await user.updateOne(id, {
                $set: {
                    password: await new Hash().text(dto.newPassword),
                    updatedAt: new Date().toISOString()
                }
            });
        }
        catch (e) {
            throw e;
        }
    };
    activateOrDeactivate = async (userId, status) => {
        const user = userModel();
        try {
            await this.getUserById(userId);
            const id = { _id: new Bson.ObjectId(userId) };
            await user.updateOne(id, {
                $set: {
                    updatedAt: new Date().toISOString(),
                    active: status
                }
            });
        }
        catch (e) {
            throw e;
        }
    };
    delete = async (userId) => {
        const user = userModel();
        try {
            await this.getUserById(userId);
            const id = { _id: new Bson.ObjectId(userId) };
            await user.deleteOne(id);
        }
        catch (e) {
            throw e;
        }
    };
    getUserById = async (userId) => {
        const user = userModel();
        try {
            const id = { _id: new Bson.ObjectId(userId) };
            const hasUser = await user.findOne(id);
            if (!hasUser)
                throw new NotFoundException(`The user id "${userId}" doesn't seems right.`);
            return hasUser;
        }
        catch (e) {
            throw e;
        }
    };
}
export default UserService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlclNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1c2VyU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWUsSUFBSSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBSS9DLE9BQU8sU0FBUyxNQUFNLHVCQUF1QixDQUFDO0FBQzlDLE9BQU8saUJBQWlCLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxvQkFBb0IsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLGlCQUFpQixNQUFNLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sSUFBSSxNQUFNLGtCQUFrQixDQUFDO0FBQ3BDLE9BQU8sS0FBSyxNQUFNLG1CQUFtQixDQUFDO0FBSXRDLE1BQU0sV0FBVztJQUNiLE1BQU0sQ0FBQyxHQUFHLENBQWM7SUFFeEIsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLEVBQUU7UUFDdEIsSUFBSSxJQUFJLENBQUMsR0FBRztZQUFFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUM5QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDN0IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ3BCLENBQUMsQ0FBQTtJQUlELE1BQU0sR0FBRyxLQUFLLEVBQUUsR0FBa0IsRUFBRSxFQUFFO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBQ3pCLElBQUk7WUFFQSxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2pCLEdBQUcsR0FBRztnQkFDTixRQUFRLEVBQUUsTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUM3QyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7Z0JBQ25DLE1BQU0sRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFBO1NBQ0w7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE1BQU0s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TjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsTUFBTSxDQUFDLENBQUM7U0FDWDtJQUNMLENBQUMsQ0FBQTtJQUlELE1BQU0sR0FBRyxLQUFLLEVBQUUsTUFBYyxFQUFFLEVBQUU7UUFDOUIsTUFBTSxJQUFJLEdBQUcsU0FBUyxFQUFFLENBQUM7UUFFekIsSUFBSTtZQUVBLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUM5QixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM5QyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7U0FFNUI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE1BQU0sQ0FBQyxDQUFDO1NBQ1g7SUFDTCxDQUFDLENBQUE7SUFFRCxXQUFXLEdBQUcsS0FBSyxFQUFFLE1BQWMsRUFBRSxFQUFFO1FBQ25DLE1BQU0sSUFBSSxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBRXpCLElBQUk7WUFDQSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM5QyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDdEMsSUFBSSxDQUFDLE9BQU87Z0JBQUUsTUFBTSxJQUFJLGlCQUFpQixDQUFDLGdCQUFnQixNQUFNLHdCQUF3QixDQUFDLENBQUM7WUFDMUYsT0FBTyxPQUFPLENBQUM7U0FDbEI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE1BQU0sQ0FBQyxDQUFDO1NBQ1g7SUFDTCxDQUFDLENBQUE7O0FBR0wsZUFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb25nb0NsaWVudCwgQnNvbiB9IGZyb20gJy4uL2RlcHMudHMnO1xuaW1wb3J0IENyZWF0ZVVzZXJEdG8gZnJvbSAnLi4vdHlwZXMvY3JlYXRlVXNlci5kdG8udHMnO1xuaW1wb3J0IExvZ2luVXNlckR0byBmcm9tICcuLi90eXBlcy9sb2dpblVzZXIuZHRvLnRzJztcbmltcG9ydCBVcGRhdGVQYXNzd29yZER0byBmcm9tICcuLi90eXBlcy91cGRhdGVQYXNzd29yZC5kdG8udHMnO1xuaW1wb3J0IHVzZXJNb2RlbCBmcm9tICcuLi9tb2RlbC91c2VyTW9kZWwudHMnO1xuaW1wb3J0IENvbmZsaWN0RXhjZXB0aW9uIGZyb20gJy4uL2Vycm9ycy9jb25mbGljdC50cyc7XG5pbXBvcnQgQXV0aGVudGljYXRpb25GYWlsZWQgZnJvbSAnLi4vZXJyb3JzL2F1dGhlbnRpY2F0aW9uRmFpbGVkLnRzJztcbmltcG9ydCBOb3RGb3VuZEV4Y2VwdGlvbiBmcm9tICcuLi9lcnJvcnMvbm90Zm91bmQudHMnO1xuaW1wb3J0IEhhc2ggZnJvbSAnLi4vdXRpbHMvaGFzaC50cyc7XG5pbXBvcnQgVG9rZW4gZnJvbSAnLi4vdXRpbHMvdG9rZW4udHMnO1xuXG5cblxuY2xhc3MgVXNlclNlcnZpY2Uge1xuICAgIHN0YXRpYyAjdXM6IFVzZXJTZXJ2aWNlO1xuXG4gICAgc3RhdGljIGdldEluc3RhbmNlID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy4jdXMpIHJldHVybiB0aGlzLiN1cztcbiAgICAgICAgdGhpcy4jdXMgPSBuZXcgVXNlclNlcnZpY2UoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuI3VzO1xuICAgIH1cblxuXG5cbiAgICBzaWdudXAgPSBhc3luYyAoZHRvOiBDcmVhdGVVc2VyRHRvKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzZXIgPSB1c2VyTW9kZWwoKTtcbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgYXdhaXQgdXNlci5pbnNlcnRPbmUoe1xuICAgICAgICAgICAgICAgIC4uLmR0byxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogYXdhaXQgbmV3IEhhc2goKS50ZXh0KGR0by5wYXNzd29yZCksXG4gICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgYWN0aXZlOiB0cnVlXG4gICAgICAgICAgICB9KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oSlNPTi5zdHJpbmdpZnkoZS5tZXNzYWdlKSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHNpZ25pbiA9IGFzeW5jIChkdG86IExvZ2luVXNlckR0bykgPT4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdXNlck1vZGVsKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBoYXNVc2VyID0gYXdhaXQgdXNlci5maW5kT25lKHsgZW1haWxBZGRyZXNzOiBkdG8uZW1haWxBZGRyZXNzIH0pXG4gICAgICAgICAgICBpZiAoIWhhc1VzZXIpIHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkZhaWxlZCgnWW91ciBjcmVkZW50aWFsIGRldGFpbHMgYXJlIGludmFsaWQnKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc1ZhbGlkUGFzc3dvcmQgPSBhd2FpdCBuZXcgSGFzaCgpLnZlcmlmeShkdG8ucGFzc3dvcmQsIGhhc1VzZXIucGFzc3dvcmQpO1xuICAgICAgICAgICAgaWYgKCFoYXNWYWxpZFBhc3N3b3JkKSB0aHJvdyBuZXcgQXV0aGVudGljYXRpb25GYWlsZWQoJ1lvdXIgY3JlZGVudGlhbCBkZXRhaWxzIGFyZSBpbnZhbGlkJyk7XG4gICAgICAgICAgICBjb25zdCB7IGVtYWlsQWRkcmVzcywgX2lkLCBmaXJzdE5hbWUsIGxhc3ROYW1lIH0gPSBoYXNVc2VyO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG5ldyBUb2tlbigpLmNyZWF0ZSh7IGVtYWlsQWRkcmVzcywgX2lkLCBmaXJzdE5hbWUsIGxhc3ROYW1lIH0pO1xuXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVQYXNzd29yZCA9IGFzeW5jIChkdG86IFVwZGF0ZVBhc3N3b3JkRHRvLCB1c2VySWQ6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdXNlck1vZGVsKCk7XG5cbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgY29uc3QgaGFzVXNlciA9IGF3YWl0IHRoaXMuZ2V0VXNlckJ5SWQodXNlcklkKTtcbiAgICAgICAgICAgIGNvbnN0IGhhc1ZhbGlkUGFzc3dvcmQgPSBhd2FpdCBuZXcgSGFzaCgpLnZlcmlmeShkdG8uY3VycmVudFBhc3N3b3JkLCBoYXNVc2VyLnBhc3N3b3JkKTtcbiAgICAgICAgICAgIGlmICghaGFzVmFsaWRQYXNzd29yZCkgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRmFpbGVkKGBUaGUgdXNlciBpZCAke3VzZXJJZH0ncyBjdXJyZW50IHBhc3N3b3JkIGRvZXNuJ3Qgc2VlbXMgcmlnaHQuIFBsZWFzZSBjaGVjayBhZ2FpbmApO1xuICAgICAgICAgICAgY29uc3QgaWQgPSB7IF9pZDogbmV3IEJzb24uT2JqZWN0SWQodXNlcklkKSB9O1xuICAgICAgICAgICAgYXdhaXQgdXNlci51cGRhdGVPbmUoaWQsIHtcbiAgICAgICAgICAgICAgICAkc2V0OiB7XG4gICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBhd2FpdCBuZXcgSGFzaCgpLnRleHQoZHRvLm5ld1Bhc3N3b3JkKSxcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWN0aXZhdGVPckRlYWN0aXZhdGUgPSBhc3luYyAodXNlcklkOiBzdHJpbmcsIHN0YXR1czogYm9vbGVhbikgPT4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdXNlck1vZGVsKCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0VXNlckJ5SWQodXNlcklkKTtcbiAgICAgICAgICAgIGNvbnN0IGlkID0geyBfaWQ6IG5ldyBCc29uLk9iamVjdElkKHVzZXJJZCkgfTtcbiAgICAgICAgICAgIGF3YWl0IHVzZXIudXBkYXRlT25lKGlkLCB7XG4gICAgICAgICAgICAgICAgJHNldDoge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlOiBzdGF0dXNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuICAgIH1cblxuXG5cbiAgICBkZWxldGUgPSBhc3luYyAodXNlcklkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgdXNlciA9IHVzZXJNb2RlbCgpO1xuXG4gICAgICAgIHRyeSB7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0VXNlckJ5SWQodXNlcklkKVxuICAgICAgICAgICAgY29uc3QgaWQgPSB7IF9pZDogbmV3IEJzb24uT2JqZWN0SWQodXNlcklkKSB9O1xuICAgICAgICAgICAgYXdhaXQgdXNlci5kZWxldGVPbmUoaWQpO1xuXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRVc2VyQnlJZCA9IGFzeW5jICh1c2VySWQ6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCB1c2VyID0gdXNlck1vZGVsKCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0geyBfaWQ6IG5ldyBCc29uLk9iamVjdElkKHVzZXJJZCkgfTtcbiAgICAgICAgICAgIGNvbnN0IGhhc1VzZXIgPSBhd2FpdCB1c2VyLmZpbmRPbmUoaWQpXG4gICAgICAgICAgICBpZiAoIWhhc1VzZXIpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihgVGhlIHVzZXIgaWQgXCIke3VzZXJJZH1cIiBkb2Vzbid0IHNlZW1zIHJpZ2h0LmApO1xuICAgICAgICAgICAgcmV0dXJuIGhhc1VzZXI7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFVzZXJTZXJ2aWNlOyJdfQ==
import { Bson } from '../deps.ts';
import NotFoundException from '../errors/notfound.ts';
import ConflictException from '../errors/conflict.ts';
import notesModel from '../model/noteModel.ts';
class NoteService {
    static #ns;
    static getInstance = () => {
        if (this.#ns)
            return this.#ns;
        this.#ns = new NoteService();
        return this.#ns;
    };
    create = async (dto) => {
        const notes = notesModel();
        try {
            await notes.insertOne({ ...dto, createdAt: new Date().toISOString() });
        }
        catch (e) {
            throw new ConflictException(e.message);
        }
    };
    update = async (dto, noteId) => {
        const notes = notesModel();
        try {
            await this.getNoteById(noteId, dto.userId);
            const id = { _id: new Bson.ObjectId(noteId) };
            await notes.updateOne(id, {
                $set: {
                    description: dto.description,
                    updatedAt: new Date().toISOString()
                }
            });
        }
        catch (e) {
            throw e;
        }
    };
    delete = async (noteId, userId) => {
        const notes = notesModel();
        try {
            await this.getNoteById(noteId, userId);
            const id = { _id: new Bson.ObjectId(noteId) };
            await notes.deleteOne(id);
        }
        catch (e) {
            throw e;
        }
    };
    getNotes = async (userId, params) => {
        const notes = notesModel();
        try {
            const totalNotes = await notes.countDocuments({ 'createdBy.userId': userId });
            const filters = {
                ...(params?.search && { 'description': new RegExp(params.search, 'i') }),
                'createdBy.userId': userId
            };
            const list = await notes.find(filters)
                .skip(parseInt(params?.page) || 0)
                .limit(parseInt(params?.limit) || 10)
                .sort({ createdAt: params?.sort === 'newest' ? -1 : 1 })
                .toArray();
            return {
                totalNotes,
                list,
                ...(params?.search && { searchQuery: params.search, matchedRecordsCount: list.length })
            };
        }
        catch (e) {
            throw e;
        }
    };
    getNoteById = async (noteId, userId) => {
        const notes = notesModel();
        try {
            const filters = {
                _id: new Bson.ObjectId(noteId),
                'createdBy.userId': userId
            };
            const note = await notes.findOne(filters);
            if (!note)
                throw new NotFoundException('The note id record does not exist');
            return note;
        }
        catch (e) {
            throw e;
        }
    };
    deleteNotesByUserId = async (userId) => {
        const notes = notesModel();
        try {
            const totalNotes = await notes.countDocuments({ 'createdBy.userId': userId });
            if (totalNotes > 0) {
                await notes.deleteMany({ 'createdBy.userId': userId });
                return true;
            }
            return false;
        }
        catch (e) {
            throw e;
        }
    };
}
export default NoteService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90ZVNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJub3RlU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ2xDLE9BQU8saUJBQWlCLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxpQkFBaUIsTUFBTSx1QkFBdUIsQ0FBQztBQUd0RCxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQyxNQUFNLFdBQVc7SUFDYixNQUFNLENBQUMsR0FBRyxDQUFjO0lBRXhCLE1BQU0sQ0FBQyxXQUFXLEdBQUcsR0FBRyxFQUFFO1FBQ3RCLElBQUksSUFBSSxDQUFDLEdBQUc7WUFBRSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDOUIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQzdCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNwQixDQUFDLENBQUE7SUFHRCxNQUFNLEdBQUcsS0FBSyxFQUFFLEdBQWtCLEVBQUUsRUFBRTtRQUNsQyxNQUFNLEtBQUssR0FBRyxVQUFVLEVBQUUsQ0FBQztRQUMzQixJQUFJO1lBQ0EsTUFBTSxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1NBQ3pFO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixNQUFNLElBQUksaUJBQWlCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzFDO0lBRUwsQ0FBQyxDQUFBO0lBRUQsTUFBTSxHQUFHLEtBQUssRUFBRSxHQUFrQixFQUFFLE1BQWMsRUFBRSxFQUFFO1FBQ2xELE1BQU0sS0FBSyxHQUFHLFVBQVUsRUFBRSxDQUFDO1FBQzNCLElBQUk7WUFDQSxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxF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TyxDQUFDLENBQUM7WUFDMUMsSUFBSSxDQUFDLElBQUk7Z0JBQUUsTUFBTSxJQUFJLGlCQUFpQixDQUFDLG1DQUFtQyxDQUFDLENBQUM7WUFDNUUsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsTUFBTSxDQUFDLENBQUM7U0FDWDtJQUVMLENBQUMsQ0FBQTtJQUVELG1CQUFtQixHQUFHLEtBQUssRUFBRSxNQUFjLEVBQUUsRUFBRTtRQUMzQyxNQUFNLEtBQUssR0FBRyxVQUFVLEVBQUUsQ0FBQztRQUMzQixJQUFJO1lBQ0EsTUFBTSxVQUFVLEdBQUcsTUFBTSxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM5RSxJQUFJLFVBQVUsR0FBRyxDQUFDLEVBQUU7Z0JBQ2hCLE1BQU0sS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7Z0JBQ3ZELE9BQU8sSUFBSSxDQUFDO2FBQ2Y7WUFDRCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsTUFBTSxDQUFDLENBQUM7U0FDWDtJQUNMLENBQUMsQ0FBQTs7QUFJTCxlQUFlLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJzb24gfSBmcm9tICcuLi9kZXBzLnRzJztcbmltcG9ydCBOb3RGb3VuZEV4Y2VwdGlvbiBmcm9tICcuLi9lcnJvcnMvbm90Zm91bmQudHMnO1xuaW1wb3J0IENvbmZsaWN0RXhjZXB0aW9uIGZyb20gJy4uL2Vycm9ycy9jb25mbGljdC50cyc7XG5pbXBvcnQgQ3JlYXRlTm90ZUR0byBmcm9tICcuLi90eXBlcy9jcmVhdGVOb3RlLmR0by50cyc7XG5pbXBvcnQgVXBkYXRlTm90ZUR0byBmcm9tICcuLi90eXBlcy91cGRhdGVOb3RlLmR0by50cyc7XG5pbXBvcnQgbm90ZXNNb2RlbCBmcm9tICcuLi9tb2RlbC9ub3RlTW9kZWwudHMnO1xuXG5jbGFzcyBOb3RlU2VydmljZSB7XG4gICAgc3RhdGljICNuczogTm90ZVNlcnZpY2U7XG5cbiAgICBzdGF0aWMgZ2V0SW5zdGFuY2UgPSAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLiNucykgcmV0dXJuIHRoaXMuI25zO1xuICAgICAgICB0aGlzLiNucyA9IG5ldyBOb3RlU2VydmljZSgpO1xuICAgICAgICByZXR1cm4gdGhpcy4jbnM7XG4gICAgfVxuXG5cbiAgICBjcmVhdGUgPSBhc3luYyAoZHRvOiBDcmVhdGVOb3RlRHRvKSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGVzID0gbm90ZXNNb2RlbCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgbm90ZXMuaW5zZXJ0T25lKHsgLi4uZHRvLCBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oZS5tZXNzYWdlKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgdXBkYXRlID0gYXN5bmMgKGR0bzogVXBkYXRlTm90ZUR0bywgbm90ZUlkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3Qgbm90ZXMgPSBub3Rlc01vZGVsKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmdldE5vdGVCeUlkKG5vdGVJZCwgZHRvLnVzZXJJZCk7XG4gICAgICAgICAgICBjb25zdCBpZCA9IHsgX2lkOiBuZXcgQnNvbi5PYmplY3RJZChub3RlSWQpIH1cbiAgICAgICAgICAgIGF3YWl0IG5vdGVzLnVwZGF0ZU9uZShpZCwge1xuICAgICAgICAgICAgICAgICRzZXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGR0by5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBkZWxldGUgPSBhc3luYyAobm90ZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGVzID0gbm90ZXNNb2RlbCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5nZXROb3RlQnlJZChub3RlSWQsIHVzZXJJZCk7XG4gICAgICAgICAgICBjb25zdCBpZCA9IHsgX2lkOiBuZXcgQnNvbi5PYmplY3RJZChub3RlSWQpIH1cbiAgICAgICAgICAgIGF3YWl0IG5vdGVzLmRlbGV0ZU9uZShpZCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGdldE5vdGVzID0gYXN5bmMgKHVzZXJJZDogc3RyaW5nLCBwYXJhbXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGVzID0gbm90ZXNNb2RlbCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdG90YWxOb3RlcyA9IGF3YWl0IG5vdGVzLmNvdW50RG9jdW1lbnRzKHsgJ2NyZWF0ZWRCeS51c2VySWQnOiB1c2VySWQgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSB7XG4gICAgICAgICAgICAgICAgLi4uKHBhcmFtcz8uc2VhcmNoICYmIHsgJ2Rlc2NyaXB0aW9uJzogbmV3IFJlZ0V4cChwYXJhbXMuc2VhcmNoLCAnaScpIH0pLFxuICAgICAgICAgICAgICAgICdjcmVhdGVkQnkudXNlcklkJzogdXNlcklkXG5cbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBhd2FpdCBub3Rlcy5maW5kKGZpbHRlcnMpXG4gICAgICAgICAgICAgICAgLnNraXAocGFyc2VJbnQocGFyYW1zPy5wYWdlKSB8fCAwKVxuICAgICAgICAgICAgICAgIC5saW1pdChwYXJzZUludChwYXJhbXM/LmxpbWl0KSB8fCAxMClcbiAgICAgICAgICAgICAgICAuc29ydCh7IGNyZWF0ZWRBdDogcGFyYW1zPy5zb3J0ID09PSAnbmV3ZXN0JyA/IC0xIDogMSB9KVxuICAgICAgICAgICAgICAgIC50b0FycmF5KCk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHRvdGFsTm90ZXMsXG4gICAgICAgICAgICAgICAgbGlzdCxcbiAgICAgICAgICAgICAgICAuLi4ocGFyYW1zPy5zZWFyY2ggJiYgeyBzZWFyY2hRdWVyeTogcGFyYW1zLnNlYXJjaCwgbWF0Y2hlZFJlY29yZHNDb3VudDogbGlzdC5sZW5ndGggfSlcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0Tm90ZUJ5SWQgPSBhc3luYyAobm90ZUlkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGVzID0gbm90ZXNNb2RlbCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgICAgICAgICAgICBfaWQ6IG5ldyBCc29uLk9iamVjdElkKG5vdGVJZCksXG4gICAgICAgICAgICAgICAgJ2NyZWF0ZWRCeS51c2VySWQnOiB1c2VySWRcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBub3RlID0gYXdhaXQgbm90ZXMuZmluZE9uZShmaWx0ZXJzKTtcbiAgICAgICAgICAgIGlmICghbm90ZSkgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdUaGUgbm90ZSBpZCByZWNvcmQgZG9lcyBub3QgZXhpc3QnKTtcbiAgICAgICAgICAgIHJldHVybiBub3RlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBkZWxldGVOb3Rlc0J5VXNlcklkID0gYXN5bmMgKHVzZXJJZDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IG5vdGVzID0gbm90ZXNNb2RlbCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdG90YWxOb3RlcyA9IGF3YWl0IG5vdGVzLmNvdW50RG9jdW1lbnRzKHsgJ2NyZWF0ZWRCeS51c2VySWQnOiB1c2VySWQgfSk7XG4gICAgICAgICAgICBpZiAodG90YWxOb3RlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBub3Rlcy5kZWxldGVNYW55KHsgJ2NyZWF0ZWRCeS51c2VySWQnOiB1c2VySWQgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgTm90ZVNlcnZpY2U7Il19
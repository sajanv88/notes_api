import { BufReader, deferred, writeAll } from "../../deps.ts";
import { MongoDriverError, MongoServerError, } from "../error.ts";
import { handshake } from "./handshake.ts";
import { parseHeader } from "./header.ts";
import { deserializeMessage, serializeMessage } from "./message.ts";
let nextRequestId = 0;
export class WireProtocol {
    #socket;
    #isPendingResponse = false;
    #isPendingRequest = false;
    #pendingResponses = new Map();
    #reader;
    #commandQueue = [];
    constructor(socket) {
        this.#socket = socket;
        this.#reader = new BufReader(this.#socket);
    }
    async connect() {
        const { connectionId: _connectionId } = await handshake(this);
    }
    async commandSingle(db, body) {
        const [doc] = await this.command(db, body);
        if (doc.ok === 0) {
            throw new MongoServerError(doc);
        }
        return doc;
    }
    async command(db, body) {
        const requestId = nextRequestId++;
        const commandTask = {
            requestId,
            db,
            body,
        };
        this.#commandQueue.push(commandTask);
        this.send();
        const pendingMessage = deferred();
        this.#pendingResponses.set(requestId, pendingMessage);
        this.receive();
        const message = await pendingMessage;
        let documents = [];
        for (const section of message?.sections) {
            if ("document" in section) {
                documents.push(section.document);
            }
            else {
                documents = documents.concat(section.documents);
            }
        }
        return documents;
    }
    async send() {
        if (this.#isPendingRequest)
            return;
        this.#isPendingRequest = true;
        while (this.#commandQueue.length > 0) {
            const task = this.#commandQueue.shift();
            const buffer = serializeMessage({
                requestId: task.requestId,
                responseTo: 0,
                sections: [
                    {
                        document: {
                            ...task.body,
                            $db: task.db,
                        },
                    },
                ],
            });
            await writeAll(this.#socket, buffer);
        }
        this.#isPendingRequest = false;
    }
    async receive() {
        if (this.#isPendingResponse)
            return;
        this.#isPendingResponse = true;
        while (this.#pendingResponses.size > 0) {
            const headerBuffer = await this.#reader.readFull(new Uint8Array(16));
            if (!headerBuffer)
                throw new MongoDriverError("Invalid response header");
            const header = parseHeader(headerBuffer);
            const bodyBuffer = await this.#reader.readFull(new Uint8Array(header.messageLength - 16));
            if (!bodyBuffer)
                throw new MongoDriverError("Invalid response body");
            const reply = deserializeMessage(header, bodyBuffer);
            const pendingMessage = this.#pendingResponses.get(header.responseTo);
            this.#pendingResponses.delete(header.responseTo);
            pendingMessage?.resolve(reply);
        }
        this.#isPendingResponse = false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm90b2NvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFZLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEUsT0FBTyxFQUNMLGdCQUFnQixFQUVoQixnQkFBZ0IsR0FDakIsTUFBTSxhQUFhLENBQUM7QUFFckIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFXLGdCQUFnQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBUzdFLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV0QixNQUFNLE9BQU8sWUFBWTtJQUN2QixPQUFPLENBQVM7SUFDaEIsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLGlCQUFpQixHQUFHLEtBQUssQ0FBQztJQUMxQixpQkFBaUIsR0FBbUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM5RCxPQUFPLENBQVk7SUFDbkIsYUFBYSxHQUFrQixFQUFFLENBQUM7SUFFbEMsWUFBWSxNQUFjO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLE1BQU0sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhLENBQ2pCLEVBQVUsRUFDVixJQUFjO1FBRWQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsSUFB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VUFBVTtnQkFBRSxNQUFNLElBQUksZ0JBQWdCLENBQUMsdUJBQXVCLENBQUMsQ0FBQztZQUNyRSxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDckQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDckUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDakQsY0FBYyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoQztRQUNELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7SUFDbEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnVmUmVhZGVyLCBEZWZlcnJlZCwgZGVmZXJyZWQsIHdyaXRlQWxsIH0gZnJvbSBcIi4uLy4uL2RlcHMudHNcIjtcbmltcG9ydCB7XG4gIE1vbmdvRHJpdmVyRXJyb3IsXG4gIE1vbmdvRXJyb3JJbmZvLFxuICBNb25nb1NlcnZlckVycm9yLFxufSBmcm9tIFwiLi4vZXJyb3IudHNcIjtcbmltcG9ydCB7IERvY3VtZW50IH0gZnJvbSBcIi4uL3R5cGVzLnRzXCI7XG5pbXBvcnQgeyBoYW5kc2hha2UgfSBmcm9tIFwiLi9oYW5kc2hha2UudHNcIjtcbmltcG9ydCB7IHBhcnNlSGVhZGVyIH0gZnJvbSBcIi4vaGVhZGVyLnRzXCI7XG5pbXBvcnQgeyBkZXNlcmlhbGl6ZU1lc3NhZ2UsIE1lc3NhZ2UsIHNlcmlhbGl6ZU1lc3NhZ2UgfSBmcm9tIFwiLi9tZXNzYWdlLnRzXCI7XG5cbnR5cGUgU29ja2V0ID0gRGVuby5SZWFkZXIgJiBEZW5vLldyaXRlcjtcbmludGVyZmFjZSBDb21tYW5kVGFzayB7XG4gIHJlcXVlc3RJZDogbnVtYmVyO1xuICBkYjogc3RyaW5nO1xuICBib2R5OiBEb2N1bWVudDtcbn1cblxubGV0IG5leHRSZXF1ZXN0SWQgPSAwO1xuXG5leHBvcnQgY2xhc3MgV2lyZVByb3RvY29sIHtcbiAgI3NvY2tldDogU29ja2V0O1xuICAjaXNQZW5kaW5nUmVzcG9uc2UgPSBmYWxzZTtcbiAgI2lzUGVuZGluZ1JlcXVlc3QgPSBmYWxzZTtcbiAgI3BlbmRpbmdSZXNwb25zZXM6IE1hcDxudW1iZXIsIERlZmVycmVkPE1lc3NhZ2U+PiA9IG5ldyBNYXAoKTtcbiAgI3JlYWRlcjogQnVmUmVhZGVyO1xuICAjY29tbWFuZFF1ZXVlOiBDb21tYW5kVGFza1tdID0gW107XG5cbiAgY29uc3RydWN0b3Ioc29ja2V0OiBTb2NrZXQpIHtcbiAgICB0aGlzLiNzb2NrZXQgPSBzb2NrZXQ7XG4gICAgdGhpcy4jcmVhZGVyID0gbmV3IEJ1ZlJlYWRlcih0aGlzLiNzb2NrZXQpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCgpIHtcbiAgICBjb25zdCB7IGNvbm5lY3Rpb25JZDogX2Nvbm5lY3Rpb25JZCB9ID0gYXdhaXQgaGFuZHNoYWtlKHRoaXMpO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZFNpbmdsZTxUID0gRG9jdW1lbnQ+KFxuICAgIGRiOiBzdHJpbmcsXG4gICAgYm9keTogRG9jdW1lbnQsXG4gICk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IFtkb2NdID0gYXdhaXQgdGhpcy5jb21tYW5kKGRiLCBib2R5KTtcbiAgICBpZiAoZG9jLm9rID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgTW9uZ29TZXJ2ZXJFcnJvcihkb2MgYXMgTW9uZ29FcnJvckluZm8pO1xuICAgIH1cbiAgICByZXR1cm4gZG9jIGFzIFQ7XG4gIH1cblxuICBhc3luYyBjb21tYW5kPFQgPSBEb2N1bWVudD4oZGI6IHN0cmluZywgYm9keTogRG9jdW1lbnQpOiBQcm9taXNlPFRbXT4ge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IG5leHRSZXF1ZXN0SWQrKztcbiAgICBjb25zdCBjb21tYW5kVGFzayA9IHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIGRiLFxuICAgICAgYm9keSxcbiAgICB9O1xuXG4gICAgdGhpcy4jY29tbWFuZFF1ZXVlLnB1c2goY29tbWFuZFRhc2spO1xuICAgIHRoaXMuc2VuZCgpO1xuXG4gICAgY29uc3QgcGVuZGluZ01lc3NhZ2UgPSBkZWZlcnJlZDxNZXNzYWdlPigpO1xuICAgIHRoaXMuI3BlbmRpbmdSZXNwb25zZXMuc2V0KHJlcXVlc3RJZCwgcGVuZGluZ01lc3NhZ2UpO1xuICAgIHRoaXMucmVjZWl2ZSgpO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCBwZW5kaW5nTWVzc2FnZTtcblxuICAgIGxldCBkb2N1bWVudHM6IFRbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBzZWN0aW9uIG9mIG1lc3NhZ2U/LnNlY3Rpb25zISkge1xuICAgICAgaWYgKFwiZG9jdW1lbnRcIiBpbiBzZWN0aW9uKSB7XG4gICAgICAgIGRvY3VtZW50cy5wdXNoKHNlY3Rpb24uZG9jdW1lbnQgYXMgVCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudHMgPSBkb2N1bWVudHMuY29uY2F0KHNlY3Rpb24uZG9jdW1lbnRzIGFzIFRbXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGRvY3VtZW50cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZCgpIHtcbiAgICBpZiAodGhpcy4jaXNQZW5kaW5nUmVxdWVzdCkgcmV0dXJuO1xuICAgIHRoaXMuI2lzUGVuZGluZ1JlcXVlc3QgPSB0cnVlO1xuICAgIHdoaWxlICh0aGlzLiNjb21tYW5kUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgdGFzayA9IHRoaXMuI2NvbW1hbmRRdWV1ZS5zaGlmdCgpITtcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IHNlcmlhbGl6ZU1lc3NhZ2Uoe1xuICAgICAgICByZXF1ZXN0SWQ6IHRhc2sucmVxdWVzdElkLFxuICAgICAgICByZXNwb25zZVRvOiAwLFxuICAgICAgICBzZWN0aW9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGRvY3VtZW50OiB7XG4gICAgICAgICAgICAgIC4uLnRhc2suYm9keSxcbiAgICAgICAgICAgICAgJGRiOiB0YXNrLmRiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHdyaXRlQWxsKHRoaXMuI3NvY2tldCwgYnVmZmVyKTtcbiAgICB9XG4gICAgdGhpcy4jaXNQZW5kaW5nUmVxdWVzdCA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWNlaXZlKCkge1xuICAgIGlmICh0aGlzLiNpc1BlbmRpbmdSZXNwb25zZSkgcmV0dXJuO1xuICAgIHRoaXMuI2lzUGVuZGluZ1Jlc3BvbnNlID0gdHJ1ZTtcbiAgICB3aGlsZSAodGhpcy4jcGVuZGluZ1Jlc3BvbnNlcy5zaXplID4gMCkge1xuICAgICAgY29uc3QgaGVhZGVyQnVmZmVyID0gYXdhaXQgdGhpcy4jcmVhZGVyLnJlYWRGdWxsKG5ldyBVaW50OEFycmF5KDE2KSk7XG4gICAgICBpZiAoIWhlYWRlckJ1ZmZlcikgdGhyb3cgbmV3IE1vbmdvRHJpdmVyRXJyb3IoXCJJbnZhbGlkIHJlc3BvbnNlIGhlYWRlclwiKTtcbiAgICAgIGNvbnN0IGhlYWRlciA9IHBhcnNlSGVhZGVyKGhlYWRlckJ1ZmZlcik7XG4gICAgICBjb25zdCBib2R5QnVmZmVyID0gYXdhaXQgdGhpcy4jcmVhZGVyLnJlYWRGdWxsKFxuICAgICAgICBuZXcgVWludDhBcnJheShoZWFkZXIubWVzc2FnZUxlbmd0aCAtIDE2KSxcbiAgICAgICk7XG4gICAgICBpZiAoIWJvZHlCdWZmZXIpIHRocm93IG5ldyBNb25nb0RyaXZlckVycm9yKFwiSW52YWxpZCByZXNwb25zZSBib2R5XCIpO1xuICAgICAgY29uc3QgcmVwbHkgPSBkZXNlcmlhbGl6ZU1lc3NhZ2UoaGVhZGVyLCBib2R5QnVmZmVyKTtcbiAgICAgIGNvbnN0IHBlbmRpbmdNZXNzYWdlID0gdGhpcy4jcGVuZGluZ1Jlc3BvbnNlcy5nZXQoaGVhZGVyLnJlc3BvbnNlVG8pO1xuICAgICAgdGhpcy4jcGVuZGluZ1Jlc3BvbnNlcy5kZWxldGUoaGVhZGVyLnJlc3BvbnNlVG8pO1xuICAgICAgcGVuZGluZ01lc3NhZ2U/LnJlc29sdmUocmVwbHkpO1xuICAgIH1cbiAgICB0aGlzLiNpc1BlbmRpbmdSZXNwb25zZSA9IGZhbHNlO1xuICB9XG59XG4iXX0=
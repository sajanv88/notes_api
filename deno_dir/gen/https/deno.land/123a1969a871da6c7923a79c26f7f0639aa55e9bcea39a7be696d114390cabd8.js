import { RequestBody } from "./body.ts";
import { preferredCharsets } from "./negotiation/charset.ts";
import { preferredEncodings } from "./negotiation/encoding.ts";
import { preferredLanguages } from "./negotiation/language.ts";
import { preferredMediaTypes } from "./negotiation/mediaType.ts";
export class Request {
    #body;
    #proxy;
    #secure;
    #serverRequest;
    #url;
    #getRemoteAddr() {
        return this.#serverRequest.remoteAddr ?? "";
    }
    get hasBody() {
        return this.#body.has();
    }
    get headers() {
        return this.#serverRequest.headers;
    }
    get ip() {
        return (this.#proxy ? this.ips[0] : this.#getRemoteAddr()) ?? "";
    }
    get ips() {
        return this.#proxy
            ? (this.#serverRequest.headers.get("x-forwarded-for") ??
                this.#getRemoteAddr()).split(/\s*,\s*/)
            : [];
    }
    get method() {
        return this.#serverRequest.method;
    }
    get secure() {
        return this.#secure;
    }
    get originalRequest() {
        return this.#serverRequest;
    }
    get url() {
        if (!this.#url) {
            const serverRequest = this.#serverRequest;
            if (!this.#proxy) {
                try {
                    this.#url = new URL(serverRequest.rawUrl);
                    return this.#url;
                }
                catch {
                }
            }
            let proto;
            let host;
            if (this.#proxy) {
                proto = serverRequest
                    .headers.get("x-forwarded-proto")?.split(/\s*,\s*/, 1)[0] ??
                    "http";
                host = serverRequest.headers.get("x-forwarded-host") ??
                    serverRequest.headers.get("host") ?? "";
            }
            else {
                proto = this.#secure ? "https" : "http";
                host = serverRequest.headers.get("host") ?? "";
            }
            try {
                this.#url = new URL(`${proto}://${host}${serverRequest.url}`);
            }
            catch {
                throw new TypeError(`The server request URL of "${proto}://${host}${serverRequest.url}" is invalid.`);
            }
        }
        return this.#url;
    }
    constructor(serverRequest, proxy = false, secure = false) {
        this.#proxy = proxy;
        this.#secure = secure;
        this.#serverRequest = serverRequest;
        this.#body = new RequestBody(serverRequest.request);
    }
    accepts(...types) {
        const acceptValue = this.#serverRequest.headers.get("Accept");
        if (!acceptValue) {
            return types.length ? types[0] : ["*/*"];
        }
        if (types.length) {
            return preferredMediaTypes(acceptValue, types)[0];
        }
        return preferredMediaTypes(acceptValue);
    }
    acceptsCharsets(...charsets) {
        const acceptCharsetValue = this.#serverRequest.headers.get("Accept-Charset");
        if (!acceptCharsetValue) {
            return charsets.length ? charsets[0] : ["*"];
        }
        if (charsets.length) {
            return preferredCharsets(acceptCharsetValue, charsets)[0];
        }
        return preferredCharsets(acceptCharsetValue);
    }
    acceptsEncodings(...encodings) {
        const acceptEncodingValue = this.#serverRequest.headers.get("Accept-Encoding");
        if (!acceptEncodingValue) {
            return encodings.length ? encodings[0] : ["*"];
        }
        if (encodings.length) {
            return preferredEncodings(acceptEncodingValue, encodings)[0];
        }
        return preferredEncodings(acceptEncodingValue);
    }
    acceptsLanguages(...langs) {
        const acceptLanguageValue = this.#serverRequest.headers.get("Accept-Language");
        if (!acceptLanguageValue) {
            return langs.length ? langs[0] : ["*"];
        }
        if (langs.length) {
            return preferredLanguages(acceptLanguageValue, langs)[0];
        }
        return preferredLanguages(acceptLanguageValue);
    }
    body(options = {}) {
        return this.#body.get(options);
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { hasBody, headers, ip, ips, method, secure, url } = this;
        return `Request ${inspect({
            hasBody,
            headers,
            ip,
            ips,
            method,
            secure,
            url: url.toString(),
        })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBYUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd4QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUdqRSxNQUFNLE9BQU8sT0FBTztJQUNsQixLQUFLLENBQWM7SUFDbkIsTUFBTSxDQUFVO0lBQ2hCLE9BQU8sQ0FBVTtJQUNqQixjQUFjLENBQWdCO0lBQzlCLElBQUksQ0FBTztJQUVYLGNBQWM7UUFDWixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztJQUM5QyxDQUFDO0lBVUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFHRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDO0lBQ3JDLENBQUM7SUFLRCxJQUFJLEVBQUU7UUFDSixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ25FLENBQUM7SUFLRCxJQUFJLEdBQUc7UUFDTCxPQUFPLElBQUksQ0FBQyxNQUFNO1lBQ2hCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQztnQkFD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UUFDakMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQ3pELGlCQUFpQixDQUNsQixDQUFDO1FBQ0YsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1lBQ3hCLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3hDO1FBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ2hCLE9BQU8sa0JBQWtCLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUQ7UUFDRCxPQUFPLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDakQsQ0FBQztJQVVELElBQUksQ0FBQyxVQUF1QixFQUFFO1FBQzVCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsT0FBbUM7UUFDcEUsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoRSxPQUFPLFdBQ0wsT0FBTyxDQUFDO1lBQ04sT0FBTztZQUNQLE9BQU87WUFDUCxFQUFFO1lBQ0YsR0FBRztZQUNILE1BQU07WUFDTixNQUFNO1lBQ04sR0FBRyxFQUFFLEdBQUcsQ0FBQyxRQUFRLEVBQUU7U0FDcEIsQ0FDSCxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHtcbiAgQm9keSxcbiAgQm9keUJ5dGVzLFxuICBCb2R5Rm9ybSxcbiAgQm9keUZvcm1EYXRhLFxuICBCb2R5SnNvbixcbiAgQm9keU9wdGlvbnMsXG4gIEJvZHlSZWFkZXIsXG4gIEJvZHlTdHJlYW0sXG4gIEJvZHlUZXh0LFxufSBmcm9tIFwiLi9ib2R5LnRzXCI7XG5pbXBvcnQgeyBSZXF1ZXN0Qm9keSB9IGZyb20gXCIuL2JvZHkudHNcIjtcbmltcG9ydCB0eXBlIHsgTmF0aXZlUmVxdWVzdCB9IGZyb20gXCIuL2h0dHBfc2VydmVyX25hdGl2ZS50c1wiO1xuaW1wb3J0IHR5cGUgeyBIVFRQTWV0aG9kcyB9IGZyb20gXCIuL3R5cGVzLmQudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZENoYXJzZXRzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vY2hhcnNldC50c1wiO1xuaW1wb3J0IHsgcHJlZmVycmVkRW5jb2RpbmdzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vZW5jb2RpbmcudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZExhbmd1YWdlcyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2xhbmd1YWdlLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRNZWRpYVR5cGVzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vbWVkaWFUeXBlLnRzXCI7XG5cbi8qKiBBbiBpbnRlcmZhY2Ugd2hpY2ggcHJvdmlkZXMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdC4gKi9cbmV4cG9ydCBjbGFzcyBSZXF1ZXN0IHtcbiAgI2JvZHk6IFJlcXVlc3RCb2R5O1xuICAjcHJveHk6IGJvb2xlYW47XG4gICNzZWN1cmU6IGJvb2xlYW47XG4gICNzZXJ2ZXJSZXF1ZXN0OiBOYXRpdmVSZXF1ZXN0O1xuICAjdXJsPzogVVJMO1xuXG4gICNnZXRSZW1vdGVBZGRyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QucmVtb3RlQWRkciA/PyBcIlwiO1xuICB9XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgcmVxdWVzdCBtaWdodCBoYXZlIGEgYm9keSwgb3RoZXJ3aXNlIGBmYWxzZWAuXG4gICAqXG4gICAqICoqV0FSTklORyoqIHRoaXMgaXMgYW4gdW5yZWxpYWJsZSBBUEkuIEluIEhUVFAvMiBpbiBtYW55IHNpdHVhdGlvbnMgeW91XG4gICAqIGNhbm5vdCBkZXRlcm1pbmUgaWYgYSByZXF1ZXN0IGhhcyBhIGJvZHkgb3Igbm90IHVubGVzcyB5b3UgYXR0ZW1wdCB0byByZWFkXG4gICAqIHRoZSBib2R5LCBkdWUgdG8gdGhlIHN0cmVhbWluZyBuYXR1cmUgb2YgSFRUUC8yLiBBcyBvZiBEZW5vIDEuMTYuMSwgZm9yXG4gICAqIEhUVFAvMS4xLCBEZW5vIGFsc28gcmVmbGVjdHMgdGhhdCBiZWhhdmlvdXIuICBUaGUgb25seSByZWxpYWJsZSB3YXkgdG9cbiAgICogZGV0ZXJtaW5lIGlmIGEgcmVxdWVzdCBoYXMgYSBib2R5IG9yIG5vdCBpcyB0byBhdHRlbXB0IHRvIHJlYWQgdGhlIGJvZHkuXG4gICAqL1xuICBnZXQgaGFzQm9keSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jYm9keS5oYXMoKTtcbiAgfVxuXG4gIC8qKiBUaGUgYEhlYWRlcnNgIHN1cHBsaWVkIGluIHRoZSByZXF1ZXN0LiAqL1xuICBnZXQgaGVhZGVycygpOiBIZWFkZXJzIHtcbiAgICByZXR1cm4gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzO1xuICB9XG5cbiAgLyoqIFJlcXVlc3QgcmVtb3RlIGFkZHJlc3MuIFdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgYC5wcm94eWAgaXMgdHJ1ZSwgdGhlXG4gICAqIGBYLUZvcndhcmRlZC1Gb3JgIHdpbGwgYmUgdXNlZCB0byBkZXRlcm1pbmUgdGhlIHJlcXVlc3RpbmcgcmVtb3RlIGFkZHJlc3MuXG4gICAqL1xuICBnZXQgaXAoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gKHRoaXMuI3Byb3h5ID8gdGhpcy5pcHNbMF0gOiB0aGlzLiNnZXRSZW1vdGVBZGRyKCkpID8/IFwiXCI7XG4gIH1cblxuICAvKiogV2hlbiB0aGUgYXBwbGljYXRpb24ncyBgLnByb3h5YCBpcyBgdHJ1ZWAsIHRoaXMgd2lsbCBiZSBzZXQgdG8gYW4gYXJyYXkgb2ZcbiAgICogSVBzLCBvcmRlcmVkIGZyb20gdXBzdHJlYW0gdG8gZG93bnN0cmVhbSwgYmFzZWQgb24gdGhlIHZhbHVlIG9mIHRoZSBoZWFkZXJcbiAgICogYFgtRm9yd2FyZGVkLUZvcmAuICBXaGVuIGBmYWxzZWAgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQuICovXG4gIGdldCBpcHMoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLiNwcm94eVxuICAgICAgPyAodGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLWZvclwiKSA/P1xuICAgICAgICB0aGlzLiNnZXRSZW1vdGVBZGRyKCkpLnNwbGl0KC9cXHMqLFxccyovKVxuICAgICAgOiBbXTtcbiAgfVxuXG4gIC8qKiBUaGUgSFRUUCBNZXRob2QgdXNlZCBieSB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IG1ldGhvZCgpOiBIVFRQTWV0aG9kcyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QubWV0aG9kIGFzIEhUVFBNZXRob2RzO1xuICB9XG5cbiAgLyoqIFNob3J0Y3V0IHRvIGByZXF1ZXN0LnVybC5wcm90b2NvbCA9PT0gXCJodHRwczpcImAuICovXG4gIGdldCBzZWN1cmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI3NlY3VyZTtcbiAgfVxuXG4gIC8qKiBTZXQgdG8gdGhlIHZhbHVlIG9mIHRoZSBfb3JpZ2luYWxfIERlbm8gc2VydmVyIHJlcXVlc3QuICovXG4gIGdldCBvcmlnaW5hbFJlcXVlc3QoKTogTmF0aXZlUmVxdWVzdCB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3Q7XG4gIH1cblxuICAvKiogQSBwYXJzZWQgVVJMIGZvciB0aGUgcmVxdWVzdCB3aGljaCBjb21wbGllcyB3aXRoIHRoZSBicm93c2VyIHN0YW5kYXJkcy5cbiAgICogV2hlbiB0aGUgYXBwbGljYXRpb24ncyBgLnByb3h5YCBpcyBgdHJ1ZWAsIHRoaXMgdmFsdWUgd2lsbCBiZSBiYXNlZCBvZmYgb2ZcbiAgICogdGhlIGBYLUZvcndhcmRlZC1Qcm90b2AgYW5kIGBYLUZvcndhcmRlZC1Ib3N0YCBoZWFkZXIgdmFsdWVzIGlmIHByZXNlbnQgaW5cbiAgICogdGhlIHJlcXVlc3QuICovXG4gIGdldCB1cmwoKTogVVJMIHtcbiAgICBpZiAoIXRoaXMuI3VybCkge1xuICAgICAgY29uc3Qgc2VydmVyUmVxdWVzdCA9IHRoaXMuI3NlcnZlclJlcXVlc3Q7XG4gICAgICBpZiAoIXRoaXMuI3Byb3h5KSB7XG4gICAgICAgIC8vIGJldHdlZW4gMS45LjAgYW5kIDEuOS4xIHRoZSByZXF1ZXN0LnVybCBvZiB0aGUgbmF0aXZlIEhUVFAgc3RhcnRlZFxuICAgICAgICAvLyByZXR1cm5pbmcgdGhlIGZ1bGwgVVJMLCB3aGVyZSBwcmV2aW91c2x5IGl0IG9ubHkgcmV0dXJuZWQgdGhlIHBhdGhcbiAgICAgICAgLy8gc28gd2Ugd2lsbCB0cnkgdG8gdXNlIHRoYXQgVVJMIGhlcmUsIGJ1dCBkZWZhdWx0IGJhY2sgdG8gb2xkIGxvZ2ljXG4gICAgICAgIC8vIGlmIHRoZSBVUkwgaXNuJ3QgdmFsaWQuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy4jdXJsID0gbmV3IFVSTChzZXJ2ZXJSZXF1ZXN0LnJhd1VybCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcnJvcnMgaGVyZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBsZXQgcHJvdG86IHN0cmluZztcbiAgICAgIGxldCBob3N0OiBzdHJpbmc7XG4gICAgICBpZiAodGhpcy4jcHJveHkpIHtcbiAgICAgICAgcHJvdG8gPSBzZXJ2ZXJSZXF1ZXN0XG4gICAgICAgICAgLmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtcHJvdG9cIik/LnNwbGl0KC9cXHMqLFxccyovLCAxKVswXSA/P1xuICAgICAgICAgIFwiaHR0cFwiO1xuICAgICAgICBob3N0ID0gc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLWhvc3RcIikgPz9cbiAgICAgICAgICBzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSA/PyBcIlwiO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcHJvdG8gPSB0aGlzLiNzZWN1cmUgPyBcImh0dHBzXCIgOiBcImh0dHBcIjtcbiAgICAgICAgaG9zdCA9IHNlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJob3N0XCIpID8/IFwiXCI7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLiN1cmwgPSBuZXcgVVJMKGAke3Byb3RvfTovLyR7aG9zdH0ke3NlcnZlclJlcXVlc3QudXJsfWApO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgICAgYFRoZSBzZXJ2ZXIgcmVxdWVzdCBVUkwgb2YgXCIke3Byb3RvfTovLyR7aG9zdH0ke3NlcnZlclJlcXVlc3QudXJsfVwiIGlzIGludmFsaWQuYCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNlcnZlclJlcXVlc3Q6IE5hdGl2ZVJlcXVlc3QsXG4gICAgcHJveHkgPSBmYWxzZSxcbiAgICBzZWN1cmUgPSBmYWxzZSxcbiAgKSB7XG4gICAgdGhpcy4jcHJveHkgPSBwcm94eTtcbiAgICB0aGlzLiNzZWN1cmUgPSBzZWN1cmU7XG4gICAgdGhpcy4jc2VydmVyUmVxdWVzdCA9IHNlcnZlclJlcXVlc3Q7XG4gICAgdGhpcy4jYm9keSA9IG5ldyBSZXF1ZXN0Qm9keShzZXJ2ZXJSZXF1ZXN0LnJlcXVlc3QpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgbWVkaWEgdHlwZXMsIGFjY2VwdGVkIGJ5IHRoZSByZXF1ZXN0b3IsIGluIG9yZGVyIG9mXG4gICAqIHByZWZlcmVuY2UuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmdzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIHRoZW4gYWNjZXB0aW5nIGFueSBpcyBpbXBsaWVkIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBtZWRpYSB0eXBlcywgcmV0dXJuIHRoZSBiZXN0IG1hdGNoIGFjY2VwdGVkIGJ5IHRoZVxuICAgKiByZXF1ZXN0b3IuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmcgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuXG4gICAqL1xuICBhY2NlcHRzKC4uLnR5cGVzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0cyguLi50eXBlczogc3RyaW5nW10pOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0VmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiQWNjZXB0XCIpO1xuICAgIGlmICghYWNjZXB0VmFsdWUpIHtcbiAgICAgIHJldHVybiB0eXBlcy5sZW5ndGggPyB0eXBlc1swXSA6IFtcIiovKlwiXTtcbiAgICB9XG4gICAgaWYgKHR5cGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUsIHR5cGVzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZE1lZGlhVHlwZXMoYWNjZXB0VmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHRoZSBoZWFkZXIgYmVoaW5kIHRoaXMgaXMgbm8gbG9uZ2VyIHVzZWQgaW4gYnJvd3NlcnNcbiAgICovXG4gIGFjY2VwdHNDaGFyc2V0cygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHRoZSBoZWFkZXIgYmVoaW5kIHRoaXMgaXMgbm8gbG9uZ2VyIHVzZWQgaW4gYnJvd3NlcnNcbiAgICovXG4gIGFjY2VwdHNDaGFyc2V0cyguLi5jaGFyc2V0czogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHNDaGFyc2V0cyguLi5jaGFyc2V0czogc3RyaW5nW10pOiBzdHJpbmdbXSB8IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgYWNjZXB0Q2hhcnNldFZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUNoYXJzZXRcIixcbiAgICApO1xuICAgIGlmICghYWNjZXB0Q2hhcnNldFZhbHVlKSB7XG4gICAgICByZXR1cm4gY2hhcnNldHMubGVuZ3RoID8gY2hhcnNldHNbMF0gOiBbXCIqXCJdO1xuICAgIH1cbiAgICBpZiAoY2hhcnNldHMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gcHJlZmVycmVkQ2hhcnNldHMoYWNjZXB0Q2hhcnNldFZhbHVlLCBjaGFyc2V0cylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRDaGFyc2V0cyhhY2NlcHRDaGFyc2V0VmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgZW5jb2RpbmdzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiB0aGVuIGBbXCIqXCJdYCBpcyByZXR1cm5lZCwgbWF0Y2hpbmcgYW55LlxuICAgKi9cbiAgYWNjZXB0c0VuY29kaW5ncygpOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgLyoqIEZvciBhIGdpdmVuIHNldCBvZiBlbmNvZGluZ3MsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyB0aGF0IG1hdGNoLCB0aGVuIHRoZSBtZXRob2QgcmV0dXJuc1xuICAgKiBgdW5kZWZpbmVkYC5cbiAgICpcbiAgICogKipOT1RFOioqIFlvdSBzaG91bGQgYWx3YXlzIHN1cHBseSBgaWRlbnRpdHlgIGFzIG9uZSBvZiB0aGUgZW5jb2RpbmdzXG4gICAqIHRvIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGEgbWF0Y2ggd2hlbiB0aGUgYEFjY2VwdC1FbmNvZGluZ2AgaGVhZGVyIGlzIHBhcnRcbiAgICogb2YgdGhlIHJlcXVlc3QuXG4gICAqL1xuICBhY2NlcHRzRW5jb2RpbmdzKC4uLmVuY29kaW5nczogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHNFbmNvZGluZ3MoLi4uZW5jb2RpbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRFbmNvZGluZ1ZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUVuY29kaW5nXCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdEVuY29kaW5nVmFsdWUpIHtcbiAgICAgIHJldHVybiBlbmNvZGluZ3MubGVuZ3RoID8gZW5jb2RpbmdzWzBdIDogW1wiKlwiXTtcbiAgICB9XG4gICAgaWYgKGVuY29kaW5ncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBwcmVmZXJyZWRFbmNvZGluZ3MoYWNjZXB0RW5jb2RpbmdWYWx1ZSwgZW5jb2RpbmdzKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIHByZWZlcnJlZEVuY29kaW5ncyhhY2NlcHRFbmNvZGluZ1ZhbHVlKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGFycmF5IG9mIGxhbmd1YWdlcywgYWNjZXB0ZWQgYnkgdGhlIHJlcXVlc3RvciwgaW4gb3JkZXIgb2ZcbiAgICogcHJlZmVyZW5jZS4gIElmIHRoZXJlIGFyZSBubyBsYW5ndWFnZXMgc3VwcGxpZWQgYnkgdGhlIHJlcXVlc3RvcixcbiAgICogYFtcIipcIl1gIGlzIHJldHVybmVkLCBpbmRpY2F0aW5nIGFueSBsYW5ndWFnZSBpcyBhY2NlcHRlZC5cbiAgICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgbGFuZ3VhZ2VzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBsYW5ndWFnZXMgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoLi4ubGFuZ3M6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzTGFuZ3VhZ2VzKC4uLmxhbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRMYW5ndWFnZVZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUxhbmd1YWdlXCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdExhbmd1YWdlVmFsdWUpIHtcbiAgICAgIHJldHVybiBsYW5ncy5sZW5ndGggPyBsYW5nc1swXSA6IFtcIipcIl07XG4gICAgfVxuICAgIGlmIChsYW5ncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBwcmVmZXJyZWRMYW5ndWFnZXMoYWNjZXB0TGFuZ3VhZ2VWYWx1ZSwgbGFuZ3MpWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcHJlZmVycmVkTGFuZ3VhZ2VzKGFjY2VwdExhbmd1YWdlVmFsdWUpO1xuICB9XG5cbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcImJ5dGVzXCI+KTogQm9keUJ5dGVzO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybVwiPik6IEJvZHlGb3JtO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybS1kYXRhXCI+KTogQm9keUZvcm1EYXRhO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwianNvblwiPik6IEJvZHlKc29uO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwicmVhZGVyXCI+KTogQm9keVJlYWRlcjtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcInN0cmVhbVwiPik6IEJvZHlTdHJlYW07XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJ0ZXh0XCI+KTogQm9keVRleHQ7XG4gIGJvZHkob3B0aW9ucz86IEJvZHlPcHRpb25zKTogQm9keTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9ucyA9IHt9KTogQm9keSB8IEJvZHlSZWFkZXIgfCBCb2R5U3RyZWFtIHtcbiAgICByZXR1cm4gdGhpcy4jYm9keS5nZXQob3B0aW9ucyk7XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGhhc0JvZHksIGhlYWRlcnMsIGlwLCBpcHMsIG1ldGhvZCwgc2VjdXJlLCB1cmwgfSA9IHRoaXM7XG4gICAgcmV0dXJuIGBSZXF1ZXN0ICR7XG4gICAgICBpbnNwZWN0KHtcbiAgICAgICAgaGFzQm9keSxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgaXAsXG4gICAgICAgIGlwcyxcbiAgICAgICAgbWV0aG9kLFxuICAgICAgICBzZWN1cmUsXG4gICAgICAgIHVybDogdXJsLnRvU3RyaW5nKCksXG4gICAgICB9KVxuICAgIH1gO1xuICB9XG59XG4iXX0=
import { Context } from "./context.ts";
import { STATUS_TEXT } from "./deps.ts";
import { HttpServerNative, NativeRequest } from "./http_server_native.ts";
import { KeyStack } from "./keyStack.ts";
import { compose } from "./middleware.ts";
import { cloneState } from "./structured_clone.ts";
import { assert, isConn } from "./util.ts";
const ADDR_REGEXP = /^\[?([^\]]*)\]?:([0-9]{1,5})$/;
export class ApplicationErrorEvent extends ErrorEvent {
    context;
    constructor(eventInitDict) {
        super("error", eventInitDict);
        this.context = eventInitDict.context;
    }
}
function logErrorListener({ error, context }) {
    if (error instanceof Error) {
        console.error(`[uncaught application error]: ${error.name} - ${error.message}`);
    }
    else {
        console.error(`[uncaught application error]\n`, error);
    }
    if (context) {
        let url;
        try {
            url = context.request.url.toString();
        }
        catch {
            url = "[malformed url]";
        }
        console.error(`\nrequest:`, {
            url,
            method: context.request.method,
            hasBody: context.request.hasBody,
        });
        console.error(`response:`, {
            status: context.response.status,
            type: context.response.type,
            hasBody: !!context.response.body,
            writable: context.response.writable,
        });
    }
    if (error instanceof Error && error.stack) {
        console.error(`\n${error.stack.split("\n").slice(1).join("\n")}`);
    }
}
export class ApplicationListenEvent extends Event {
    hostname;
    listener;
    port;
    secure;
    serverType;
    constructor(eventInitDict) {
        super("listen", eventInitDict);
        this.hostname = eventInitDict.hostname;
        this.listener = eventInitDict.listener;
        this.port = eventInitDict.port;
        this.secure = eventInitDict.secure;
        this.serverType = eventInitDict.serverType;
    }
}
export class Application extends EventTarget {
    #composedMiddleware;
    #contextState;
    #keys;
    #middleware = [];
    #serverConstructor;
    get keys() {
        return this.#keys;
    }
    set keys(keys) {
        if (!keys) {
            this.#keys = undefined;
            return;
        }
        else if (Array.isArray(keys)) {
            this.#keys = new KeyStack(keys);
        }
        else {
            this.#keys = keys;
        }
    }
    proxy;
    state;
    constructor(options = {}) {
        super();
        const { state, keys, proxy, serverConstructor = HttpServerNative, contextState = "clone", logErrors = true, } = options;
        this.proxy = proxy ?? false;
        this.keys = keys;
        this.state = state ?? {};
        this.#serverConstructor = serverConstructor;
        this.#contextState = contextState;
        if (logErrors) {
            this.addEventListener("error", logErrorListener);
        }
    }
    #getComposed() {
        if (!this.#composedMiddleware) {
            this.#composedMiddleware = compose(this.#middleware);
        }
        return this.#composedMiddleware;
    }
    #getContextState() {
        switch (this.#contextState) {
            case "alias":
                return this.state;
            case "clone":
                return cloneState(this.state);
            case "empty":
                return {};
            case "prototype":
                return Object.create(this.state);
        }
    }
    #handleError(context, error) {
        if (!(error instanceof Error)) {
            error = new Error(`non-error thrown: ${JSON.stringify(error)}`);
        }
        const { message } = error;
        this.dispatchEvent(new ApplicationErrorEvent({ context, message, error }));
        if (!context.response.writable) {
            return;
        }
        for (const key of [...context.response.headers.keys()]) {
            context.response.headers.delete(key);
        }
        if (error.headers && error.headers instanceof Headers) {
            for (const [key, value] of error.headers) {
                context.response.headers.set(key, value);
            }
        }
        context.response.type = "text";
        const status = context.response.status =
            Deno.errors && error instanceof Deno.errors.NotFound
                ? 404
                : error.status && typeof error.status === "number"
                    ? error.status
                    : 500;
        context.response.body = error.expose
            ? error.message
            : STATUS_TEXT.get(status);
    }
    async #handleRequest(request, secure, state) {
        const context = new Context(this, request, this.#getContextState(), secure);
        let resolve;
        const handlingPromise = new Promise((res) => resolve = res);
        state.handling.add(handlingPromise);
        if (!state.closing && !state.closed) {
            try {
                await this.#getComposed()(context);
            }
            catch (err) {
                this.#handleError(context, err);
            }
        }
        if (context.respond === false) {
            context.response.destroy();
            resolve();
            state.handling.delete(handlingPromise);
            return;
        }
        let closeResources = true;
        let response;
        try {
            closeResources = false;
            response = await context.response.toDomResponse();
        }
        catch (err) {
            this.#handleError(context, err);
            response = await context.response.toDomResponse();
        }
        assert(response);
        try {
            await request.respond(response);
        }
        catch (err) {
            this.#handleError(context, err);
        }
        finally {
            context.response.destroy(closeResources);
            resolve();
            state.handling.delete(handlingPromise);
            if (state.closing) {
                state.server.close();
                state.closed = true;
            }
        }
    }
    addEventListener(type, listener, options) {
        super.addEventListener(type, listener, options);
    }
    handle = (async (request, secureOrConn, secure = false) => {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        assert(isConn(secureOrConn) || typeof secureOrConn === "undefined");
        const contextRequest = new NativeRequest({
            request,
            respondWith() {
                return Promise.resolve(undefined);
            },
        }, { conn: secureOrConn });
        const context = new Context(this, contextRequest, this.#getContextState(), secure);
        try {
            await this.#getComposed()(context);
        }
        catch (err) {
            this.#handleError(context, err);
        }
        if (context.respond === false) {
            context.response.destroy();
            return;
        }
        try {
            const response = await context.response.toDomResponse();
            context.response.destroy(false);
            return response;
        }
        catch (err) {
            this.#handleError(context, err);
            throw err;
        }
    });
    async listen(options) {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        if (typeof options === "string") {
            const match = ADDR_REGEXP.exec(options);
            if (!match) {
                throw TypeError(`Invalid address passed: "${options}"`);
            }
            const [, hostname, portStr] = match;
            options = { hostname, port: parseInt(portStr, 10) };
        }
        const server = new this.#serverConstructor(this, options);
        const { signal } = options;
        const state = {
            closed: false,
            closing: false,
            handling: new Set(),
            server,
        };
        if (signal) {
            signal.addEventListener("abort", () => {
                if (!state.handling.size) {
                    server.close();
                    state.closed = true;
                }
                state.closing = true;
            });
        }
        const { secure = false } = options;
        const serverType = server instanceof HttpServerNative ? "native" : "custom";
        const listener = server.listen();
        const { hostname, port } = listener.addr;
        this.dispatchEvent(new ApplicationListenEvent({
            hostname,
            listener,
            port,
            secure,
            serverType,
        }));
        try {
            for await (const request of server) {
                this.#handleRequest(request, secure, state);
            }
            await Promise.all(state.handling);
        }
        catch (error) {
            const message = error instanceof Error
                ? error.message
                : "Application Error";
            this.dispatchEvent(new ApplicationErrorEvent({ message, error }));
        }
    }
    use(...middleware) {
        this.#middleware.push(...middleware);
        this.#composedMiddleware = undefined;
        return this;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        const { keys, proxy, state } = this;
        return `${this.constructor.name} ${inspect({ "#middleware": this.#middleware, keys, proxy, state })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZDLE9BQU8sRUFBVSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFFLE9BQU8sRUFBYyxNQUFNLGlCQUFpQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQXFJM0MsTUFBTSxXQUFXLEdBQUcsK0JBQStCLENBQUM7QUFFcEQsTUFBTSxPQUFPLHFCQUNYLFNBQVEsVUFBVTtJQUNsQixPQUFPLENBQWtCO0lBRXpCLFlBQVksYUFBK0M7UUFDekQsS0FBSyxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsT0FBTyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUM7SUFDdkMsQ0FBQztDQUNGO0FBRUQsU0FBUyxnQkFBZ0IsQ0FDdkIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFnQztJQUVoRCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUU7UUFDMUIsT0FBTyxDQUFDLEtBQUssQ0FDWCxpQ0FBaUMsS0FBSyxDQUFDLElBQUksTUFBTSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQ2pFLENBQUM7S0FDSDtTQUFNO1FBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUN4RDtJQUNELElBQUksT0FBTyxFQUFFO1FBQ1gsSUFBSSxHQUFXLENBQUM7UUFDaEIs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R0FBRyxJQUFJLENBQUM7UUFDcEMsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUM3QixPQUFPLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUNqRSxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgeyBTdGF0dXMsIFNUQVRVU19URVhUIH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgSHR0cFNlcnZlck5hdGl2ZSwgTmF0aXZlUmVxdWVzdCB9IGZyb20gXCIuL2h0dHBfc2VydmVyX25hdGl2ZS50c1wiO1xuaW1wb3J0IHsgS2V5U3RhY2sgfSBmcm9tIFwiLi9rZXlTdGFjay50c1wiO1xuaW1wb3J0IHsgY29tcG9zZSwgTWlkZGxld2FyZSB9IGZyb20gXCIuL21pZGRsZXdhcmUudHNcIjtcbmltcG9ydCB7IGNsb25lU3RhdGUgfSBmcm9tIFwiLi9zdHJ1Y3R1cmVkX2Nsb25lLnRzXCI7XG5pbXBvcnQgeyBLZXksIFNlcnZlciwgU2VydmVyQ29uc3RydWN0b3IgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5pbXBvcnQgeyBhc3NlcnQsIGlzQ29ubiB9IGZyb20gXCIuL3V0aWwudHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBMaXN0ZW5PcHRpb25zQmFzZSBleHRlbmRzIERlbm8uTGlzdGVuT3B0aW9ucyB7XG4gIHNlY3VyZT86IGZhbHNlO1xuICBzaWduYWw/OiBBYm9ydFNpZ25hbDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMaXN0ZW5PcHRpb25zVGxzIGV4dGVuZHMgRGVuby5MaXN0ZW5UbHNPcHRpb25zIHtcbiAgLyoqIEFwcGxpY2F0aW9uLUxheWVyIFByb3RvY29sIE5lZ290aWF0aW9uIChBTFBOKSBwcm90b2NvbHMgdG8gYW5ub3VuY2UgdG9cbiAgICogdGhlIGNsaWVudC4gSWYgbm90IHNwZWNpZmllZCwgbm8gQUxQTiBleHRlbnNpb24gd2lsbCBiZSBpbmNsdWRlZCBpbiB0aGVcbiAgICogVExTIGhhbmRzaGFrZS5cbiAgICpcbiAgICogKipOT1RFKiogdGhpcyBpcyBwYXJ0IG9mIHRoZSBuYXRpdmUgSFRUUCBzZXJ2ZXIgaW4gRGVubyAxLjkgb3IgbGF0ZXIsXG4gICAqIHdoaWNoIHJlcXVpcmVzIHRoZSBgLS11bnN0YWJsZWAgZmxhZyB0byBiZSBhdmFpbGFibGUuXG4gICAqL1xuICBhbHBuUHJvdG9jb2xzPzogc3RyaW5nW107XG4gIHNlY3VyZTogdHJ1ZTtcbiAgc2lnbmFsPzogQWJvcnRTaWduYWw7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSGFuZGxlTWV0aG9kIHtcbiAgLyoqIEhhbmRsZSBhbiBpbmRpdmlkdWFsIHNlcnZlciByZXF1ZXN0LCByZXR1cm5pbmcgdGhlIHNlcnZlciByZXNwb25zZS4gIFRoaXNcbiAgICogaXMgc2ltaWxhciB0byBgLmxpc3RlbigpYCwgYnV0IG9wZW5pbmcgdGhlIGNvbm5lY3Rpb24gYW5kIHJldHJpZXZpbmdcbiAgICogcmVxdWVzdHMgYXJlIG5vdCB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGFwcGxpY2F0aW9uLiAgSWYgdGhlIGdlbmVyYXRlZFxuICAgKiBjb250ZXh0IGdldHMgc2V0IHRvIG5vdCB0byByZXNwb25kLCB0aGVuIHRoZSBtZXRob2QgcmVzb2x2ZXMgd2l0aFxuICAgKiBgdW5kZWZpbmVkYCwgb3RoZXJ3aXNlIGl0IHJlc29sdmVzIHdpdGggYSBET00gYFJlc3BvbnNlYCBvYmplY3QuICovXG4gIChcbiAgICByZXF1ZXN0OiBSZXF1ZXN0LFxuICAgIGNvbm4/OiBEZW5vLkNvbm4sXG4gICAgc2VjdXJlPzogYm9vbGVhbixcbiAgKTogUHJvbWlzZTxSZXNwb25zZSB8IHVuZGVmaW5lZD47XG59XG5cbmV4cG9ydCB0eXBlIExpc3Rlbk9wdGlvbnMgPSBMaXN0ZW5PcHRpb25zVGxzIHwgTGlzdGVuT3B0aW9uc0Jhc2U7XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkVycm9yRXZlbnRMaXN0ZW5lcjxTIGV4dGVuZHMgQVMsIEFTPiB7XG4gIChldnQ6IEFwcGxpY2F0aW9uRXJyb3JFdmVudDxTLCBBUz4pOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyT2JqZWN0PFMgZXh0ZW5kcyBBUywgQVM+IHtcbiAgaGFuZGxlRXZlbnQoZXZ0OiBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8UywgQVM+KTogdm9pZCB8IFByb21pc2U8dm9pZD47XG59XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkVycm9yRXZlbnRJbml0PFMgZXh0ZW5kcyBBUywgQVMgZXh0ZW5kcyBTdGF0ZT5cbiAgZXh0ZW5kcyBFcnJvckV2ZW50SW5pdCB7XG4gIGNvbnRleHQ/OiBDb250ZXh0PFMsIEFTPjtcbn1cblxudHlwZSBBcHBsaWNhdGlvbkVycm9yRXZlbnRMaXN0ZW5lck9yRXZlbnRMaXN0ZW5lck9iamVjdDxTIGV4dGVuZHMgQVMsIEFTPiA9XG4gIHwgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXI8UywgQVM+XG4gIHwgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXJPYmplY3Q8UywgQVM+O1xuXG5pbnRlcmZhY2UgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyIHtcbiAgKGV2dDogQXBwbGljYXRpb25MaXN0ZW5FdmVudCk6IHZvaWQgfCBQcm9taXNlPHZvaWQ+O1xufVxuXG5pbnRlcmZhY2UgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT2JqZWN0IHtcbiAgaGFuZGxlRXZlbnQoZXZ0OiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50KTogdm9pZCB8IFByb21pc2U8dm9pZD47XG59XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50SW5pdCBleHRlbmRzIEV2ZW50SW5pdCB7XG4gIGhvc3RuYW1lOiBzdHJpbmc7XG4gIGxpc3RlbmVyOiBEZW5vLkxpc3RlbmVyO1xuICBwb3J0OiBudW1iZXI7XG4gIHNlY3VyZTogYm9vbGVhbjtcbiAgc2VydmVyVHlwZTogXCJuYXRpdmVcIiB8IFwiY3VzdG9tXCI7XG59XG5cbnR5cGUgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0ID1cbiAgfCBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJcbiAgfCBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJPYmplY3Q7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwbGljYXRpb25PcHRpb25zPFM+IHtcbiAgLyoqIERldGVybWluZSBob3cgd2hlbiBjcmVhdGluZyBhIG5ldyBjb250ZXh0LCB0aGUgc3RhdGUgZnJvbSB0aGUgYXBwbGljYXRpb25cbiAgICogc2hvdWxkIGJlIGFwcGxpZWQuIEEgdmFsdWUgb2YgYFwiY2xvbmVcImAgd2lsbCBzZXQgdGhlIHN0YXRlIGFzIGEgY2xvbmUgb2ZcbiAgICogdGhlIGFwcCBzdGF0ZS4gQW55IG5vbi1jbG9uZWFibGUgb3Igbm9uLWVudW1lcmFibGUgcHJvcGVydGllcyB3aWxsIG5vdCBiZVxuICAgKiBjb3BpZWQuIEEgdmFsdWUgb2YgYFwicHJvdG90eXBlXCJgIG1lYW5zIHRoYXQgdGhlIGFwcGxpY2F0aW9uJ3Mgc3RhdGUgd2lsbCBiZVxuICAgKiB1c2VkIGFzIHRoZSBwcm90b3R5cGUgb2YgdGhlIHRoZSBjb250ZXh0J3Mgc3RhdGUsIG1lYW5pbmcgc2hhbGxvd1xuICAgKiBwcm9wZXJ0aWVzIG9uIHRoZSBjb250ZXh0J3Mgc3RhdGUgd2lsbCBub3QgYmUgcmVmbGVjdGVkIGluIHRoZVxuICAgKiBhcHBsaWNhdGlvbidzIHN0YXRlLiBBIHZhbHVlIG9mIGBcImFsaWFzXCJgIG1lYW5zIHRoYXQgYXBwbGljYXRpb24ncyBgLnN0YXRlYFxuICAgKiBhbmQgdGhlIGNvbnRleHQncyBgLnN0YXRlYCB3aWxsIGJlIGEgcmVmZXJlbmNlIHRvIHRoZSBzYW1lIG9iamVjdC4gQSB2YWx1ZVxuICAgKiBvZiBgXCJlbXB0eVwiYCB3aWxsIGluaXRpYWxpemUgdGhlIGNvbnRleHQncyBgLnN0YXRlYCB3aXRoIGFuIGVtcHR5IG9iamVjdC5cbiAgICpcbiAgICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgYFwiY2xvbmVcImAuXG4gICAqL1xuICBjb250ZXh0U3RhdGU/OiBcImNsb25lXCIgfCBcInByb3RvdHlwZVwiIHwgXCJhbGlhc1wiIHwgXCJlbXB0eVwiO1xuXG4gIC8qKiBBbiBpbml0aWFsIHNldCBvZiBrZXlzIChvciBpbnN0YW5jZSBvZiBgS2V5R3JpcGApIHRvIGJlIHVzZWQgZm9yIHNpZ25pbmdcbiAgICogY29va2llcyBwcm9kdWNlZCBieSB0aGUgYXBwbGljYXRpb24uICovXG4gIGtleXM/OiBLZXlTdGFjayB8IEtleVtdO1xuXG4gIC8qKiBJZiBgdHJ1ZWAsIGFueSBlcnJvcnMgaGFuZGxlZCBieSB0aGUgYXBwbGljYXRpb24gd2lsbCBiZSBsb2dnZWQgdG8gdGhlXG4gICAqIHN0ZGVyci4gSWYgYGZhbHNlYCBub3RoaW5nIHdpbGwgYmUgbG9nZ2VkLiBUaGUgZGVmYXVsdCBpcyBgdHJ1ZWAuXG4gICAqXG4gICAqIEFsbCBlcnJvcnMgYXJlIGF2YWlsYWJsZSBhcyBldmVudHMgb24gdGhlIGFwcGxpY2F0aW9uIG9mIHR5cGUgYFwiZXJyb3JcImAgYW5kXG4gICAqIGNhbiBiZSBhY2Nlc3NlZCBmb3IgY3VzdG9tIGxvZ2dpbmcvYXBwbGljYXRpb24gbWFuYWdlbWVudCB2aWEgYWRkaW5nIGFuXG4gICAqIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSBhcHBsaWNhdGlvbjpcbiAgICpcbiAgICogYGBgdHNcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHsgbG9nRXJyb3JzOiBmYWxzZSB9KTtcbiAgICogYXBwLmFkZEV2ZW50TGlzdGVuZXIoXCJlcnJvclwiLCAoZXZ0KSA9PiB7XG4gICAqICAgLy8gZXZ0LmVycm9yIHdpbGwgY29udGFpbiB3aGF0IGVycm9yIHdhcyB0aHJvd25cbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgbG9nRXJyb3JzPzogYm9vbGVhbjtcblxuICAvKiogSWYgc2V0IHRvIGB0cnVlYCwgcHJveHkgaGVhZGVycyB3aWxsIGJlIHRydXN0ZWQgd2hlbiBwcm9jZXNzaW5nIHJlcXVlc3RzLlxuICAgKiBUaGlzIGRlZmF1bHRzIHRvIGBmYWxzZWAuICovXG4gIHByb3h5PzogYm9vbGVhbjtcblxuICAvKiogQSBzZXJ2ZXIgY29uc3RydWN0b3IgdG8gdXNlIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgc2VydmVyIGZvciByZWNlaXZpbmdcbiAgICogcmVxdWVzdHMuXG4gICAqXG4gICAqIEdlbmVyYWxseSB0aGlzIGlzIG9ubHkgdXNlZCBmb3IgdGVzdGluZy4gKi9cbiAgc2VydmVyQ29uc3RydWN0b3I/OiBTZXJ2ZXJDb25zdHJ1Y3RvcjxOYXRpdmVSZXF1ZXN0PjtcblxuICAvKiogVGhlIGluaXRpYWwgc3RhdGUgb2JqZWN0IGZvciB0aGUgYXBwbGljYXRpb24sIG9mIHdoaWNoIHRoZSB0eXBlIGNhbiBiZVxuICAgKiB1c2VkIHRvIGluZmVyIHRoZSB0eXBlIG9mIHRoZSBzdGF0ZSBmb3IgYm90aCB0aGUgYXBwbGljYXRpb24gYW5kIGFueSBvZiB0aGVcbiAgICogYXBwbGljYXRpb24ncyBjb250ZXh0LiAqL1xuICBzdGF0ZT86IFM7XG59XG5cbmludGVyZmFjZSBSZXF1ZXN0U3RhdGUge1xuICBoYW5kbGluZzogU2V0PFByb21pc2U8dm9pZD4+O1xuICBjbG9zaW5nOiBib29sZWFuO1xuICBjbG9zZWQ6IGJvb2xlYW47XG4gIHNlcnZlcjogU2VydmVyPE5hdGl2ZVJlcXVlc3Q+O1xufVxuXG4vLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuZXhwb3J0IHR5cGUgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nIHwgbnVtYmVyIHwgc3ltYm9sLCBhbnk+O1xuXG5jb25zdCBBRERSX1JFR0VYUCA9IC9eXFxbPyhbXlxcXV0qKVxcXT86KFswLTldezEsNX0pJC87XG5cbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8UyBleHRlbmRzIEFTLCBBUyBleHRlbmRzIFN0YXRlPlxuICBleHRlbmRzIEVycm9yRXZlbnQge1xuICBjb250ZXh0PzogQ29udGV4dDxTLCBBUz47XG5cbiAgY29uc3RydWN0b3IoZXZlbnRJbml0RGljdDogQXBwbGljYXRpb25FcnJvckV2ZW50SW5pdDxTLCBBUz4pIHtcbiAgICBzdXBlcihcImVycm9yXCIsIGV2ZW50SW5pdERpY3QpO1xuICAgIHRoaXMuY29udGV4dCA9IGV2ZW50SW5pdERpY3QuY29udGV4dDtcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2dFcnJvckxpc3RlbmVyPFMgZXh0ZW5kcyBBUywgQVMgZXh0ZW5kcyBTdGF0ZT4oXG4gIHsgZXJyb3IsIGNvbnRleHQgfTogQXBwbGljYXRpb25FcnJvckV2ZW50PFMsIEFTPixcbikge1xuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICBgW3VuY2F1Z2h0IGFwcGxpY2F0aW9uIGVycm9yXTogJHtlcnJvci5uYW1lfSAtICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcihgW3VuY2F1Z2h0IGFwcGxpY2F0aW9uIGVycm9yXVxcbmAsIGVycm9yKTtcbiAgfVxuICBpZiAoY29udGV4dCkge1xuICAgIGxldCB1cmw6IHN0cmluZztcbiAgICB0cnkge1xuICAgICAgdXJsID0gY29udGV4dC5yZXF1ZXN0LnVybC50b1N0cmluZygpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdXJsID0gXCJbbWFsZm9ybWVkIHVybF1cIjtcbiAgICB9XG4gICAgY29uc29sZS5lcnJvcihgXFxucmVxdWVzdDpgLCB7XG4gICAgICB1cmwsXG4gICAgICBtZXRob2Q6IGNvbnRleHQucmVxdWVzdC5tZXRob2QsXG4gICAgICBoYXNCb2R5OiBjb250ZXh0LnJlcXVlc3QuaGFzQm9keSxcbiAgICB9KTtcbiAgICBjb25zb2xlLmVycm9yKGByZXNwb25zZTpgLCB7XG4gICAgICBzdGF0dXM6IGNvbnRleHQucmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgdHlwZTogY29udGV4dC5yZXNwb25zZS50eXBlLFxuICAgICAgaGFzQm9keTogISFjb250ZXh0LnJlc3BvbnNlLmJvZHksXG4gICAgICB3cml0YWJsZTogY29udGV4dC5yZXNwb25zZS53cml0YWJsZSxcbiAgICB9KTtcbiAgfVxuICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5zdGFjaykge1xuICAgIGNvbnNvbGUuZXJyb3IoYFxcbiR7ZXJyb3Iuc3RhY2suc3BsaXQoXCJcXG5cIikuc2xpY2UoMSkuam9pbihcIlxcblwiKX1gKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25MaXN0ZW5FdmVudCBleHRlbmRzIEV2ZW50IHtcbiAgaG9zdG5hbWU6IHN0cmluZztcbiAgbGlzdGVuZXI6IERlbm8uTGlzdGVuZXI7XG4gIHBvcnQ6IG51bWJlcjtcbiAgc2VjdXJlOiBib29sZWFuO1xuICBzZXJ2ZXJUeXBlOiBcIm5hdGl2ZVwiIHwgXCJjdXN0b21cIjtcblxuICBjb25zdHJ1Y3RvcihldmVudEluaXREaWN0OiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50SW5pdCkge1xuICAgIHN1cGVyKFwibGlzdGVuXCIsIGV2ZW50SW5pdERpY3QpO1xuICAgIHRoaXMuaG9zdG5hbWUgPSBldmVudEluaXREaWN0Lmhvc3RuYW1lO1xuICAgIHRoaXMubGlzdGVuZXIgPSBldmVudEluaXREaWN0Lmxpc3RlbmVyO1xuICAgIHRoaXMucG9ydCA9IGV2ZW50SW5pdERpY3QucG9ydDtcbiAgICB0aGlzLnNlY3VyZSA9IGV2ZW50SW5pdERpY3Quc2VjdXJlO1xuICAgIHRoaXMuc2VydmVyVHlwZSA9IGV2ZW50SW5pdERpY3Quc2VydmVyVHlwZTtcbiAgfVxufVxuXG4vKiogQSBjbGFzcyB3aGljaCByZWdpc3RlcnMgbWlkZGxld2FyZSAodmlhIGAudXNlKClgKSBhbmQgdGhlbiBwcm9jZXNzZXNcbiAqIGluYm91bmQgcmVxdWVzdHMgYWdhaW5zdCB0aGF0IG1pZGRsZXdhcmUgKHZpYSBgLmxpc3RlbigpYCkuXG4gKlxuICogVGhlIGBjb250ZXh0LnN0YXRlYCBjYW4gYmUgdHlwZWQgdmlhIHBhc3NpbmcgYSBnZW5lcmljIGFyZ3VtZW50IHdoZW5cbiAqIGNvbnN0cnVjdGluZyBhbiBpbnN0YW5jZSBvZiBgQXBwbGljYXRpb25gLlxuICovXG4vLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uPEFTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+PlxuICBleHRlbmRzIEV2ZW50VGFyZ2V0IHtcbiAgI2NvbXBvc2VkTWlkZGxld2FyZT86IChjb250ZXh0OiBDb250ZXh0PEFTLCBBUz4pID0+IFByb21pc2U8dW5rbm93bj47XG4gICNjb250ZXh0U3RhdGU6IFwiY2xvbmVcIiB8IFwicHJvdG90eXBlXCIgfCBcImFsaWFzXCIgfCBcImVtcHR5XCI7XG4gICNrZXlzPzogS2V5U3RhY2s7XG4gICNtaWRkbGV3YXJlOiBNaWRkbGV3YXJlPFN0YXRlLCBDb250ZXh0PFN0YXRlLCBBUz4+W10gPSBbXTtcbiAgI3NlcnZlckNvbnN0cnVjdG9yOiBTZXJ2ZXJDb25zdHJ1Y3RvcjxOYXRpdmVSZXF1ZXN0PjtcblxuICAvKiogQSBzZXQgb2Yga2V5cywgb3IgYW4gaW5zdGFuY2Ugb2YgYEtleVN0YWNrYCB3aGljaCB3aWxsIGJlIHVzZWQgdG8gc2lnblxuICAgKiBjb29raWVzIHJlYWQgYW5kIHNldCBieSB0aGUgYXBwbGljYXRpb24gdG8gYXZvaWQgdGFtcGVyaW5nIHdpdGggdGhlXG4gICAqIGNvb2tpZXMuICovXG4gIGdldCBrZXlzKCk6IEtleVN0YWNrIHwgS2V5W10gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNrZXlzO1xuICB9XG5cbiAgc2V0IGtleXMoa2V5czogS2V5U3RhY2sgfCBLZXlbXSB8IHVuZGVmaW5lZCkge1xuICAgIGlmICgha2V5cykge1xuICAgICAgdGhpcy4ja2V5cyA9IHVuZGVmaW5lZDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoa2V5cykpIHtcbiAgICAgIHRoaXMuI2tleXMgPSBuZXcgS2V5U3RhY2soa2V5cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuI2tleXMgPSBrZXlzO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBJZiBgdHJ1ZWAsIHByb3h5IGhlYWRlcnMgd2lsbCBiZSB0cnVzdGVkIHdoZW4gcHJvY2Vzc2luZyByZXF1ZXN0cy4gIFRoaXNcbiAgICogZGVmYXVsdHMgdG8gYGZhbHNlYC4gKi9cbiAgcHJveHk6IGJvb2xlYW47XG5cbiAgLyoqIEdlbmVyaWMgc3RhdGUgb2YgdGhlIGFwcGxpY2F0aW9uLCB3aGljaCBjYW4gYmUgc3BlY2lmaWVkIGJ5IHBhc3NpbmcgdGhlXG4gICAqIGdlbmVyaWMgYXJndW1lbnQgd2hlbiBjb25zdHJ1Y3Rpbmc6XG4gICAqXG4gICAqICAgICAgIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbjx7IGZvbzogc3RyaW5nIH0+KCk7XG4gICAqXG4gICAqIE9yIGNhbiBiZSBjb250ZXh0dWFsbHkgaW5mZXJyZWQgYmFzZWQgb24gc2V0dGluZyBhbiBpbml0aWFsIHN0YXRlIG9iamVjdDpcbiAgICpcbiAgICogICAgICAgY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHsgc3RhdGU6IHsgZm9vOiBcImJhclwiIH0gfSk7XG4gICAqXG4gICAqIFdoZW4gYSBuZXcgY29udGV4dCBpcyBjcmVhdGVkLCB0aGUgYXBwbGljYXRpb24ncyBzdGF0ZSBpcyBjbG9uZWQgYW5kIHRoZVxuICAgKiBzdGF0ZSBpcyB1bmlxdWUgdG8gdGhhdCByZXF1ZXN0L3Jlc3BvbnNlLiAgQ2hhbmdlcyBjYW4gYmUgbWFkZSB0byB0aGVcbiAgICogYXBwbGljYXRpb24gc3RhdGUgdGhhdCB3aWxsIGJlIHNoYXJlZCB3aXRoIGFsbCBjb250ZXh0cy5cbiAgICovXG4gIHN0YXRlOiBBUztcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBBcHBsaWNhdGlvbk9wdGlvbnM8QVM+ID0ge30pIHtcbiAgICBzdXBlcigpO1xuICAgIGNvbnN0IHtcbiAgICAgIHN0YXRlLFxuICAgICAga2V5cyxcbiAgICAgIHByb3h5LFxuICAgICAgc2VydmVyQ29uc3RydWN0b3IgPSBIdHRwU2VydmVyTmF0aXZlLFxuICAgICAgY29udGV4dFN0YXRlID0gXCJjbG9uZVwiLFxuICAgICAgbG9nRXJyb3JzID0gdHJ1ZSxcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIHRoaXMucHJveHkgPSBwcm94eSA/PyBmYWxzZTtcbiAgICB0aGlzLmtleXMgPSBrZXlzO1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZSA/PyB7fSBhcyBBUztcbiAgICB0aGlzLiNzZXJ2ZXJDb25zdHJ1Y3RvciA9IHNlcnZlckNvbnN0cnVjdG9yO1xuICAgIHRoaXMuI2NvbnRleHRTdGF0ZSA9IGNvbnRleHRTdGF0ZTtcblxuICAgIGlmIChsb2dFcnJvcnMpIHtcbiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihcImVycm9yXCIsIGxvZ0Vycm9yTGlzdGVuZXIpO1xuICAgIH1cbiAgfVxuXG4gICNnZXRDb21wb3NlZCgpOiAoKGNvbnRleHQ6IENvbnRleHQ8QVMsIEFTPikgPT4gUHJvbWlzZTx1bmtub3duPikge1xuICAgIGlmICghdGhpcy4jY29tcG9zZWRNaWRkbGV3YXJlKSB7XG4gICAgICB0aGlzLiNjb21wb3NlZE1pZGRsZXdhcmUgPSBjb21wb3NlKHRoaXMuI21pZGRsZXdhcmUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy4jY29tcG9zZWRNaWRkbGV3YXJlO1xuICB9XG5cbiAgI2dldENvbnRleHRTdGF0ZSgpOiBBUyB7XG4gICAgc3dpdGNoICh0aGlzLiNjb250ZXh0U3RhdGUpIHtcbiAgICAgIGNhc2UgXCJhbGlhc1wiOlxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbiAgICAgIGNhc2UgXCJjbG9uZVwiOlxuICAgICAgICByZXR1cm4gY2xvbmVTdGF0ZSh0aGlzLnN0YXRlKTtcbiAgICAgIGNhc2UgXCJlbXB0eVwiOlxuICAgICAgICByZXR1cm4ge30gYXMgQVM7XG4gICAgICBjYXNlIFwicHJvdG90eXBlXCI6XG4gICAgICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHRoaXMuc3RhdGUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBEZWFsIHdpdGggdW5jYXVnaHQgZXJyb3JzIGluIGVpdGhlciB0aGUgbWlkZGxld2FyZSBvciBzZW5kaW5nIHRoZVxuICAgKiByZXNwb25zZS4gKi9cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgI2hhbmRsZUVycm9yKGNvbnRleHQ6IENvbnRleHQ8QVM+LCBlcnJvcjogYW55KTogdm9pZCB7XG4gICAgaWYgKCEoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikpIHtcbiAgICAgIGVycm9yID0gbmV3IEVycm9yKGBub24tZXJyb3IgdGhyb3duOiAke0pTT04uc3RyaW5naWZ5KGVycm9yKX1gKTtcbiAgICB9XG4gICAgY29uc3QgeyBtZXNzYWdlIH0gPSBlcnJvcjtcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEFwcGxpY2F0aW9uRXJyb3JFdmVudCh7IGNvbnRleHQsIG1lc3NhZ2UsIGVycm9yIH0pKTtcbiAgICBpZiAoIWNvbnRleHQucmVzcG9uc2Uud3JpdGFibGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZm9yIChjb25zdCBrZXkgb2YgWy4uLmNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5rZXlzKCldKSB7XG4gICAgICBjb250ZXh0LnJlc3BvbnNlLmhlYWRlcnMuZGVsZXRlKGtleSk7XG4gICAgfVxuICAgIGlmIChlcnJvci5oZWFkZXJzICYmIGVycm9yLmhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBlcnJvci5oZWFkZXJzKSB7XG4gICAgICAgIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnRleHQucmVzcG9uc2UudHlwZSA9IFwidGV4dFwiO1xuICAgIGNvbnN0IHN0YXR1czogU3RhdHVzID0gY29udGV4dC5yZXNwb25zZS5zdGF0dXMgPVxuICAgICAgRGVuby5lcnJvcnMgJiYgZXJyb3IgaW5zdGFuY2VvZiBEZW5vLmVycm9ycy5Ob3RGb3VuZFxuICAgICAgICA/IDQwNFxuICAgICAgICA6IGVycm9yLnN0YXR1cyAmJiB0eXBlb2YgZXJyb3Iuc3RhdHVzID09PSBcIm51bWJlclwiXG4gICAgICAgID8gZXJyb3Iuc3RhdHVzXG4gICAgICAgIDogNTAwO1xuICAgIGNvbnRleHQucmVzcG9uc2UuYm9keSA9IGVycm9yLmV4cG9zZVxuICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICA6IFNUQVRVU19URVhULmdldChzdGF0dXMpO1xuICB9XG5cbiAgLyoqIFByb2Nlc3NpbmcgcmVnaXN0ZXJlZCBtaWRkbGV3YXJlIG9uIGVhY2ggcmVxdWVzdC4gKi9cbiAgYXN5bmMgI2hhbmRsZVJlcXVlc3QoXG4gICAgcmVxdWVzdDogTmF0aXZlUmVxdWVzdCxcbiAgICBzZWN1cmU6IGJvb2xlYW4sXG4gICAgc3RhdGU6IFJlcXVlc3RTdGF0ZSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGV4dCA9IG5ldyBDb250ZXh0KHRoaXMsIHJlcXVlc3QsIHRoaXMuI2dldENvbnRleHRTdGF0ZSgpLCBzZWN1cmUpO1xuICAgIGxldCByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICAgIGNvbnN0IGhhbmRsaW5nUHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXMpID0+IHJlc29sdmUgPSByZXMpO1xuICAgIHN0YXRlLmhhbmRsaW5nLmFkZChoYW5kbGluZ1Byb21pc2UpO1xuICAgIGlmICghc3RhdGUuY2xvc2luZyAmJiAhc3RhdGUuY2xvc2VkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLiNnZXRDb21wb3NlZCgpKGNvbnRleHQpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjb250ZXh0LnJlc3BvbmQgPT09IGZhbHNlKSB7XG4gICAgICBjb250ZXh0LnJlc3BvbnNlLmRlc3Ryb3koKTtcbiAgICAgIHJlc29sdmUhKCk7XG4gICAgICBzdGF0ZS5oYW5kbGluZy5kZWxldGUoaGFuZGxpbmdQcm9taXNlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGNsb3NlUmVzb3VyY2VzID0gdHJ1ZTtcbiAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlO1xuICAgIHRyeSB7XG4gICAgICBjbG9zZVJlc291cmNlcyA9IGZhbHNlO1xuICAgICAgcmVzcG9uc2UgPSBhd2FpdCBjb250ZXh0LnJlc3BvbnNlLnRvRG9tUmVzcG9uc2UoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMuI2hhbmRsZUVycm9yKGNvbnRleHQsIGVycik7XG4gICAgICByZXNwb25zZSA9IGF3YWl0IGNvbnRleHQucmVzcG9uc2UudG9Eb21SZXNwb25zZSgpO1xuICAgIH1cbiAgICBhc3NlcnQocmVzcG9uc2UpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXF1ZXN0LnJlc3BvbmQocmVzcG9uc2UpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy4jaGFuZGxlRXJyb3IoY29udGV4dCwgZXJyKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgY29udGV4dC5yZXNwb25zZS5kZXN0cm95KGNsb3NlUmVzb3VyY2VzKTtcbiAgICAgIHJlc29sdmUhKCk7XG4gICAgICBzdGF0ZS5oYW5kbGluZy5kZWxldGUoaGFuZGxpbmdQcm9taXNlKTtcbiAgICAgIGlmIChzdGF0ZS5jbG9zaW5nKSB7XG4gICAgICAgIHN0YXRlLnNlcnZlci5jbG9zZSgpO1xuICAgICAgICBzdGF0ZS5jbG9zZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKiBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGFuIGBcImVycm9yXCJgIGV2ZW50IHdoaWNoIG9jY3VycyB3aGVuIGFuXG4gICAqIHVuLWNhdWdodCBlcnJvciBvY2N1cnMgd2hlbiBwcm9jZXNzaW5nIHRoZSBtaWRkbGV3YXJlIG9yIGR1cmluZyBwcm9jZXNzaW5nXG4gICAqIG9mIHRoZSByZXNwb25zZS4gKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcjxTIGV4dGVuZHMgQVM+KFxuICAgIHR5cGU6IFwiZXJyb3JcIixcbiAgICBsaXN0ZW5lcjogQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXJPckV2ZW50TGlzdGVuZXJPYmplY3Q8UywgQVM+IHwgbnVsbCxcbiAgICBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zLFxuICApOiB2b2lkO1xuICAvKiogQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIGBcImxpc3RlblwiYCBldmVudCB3aGljaCBvY2N1cnMgd2hlbiB0aGUgc2VydmVyXG4gICAqIGhhcyBzdWNjZXNzZnVsbHkgb3BlbmVkIGJ1dCBiZWZvcmUgYW55IHJlcXVlc3RzIHN0YXJ0IGJlaW5nIHByb2Nlc3NlZC4gKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcihcbiAgICB0eXBlOiBcImxpc3RlblwiLFxuICAgIGxpc3RlbmVyOiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJPckV2ZW50TGlzdGVuZXJPYmplY3QgfCBudWxsLFxuICAgIG9wdGlvbnM/OiBib29sZWFuIHwgQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnMsXG4gICk6IHZvaWQ7XG4gIC8qKiBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGFuIGV2ZW50LiAgQ3VycmVudGx5IHZhbGlkIGV2ZW50IHR5cGVzIGFyZVxuICAgKiBgXCJlcnJvclwiYCBhbmQgYFwibGlzdGVuXCJgLiAqL1xuICBhZGRFdmVudExpc3RlbmVyKFxuICAgIHR5cGU6IFwiZXJyb3JcIiB8IFwibGlzdGVuXCIsXG4gICAgbGlzdGVuZXI6IEV2ZW50TGlzdGVuZXJPckV2ZW50TGlzdGVuZXJPYmplY3QgfCBudWxsLFxuICAgIG9wdGlvbnM/OiBib29sZWFuIHwgQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnMsXG4gICk6IHZvaWQge1xuICAgIHN1cGVyLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqIEhhbmRsZSBhbiBpbmRpdmlkdWFsIHNlcnZlciByZXF1ZXN0LCByZXR1cm5pbmcgdGhlIHNlcnZlciByZXNwb25zZS4gIFRoaXNcbiAgICogaXMgc2ltaWxhciB0byBgLmxpc3RlbigpYCwgYnV0IG9wZW5pbmcgdGhlIGNvbm5lY3Rpb24gYW5kIHJldHJpZXZpbmdcbiAgICogcmVxdWVzdHMgYXJlIG5vdCB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGFwcGxpY2F0aW9uLiAgSWYgdGhlIGdlbmVyYXRlZFxuICAgKiBjb250ZXh0IGdldHMgc2V0IHRvIG5vdCB0byByZXNwb25kLCB0aGVuIHRoZSBtZXRob2QgcmVzb2x2ZXMgd2l0aFxuICAgKiBgdW5kZWZpbmVkYCwgb3RoZXJ3aXNlIGl0IHJlc29sdmVzIHdpdGggYSByZXF1ZXN0IHRoYXQgaXMgY29tcGF0aWJsZSB3aXRoXG4gICAqIGBzdGQvaHR0cC9zZXJ2ZXJgLiAqL1xuICBoYW5kbGUgPSAoYXN5bmMgKFxuICAgIHJlcXVlc3Q6IFJlcXVlc3QsXG4gICAgc2VjdXJlT3JDb25uOiBEZW5vLkNvbm4gfCBib29sZWFuIHwgdW5kZWZpbmVkLFxuICAgIHNlY3VyZTogYm9vbGVhbiB8IHVuZGVmaW5lZCA9IGZhbHNlLFxuICApOiBQcm9taXNlPFJlc3BvbnNlIHwgdW5kZWZpbmVkPiA9PiB7XG4gICAgaWYgKCF0aGlzLiNtaWRkbGV3YXJlLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlRoZXJlIGlzIG5vIG1pZGRsZXdhcmUgdG8gcHJvY2VzcyByZXF1ZXN0cy5cIik7XG4gICAgfVxuICAgIGFzc2VydChpc0Nvbm4oc2VjdXJlT3JDb25uKSB8fCB0eXBlb2Ygc2VjdXJlT3JDb25uID09PSBcInVuZGVmaW5lZFwiKTtcbiAgICBjb25zdCBjb250ZXh0UmVxdWVzdCA9IG5ldyBOYXRpdmVSZXF1ZXN0KHtcbiAgICAgIHJlcXVlc3QsXG4gICAgICByZXNwb25kV2l0aCgpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgfSxcbiAgICB9LCB7IGNvbm46IHNlY3VyZU9yQ29ubiB9KTtcbiAgICBjb25zdCBjb250ZXh0ID0gbmV3IENvbnRleHQoXG4gICAgICB0aGlzLFxuICAgICAgY29udGV4dFJlcXVlc3QsXG4gICAgICB0aGlzLiNnZXRDb250ZXh0U3RhdGUoKSxcbiAgICAgIHNlY3VyZSxcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLiNnZXRDb21wb3NlZCgpKGNvbnRleHQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy4jaGFuZGxlRXJyb3IoY29udGV4dCwgZXJyKTtcbiAgICB9XG4gICAgaWYgKGNvbnRleHQucmVzcG9uZCA9PT0gZmFsc2UpIHtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuZGVzdHJveSgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjb250ZXh0LnJlc3BvbnNlLnRvRG9tUmVzcG9uc2UoKTtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuZGVzdHJveShmYWxzZSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLiNoYW5kbGVFcnJvcihjb250ZXh0LCBlcnIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSkgYXMgSGFuZGxlTWV0aG9kO1xuXG4gIC8qKiBTdGFydCBsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzLCBwcm9jZXNzaW5nIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSBvbiBlYWNoXG4gICAqIHJlcXVlc3QuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgaXMgdW5kZWZpbmVkIG9yIGBmYWxzZWAsIHRoZSBsaXN0ZW5pbmdcbiAgICogd2lsbCBiZSBvdmVyIEhUVFAuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgcHJvcGVydHkgaXMgYHRydWVgLCBhXG4gICAqIGAuY2VydEZpbGVgIGFuZCBhIGAua2V5RmlsZWAgcHJvcGVydHkgbmVlZCB0byBiZSBzdXBwbGllZCBhbmQgcmVxdWVzdHNcbiAgICogd2lsbCBiZSBwcm9jZXNzZWQgb3ZlciBIVFRQUy4gKi9cbiAgYXN5bmMgbGlzdGVuKGFkZHI6IHN0cmluZyk6IFByb21pc2U8dm9pZD47XG4gIC8qKiBTdGFydCBsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzLCBwcm9jZXNzaW5nIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSBvbiBlYWNoXG4gICAqIHJlcXVlc3QuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgaXMgdW5kZWZpbmVkIG9yIGBmYWxzZWAsIHRoZSBsaXN0ZW5pbmdcbiAgICogd2lsbCBiZSBvdmVyIEhUVFAuICBJZiB0aGUgb3B0aW9ucyBgLnNlY3VyZWAgcHJvcGVydHkgaXMgYHRydWVgLCBhXG4gICAqIGAuY2VydEZpbGVgIGFuZCBhIGAua2V5RmlsZWAgcHJvcGVydHkgbmVlZCB0byBiZSBzdXBwbGllZCBhbmQgcmVxdWVzdHNcbiAgICogd2lsbCBiZSBwcm9jZXNzZWQgb3ZlciBIVFRQUy4gKi9cbiAgYXN5bmMgbGlzdGVuKG9wdGlvbnM6IExpc3Rlbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+O1xuICBhc3luYyBsaXN0ZW4ob3B0aW9uczogc3RyaW5nIHwgTGlzdGVuT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy4jbWlkZGxld2FyZS5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJUaGVyZSBpcyBubyBtaWRkbGV3YXJlIHRvIHByb2Nlc3MgcmVxdWVzdHMuXCIpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGNvbnN0IG1hdGNoID0gQUREUl9SRUdFWFAuZXhlYyhvcHRpb25zKTtcbiAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgdGhyb3cgVHlwZUVycm9yKGBJbnZhbGlkIGFkZHJlc3MgcGFzc2VkOiBcIiR7b3B0aW9uc31cImApO1xuICAgICAgfVxuICAgICAgY29uc3QgWywgaG9zdG5hbWUsIHBvcnRTdHJdID0gbWF0Y2g7XG4gICAgICBvcHRpb25zID0geyBob3N0bmFtZSwgcG9ydDogcGFyc2VJbnQocG9ydFN0ciwgMTApIH07XG4gICAgfVxuICAgIGNvbnN0IHNlcnZlciA9IG5ldyB0aGlzLiNzZXJ2ZXJDb25zdHJ1Y3Rvcih0aGlzLCBvcHRpb25zKTtcbiAgICBjb25zdCB7IHNpZ25hbCB9ID0gb3B0aW9ucztcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIGNsb3NlZDogZmFsc2UsXG4gICAgICBjbG9zaW5nOiBmYWxzZSxcbiAgICAgIGhhbmRsaW5nOiBuZXcgU2V0PFByb21pc2U8dm9pZD4+KCksXG4gICAgICBzZXJ2ZXIsXG4gICAgfTtcbiAgICBpZiAoc2lnbmFsKSB7XG4gICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcihcImFib3J0XCIsICgpID0+IHtcbiAgICAgICAgaWYgKCFzdGF0ZS5oYW5kbGluZy5zaXplKSB7XG4gICAgICAgICAgc2VydmVyLmNsb3NlKCk7XG4gICAgICAgICAgc3RhdGUuY2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5jbG9zaW5nID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB7IHNlY3VyZSA9IGZhbHNlIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHNlcnZlclR5cGUgPSBzZXJ2ZXIgaW5zdGFuY2VvZiBIdHRwU2VydmVyTmF0aXZlID8gXCJuYXRpdmVcIiA6IFwiY3VzdG9tXCI7XG4gICAgY29uc3QgbGlzdGVuZXIgPSBzZXJ2ZXIubGlzdGVuKCk7XG4gICAgY29uc3QgeyBob3N0bmFtZSwgcG9ydCB9ID0gbGlzdGVuZXIuYWRkciBhcyBEZW5vLk5ldEFkZHI7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgbmV3IEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQoe1xuICAgICAgICBob3N0bmFtZSxcbiAgICAgICAgbGlzdGVuZXIsXG4gICAgICAgIHBvcnQsXG4gICAgICAgIHNlY3VyZSxcbiAgICAgICAgc2VydmVyVHlwZSxcbiAgICAgIH0pLFxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIGZvciBhd2FpdCAoY29uc3QgcmVxdWVzdCBvZiBzZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy4jaGFuZGxlUmVxdWVzdChyZXF1ZXN0LCBzZWN1cmUsIHN0YXRlKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHN0YXRlLmhhbmRsaW5nKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgIDogXCJBcHBsaWNhdGlvbiBFcnJvclwiO1xuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgICBuZXcgQXBwbGljYXRpb25FcnJvckV2ZW50KHsgbWVzc2FnZSwgZXJyb3IgfSksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBSZWdpc3RlciBtaWRkbGV3YXJlIHRvIGJlIHVzZWQgd2l0aCB0aGUgYXBwbGljYXRpb24uICBNaWRkbGV3YXJlIHdpbGxcbiAgICogYmUgcHJvY2Vzc2VkIGluIHRoZSBvcmRlciBpdCBpcyBhZGRlZCwgYnV0IG1pZGRsZXdhcmUgY2FuIGNvbnRyb2wgdGhlIGZsb3dcbiAgICogb2YgZXhlY3V0aW9uIHZpYSB0aGUgdXNlIG9mIHRoZSBgbmV4dCgpYCBmdW5jdGlvbiB0aGF0IHRoZSBtaWRkbGV3YXJlXG4gICAqIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGguICBUaGUgYGNvbnRleHRgIG9iamVjdCBwcm92aWRlcyBpbmZvcm1hdGlvblxuICAgKiBhYm91dCB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqXG4gICAqIEJhc2ljIHVzYWdlOlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICpcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gICAqXG4gICAqIGFwcC51c2UoKGN0eCwgbmV4dCkgPT4ge1xuICAgKiAgIGN0eC5yZXF1ZXN0OyAvLyBjb250YWlucyByZXF1ZXN0IGluZm9ybWF0aW9uXG4gICAqICAgY3R4LnJlc3BvbnNlOyAvLyBzZXR1cHMgdXAgaW5mb3JtYXRpb24gdG8gdXNlIGluIHRoZSByZXNwb25zZTtcbiAgICogICBhd2FpdCBuZXh0KCk7IC8vIG1hbmFnZXMgdGhlIGZsb3cgY29udHJvbCBvZiB0aGUgbWlkZGxld2FyZSBleGVjdXRpb25cbiAgICogfSk7XG4gICAqXG4gICAqIGF3YWl0IGFwcC5saXN0ZW4oeyBwb3J0OiA4MCB9KTtcbiAgICogYGBgXG4gICAqL1xuICB1c2U8UyBleHRlbmRzIFN0YXRlID0gQVM+KFxuICAgIG1pZGRsZXdhcmU6IE1pZGRsZXdhcmU8UywgQ29udGV4dDxTLCBBUz4+LFxuICAgIC4uLm1pZGRsZXdhcmVzOiBNaWRkbGV3YXJlPFMsIENvbnRleHQ8UywgQVM+PltdXG4gICk6IEFwcGxpY2F0aW9uPFMgZXh0ZW5kcyBBUyA/IFMgOiAoUyAmIEFTKT47XG4gIHVzZTxTIGV4dGVuZHMgU3RhdGUgPSBBUz4oXG4gICAgLi4ubWlkZGxld2FyZTogTWlkZGxld2FyZTxTLCBDb250ZXh0PFMsIEFTPj5bXVxuICApOiBBcHBsaWNhdGlvbjxTIGV4dGVuZHMgQVMgPyBTIDogKFMgJiBBUyk+IHtcbiAgICB0aGlzLiNtaWRkbGV3YXJlLnB1c2goLi4ubWlkZGxld2FyZSk7XG4gICAgdGhpcy4jY29tcG9zZWRNaWRkbGV3YXJlID0gdW5kZWZpbmVkO1xuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgcmV0dXJuIHRoaXMgYXMgQXBwbGljYXRpb248YW55PjtcbiAgfVxuXG4gIFtTeW1ib2wuZm9yKFwiRGVuby5jdXN0b21JbnNwZWN0XCIpXShpbnNwZWN0OiAodmFsdWU6IHVua25vd24pID0+IHN0cmluZykge1xuICAgIGNvbnN0IHsga2V5cywgcHJveHksIHN0YXRlIH0gPSB0aGlzO1xuICAgIHJldHVybiBgJHt0aGlzLmNvbnN0cnVjdG9yLm5hbWV9ICR7XG4gICAgICBpbnNwZWN0KHsgXCIjbWlkZGxld2FyZVwiOiB0aGlzLiNtaWRkbGV3YXJlLCBrZXlzLCBwcm94eSwgc3RhdGUgfSlcbiAgICB9YDtcbiAgfVxufVxuIl19
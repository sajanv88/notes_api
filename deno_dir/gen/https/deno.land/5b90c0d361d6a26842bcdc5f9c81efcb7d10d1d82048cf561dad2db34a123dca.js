import { OpCode, setHeader } from "./header.ts";
import { deserializeBson, serializeBson } from "../utils/bson.ts";
const encoder = new TextEncoder();
const decoder = new TextDecoder();
function serializeSections(sections) {
    let totalLen = 0;
    const buffers = sections.map((section) => {
        if ("document" in section) {
            const document = serializeBson(section.document);
            const section0 = new Uint8Array(1 + document.byteLength);
            new DataView(section0.buffer).setUint8(0, 0);
            section0.set(document, 1);
            totalLen += section0.byteLength;
            return section0;
        }
        else {
            const identifier = encoder.encode(section.identifier + "\0");
            let documentsLength = 0;
            const docs = section.documents.map((doc) => {
                const document = serializeBson(doc);
                documentsLength += document.byteLength;
                return document;
            });
            const section1 = new Uint8Array(1 + 4 + identifier.byteLength + documentsLength);
            const view = new DataView(section1.buffer);
            view.setUint8(0, 1);
            view.setUint32(1, section1.byteLength - 1, true);
            let pos = 4;
            for (const doc of docs) {
                section1.set(doc, pos);
                pos += doc.byteLength;
            }
            totalLen += section1.byteLength;
            return section1;
        }
    });
    return { length: totalLen, sections: buffers };
}
export function serializeMessage(message) {
    const { length: sectionsLength, sections } = serializeSections(message.sections);
    const buffer = new Uint8Array(20 + sectionsLength);
    const view = new DataView(buffer.buffer);
    setHeader(view, {
        messageLength: buffer.byteLength,
        responseTo: message.responseTo,
        requestId: message.requestId,
        opCode: OpCode.MSG,
    });
    view.setInt32(16, message.flags ?? 0, true);
    let pos = 20;
    for (const section of sections) {
        buffer.set(section, pos);
        pos += section.byteLength;
    }
    return buffer;
}
export function deserializeMessage(header, buffer) {
    const view = new DataView(buffer.buffer);
    const flags = view.getInt32(0);
    const sections = [];
    let pos = 4;
    while (pos < view.byteLength) {
        const kind = view.getInt8(pos);
        pos++;
        if (kind === 0) {
            const docLen = view.getInt32(pos, true);
            const document = deserializeBson(new Uint8Array(view.buffer.slice(pos, pos + docLen)));
            pos += docLen;
            sections.push({ document });
        }
        else if (kind === 1) {
            const len = view.getInt32(pos, true);
            const sectionBody = new Uint8Array(view.buffer.slice(pos + 4, pos + len - 4));
            const identifierEndPos = sectionBody.findIndex((byte) => byte === 0);
            const identifier = decoder.decode(buffer.slice(0, identifierEndPos));
            const docsBuffer = sectionBody.slice(identifierEndPos + 1);
            const documents = parseDocuments(docsBuffer);
            pos += len;
            sections.push({ identifier, documents });
        }
        else {
            throw new Error("Invalid section kind: " + kind);
        }
    }
    return {
        responseTo: header.responseTo,
        requestId: header.requestId,
        flags,
        sections,
    };
}
function parseDocuments(buffer) {
    let pos = 0;
    const docs = [];
    const view = new DataView(buffer);
    while (pos < buffer.byteLength) {
        const docLen = view.getInt32(pos, true);
        const doc = deserializeBson(buffer.slice(pos, pos + docLen));
        docs.push(doc);
        pos += docLen;
    }
    return docs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1lc3NhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFpQixNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRS9ELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFJbEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBcUJsQyxTQUFTLGlCQUFpQixDQUN4QixRQUFtQjtJQUVuQixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7SUFDakIsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3ZDLElBQUksVUFBVSxJQUFJLE9BQU8sRUFBRTtZQUN6QixNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sUUFBUSxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDekQsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0MsUUFBUSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDMUIsUUFBUSxJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQUM7WUFDaEMsT0FBTyxRQUFRLENBQUM7U0FDakI7YUFBTTtZQUNMLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsQ0FBQztZQUM3RCxJQUFJLGVBQWUsR0FBRyxDQUFDLENBQUM7WUFDeEIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFD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O2FBQU07WUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxDQUFDO1NBQ2xEO0tBQ0Y7SUFFRCxPQUFPO1FBQ0wsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO1FBQzdCLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUztRQUMzQixLQUFLO1FBQ0wsUUFBUTtLQUNULENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsTUFBa0I7SUFDeEMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ1osTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2hCLE1BQU0sSUFBSSxHQUFHLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLE9BQU8sR0FBRyxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUU7UUFDOUIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDeEMsTUFBTSxHQUFHLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDZixHQUFHLElBQUksTUFBTSxDQUFDO0tBQ2Y7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNZXNzYWdlSGVhZGVyLCBPcENvZGUsIHNldEhlYWRlciB9IGZyb20gXCIuL2hlYWRlci50c1wiO1xuaW1wb3J0IHsgRG9jdW1lbnQgfSBmcm9tIFwiLi4vdHlwZXMudHNcIjtcbmltcG9ydCB7IGRlc2VyaWFsaXplQnNvbiwgc2VyaWFsaXplQnNvbiB9IGZyb20gXCIuLi91dGlscy9ic29uLnRzXCI7XG5cbnR5cGUgTWVzc2FnZUZsYWdzID0gbnVtYmVyO1xuXG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5jb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5cbmludGVyZmFjZSBTZWN0aW9uMCB7XG4gIGRvY3VtZW50OiBEb2N1bWVudDtcbn1cblxuaW50ZXJmYWNlIFNlY3Rpb24xIHtcbiAgaWRlbnRpZmllcjogc3RyaW5nO1xuICBkb2N1bWVudHM6IERvY3VtZW50W107XG59XG5cbmV4cG9ydCB0eXBlIFNlY3Rpb24gPSBTZWN0aW9uMCB8IFNlY3Rpb24xO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2Uge1xuICByZXNwb25zZVRvOiBudW1iZXI7XG4gIGZsYWdzPzogTWVzc2FnZUZsYWdzO1xuICBzZWN0aW9uczogU2VjdGlvbltdO1xuICBjaGVja3N1bT86IG51bWJlcjtcbiAgcmVxdWVzdElkOiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZVNlY3Rpb25zKFxuICBzZWN0aW9uczogU2VjdGlvbltdLFxuKTogeyBsZW5ndGg6IG51bWJlcjsgc2VjdGlvbnM6IFVpbnQ4QXJyYXlbXSB9IHtcbiAgbGV0IHRvdGFsTGVuID0gMDtcbiAgY29uc3QgYnVmZmVycyA9IHNlY3Rpb25zLm1hcCgoc2VjdGlvbikgPT4ge1xuICAgIGlmIChcImRvY3VtZW50XCIgaW4gc2VjdGlvbikge1xuICAgICAgY29uc3QgZG9jdW1lbnQgPSBzZXJpYWxpemVCc29uKHNlY3Rpb24uZG9jdW1lbnQpO1xuICAgICAgY29uc3Qgc2VjdGlvbjAgPSBuZXcgVWludDhBcnJheSgxICsgZG9jdW1lbnQuYnl0ZUxlbmd0aCk7XG4gICAgICBuZXcgRGF0YVZpZXcoc2VjdGlvbjAuYnVmZmVyKS5zZXRVaW50OCgwLCAwKTtcbiAgICAgIHNlY3Rpb24wLnNldChkb2N1bWVudCwgMSk7XG4gICAgICB0b3RhbExlbiArPSBzZWN0aW9uMC5ieXRlTGVuZ3RoO1xuICAgICAgcmV0dXJuIHNlY3Rpb24wO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpZGVudGlmaWVyID0gZW5jb2Rlci5lbmNvZGUoc2VjdGlvbi5pZGVudGlmaWVyICsgXCJcXDBcIik7XG4gICAgICBsZXQgZG9jdW1lbnRzTGVuZ3RoID0gMDtcbiAgICAgIGNvbnN0IGRvY3MgPSBzZWN0aW9uLmRvY3VtZW50cy5tYXAoKGRvYykgPT4ge1xuICAgICAgICBjb25zdCBkb2N1bWVudCA9IHNlcmlhbGl6ZUJzb24oZG9jKTtcbiAgICAgICAgZG9jdW1lbnRzTGVuZ3RoICs9IGRvY3VtZW50LmJ5dGVMZW5ndGg7XG4gICAgICAgIHJldHVybiBkb2N1bWVudDtcbiAgICAgIH0pO1xuICAgICAgY29uc3Qgc2VjdGlvbjEgPSBuZXcgVWludDhBcnJheShcbiAgICAgICAgMSArIDQgKyBpZGVudGlmaWVyLmJ5dGVMZW5ndGggKyBkb2N1bWVudHNMZW5ndGgsXG4gICAgICApO1xuICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhzZWN0aW9uMS5idWZmZXIpO1xuXG4gICAgICB2aWV3LnNldFVpbnQ4KDAsIDEpO1xuICAgICAgdmlldy5zZXRVaW50MzIoMSwgc2VjdGlvbjEuYnl0ZUxlbmd0aCAtIDEsIHRydWUpO1xuICAgICAgbGV0IHBvcyA9IDQ7XG5cbiAgICAgIGZvciAoY29uc3QgZG9jIG9mIGRvY3MpIHtcbiAgICAgICAgc2VjdGlvbjEuc2V0KGRvYywgcG9zKTtcbiAgICAgICAgcG9zICs9IGRvYy5ieXRlTGVuZ3RoO1xuICAgICAgfVxuXG4gICAgICB0b3RhbExlbiArPSBzZWN0aW9uMS5ieXRlTGVuZ3RoO1xuICAgICAgcmV0dXJuIHNlY3Rpb24xO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHsgbGVuZ3RoOiB0b3RhbExlbiwgc2VjdGlvbnM6IGJ1ZmZlcnMgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZU1lc3NhZ2UobWVzc2FnZTogTWVzc2FnZSk6IFVpbnQ4QXJyYXkge1xuICBjb25zdCB7IGxlbmd0aDogc2VjdGlvbnNMZW5ndGgsIHNlY3Rpb25zIH0gPSBzZXJpYWxpemVTZWN0aW9ucyhcbiAgICBtZXNzYWdlLnNlY3Rpb25zLFxuICApO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDIwICsgc2VjdGlvbnNMZW5ndGgpOyAvLyAxNiBieXRlcyBoZWFkZXIgKyA0IGJ5dGVzIGZsYWdzICsgc2VjdGlvbnNcbiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyKTtcblxuICAvLyBzZXQgaGVhZGVyXG4gIHNldEhlYWRlcih2aWV3LCB7XG4gICAgbWVzc2FnZUxlbmd0aDogYnVmZmVyLmJ5dGVMZW5ndGgsXG4gICAgcmVzcG9uc2VUbzogbWVzc2FnZS5yZXNwb25zZVRvLFxuICAgIHJlcXVlc3RJZDogbWVzc2FnZS5yZXF1ZXN0SWQsXG4gICAgb3BDb2RlOiBPcENvZGUuTVNHLFxuICB9KTtcblxuICAvLyBzZXQgZmxhZ3NcbiAgdmlldy5zZXRJbnQzMigxNiwgbWVzc2FnZS5mbGFncyA/PyAwLCB0cnVlKTtcblxuICAvLyBzZXQgc2VjdGlvbnNcbiAgbGV0IHBvcyA9IDIwO1xuICBmb3IgKGNvbnN0IHNlY3Rpb24gb2Ygc2VjdGlvbnMpIHtcbiAgICBidWZmZXIuc2V0KHNlY3Rpb24sIHBvcyk7XG4gICAgcG9zICs9IHNlY3Rpb24uYnl0ZUxlbmd0aDtcbiAgfVxuXG4gIHJldHVybiBidWZmZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXNlcmlhbGl6ZU1lc3NhZ2UoXG4gIGhlYWRlcjogTWVzc2FnZUhlYWRlcixcbiAgYnVmZmVyOiBVaW50OEFycmF5LFxuKTogTWVzc2FnZSB7XG4gIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyLmJ1ZmZlcik7XG5cbiAgY29uc3QgZmxhZ3MgPSB2aWV3LmdldEludDMyKDApO1xuICBjb25zdCBzZWN0aW9uczogU2VjdGlvbltdID0gW107XG5cbiAgbGV0IHBvcyA9IDQ7XG4gIHdoaWxlIChwb3MgPCB2aWV3LmJ5dGVMZW5ndGgpIHtcbiAgICBjb25zdCBraW5kID0gdmlldy5nZXRJbnQ4KHBvcyk7XG4gICAgcG9zKys7XG4gICAgaWYgKGtpbmQgPT09IDApIHtcbiAgICAgIGNvbnN0IGRvY0xlbiA9IHZpZXcuZ2V0SW50MzIocG9zLCB0cnVlKTtcbiAgICAgIGNvbnN0IGRvY3VtZW50ID0gZGVzZXJpYWxpemVCc29uKFxuICAgICAgICBuZXcgVWludDhBcnJheSh2aWV3LmJ1ZmZlci5zbGljZShwb3MsIHBvcyArIGRvY0xlbikpLFxuICAgICAgKTtcbiAgICAgIHBvcyArPSBkb2NMZW47XG4gICAgICBzZWN0aW9ucy5wdXNoKHsgZG9jdW1lbnQgfSk7XG4gICAgfSBlbHNlIGlmIChraW5kID09PSAxKSB7XG4gICAgICBjb25zdCBsZW4gPSB2aWV3LmdldEludDMyKHBvcywgdHJ1ZSk7XG4gICAgICBjb25zdCBzZWN0aW9uQm9keSA9IG5ldyBVaW50OEFycmF5KFxuICAgICAgICB2aWV3LmJ1ZmZlci5zbGljZShwb3MgKyA0LCBwb3MgKyBsZW4gLSA0KSxcbiAgICAgICk7XG4gICAgICBjb25zdCBpZGVudGlmaWVyRW5kUG9zID0gc2VjdGlvbkJvZHkuZmluZEluZGV4KChieXRlKSA9PiBieXRlID09PSAwKTtcbiAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSBkZWNvZGVyLmRlY29kZShidWZmZXIuc2xpY2UoMCwgaWRlbnRpZmllckVuZFBvcykpO1xuICAgICAgY29uc3QgZG9jc0J1ZmZlciA9IHNlY3Rpb25Cb2R5LnNsaWNlKGlkZW50aWZpZXJFbmRQb3MgKyAxKTtcbiAgICAgIGNvbnN0IGRvY3VtZW50cyA9IHBhcnNlRG9jdW1lbnRzKGRvY3NCdWZmZXIpO1xuICAgICAgcG9zICs9IGxlbjtcbiAgICAgIHNlY3Rpb25zLnB1c2goeyBpZGVudGlmaWVyLCBkb2N1bWVudHMgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgc2VjdGlvbiBraW5kOiBcIiArIGtpbmQpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVzcG9uc2VUbzogaGVhZGVyLnJlc3BvbnNlVG8sXG4gICAgcmVxdWVzdElkOiBoZWFkZXIucmVxdWVzdElkLFxuICAgIGZsYWdzLFxuICAgIHNlY3Rpb25zLFxuICB9O1xufVxuXG5mdW5jdGlvbiBwYXJzZURvY3VtZW50cyhidWZmZXI6IFVpbnQ4QXJyYXkpOiBEb2N1bWVudFtdIHtcbiAgbGV0IHBvcyA9IDA7XG4gIGNvbnN0IGRvY3MgPSBbXTtcbiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpO1xuICB3aGlsZSAocG9zIDwgYnVmZmVyLmJ5dGVMZW5ndGgpIHtcbiAgICBjb25zdCBkb2NMZW4gPSB2aWV3LmdldEludDMyKHBvcywgdHJ1ZSk7XG4gICAgY29uc3QgZG9jID0gZGVzZXJpYWxpemVCc29uKGJ1ZmZlci5zbGljZShwb3MsIHBvcyArIGRvY0xlbikpO1xuICAgIGRvY3MucHVzaChkb2MpO1xuICAgIHBvcyArPSBkb2NMZW47XG4gIH1cbiAgcmV0dXJuIGRvY3M7XG59XG4iXX0=
import { assert, BufReader, deferred, writeAll } from "../../deps.ts";
import { MongoServerError } from "../error.ts";
import { handshake } from "./handshake.ts";
import { parseHeader } from "./header.ts";
import { deserializeMessage, serializeMessage } from "./message.ts";
let nextRequestId = 0;
export class WireProtocol {
    #socket;
    #isPendingResponse = false;
    #isPendingRequest = false;
    #pendingResponses = new Map();
    #reader;
    #commandQueue = [];
    constructor(socket) {
        this.#socket = socket;
        this.#reader = new BufReader(this.#socket);
    }
    async connect() {
        const { connectionId: _connectionId } = await handshake(this);
    }
    async commandSingle(db, body) {
        const [doc] = await this.command(db, body);
        const maybeError = doc;
        if (maybeError.ok === 0) {
            throw new MongoServerError(maybeError);
        }
        return doc;
    }
    async command(db, body) {
        const requestId = nextRequestId++;
        const commandTask = {
            requestId,
            db,
            body,
        };
        this.#commandQueue.push(commandTask);
        this.send();
        const pendingMessage = deferred();
        this.#pendingResponses.set(requestId, pendingMessage);
        this.receive();
        const message = await pendingMessage;
        let documents = [];
        for (const section of message?.sections) {
            if ("document" in section) {
                documents.push(section.document);
            }
            else {
                documents = documents.concat(section.documents);
            }
        }
        return documents;
    }
    async send() {
        if (this.#isPendingRequest)
            return;
        this.#isPendingRequest = true;
        while (this.#commandQueue.length > 0) {
            const task = this.#commandQueue.shift();
            const buffer = serializeMessage({
                requestId: task.requestId,
                responseTo: 0,
                sections: [
                    {
                        document: {
                            ...task.body,
                            $db: task.db,
                        },
                    },
                ],
            });
            await writeAll(this.#socket, buffer);
        }
        this.#isPendingRequest = false;
    }
    async receive() {
        if (this.#isPendingResponse)
            return;
        this.#isPendingResponse = true;
        while (this.#pendingResponses.size > 0) {
            const headerBuffer = await this.#reader.readFull(new Uint8Array(16));
            assert(headerBuffer);
            const header = parseHeader(headerBuffer);
            const bodyBuffer = await this.#reader.readFull(new Uint8Array(header.messageLength - 16));
            assert(bodyBuffer);
            const reply = deserializeMessage(header, bodyBuffer);
            const pendingMessage = this.#pendingResponses.get(header.responseTo);
            this.#pendingResponses.delete(header.responseTo);
            pendingMessage?.resolve(reply);
        }
        this.#isPendingResponse = false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm90b2NvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBWSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBa0IsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFXLGdCQUFnQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBUzdFLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV0QixNQUFNLE9BQU8sWUFBWTtJQUN2QixPQUFPLENBQVM7SUFDaEIsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQzNCLGlCQUFpQixHQUFHLEtBQUssQ0FBQztJQUMxQixpQkFBaUIsR0FBbUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM5RCxPQUFPLENBQVk7SUFDbkIsYUFBYSxHQUFrQixFQUFFLENBQUM7SUFFbEMsWUFBWSxNQUFjO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLE1BQU0sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhLENBQWUsRUFBVSxFQUFFLElBQWM7UUFDMUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBcUIsRUFBRSxFQUFFLElBQUks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QUFDLENBQUM7WUFDbkIsTUFBTSxLQUFLLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3JFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pELGNBQWMsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDaEM7UUFDRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0lBQ2xDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydCwgQnVmUmVhZGVyLCBEZWZlcnJlZCwgZGVmZXJyZWQsIHdyaXRlQWxsIH0gZnJvbSBcIi4uLy4uL2RlcHMudHNcIjtcbmltcG9ydCB7IE1vbmdvRXJyb3JJbmZvLCBNb25nb1NlcnZlckVycm9yIH0gZnJvbSBcIi4uL2Vycm9yLnRzXCI7XG5pbXBvcnQgeyBEb2N1bWVudCB9IGZyb20gXCIuLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgaGFuZHNoYWtlIH0gZnJvbSBcIi4vaGFuZHNoYWtlLnRzXCI7XG5pbXBvcnQgeyBwYXJzZUhlYWRlciB9IGZyb20gXCIuL2hlYWRlci50c1wiO1xuaW1wb3J0IHsgZGVzZXJpYWxpemVNZXNzYWdlLCBNZXNzYWdlLCBzZXJpYWxpemVNZXNzYWdlIH0gZnJvbSBcIi4vbWVzc2FnZS50c1wiO1xuXG50eXBlIFNvY2tldCA9IERlbm8uUmVhZGVyICYgRGVuby5Xcml0ZXI7XG5pbnRlcmZhY2UgQ29tbWFuZFRhc2sge1xuICByZXF1ZXN0SWQ6IG51bWJlcjtcbiAgZGI6IHN0cmluZztcbiAgYm9keTogRG9jdW1lbnQ7XG59XG5cbmxldCBuZXh0UmVxdWVzdElkID0gMDtcblxuZXhwb3J0IGNsYXNzIFdpcmVQcm90b2NvbCB7XG4gICNzb2NrZXQ6IFNvY2tldDtcbiAgI2lzUGVuZGluZ1Jlc3BvbnNlID0gZmFsc2U7XG4gICNpc1BlbmRpbmdSZXF1ZXN0ID0gZmFsc2U7XG4gICNwZW5kaW5nUmVzcG9uc2VzOiBNYXA8bnVtYmVyLCBEZWZlcnJlZDxNZXNzYWdlPj4gPSBuZXcgTWFwKCk7XG4gICNyZWFkZXI6IEJ1ZlJlYWRlcjtcbiAgI2NvbW1hbmRRdWV1ZTogQ29tbWFuZFRhc2tbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHNvY2tldDogU29ja2V0KSB7XG4gICAgdGhpcy4jc29ja2V0ID0gc29ja2V0O1xuICAgIHRoaXMuI3JlYWRlciA9IG5ldyBCdWZSZWFkZXIodGhpcy4jc29ja2V0KTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QoKSB7XG4gICAgY29uc3QgeyBjb25uZWN0aW9uSWQ6IF9jb25uZWN0aW9uSWQgfSA9IGF3YWl0IGhhbmRzaGFrZSh0aGlzKTtcbiAgfVxuXG4gIGFzeW5jIGNvbW1hbmRTaW5nbGU8VCA9IERvY3VtZW50PihkYjogc3RyaW5nLCBib2R5OiBEb2N1bWVudCk6IFByb21pc2U8VD4ge1xuICAgIGNvbnN0IFtkb2NdID0gYXdhaXQgdGhpcy5jb21tYW5kPE1vbmdvRXJyb3JJbmZvIHwgVD4oZGIsIGJvZHkpO1xuICAgIGNvbnN0IG1heWJlRXJyb3IgPSBkb2MgYXMgTW9uZ29FcnJvckluZm87XG4gICAgaWYgKG1heWJlRXJyb3Iub2sgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBNb25nb1NlcnZlckVycm9yKG1heWJlRXJyb3IpO1xuICAgIH1cbiAgICByZXR1cm4gZG9jIGFzIFQ7XG4gIH1cblxuICBhc3luYyBjb21tYW5kPFQgPSBEb2N1bWVudD4oZGI6IHN0cmluZywgYm9keTogRG9jdW1lbnQpOiBQcm9taXNlPFRbXT4ge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IG5leHRSZXF1ZXN0SWQrKztcbiAgICBjb25zdCBjb21tYW5kVGFzayA9IHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIGRiLFxuICAgICAgYm9keSxcbiAgICB9O1xuXG4gICAgdGhpcy4jY29tbWFuZFF1ZXVlLnB1c2goY29tbWFuZFRhc2spO1xuICAgIHRoaXMuc2VuZCgpO1xuXG4gICAgY29uc3QgcGVuZGluZ01lc3NhZ2UgPSBkZWZlcnJlZDxNZXNzYWdlPigpO1xuICAgIHRoaXMuI3BlbmRpbmdSZXNwb25zZXMuc2V0KHJlcXVlc3RJZCwgcGVuZGluZ01lc3NhZ2UpO1xuICAgIHRoaXMucmVjZWl2ZSgpO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCBwZW5kaW5nTWVzc2FnZTtcblxuICAgIGxldCBkb2N1bWVudHM6IFRbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBzZWN0aW9uIG9mIG1lc3NhZ2U/LnNlY3Rpb25zISkge1xuICAgICAgaWYgKFwiZG9jdW1lbnRcIiBpbiBzZWN0aW9uKSB7XG4gICAgICAgIGRvY3VtZW50cy5wdXNoKHNlY3Rpb24uZG9jdW1lbnQgYXMgVCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudHMgPSBkb2N1bWVudHMuY29uY2F0KHNlY3Rpb24uZG9jdW1lbnRzIGFzIFRbXSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGRvY3VtZW50cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2VuZCgpIHtcbiAgICBpZiAodGhpcy4jaXNQZW5kaW5nUmVxdWVzdCkgcmV0dXJuO1xuICAgIHRoaXMuI2lzUGVuZGluZ1JlcXVlc3QgPSB0cnVlO1xuICAgIHdoaWxlICh0aGlzLiNjb21tYW5kUXVldWUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgdGFzayA9IHRoaXMuI2NvbW1hbmRRdWV1ZS5zaGlmdCgpITtcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IHNlcmlhbGl6ZU1lc3NhZ2Uoe1xuICAgICAgICByZXF1ZXN0SWQ6IHRhc2sucmVxdWVzdElkLFxuICAgICAgICByZXNwb25zZVRvOiAwLFxuICAgICAgICBzZWN0aW9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGRvY3VtZW50OiB7XG4gICAgICAgICAgICAgIC4uLnRhc2suYm9keSxcbiAgICAgICAgICAgICAgJGRiOiB0YXNrLmRiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHdyaXRlQWxsKHRoaXMuI3NvY2tldCwgYnVmZmVyKTtcbiAgICB9XG4gICAgdGhpcy4jaXNQZW5kaW5nUmVxdWVzdCA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWNlaXZlKCkge1xuICAgIGlmICh0aGlzLiNpc1BlbmRpbmdSZXNwb25zZSkgcmV0dXJuO1xuICAgIHRoaXMuI2lzUGVuZGluZ1Jlc3BvbnNlID0gdHJ1ZTtcbiAgICB3aGlsZSAodGhpcy4jcGVuZGluZ1Jlc3BvbnNlcy5zaXplID4gMCkge1xuICAgICAgY29uc3QgaGVhZGVyQnVmZmVyID0gYXdhaXQgdGhpcy4jcmVhZGVyLnJlYWRGdWxsKG5ldyBVaW50OEFycmF5KDE2KSk7XG4gICAgICBhc3NlcnQoaGVhZGVyQnVmZmVyKTtcbiAgICAgIGNvbnN0IGhlYWRlciA9IHBhcnNlSGVhZGVyKGhlYWRlckJ1ZmZlcik7XG4gICAgICBjb25zdCBib2R5QnVmZmVyID0gYXdhaXQgdGhpcy4jcmVhZGVyLnJlYWRGdWxsKFxuICAgICAgICBuZXcgVWludDhBcnJheShoZWFkZXIubWVzc2FnZUxlbmd0aCAtIDE2KSxcbiAgICAgICk7XG4gICAgICBhc3NlcnQoYm9keUJ1ZmZlcik7XG4gICAgICBjb25zdCByZXBseSA9IGRlc2VyaWFsaXplTWVzc2FnZShoZWFkZXIsIGJvZHlCdWZmZXIpO1xuICAgICAgY29uc3QgcGVuZGluZ01lc3NhZ2UgPSB0aGlzLiNwZW5kaW5nUmVzcG9uc2VzLmdldChoZWFkZXIucmVzcG9uc2VUbyk7XG4gICAgICB0aGlzLiNwZW5kaW5nUmVzcG9uc2VzLmRlbGV0ZShoZWFkZXIucmVzcG9uc2VUbyk7XG4gICAgICBwZW5kaW5nTWVzc2FnZT8ucmVzb2x2ZShyZXBseSk7XG4gICAgfVxuICAgIHRoaXMuI2lzUGVuZGluZ1Jlc3BvbnNlID0gZmFsc2U7XG4gIH1cbn1cbiJdfQ==
import { OpCode, setHeader } from "./header.ts";
import { Bson } from "../../deps.ts";
const encoder = new TextEncoder();
const decoder = new TextDecoder();
function serializeSections(sections) {
    let totalLen = 0;
    const buffers = sections.map((section) => {
        if ("document" in section) {
            const document = Bson.serialize(section.document);
            const section0 = new Uint8Array(1 + document.byteLength);
            new DataView(section0.buffer).setUint8(0, 0);
            section0.set(document, 1);
            totalLen += section0.byteLength;
            return section0;
        }
        else {
            const identifier = encoder.encode(section.identifier + "\0");
            let documentsLength = 0;
            const docs = section.documents.map((doc) => {
                const document = Bson.serialize(doc);
                documentsLength += document.byteLength;
                return document;
            });
            const section1 = new Uint8Array(1 + 4 + identifier.byteLength + documentsLength);
            const view = new DataView(section1.buffer);
            view.setUint8(0, 1);
            view.setUint32(1, section1.byteLength - 1, true);
            let pos = 4;
            for (const doc of docs) {
                section1.set(doc, pos);
                pos += doc.byteLength;
            }
            totalLen += section1.byteLength;
            return section1;
        }
    });
    return { length: totalLen, sections: buffers };
}
export function serializeMessage(message) {
    const { length: sectionsLength, sections } = serializeSections(message.sections);
    const buffer = new Uint8Array(20 + sectionsLength);
    const view = new DataView(buffer.buffer);
    setHeader(view, {
        messageLength: buffer.byteLength,
        responseTo: message.responseTo,
        requestId: message.requestId,
        opCode: OpCode.MSG,
    });
    view.setInt32(16, message.flags ?? 0, true);
    let pos = 20;
    for (const section of sections) {
        buffer.set(section, pos);
        pos += section.byteLength;
    }
    return buffer;
}
export function deserializeMessage(header, buffer) {
    const view = new DataView(buffer.buffer);
    const flags = view.getInt32(0);
    const sections = [];
    let pos = 4;
    while (pos < view.byteLength) {
        const kind = view.getInt8(pos);
        pos++;
        if (kind === 0) {
            const docLen = view.getInt32(pos, true);
            const document = Bson.deserialize(new Uint8Array(view.buffer.slice(pos, pos + docLen)));
            pos += docLen;
            sections.push({ document });
        }
        else if (kind === 1) {
            const len = view.getInt32(pos, true);
            const sectionBody = new Uint8Array(view.buffer.slice(pos + 4, pos + len - 4));
            const identifierEndPos = sectionBody.findIndex((byte) => byte === 0);
            const identifier = decoder.decode(buffer.slice(0, identifierEndPos));
            const docsBuffer = sectionBody.slice(identifierEndPos + 1);
            const documents = parseDocuments(docsBuffer);
            pos += len;
            sections.push({ identifier, documents });
        }
        else {
            throw new Error("Invalid section kind: " + kind);
        }
    }
    return {
        responseTo: header.responseTo,
        requestId: header.requestId,
        flags,
        sections,
    };
}
function parseDocuments(buffer) {
    let pos = 0;
    const docs = [];
    const view = new DataView(buffer);
    while (pos < buffer.byteLength) {
        const docLen = view.getInt32(pos, true);
        const doc = Bson.deserialize(buffer.slice(pos, pos + docLen));
        docs.push(doc);
        pos += docLen;
    }
    return docs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1lc3NhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFpQixNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRS9ELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBcUJsQyxTQUFTLGlCQUFpQixDQUN4QixRQUFtQjtJQUVuQixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUM7SUFDakIsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3ZDLElBQUksVUFBVSxJQUFJLE9BQU8sRUFBRTtZQUN6QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNsRCxNQUFNLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3pELElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzdDLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzFCLFFBQVEsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDO1lBQ2hDLE9BQU8sUUFBUSxDQUFDO1NBQ2pCO2FBQU07WUFDTCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLENBQUM7WUFDN0QsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxT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QUFFLENBQUMsQ0FBQztTQUMxQzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsQ0FBQztTQUNsRDtLQUNGO0lBRUQsT0FBTztRQUNMLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVTtRQUM3QixTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVM7UUFDM0IsS0FBSztRQUNMLFFBQVE7S0FDVCxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLE1BQWtCO0lBQ3hDLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNaLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNoQixNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxPQUFPLEdBQUcsR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFO1FBQzlCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNmLEdBQUcsSUFBSSxNQUFNLENBQUM7S0FDZjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1lc3NhZ2VIZWFkZXIsIE9wQ29kZSwgc2V0SGVhZGVyIH0gZnJvbSBcIi4vaGVhZGVyLnRzXCI7XG5pbXBvcnQgeyBEb2N1bWVudCB9IGZyb20gXCIuLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgQnNvbiB9IGZyb20gXCIuLi8uLi9kZXBzLnRzXCI7XG5cbnR5cGUgTWVzc2FnZUZsYWdzID0gbnVtYmVyO1xuXG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5jb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5cbmludGVyZmFjZSBTZWN0aW9uMCB7XG4gIGRvY3VtZW50OiBEb2N1bWVudDtcbn1cblxuaW50ZXJmYWNlIFNlY3Rpb24xIHtcbiAgaWRlbnRpZmllcjogc3RyaW5nO1xuICBkb2N1bWVudHM6IERvY3VtZW50W107XG59XG5cbmV4cG9ydCB0eXBlIFNlY3Rpb24gPSBTZWN0aW9uMCB8IFNlY3Rpb24xO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2Uge1xuICByZXNwb25zZVRvOiBudW1iZXI7XG4gIGZsYWdzPzogTWVzc2FnZUZsYWdzO1xuICBzZWN0aW9uczogU2VjdGlvbltdO1xuICBjaGVja3N1bT86IG51bWJlcjtcbiAgcmVxdWVzdElkOiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIHNlcmlhbGl6ZVNlY3Rpb25zKFxuICBzZWN0aW9uczogU2VjdGlvbltdLFxuKTogeyBsZW5ndGg6IG51bWJlcjsgc2VjdGlvbnM6IFVpbnQ4QXJyYXlbXSB9IHtcbiAgbGV0IHRvdGFsTGVuID0gMDtcbiAgY29uc3QgYnVmZmVycyA9IHNlY3Rpb25zLm1hcCgoc2VjdGlvbikgPT4ge1xuICAgIGlmIChcImRvY3VtZW50XCIgaW4gc2VjdGlvbikge1xuICAgICAgY29uc3QgZG9jdW1lbnQgPSBCc29uLnNlcmlhbGl6ZShzZWN0aW9uLmRvY3VtZW50KTtcbiAgICAgIGNvbnN0IHNlY3Rpb24wID0gbmV3IFVpbnQ4QXJyYXkoMSArIGRvY3VtZW50LmJ5dGVMZW5ndGgpO1xuICAgICAgbmV3IERhdGFWaWV3KHNlY3Rpb24wLmJ1ZmZlcikuc2V0VWludDgoMCwgMCk7XG4gICAgICBzZWN0aW9uMC5zZXQoZG9jdW1lbnQsIDEpO1xuICAgICAgdG90YWxMZW4gKz0gc2VjdGlvbjAuYnl0ZUxlbmd0aDtcbiAgICAgIHJldHVybiBzZWN0aW9uMDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaWRlbnRpZmllciA9IGVuY29kZXIuZW5jb2RlKHNlY3Rpb24uaWRlbnRpZmllciArIFwiXFwwXCIpO1xuICAgICAgbGV0IGRvY3VtZW50c0xlbmd0aCA9IDA7XG4gICAgICBjb25zdCBkb2NzID0gc2VjdGlvbi5kb2N1bWVudHMubWFwKChkb2MpID0+IHtcbiAgICAgICAgY29uc3QgZG9jdW1lbnQgPSBCc29uLnNlcmlhbGl6ZShkb2MpO1xuICAgICAgICBkb2N1bWVudHNMZW5ndGggKz0gZG9jdW1lbnQuYnl0ZUxlbmd0aDtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50O1xuICAgICAgfSk7XG4gICAgICBjb25zdCBzZWN0aW9uMSA9IG5ldyBVaW50OEFycmF5KFxuICAgICAgICAxICsgNCArIGlkZW50aWZpZXIuYnl0ZUxlbmd0aCArIGRvY3VtZW50c0xlbmd0aCxcbiAgICAgICk7XG4gICAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KHNlY3Rpb24xLmJ1ZmZlcik7XG5cbiAgICAgIHZpZXcuc2V0VWludDgoMCwgMSk7XG4gICAgICB2aWV3LnNldFVpbnQzMigxLCBzZWN0aW9uMS5ieXRlTGVuZ3RoIC0gMSwgdHJ1ZSk7XG4gICAgICBsZXQgcG9zID0gNDtcblxuICAgICAgZm9yIChjb25zdCBkb2Mgb2YgZG9jcykge1xuICAgICAgICBzZWN0aW9uMS5zZXQoZG9jLCBwb3MpO1xuICAgICAgICBwb3MgKz0gZG9jLmJ5dGVMZW5ndGg7XG4gICAgICB9XG5cbiAgICAgIHRvdGFsTGVuICs9IHNlY3Rpb24xLmJ5dGVMZW5ndGg7XG4gICAgICByZXR1cm4gc2VjdGlvbjE7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4geyBsZW5ndGg6IHRvdGFsTGVuLCBzZWN0aW9uczogYnVmZmVycyB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplTWVzc2FnZShcbiAgbWVzc2FnZTogTWVzc2FnZSxcbik6IFVpbnQ4QXJyYXkge1xuICBjb25zdCB7IGxlbmd0aDogc2VjdGlvbnNMZW5ndGgsIHNlY3Rpb25zIH0gPSBzZXJpYWxpemVTZWN0aW9ucyhcbiAgICBtZXNzYWdlLnNlY3Rpb25zLFxuICApO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDIwICsgc2VjdGlvbnNMZW5ndGgpOyAvLyAxNiBieXRlcyBoZWFkZXIgKyA0IGJ5dGVzIGZsYWdzICsgc2VjdGlvbnNcbiAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyKTtcblxuICAvLyBzZXQgaGVhZGVyXG4gIHNldEhlYWRlcih2aWV3LCB7XG4gICAgbWVzc2FnZUxlbmd0aDogYnVmZmVyLmJ5dGVMZW5ndGgsXG4gICAgcmVzcG9uc2VUbzogbWVzc2FnZS5yZXNwb25zZVRvLFxuICAgIHJlcXVlc3RJZDogbWVzc2FnZS5yZXF1ZXN0SWQsXG4gICAgb3BDb2RlOiBPcENvZGUuTVNHLFxuICB9KTtcblxuICAvLyBzZXQgZmxhZ3NcbiAgdmlldy5zZXRJbnQzMigxNiwgbWVzc2FnZS5mbGFncyA/PyAwLCB0cnVlKTtcblxuICAvLyBzZXQgc2VjdGlvbnNcbiAgbGV0IHBvcyA9IDIwO1xuICBmb3IgKGNvbnN0IHNlY3Rpb24gb2Ygc2VjdGlvbnMpIHtcbiAgICBidWZmZXIuc2V0KHNlY3Rpb24sIHBvcyk7XG4gICAgcG9zICs9IHNlY3Rpb24uYnl0ZUxlbmd0aDtcbiAgfVxuXG4gIHJldHVybiBidWZmZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXNlcmlhbGl6ZU1lc3NhZ2UoXG4gIGhlYWRlcjogTWVzc2FnZUhlYWRlcixcbiAgYnVmZmVyOiBVaW50OEFycmF5LFxuKTogTWVzc2FnZSB7XG4gIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyLmJ1ZmZlcik7XG5cbiAgY29uc3QgZmxhZ3MgPSB2aWV3LmdldEludDMyKDApO1xuICBjb25zdCBzZWN0aW9uczogU2VjdGlvbltdID0gW107XG5cbiAgbGV0IHBvcyA9IDQ7XG4gIHdoaWxlIChwb3MgPCB2aWV3LmJ5dGVMZW5ndGgpIHtcbiAgICBjb25zdCBraW5kID0gdmlldy5nZXRJbnQ4KHBvcyk7XG4gICAgcG9zKys7XG4gICAgaWYgKGtpbmQgPT09IDApIHtcbiAgICAgIGNvbnN0IGRvY0xlbiA9IHZpZXcuZ2V0SW50MzIocG9zLCB0cnVlKTtcbiAgICAgIGNvbnN0IGRvY3VtZW50ID0gQnNvbi5kZXNlcmlhbGl6ZShcbiAgICAgICAgbmV3IFVpbnQ4QXJyYXkodmlldy5idWZmZXIuc2xpY2UocG9zLCBwb3MgKyBkb2NMZW4pKSxcbiAgICAgICk7XG4gICAgICBwb3MgKz0gZG9jTGVuO1xuICAgICAgc2VjdGlvbnMucHVzaCh7IGRvY3VtZW50IH0pO1xuICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gMSkge1xuICAgICAgY29uc3QgbGVuID0gdmlldy5nZXRJbnQzMihwb3MsIHRydWUpO1xuICAgICAgY29uc3Qgc2VjdGlvbkJvZHkgPSBuZXcgVWludDhBcnJheShcbiAgICAgICAgdmlldy5idWZmZXIuc2xpY2UocG9zICsgNCwgcG9zICsgbGVuIC0gNCksXG4gICAgICApO1xuICAgICAgY29uc3QgaWRlbnRpZmllckVuZFBvcyA9IHNlY3Rpb25Cb2R5LmZpbmRJbmRleCgoYnl0ZSkgPT4gYnl0ZSA9PT0gMCk7XG4gICAgICBjb25zdCBpZGVudGlmaWVyID0gZGVjb2Rlci5kZWNvZGUoYnVmZmVyLnNsaWNlKDAsIGlkZW50aWZpZXJFbmRQb3MpKTtcbiAgICAgIGNvbnN0IGRvY3NCdWZmZXIgPSBzZWN0aW9uQm9keS5zbGljZShpZGVudGlmaWVyRW5kUG9zICsgMSk7XG4gICAgICBjb25zdCBkb2N1bWVudHMgPSBwYXJzZURvY3VtZW50cyhkb2NzQnVmZmVyKTtcbiAgICAgIHBvcyArPSBsZW47XG4gICAgICBzZWN0aW9ucy5wdXNoKHsgaWRlbnRpZmllciwgZG9jdW1lbnRzIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHNlY3Rpb24ga2luZDogXCIgKyBraW5kKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHJlc3BvbnNlVG86IGhlYWRlci5yZXNwb25zZVRvLFxuICAgIHJlcXVlc3RJZDogaGVhZGVyLnJlcXVlc3RJZCxcbiAgICBmbGFncyxcbiAgICBzZWN0aW9ucyxcbiAgfTtcbn1cblxuZnVuY3Rpb24gcGFyc2VEb2N1bWVudHMoYnVmZmVyOiBVaW50OEFycmF5KTogRG9jdW1lbnRbXSB7XG4gIGxldCBwb3MgPSAwO1xuICBjb25zdCBkb2NzID0gW107XG4gIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTtcbiAgd2hpbGUgKHBvcyA8IGJ1ZmZlci5ieXRlTGVuZ3RoKSB7XG4gICAgY29uc3QgZG9jTGVuID0gdmlldy5nZXRJbnQzMihwb3MsIHRydWUpO1xuICAgIGNvbnN0IGRvYyA9IEJzb24uZGVzZXJpYWxpemUoYnVmZmVyLnNsaWNlKHBvcywgcG9zICsgZG9jTGVuKSk7XG4gICAgZG9jcy5wdXNoKGRvYyk7XG4gICAgcG9zICs9IGRvY0xlbjtcbiAgfVxuICByZXR1cm4gZG9jcztcbn1cbiJdfQ==
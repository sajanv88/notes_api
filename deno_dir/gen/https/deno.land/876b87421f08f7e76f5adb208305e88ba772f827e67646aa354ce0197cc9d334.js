function grow(pager, index) {
    while (pager.maxPages < index) {
        const old = pager.pages;
        pager.pages = new Array(32768);
        pager.pages[0] = old;
        pager.level++;
        pager.maxPages *= 32768;
    }
}
function truncate(buf, len) {
    if (buf.length === len) {
        return buf;
    }
    if (buf.length > len) {
        return buf.slice(0, len);
    }
    const cpy = new Uint8Array(len);
    cpy.set(buf, 0);
    return cpy;
}
function concat(bufs) {
    const total = bufs.reduce((acc, cur) => acc + cur.byteLength, 0);
    const buf = new Uint8Array(total);
    let offset = 0;
    for (const b of bufs) {
        buf.set(b, offset);
        offset += b.byteLength;
    }
    return buf;
}
function equal(a, b) {
    if (a.length !== b.length) {
        return false;
    }
    return a.every((x, i) => x === b[i]);
}
function factor(n, out) {
    n = (n - (out[0] = n & 32767)) / 32768;
    n = (n - (out[1] = n & 32767)) / 32768;
    out[3] = ((n - (out[2] = n & 32767)) / 32768) & 32767;
}
function copy(buf) {
    const cpy = new Uint8Array(buf.length);
    cpy.set(buf, 0);
    return cpy;
}
export class Page {
    offset;
    buffer;
    updated;
    deduplicate;
    constructor(i, buf) {
        this.offset = i * buf.length;
        this.buffer = buf;
        this.updated = false;
        this.deduplicate = 0;
    }
}
export class Pager {
    pageSize;
    maxPages = 32768;
    pages = new Array(32768);
    length = 0;
    level = 0;
    updates = [];
    path = new Uint16Array(4);
    deduplicate;
    zeros;
    constructor(pageSize, opts = {}) {
        this.pageSize = pageSize;
        this.deduplicate = opts.deduplicate || null;
        this.zeros = this.deduplicate
            ? new Uint8Array(this.deduplicate.length)
            : null;
    }
    updated(page) {
        while (this.deduplicate &&
            page.buffer[page.deduplicate] === this.deduplicate[page.deduplicate]) {
            if (++page.deduplicate === this.deduplicate.length) {
                page.deduplicate = 0;
                if (equal(page.buffer, this.deduplicate)) {
                    page.buffer = this.deduplicate;
                }
                break;
            }
        }
        if (page.updated || !this.updates) {
            return;
        }
        page.updated = true;
        this.updates.push(page);
    }
    lastUpdate() {
        if (!this.updates || !this.updates.length) {
            return null;
        }
        const page = this.updates.pop();
        page.updated = false;
        return page;
    }
    get(i, noAllocate) {
        const arr = this._array(i, !!noAllocate);
        const first = this.path[0];
        let page = arr && arr[first];
        if (!page && !noAllocate) {
            page = arr[first] = new Page(i, new Uint8Array(this.pageSize));
            if (i >= this.length) {
                this.length = i + 1;
            }
        }
        if (page &&
            page.buffer === this.deduplicate &&
            this.deduplicate &&
            !noAllocate) {
            page.buffer = copy(page.buffer);
            page.deduplicate = 0;
        }
        return page;
    }
    set(i, buf) {
        const arr = this._array(i, false);
        const first = this.path[0];
        if (i >= this.length) {
            this.length = i + 1;
        }
        if (!buf || (this.zeros && equal(buf, this.zeros))) {
            arr[first] = undefined;
            return;
        }
        if (this.deduplicate && equal(buf, this.deduplicate)) {
            buf = this.deduplicate;
        }
        const page = arr[first];
        const b = truncate(buf, this.pageSize);
        if (page) {
            page.buffer = b;
        }
        else {
            arr[first] = new Page(i, b);
        }
    }
    toBuffer() {
        const list = new Array(this.length);
        const empty = new Uint8Array(this.pageSize);
        let ptr = 0;
        while (ptr < list.length) {
            const arr = this._array(ptr, true);
            for (let i = 0; i < 32768 && ptr < list.length; i++) {
                list[ptr++] = arr && arr[i] ? arr[i].buffer : empty;
            }
        }
        return concat(list);
    }
    _array(i, noAllocate) {
        if (i >= this.maxPages) {
            if (noAllocate) {
                return [];
            }
            grow(this, i);
        }
        factor(i, this.path);
        let arr = this.pages;
        for (let j = this.level; j > 0; j--) {
            const p = this.path[j];
            let next = arr[p];
            if (!next) {
                if (noAllocate) {
                    return [];
                }
                next = arr[p] = new Array(32768);
            }
            arr = next;
        }
        return arr;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtb3J5X3BhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWVtb3J5X3BhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLFNBQVMsSUFBSSxDQUFDLEtBQVksRUFBRSxLQUFhO0lBQ3ZDLE9BQU8sS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLEVBQUU7UUFFN0IsTUFBTSxHQUFHLEdBQVEsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUM3QixLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3JCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNkLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDO0tBQ3pCO0FBQ0gsQ0FBQztBQUdELFNBQVMsUUFBUSxDQUFDLEdBQWUsRUFBRSxHQUFXO0lBQzVDLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7UUFDdEIsT0FBTyxHQUFHLENBQUM7S0FDWjtJQUVELElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7UUFDcEIsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztLQUMxQjtJQUVELE1BQU0sR0FBRyxHQUFlLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRWhCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUdELFNBQVMsTUFBTSxDQUFDLElBQWtCO0lBQ2hDLE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxNQUFNLENBQy9CLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBVSxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxVQUFVLEVBQzFDLENBQUMsQ0FDRixDQUFDO0lB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QUMsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7YUFDckQ7U0FDRjtRQUVELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTyxNQUFNLENBQUMsQ0FBUyxFQUFFLFVBQW1CO1FBQzNDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDdEIsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsT0FBTyxFQUFFLENBQUM7YUFDWDtZQUVELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDZjtRQUVELE1BQU0sQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXJCLElBQUksR0FBRyxHQUFVLElBQUksQ0FBQyxLQUFLLENBQUM7UUFFNUIsS0FBSyxJQUFJLENBQUMsR0FBVyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0MsTUFBTSxDQUFDLEdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUUvQixJQUFJLElBQUksR0FBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdkIsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDVCxJQUFJLFVBQVUsRUFBRTtvQkFDZCxPQUFPLEVBQUUsQ0FBQztpQkFDWDtnQkFFRCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2xDO1lBRUQsR0FBRyxHQUFHLElBQUksQ0FBQztTQUNaO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKiogR3Jvd3MgYSBwYWdlci4gKi9cbmZ1bmN0aW9uIGdyb3cocGFnZXI6IFBhZ2VyLCBpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gIHdoaWxlIChwYWdlci5tYXhQYWdlcyA8IGluZGV4KSB7XG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICBjb25zdCBvbGQ6IGFueSA9IHBhZ2VyLnBhZ2VzO1xuICAgIHBhZ2VyLnBhZ2VzID0gbmV3IEFycmF5KDMyNzY4KTtcbiAgICBwYWdlci5wYWdlc1swXSA9IG9sZDtcbiAgICBwYWdlci5sZXZlbCsrO1xuICAgIHBhZ2VyLm1heFBhZ2VzICo9IDMyNzY4O1xuICB9XG59XG5cbi8qKiBUcnVuY2F0ZXMgdGhlIGlucHV0IGJ1ZmZlci4gKi9cbmZ1bmN0aW9uIHRydW5jYXRlKGJ1ZjogVWludDhBcnJheSwgbGVuOiBudW1iZXIpOiBVaW50OEFycmF5IHtcbiAgaWYgKGJ1Zi5sZW5ndGggPT09IGxlbikge1xuICAgIHJldHVybiBidWY7XG4gIH1cblxuICBpZiAoYnVmLmxlbmd0aCA+IGxlbikge1xuICAgIHJldHVybiBidWYuc2xpY2UoMCwgbGVuKTtcbiAgfVxuXG4gIGNvbnN0IGNweTogVWludDhBcnJheSA9IG5ldyBVaW50OEFycmF5KGxlbik7XG4gIGNweS5zZXQoYnVmLCAwKTtcblxuICByZXR1cm4gY3B5O1xufVxuXG4vKiogQ29uY2F0ZW5hdGVzIGdpdmVuIGJ1ZmZlcnMuICovXG5mdW5jdGlvbiBjb25jYXQoYnVmczogVWludDhBcnJheVtdKTogVWludDhBcnJheSB7XG4gIGNvbnN0IHRvdGFsOiBudW1iZXIgPSBidWZzLnJlZHVjZShcbiAgICAoYWNjLCBjdXIpOiBudW1iZXIgPT4gYWNjICsgY3VyLmJ5dGVMZW5ndGgsXG4gICAgMCxcbiAgKTtcblxuICBjb25zdCBidWY6IFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheSh0b3RhbCk7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIGZvciAoY29uc3QgYiBvZiBidWZzKSB7XG4gICAgYnVmLnNldChiLCBvZmZzZXQpO1xuICAgIG9mZnNldCArPSBiLmJ5dGVMZW5ndGg7XG4gIH1cblxuICByZXR1cm4gYnVmO1xufVxuXG4vKiogQ29tcGFyZXMgdHdvIGJ1ZmZlcnMuICovXG5mdW5jdGlvbiBlcXVhbChhOiBVaW50OEFycmF5LCBiOiBVaW50OEFycmF5KTogYm9vbGVhbiB7XG4gIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gYS5ldmVyeSgoeDogbnVtYmVyLCBpOiBudW1iZXIpOiBib29sZWFuID0+IHggPT09IGJbaV0pO1xufVxuXG4vKiogRmFjdG9ycyBzb21ldGhpbmc/ICovXG5mdW5jdGlvbiBmYWN0b3IobjogbnVtYmVyLCBvdXQ6IFVpbnQxNkFycmF5KTogdm9pZCB7XG4gIG4gPSAobiAtIChvdXRbMF0gPSBuICYgMzI3NjcpKSAvIDMyNzY4O1xuICBuID0gKG4gLSAob3V0WzFdID0gbiAmIDMyNzY3KSkgLyAzMjc2ODtcbiAgb3V0WzNdID0gKChuIC0gKG91dFsyXSA9IG4gJiAzMjc2NykpIC8gMzI3NjgpICYgMzI3Njc7XG59XG5cbi8qKiBDb3BpZXMgYSBidWZmZXIuICovXG5mdW5jdGlvbiBjb3B5KGJ1ZjogVWludDhBcnJheSk6IFVpbnQ4QXJyYXkge1xuICBjb25zdCBjcHk6IFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheShidWYubGVuZ3RoKTtcbiAgY3B5LnNldChidWYsIDApO1xuICByZXR1cm4gY3B5O1xufVxuXG4vKiogQSBjbGFzcyByZXByZXNlbnRhdGlvbiBvZiBhIHBhZ2UuICovXG5leHBvcnQgY2xhc3MgUGFnZSB7XG4gIG9mZnNldDogbnVtYmVyO1xuICBidWZmZXI6IFVpbnQ4QXJyYXk7XG4gIHVwZGF0ZWQ6IGJvb2xlYW47XG4gIGRlZHVwbGljYXRlOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoaTogbnVtYmVyLCBidWY6IFVpbnQ4QXJyYXkpIHtcbiAgICB0aGlzLm9mZnNldCA9IGkgKiBidWYubGVuZ3RoO1xuICAgIHRoaXMuYnVmZmVyID0gYnVmO1xuICAgIHRoaXMudXBkYXRlZCA9IGZhbHNlO1xuICAgIHRoaXMuZGVkdXBsaWNhdGUgPSAwO1xuICB9XG59XG5cbi8qKiBQYWdlciBjb25zdHJ1Y3RvciBvcHRpb25zLiAqL1xuZXhwb3J0IGludGVyZmFjZSBQYWdlck9wdGlvbnMge1xuICBkZWR1cGxpY2F0ZT86IFVpbnQ4QXJyYXk7XG59XG5cbi8qKiBBIGNsYXNzIHJlcHJlc2VudGF0aW9uIG9mIGEgcGFnZXIuICovXG5leHBvcnQgY2xhc3MgUGFnZXIge1xuICByZWFkb25seSBwYWdlU2l6ZTogbnVtYmVyO1xuXG4gIG1heFBhZ2VzID0gMzI3Njg7XG4gIHBhZ2VzID0gbmV3IEFycmF5KDMyNzY4KTtcbiAgbGVuZ3RoID0gMDtcbiAgbGV2ZWwgPSAwO1xuXG4gIHByaXZhdGUgdXBkYXRlczogUGFnZVtdID0gW107XG4gIHByaXZhdGUgcGF0aDogVWludDE2QXJyYXkgPSBuZXcgVWludDE2QXJyYXkoNCk7XG4gIHByaXZhdGUgZGVkdXBsaWNhdGU6IG51bGwgfCBVaW50OEFycmF5O1xuICBwcml2YXRlIHplcm9zOiBudWxsIHwgVWludDhBcnJheTtcblxuICBjb25zdHJ1Y3RvcihwYWdlU2l6ZTogbnVtYmVyLCBvcHRzOiBQYWdlck9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMucGFnZVNpemUgPSBwYWdlU2l6ZTtcbiAgICB0aGlzLmRlZHVwbGljYXRlID0gb3B0cy5kZWR1cGxpY2F0ZSB8fCBudWxsO1xuICAgIHRoaXMuemVyb3MgPSB0aGlzLmRlZHVwbGljYXRlXG4gICAgICA/IG5ldyBVaW50OEFycmF5KHRoaXMuZGVkdXBsaWNhdGUubGVuZ3RoKVxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgdXBkYXRlZChwYWdlOiBQYWdlKTogdm9pZCB7XG4gICAgd2hpbGUgKFxuICAgICAgdGhpcy5kZWR1cGxpY2F0ZSAmJlxuICAgICAgcGFnZS5idWZmZXJbcGFnZS5kZWR1cGxpY2F0ZV0gPT09IHRoaXMuZGVkdXBsaWNhdGVbcGFnZS5kZWR1cGxpY2F0ZV1cbiAgICApIHtcbiAgICAgIGlmICgrK3BhZ2UuZGVkdXBsaWNhdGUgPT09IHRoaXMuZGVkdXBsaWNhdGUubGVuZ3RoKSB7XG4gICAgICAgIHBhZ2UuZGVkdXBsaWNhdGUgPSAwO1xuXG4gICAgICAgIGlmIChlcXVhbChwYWdlLmJ1ZmZlciwgdGhpcy5kZWR1cGxpY2F0ZSkpIHtcbiAgICAgICAgICBwYWdlLmJ1ZmZlciA9IHRoaXMuZGVkdXBsaWNhdGU7XG4gICAgICAgIH1cblxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocGFnZS51cGRhdGVkIHx8ICF0aGlzLnVwZGF0ZXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwYWdlLnVwZGF0ZWQgPSB0cnVlO1xuICAgIHRoaXMudXBkYXRlcy5wdXNoKHBhZ2UpO1xuICB9XG5cbiAgbGFzdFVwZGF0ZSgpOiBudWxsIHwgUGFnZSB7XG4gICAgaWYgKCF0aGlzLnVwZGF0ZXMgfHwgIXRoaXMudXBkYXRlcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHBhZ2U6IFBhZ2UgPSB0aGlzLnVwZGF0ZXMucG9wKCkhO1xuICAgIHBhZ2UudXBkYXRlZCA9IGZhbHNlO1xuICAgIHJldHVybiBwYWdlO1xuICB9XG5cbiAgZ2V0KGk6IG51bWJlciwgbm9BbGxvY2F0ZT86IGJvb2xlYW4pOiBQYWdlIHtcbiAgICBjb25zdCBhcnI6IFBhZ2VbXSA9IHRoaXMuX2FycmF5KGksICEhbm9BbGxvY2F0ZSk7XG4gICAgY29uc3QgZmlyc3Q6IG51bWJlciA9IHRoaXMucGF0aFswXTtcbiAgICBsZXQgcGFnZTogdW5kZWZpbmVkIHwgUGFnZSA9IGFyciAmJiBhcnJbZmlyc3RdO1xuICAgIGlmICghcGFnZSAmJiAhbm9BbGxvY2F0ZSkge1xuICAgICAgcGFnZSA9IGFycltmaXJzdF0gPSBuZXcgUGFnZShpLCBuZXcgVWludDhBcnJheSh0aGlzLnBhZ2VTaXplKSk7XG4gICAgICBpZiAoaSA+PSB0aGlzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmxlbmd0aCA9IGkgKyAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHBhZ2UgJiZcbiAgICAgIHBhZ2UuYnVmZmVyID09PSB0aGlzLmRlZHVwbGljYXRlICYmXG4gICAgICB0aGlzLmRlZHVwbGljYXRlICYmXG4gICAgICAhbm9BbGxvY2F0ZVxuICAgICkge1xuICAgICAgcGFnZS5idWZmZXIgPSBjb3B5KHBhZ2UuYnVmZmVyKTtcbiAgICAgIHBhZ2UuZGVkdXBsaWNhdGUgPSAwO1xuICAgIH1cblxuICAgIHJldHVybiBwYWdlO1xuICB9XG5cbiAgc2V0KGk6IG51bWJlciwgYnVmOiBVaW50OEFycmF5KTogdm9pZCB7XG4gICAgY29uc3QgYXJyOiAodW5kZWZpbmVkIHwgUGFnZSlbXSA9IHRoaXMuX2FycmF5KGksIGZhbHNlKTtcbiAgICBjb25zdCBmaXJzdDogbnVtYmVyID0gdGhpcy5wYXRoWzBdO1xuXG4gICAgaWYgKGkgPj0gdGhpcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMubGVuZ3RoID0gaSArIDE7XG4gICAgfVxuXG4gICAgaWYgKCFidWYgfHwgKHRoaXMuemVyb3MgJiYgZXF1YWwoYnVmLCB0aGlzLnplcm9zKSkpIHtcbiAgICAgIGFycltmaXJzdF0gPSB1bmRlZmluZWQ7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZGVkdXBsaWNhdGUgJiYgZXF1YWwoYnVmLCB0aGlzLmRlZHVwbGljYXRlKSkge1xuICAgICAgYnVmID0gdGhpcy5kZWR1cGxpY2F0ZTtcbiAgICB9XG5cbiAgICBjb25zdCBwYWdlOiB1bmRlZmluZWQgfCBQYWdlID0gYXJyW2ZpcnN0XTtcbiAgICBjb25zdCBiOiBVaW50OEFycmF5ID0gdHJ1bmNhdGUoYnVmLCB0aGlzLnBhZ2VTaXplKTtcblxuICAgIGlmIChwYWdlKSB7XG4gICAgICBwYWdlLmJ1ZmZlciA9IGI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFycltmaXJzdF0gPSBuZXcgUGFnZShpLCBiKTtcbiAgICB9XG4gIH1cblxuICAvKiogQ29uY2F0IGFsbCBhbGxvY2F0ZWQgcGFnZXMgaW50byBhIHNpbmdsZSBidWZmZXIuICovXG4gIHRvQnVmZmVyKCk6IFVpbnQ4QXJyYXkge1xuICAgIGNvbnN0IGxpc3Q6IFVpbnQ4QXJyYXlbXSA9IG5ldyBBcnJheSh0aGlzLmxlbmd0aCk7XG4gICAgY29uc3QgZW1wdHk6IFVpbnQ4QXJyYXkgPSBuZXcgVWludDhBcnJheSh0aGlzLnBhZ2VTaXplKTtcbiAgICBsZXQgcHRyID0gMDtcblxuICAgIHdoaWxlIChwdHIgPCBsaXN0Lmxlbmd0aCkge1xuICAgICAgY29uc3QgYXJyOiBQYWdlW10gPSB0aGlzLl9hcnJheShwdHIsIHRydWUpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDMyNzY4ICYmIHB0ciA8IGxpc3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbGlzdFtwdHIrK10gPSBhcnIgJiYgYXJyW2ldID8gYXJyW2ldLmJ1ZmZlciA6IGVtcHR5O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb25jYXQobGlzdCk7XG4gIH1cblxuICBwcml2YXRlIF9hcnJheShpOiBudW1iZXIsIG5vQWxsb2NhdGU6IGJvb2xlYW4pOiBQYWdlW10ge1xuICAgIGlmIChpID49IHRoaXMubWF4UGFnZXMpIHtcbiAgICAgIGlmIChub0FsbG9jYXRlKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cblxuICAgICAgZ3Jvdyh0aGlzLCBpKTtcbiAgICB9XG5cbiAgICBmYWN0b3IoaSwgdGhpcy5wYXRoKTtcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIGxldCBhcnI6IGFueVtdID0gdGhpcy5wYWdlcztcblxuICAgIGZvciAobGV0IGo6IG51bWJlciA9IHRoaXMubGV2ZWw7IGogPiAwOyBqLS0pIHtcbiAgICAgIGNvbnN0IHA6IG51bWJlciA9IHRoaXMucGF0aFtqXTtcbiAgICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgICBsZXQgbmV4dDogYW55ID0gYXJyW3BdO1xuXG4gICAgICBpZiAoIW5leHQpIHtcbiAgICAgICAgaWYgKG5vQWxsb2NhdGUpIHtcbiAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cblxuICAgICAgICBuZXh0ID0gYXJyW3BdID0gbmV3IEFycmF5KDMyNzY4KTtcbiAgICAgIH1cblxuICAgICAgYXJyID0gbmV4dDtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJyO1xuICB9XG59XG4iXX0=
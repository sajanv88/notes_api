import { Bson } from "../../deps.ts";
import { checkIndexes } from "./indexes.ts";
import { createUploadStream } from "./upload.ts";
import { MongoRuntimeError } from "../error.ts";
export class GridFSBucket {
    #chunksCollection;
    #filesCollection;
    #chunkSizeBytes;
    #checkedIndexes = false;
    getBucketData = () => ({
        filesCollection: this.#filesCollection,
        chunksCollection: this.#chunksCollection,
        chunkSizeBytes: this.#chunkSizeBytes,
    });
    constructor(db, options = {}) {
        const newLocal = options.bucketName ?? "fs";
        this.#chunksCollection = db.collection(`${newLocal}.chunks`);
        this.#filesCollection = db.collection(`${newLocal}.files`);
        this.#chunkSizeBytes = options.chunkSizeBytes ?? 255 * 1024;
    }
    openUploadStream(filename, options) {
        return this.openUploadStreamWithId(new Bson.ObjectId(), filename, options);
    }
    async openUploadStreamWithId(id, filename, options) {
        if (!this.#checkedIndexes)
            await this.#checkIndexes();
        return createUploadStream(this.getBucketData(), filename, id, options);
    }
    async uploadFromStream(filename, source, options) {
        const objectid = new Bson.ObjectId();
        await source.pipeTo(await this.openUploadStreamWithId(objectid, filename, options));
        return objectid;
    }
    async uploadFromStreamWithId(id, filename, source, options) {
        await source.pipeTo(await this.openUploadStreamWithId(id, filename, options));
    }
    async openDownloadStream(id) {
        if (!this.#checkedIndexes)
            await this.#checkIndexes();
        return new ReadableStream({
            start: async (controller) => {
                const collection = this.#chunksCollection.find({ files_id: id });
                await collection.forEach((value) => controller.enqueue(value?.data.buffer));
                controller.close();
            },
        });
    }
    async downloadToStream(id, destination) {
        await (await this.openDownloadStream(id)).pipeTo(destination);
    }
    async delete(id) {
        await this.#filesCollection.deleteOne({ _id: id });
        const response = await this.#chunksCollection.deleteMany({ files_id: id });
        if (!response) {
            throw new MongoRuntimeError(`File not found for id ${id}`);
        }
    }
    find(filter, options = {}) {
        return this.#filesCollection.find(filter ?? {}, options);
    }
    async drop() {
        await this.#filesCollection.drop();
        await this.#chunksCollection.drop();
    }
    #checkIndexes = () => checkIndexes(this.#filesCollection, this.#chunksCollection, (value) => (this.#checkedIndexes = value));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFhckMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUM1QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRWhELE1BQU0sT0FBTyxZQUFZO0lBQ3ZCLGlCQUFpQixDQUFvQjtJQUNyQyxnQkFBZ0IsQ0FBbUI7SUFDbkMsZUFBZSxDQUFTO0lBQ3hCLGVBQWUsR0FBRyxLQUFLLENBQUM7SUFFUCxhQUFhLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN0QyxlQUFlLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtRQUN0QyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsaUJBQWlCO1FBQ3hDLGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZTtLQUNyQyxDQUFDLENBQUM7SUFLSCxZQUFZLEVBQVksRUFBRSxVQUErQixFQUFFO1FBQ3pELE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsUUFBUSxTQUFTLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLFFBQVEsUUFBUSxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxPQUFPLENBQUMsY0FBYyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7SUFDOUQsQ0FBQztJQVlELGdCQUFnQixDQUFDLFFBQWdCLEVBQUUsT0FBNkI7UUFDOUQsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQ2hDLElBQUksSUFBSSxDQUFD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RSxDQUFDO0lBQ3RDLENBQUM7SUFFRCxhQUFhLEdBQUcsR0FBRyxFQUFFLENBQ25CLFlBQVksQ0FDVixJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLElBQUksQ0FBQyxpQkFBaUIsRUFDdEIsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUMsQ0FDMUMsQ0FBQztDQUNMIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnNvbiB9IGZyb20gXCIuLi8uLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uIH0gZnJvbSBcIi4uL2NvbGxlY3Rpb24vY29sbGVjdGlvbi50c1wiO1xuaW1wb3J0IHsgRmluZEN1cnNvciB9IGZyb20gXCIuLi9jb2xsZWN0aW9uL2NvbW1hbmRzL2ZpbmQudHNcIjtcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSBcIi4uL2RhdGFiYXNlLnRzXCI7XG5pbXBvcnQgeyBGaWx0ZXIgfSBmcm9tIFwiLi4vdHlwZXMudHNcIjtcbmltcG9ydCB7XG4gIENodW5rLFxuICBGaWxlLFxuICBGaWxlSWQsXG4gIEdyaWRGU0J1Y2tldE9wdGlvbnMsXG4gIEdyaWRGU0ZpbmRPcHRpb25zLFxuICBHcmlkRlNVcGxvYWRPcHRpb25zLFxufSBmcm9tIFwiLi4vdHlwZXMvZ3JpZGZzLnRzXCI7XG5pbXBvcnQgeyBjaGVja0luZGV4ZXMgfSBmcm9tIFwiLi9pbmRleGVzLnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVVcGxvYWRTdHJlYW0gfSBmcm9tIFwiLi91cGxvYWQudHNcIjtcbmltcG9ydCB7IE1vbmdvUnVudGltZUVycm9yIH0gZnJvbSBcIi4uL2Vycm9yLnRzXCI7XG5cbmV4cG9ydCBjbGFzcyBHcmlkRlNCdWNrZXQge1xuICAjY2h1bmtzQ29sbGVjdGlvbjogQ29sbGVjdGlvbjxDaHVuaz47XG4gICNmaWxlc0NvbGxlY3Rpb246IENvbGxlY3Rpb248RmlsZT47XG4gICNjaHVua1NpemVCeXRlczogbnVtYmVyO1xuICAjY2hlY2tlZEluZGV4ZXMgPSBmYWxzZTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdldEJ1Y2tldERhdGEgPSAoKSA9PiAoe1xuICAgIGZpbGVzQ29sbGVjdGlvbjogdGhpcy4jZmlsZXNDb2xsZWN0aW9uLFxuICAgIGNodW5rc0NvbGxlY3Rpb246IHRoaXMuI2NodW5rc0NvbGxlY3Rpb24sXG4gICAgY2h1bmtTaXplQnl0ZXM6IHRoaXMuI2NodW5rU2l6ZUJ5dGVzLFxuICB9KTtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEdyaWRGU0J1Y2tldCBvYmplY3Qgb24gQGRiIHdpdGggdGhlIGdpdmVuIEBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoZGI6IERhdGFiYXNlLCBvcHRpb25zOiBHcmlkRlNCdWNrZXRPcHRpb25zID0ge30pIHtcbiAgICBjb25zdCBuZXdMb2NhbCA9IG9wdGlvbnMuYnVja2V0TmFtZSA/PyBcImZzXCI7XG4gICAgdGhpcy4jY2h1bmtzQ29sbGVjdGlvbiA9IGRiLmNvbGxlY3Rpb24oYCR7bmV3TG9jYWx9LmNodW5rc2ApO1xuICAgIHRoaXMuI2ZpbGVzQ29sbGVjdGlvbiA9IGRiLmNvbGxlY3Rpb24oYCR7bmV3TG9jYWx9LmZpbGVzYCk7XG4gICAgdGhpcy4jY2h1bmtTaXplQnl0ZXMgPSBvcHRpb25zLmNodW5rU2l6ZUJ5dGVzID8/IDI1NSAqIDEwMjQ7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgYSBTdHJlYW0gdGhhdCB0aGUgYXBwbGljYXRpb24gY2FuIHdyaXRlIHRoZSBjb250ZW50cyBvZiB0aGUgZmlsZSB0by5cbiAgICogVGhlIGRyaXZlciBnZW5lcmF0ZXMgdGhlIGZpbGUgaWQuXG4gICAqXG4gICAqIFJldHVybnMgYSBTdHJlYW0gdG8gd2hpY2ggdGhlIGFwcGxpY2F0aW9uIHdpbGwgd3JpdGUgdGhlIGNvbnRlbnRzLlxuICAgKlxuICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyBwcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gSW4gbGFuZ3VhZ2VzXG4gICAqIHRoYXQgdXNlIGdlbmVyaWMgdHlwZSBwYXJhbWV0ZXJzLCB0aGlzIG1ldGhvZCBtYXkgYmUgb21pdHRlZCBzaW5jZVxuICAgKiB0aGUgVEZpbGVJZCB0eXBlIG1pZ2h0IG5vdCBiZSBhbiBPYmplY3RJZC5cbiAgICovXG4gIG9wZW5VcGxvYWRTdHJlYW0oZmlsZW5hbWU6IHN0cmluZywgb3B0aW9ucz86IEdyaWRGU1VwbG9hZE9wdGlvbnMpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVuVXBsb2FkU3RyZWFtV2l0aElkKFxuICAgICAgbmV3IEJzb24uT2JqZWN0SWQoKSxcbiAgICAgIGZpbGVuYW1lLFxuICAgICAgb3B0aW9ucyxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIE9wZW5zIGEgU3RyZWFtIHRoYXQgdGhlIGFwcGxpY2F0aW9uIGNhbiB3cml0ZSB0aGUgY29udGVudHMgb2YgdGhlIGZpbGUgdG8uXG4gICAqIFRoZSBhcHBsaWNhdGlvbiBwcm92aWRlcyBhIGN1c3RvbSBmaWxlIGlkLlxuICAgKlxuICAgKiBSZXR1cm5zIGEgU3RyZWFtIHRvIHdoaWNoIHRoZSBhcHBsaWNhdGlvbiB3aWxsIHdyaXRlIHRoZSBjb250ZW50cy5cbiAgICovXG4gIGFzeW5jIG9wZW5VcGxvYWRTdHJlYW1XaXRoSWQoXG4gICAgaWQ6IEZpbGVJZCxcbiAgICBmaWxlbmFtZTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBHcmlkRlNVcGxvYWRPcHRpb25zLFxuICApIHtcbiAgICBpZiAoIXRoaXMuI2NoZWNrZWRJbmRleGVzKSBhd2FpdCB0aGlzLiNjaGVja0luZGV4ZXMoKTtcbiAgICByZXR1cm4gY3JlYXRlVXBsb2FkU3RyZWFtKHRoaXMuZ2V0QnVja2V0RGF0YSgpLCBmaWxlbmFtZSwgaWQsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwbG9hZHMgYSB1c2VyIGZpbGUgdG8gYSBHcmlkRlMgYnVja2V0LiBUaGUgZHJpdmVyIGdlbmVyYXRlcyB0aGUgZmlsZSBpZC5cbiAgICpcbiAgICogUmVhZHMgdGhlIGNvbnRlbnRzIG9mIHRoZSB1c2VyIGZpbGUgZnJvbSB0aGUgQHNvdXJjZSBTdHJlYW0gYW5kIHVwbG9hZHMgaXRcbiAgICogYXMgY2h1bmtzIGluIHRoZSBjaHVua3MgY29sbGVjdGlvbi4gQWZ0ZXIgYWxsIHRoZSBjaHVua3MgaGF2ZSBiZWVuIHVwbG9hZGVkLFxuICAgKiBpdCBjcmVhdGVzIGEgZmlsZXMgY29sbGVjdGlvbiBkb2N1bWVudCBmb3IgQGZpbGVuYW1lIGluIHRoZSBmaWxlcyBjb2xsZWN0aW9uLlxuICAgKlxuICAgKiBSZXR1cm5zIHRoZSBpZCBvZiB0aGUgdXBsb2FkZWQgZmlsZS5cbiAgICpcbiAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgcHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuIEluIGxhbmd1YWdlc1xuICAgKiB0aGF0IHVzZSBnZW5lcmljIHR5cGUgcGFyYW1ldGVycywgdGhpcyBtZXRob2QgbWF5IGJlIG9taXR0ZWQgc2luY2VcbiAgICogdGhlIFRGaWxlSWQgdHlwZSBtaWdodCBub3QgYmUgYW4gT2JqZWN0SWQuXG4gICAqL1xuICBhc3luYyB1cGxvYWRGcm9tU3RyZWFtKFxuICAgIGZpbGVuYW1lOiBzdHJpbmcsXG4gICAgc291cmNlOiBSZWFkYWJsZVN0cmVhbSxcbiAgICBvcHRpb25zPzogR3JpZEZTVXBsb2FkT3B0aW9ucyxcbiAgKTogUHJvbWlzZTxCc29uLk9iamVjdElkPiB7XG4gICAgY29uc3Qgb2JqZWN0aWQgPSBuZXcgQnNvbi5PYmplY3RJZCgpO1xuICAgIGF3YWl0IHNvdXJjZS5waXBlVG8oXG4gICAgICBhd2FpdCB0aGlzLm9wZW5VcGxvYWRTdHJlYW1XaXRoSWQob2JqZWN0aWQsIGZpbGVuYW1lLCBvcHRpb25zKSxcbiAgICApO1xuICAgIHJldHVybiBvYmplY3RpZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGxvYWRzIGEgdXNlciBmaWxlIHRvIGEgR3JpZEZTIGJ1Y2tldC4gVGhlIGFwcGxpY2F0aW9uIHN1cHBsaWVzIGEgY3VzdG9tIGZpbGUgaWQuXG4gICAqXG4gICAqIFJlYWRzIHRoZSBjb250ZW50cyBvZiB0aGUgdXNlciBmaWxlIGZyb20gdGhlIEBzb3VyY2UgU3RyZWFtIGFuZCB1cGxvYWRzIGl0XG4gICAqIGFzIGNodW5rcyBpbiB0aGUgY2h1bmtzIGNvbGxlY3Rpb24uIEFmdGVyIGFsbCB0aGUgY2h1bmtzIGhhdmUgYmVlbiB1cGxvYWRlZCxcbiAgICogaXQgY3JlYXRlcyBhIGZpbGVzIGNvbGxlY3Rpb24gZG9jdW1lbnQgZm9yIEBmaWxlbmFtZSBpbiB0aGUgZmlsZXMgY29sbGVjdGlvbi5cbiAgICpcbiAgICogTm90ZTogdGhlcmUgaXMgbm8gbmVlZCB0byByZXR1cm4gdGhlIGlkIG9mIHRoZSB1cGxvYWRlZCBmaWxlIGJlY2F1c2UgdGhlIGFwcGxpY2F0aW9uXG4gICAqIGFscmVhZHkgc3VwcGxpZWQgaXQgYXMgYSBwYXJhbWV0ZXIuXG4gICAqL1xuICBhc3luYyB1cGxvYWRGcm9tU3RyZWFtV2l0aElkKFxuICAgIGlkOiBGaWxlSWQsXG4gICAgZmlsZW5hbWU6IHN0cmluZyxcbiAgICBzb3VyY2U6IFJlYWRhYmxlU3RyZWFtLFxuICAgIG9wdGlvbnM6IEdyaWRGU1VwbG9hZE9wdGlvbnMsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHNvdXJjZS5waXBlVG8oXG4gICAgICBhd2FpdCB0aGlzLm9wZW5VcGxvYWRTdHJlYW1XaXRoSWQoaWQsIGZpbGVuYW1lLCBvcHRpb25zKSxcbiAgICApO1xuICB9XG5cbiAgLyoqIE9wZW5zIGEgU3RyZWFtIGZyb20gd2hpY2ggdGhlIGFwcGxpY2F0aW9uIGNhbiByZWFkIHRoZSBjb250ZW50cyBvZiB0aGUgc3RvcmVkIGZpbGVcbiAgICogc3BlY2lmaWVkIGJ5IEBpZC5cbiAgICpcbiAgICogUmV0dXJucyBhIFN0cmVhbS5cbiAgICovXG4gIGFzeW5jIG9wZW5Eb3dubG9hZFN0cmVhbShpZDogRmlsZUlkKSB7XG4gICAgaWYgKCF0aGlzLiNjaGVja2VkSW5kZXhlcykgYXdhaXQgdGhpcy4jY2hlY2tJbmRleGVzKCk7XG5cbiAgICByZXR1cm4gbmV3IFJlYWRhYmxlU3RyZWFtPFVpbnQ4QXJyYXk+KHtcbiAgICAgIHN0YXJ0OiBhc3luYyAoY29udHJvbGxlcikgPT4ge1xuICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gdGhpcy4jY2h1bmtzQ29sbGVjdGlvbi5maW5kKHsgZmlsZXNfaWQ6IGlkIH0pO1xuICAgICAgICBhd2FpdCBjb2xsZWN0aW9uLmZvckVhY2goKHZhbHVlKSA9PlxuICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZSh2YWx1ZT8uZGF0YS5idWZmZXIpXG4gICAgICAgICk7XG4gICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRG93bmxvYWRzIHRoZSBjb250ZW50cyBvZiB0aGUgc3RvcmVkIGZpbGUgc3BlY2lmaWVkIGJ5IEBpZCBhbmQgd3JpdGVzXG4gICAqIHRoZSBjb250ZW50cyB0byB0aGUgQGRlc3RpbmF0aW9uIFN0cmVhbS5cbiAgICovXG4gIGFzeW5jIGRvd25sb2FkVG9TdHJlYW0oaWQ6IEZpbGVJZCwgZGVzdGluYXRpb246IFdyaXRhYmxlU3RyZWFtPFVpbnQ4QXJyYXk+KSB7XG4gICAgYXdhaXQgKGF3YWl0IHRoaXMub3BlbkRvd25sb2FkU3RyZWFtKGlkKSkucGlwZVRvKGRlc3RpbmF0aW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlbiBhIEBpZCwgZGVsZXRlIHRoaXMgc3RvcmVkIGZpbGXigJlzIGZpbGVzIGNvbGxlY3Rpb24gZG9jdW1lbnQgYW5kXG4gICAqIGFzc29jaWF0ZWQgY2h1bmtzIGZyb20gYSBHcmlkRlMgYnVja2V0LlxuICAgKi9cbiAgYXN5bmMgZGVsZXRlKGlkOiBGaWxlSWQpIHtcbiAgICBhd2FpdCB0aGlzLiNmaWxlc0NvbGxlY3Rpb24uZGVsZXRlT25lKHsgX2lkOiBpZCB9KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuI2NodW5rc0NvbGxlY3Rpb24uZGVsZXRlTWFueSh7IGZpbGVzX2lkOiBpZCB9KTtcbiAgICBpZiAoIXJlc3BvbnNlKSB7XG4gICAgICB0aHJvdyBuZXcgTW9uZ29SdW50aW1lRXJyb3IoYEZpbGUgbm90IGZvdW5kIGZvciBpZCAke2lkfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGaW5kIGFuZCByZXR1cm4gdGhlIGZpbGVzIGNvbGxlY3Rpb24gZG9jdW1lbnRzIHRoYXQgbWF0Y2ggQGZpbHRlci5cbiAgICovXG4gIGZpbmQoXG4gICAgZmlsdGVyOiBGaWx0ZXI8RmlsZT4sXG4gICAgb3B0aW9uczogR3JpZEZTRmluZE9wdGlvbnMgPSB7fSxcbiAgKTogRmluZEN1cnNvcjxGaWxlPiB7XG4gICAgcmV0dXJuIHRoaXMuI2ZpbGVzQ29sbGVjdGlvbi5maW5kKGZpbHRlciA/PyB7fSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogRHJvcHMgdGhlIGZpbGVzIGFuZCBjaHVua3MgY29sbGVjdGlvbnMgYXNzb2NpYXRlZCB3aXRoXG4gICAqIHRoaXMgYnVja2V0LlxuICAgKi9cbiAgYXN5bmMgZHJvcCgpIHtcbiAgICBhd2FpdCB0aGlzLiNmaWxlc0NvbGxlY3Rpb24uZHJvcCgpO1xuICAgIGF3YWl0IHRoaXMuI2NodW5rc0NvbGxlY3Rpb24uZHJvcCgpO1xuICB9XG5cbiAgI2NoZWNrSW5kZXhlcyA9ICgpID0+XG4gICAgY2hlY2tJbmRleGVzKFxuICAgICAgdGhpcy4jZmlsZXNDb2xsZWN0aW9uLFxuICAgICAgdGhpcy4jY2h1bmtzQ29sbGVjdGlvbixcbiAgICAgICh2YWx1ZSkgPT4gKHRoaXMuI2NoZWNrZWRJbmRleGVzID0gdmFsdWUpLFxuICAgICk7XG59XG4iXX0=
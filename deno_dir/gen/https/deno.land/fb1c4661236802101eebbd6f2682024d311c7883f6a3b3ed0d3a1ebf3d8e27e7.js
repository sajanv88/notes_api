import { Binary, BinarySizes } from "./binary.ts";
import { Code } from "./code.ts";
import { DBRef } from "./db_ref.ts";
import { Decimal128 } from "./decimal128.ts";
import { Double } from "./double.ts";
import { Int32 } from "./int_32.ts";
import { Long } from "./long.ts";
import { MaxKey, MinKey } from "./key.ts";
import { ObjectId } from "./objectid.ts";
import { calculateObjectSize as internalCalculateObjectSize } from "./parser/calculate_size.ts";
import { deserialize as internalDeserialize, } from "./parser/deserializer.ts";
import { serializeInto as internalSerialize, } from "./parser/serializer.ts";
import { BSONRegExp } from "./regexp.ts";
import { BSONSymbol } from "./symbol.ts";
import { Timestamp } from "./timestamp.ts";
import { UUID } from "./uuid.ts";
import { bytesCopy } from "./parser/utils.ts";
export * from "./constants.ts";
export { LongWithoutOverridesClass } from "./timestamp.ts";
export { Binary, BinarySizes, BSONRegExp, BSONSymbol, Code, DBRef, Decimal128, Double, Int32, Long, MaxKey, MinKey, ObjectId, Timestamp, UUID, };
export * from "./error.ts";
const MAXSIZE = 1024 * 1024 * 17;
let buffer = new Uint8Array(MAXSIZE);
export function setInternalBufferSize(size) {
    if (buffer.length < size) {
        buffer = new Uint8Array(size);
    }
}
export function serialize(object, options = {}) {
    const checkKeys = typeof options.checkKeys === "boolean"
        ? options.checkKeys
        : false;
    const serializeFunctions = typeof options.serializeFunctions === "boolean"
        ? options.serializeFunctions
        : false;
    const ignoreUndefined = typeof options.ignoreUndefined === "boolean"
        ? options.ignoreUndefined
        : true;
    const serializationIndex = internalSerialize(buffer, object, checkKeys, 0, 0, serializeFunctions, ignoreUndefined, []);
    const finishedBuffer = new Uint8Array(serializationIndex);
    bytesCopy(finishedBuffer, 0, buffer, 0, finishedBuffer.length);
    return finishedBuffer;
}
export function serializeWithBufferAndIndex(object, finalBuffer, options = {}) {
    const checkKeys = typeof options.checkKeys === "boolean"
        ? options.checkKeys
        : false;
    const serializeFunctions = typeof options.serializeFunctions === "boolean"
        ? options.serializeFunctions
        : false;
    const ignoreUndefined = typeof options.ignoreUndefined === "boolean"
        ? options.ignoreUndefined
        : true;
    const startIndex = typeof options.index === "number" ? options.index : 0;
    const serializationIndex = internalSerialize(buffer, object, checkKeys, 0, 0, serializeFunctions, ignoreUndefined);
    bytesCopy(finalBuffer, startIndex, buffer, 0, serializationIndex);
    return startIndex + serializationIndex - 1;
}
export function deserialize(buffer, options = {}) {
    return internalDeserialize(buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer), options);
}
export function calculateObjectSize(object, options = {}) {
    options = options || {};
    const serializeFunctions = typeof options.serializeFunctions === "boolean"
        ? options.serializeFunctions
        : false;
    const ignoreUndefined = typeof options.ignoreUndefined === "boolean"
        ? options.ignoreUndefined
        : true;
    return internalCalculateObjectSize(object, serializeFunctions, ignoreUndefined);
}
export function deserializeStream(data, startIndex, numberOfDocuments, documents, docStartIndex, options) {
    const internalOptions = Object.assign({ allowObjectSmallerThanBufferSize: true, index: 0 }, options);
    const bufferData = data instanceof Uint8Array
        ? data
        : data instanceof ArrayBuffer
            ? new Uint8Array(data)
            : new Uint8Array(data.buffer, data.byteOffset, data.byteLength);
    let index = startIndex;
    for (let i = 0; i < numberOfDocuments; i++) {
        const size = bufferData[index] |
            (bufferData[index + 1] << 8) |
            (bufferData[index + 2] << 16) |
            (bufferData[index + 3] << 24);
        internalOptions.index = index;
        documents[docStartIndex + i] = internalDeserialize(bufferData, internalOptions);
        index += size;
    }
    return index;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnNvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDbEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxtQkFBbUIsSUFBSSwyQkFBMkIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRWhHLE9BQU8sRUFDTCxXQUFXLElBQUksbUJBQW1CLEdBRW5DLE1BQU0sMEJBQTBCLENBQUM7QUFDbEMsT0FBTyxFQUNMLGFBQWEsSUFBSSxpQkFBaUIsR0FFbkMsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLGNBQWMsZ0JBQWdCLENBQUM7QUFFL0IsT0FBTyxFQUFFLHlC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QVksV0FBVztZQUM3QixDQUFDLENBQUMsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRWxFLElBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQztJQUV2QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFFMUMsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztZQUM1QixDQUFDLFVBQVUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVCLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDN0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRWhDLGVBQWUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRTlCLFNBQVMsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLEdBQUcsbUJBQW1CLENBQ2hELFVBQVUsRUFDVixlQUFlLENBQ2hCLENBQUM7UUFFRixLQUFLLElBQUksSUFBSSxDQUFDO0tBQ2Y7SUFHRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBkZW5vLWxpbnQtaWdub3JlLWZpbGUgbm8tZXhwbGljaXQtYW55XG5pbXBvcnQgeyBCaW5hcnksIEJpbmFyeVNpemVzIH0gZnJvbSBcIi4vYmluYXJ5LnRzXCI7XG5pbXBvcnQgeyBDb2RlIH0gZnJvbSBcIi4vY29kZS50c1wiO1xuaW1wb3J0IHsgREJSZWYgfSBmcm9tIFwiLi9kYl9yZWYudHNcIjtcbmltcG9ydCB7IERlY2ltYWwxMjggfSBmcm9tIFwiLi9kZWNpbWFsMTI4LnRzXCI7XG5pbXBvcnQgeyBEb3VibGUgfSBmcm9tIFwiLi9kb3VibGUudHNcIjtcbmltcG9ydCB7IEludDMyIH0gZnJvbSBcIi4vaW50XzMyLnRzXCI7XG5pbXBvcnQgeyBMb25nIH0gZnJvbSBcIi4vbG9uZy50c1wiO1xuaW1wb3J0IHsgTWF4S2V5LCBNaW5LZXkgfSBmcm9tIFwiLi9rZXkudHNcIjtcbmltcG9ydCB7IE9iamVjdElkIH0gZnJvbSBcIi4vb2JqZWN0aWQudHNcIjtcbmltcG9ydCB7IGNhbGN1bGF0ZU9iamVjdFNpemUgYXMgaW50ZXJuYWxDYWxjdWxhdGVPYmplY3RTaXplIH0gZnJvbSBcIi4vcGFyc2VyL2NhbGN1bGF0ZV9zaXplLnRzXCI7XG4vLyBQYXJ0cyBvZiB0aGUgcGFyc2VyXG5pbXBvcnQge1xuICBkZXNlcmlhbGl6ZSBhcyBpbnRlcm5hbERlc2VyaWFsaXplLFxuICBEZXNlcmlhbGl6ZU9wdGlvbnMsXG59IGZyb20gXCIuL3BhcnNlci9kZXNlcmlhbGl6ZXIudHNcIjtcbmltcG9ydCB7XG4gIHNlcmlhbGl6ZUludG8gYXMgaW50ZXJuYWxTZXJpYWxpemUsXG4gIFNlcmlhbGl6ZU9wdGlvbnMsXG59IGZyb20gXCIuL3BhcnNlci9zZXJpYWxpemVyLnRzXCI7XG5pbXBvcnQgeyBCU09OUmVnRXhwIH0gZnJvbSBcIi4vcmVnZXhwLnRzXCI7XG5pbXBvcnQgeyBCU09OU3ltYm9sIH0gZnJvbSBcIi4vc3ltYm9sLnRzXCI7XG5pbXBvcnQgeyBUaW1lc3RhbXAgfSBmcm9tIFwiLi90aW1lc3RhbXAudHNcIjtcbmltcG9ydCB7IFVVSUQgfSBmcm9tIFwiLi91dWlkLnRzXCI7XG5pbXBvcnQgeyBieXRlc0NvcHkgfSBmcm9tIFwiLi9wYXJzZXIvdXRpbHMudHNcIjtcbmV4cG9ydCAqIGZyb20gXCIuL2NvbnN0YW50cy50c1wiO1xuZXhwb3J0IHR5cGUgeyBEQlJlZkxpa2UgfSBmcm9tIFwiLi9kYl9yZWYudHNcIjtcbmV4cG9ydCB7IExvbmdXaXRob3V0T3ZlcnJpZGVzQ2xhc3MgfSBmcm9tIFwiLi90aW1lc3RhbXAudHNcIjtcbmV4cG9ydCB0eXBlIHsgTG9uZ1dpdGhvdXRPdmVycmlkZXMgfSBmcm9tIFwiLi90aW1lc3RhbXAudHNcIjtcbmV4cG9ydCB0eXBlIHsgRGVzZXJpYWxpemVPcHRpb25zLCBTZXJpYWxpemVPcHRpb25zIH07XG5leHBvcnQge1xuICBCaW5hcnksXG4gIEJpbmFyeVNpemVzLFxuICBCU09OUmVnRXhwLFxuICBCU09OU3ltYm9sLFxuICBDb2RlLFxuICBEQlJlZixcbiAgRGVjaW1hbDEyOCxcbiAgRG91YmxlLFxuICBJbnQzMixcbiAgTG9uZyxcbiAgTWF4S2V5LFxuICBNaW5LZXksXG4gIE9iamVjdElkLFxuICBUaW1lc3RhbXAsXG4gIFVVSUQsXG59O1xuZXhwb3J0ICogZnJvbSBcIi4vZXJyb3IudHNcIjtcblxuLyoqIEBwdWJsaWMgKi9cbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnQge1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbi8qKiBAaW50ZXJuYWwgKi9cbi8vIERlZmF1bHQgTWF4IFNpemVcbmNvbnN0IE1BWFNJWkUgPSAxMDI0ICogMTAyNCAqIDE3O1xuXG4vLyBDdXJyZW50IEludGVybmFsIFRlbXBvcmFyeSBTZXJpYWxpemF0aW9uIEJ1ZmZlclxubGV0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KE1BWFNJWkUpO1xuXG4vKipcbiAqIFNldHMgdGhlIHNpemUgb2YgdGhlIGludGVybmFsIHNlcmlhbGl6YXRpb24gYnVmZmVyLlxuICpcbiAqIEBwYXJhbSBzaXplIC0gVGhlIGRlc2lyZWQgc2l6ZSBmb3IgdGhlIGludGVybmFsIHNlcmlhbGl6YXRpb24gYnVmZmVyXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRJbnRlcm5hbEJ1ZmZlclNpemUoc2l6ZTogbnVtYmVyKTogdm9pZCB7XG4gIC8vIFJlc2l6ZSB0aGUgaW50ZXJuYWwgc2VyaWFsaXphdGlvbiBidWZmZXIgaWYgbmVlZGVkXG4gIGlmIChidWZmZXIubGVuZ3RoIDwgc2l6ZSkge1xuICAgIGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KHNpemUpO1xuICB9XG59XG5cbi8qKlxuICogU2VyaWFsaXplIGEgSmF2YXNjcmlwdCBvYmplY3QuXG4gKlxuICogQHBhcmFtIG9iamVjdCAtIHRoZSBKYXZhc2NyaXB0IG9iamVjdCB0byBzZXJpYWxpemUuXG4gKiBAcmV0dXJucyBCdWZmZXIgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHNlcmlhbGl6ZWQgb2JqZWN0LlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplKFxuICBvYmplY3Q6IERvY3VtZW50LFxuICBvcHRpb25zOiBTZXJpYWxpemVPcHRpb25zID0ge30sXG4pOiBVaW50OEFycmF5IHtcbiAgLy8gVW5wYWNrIHRoZSBvcHRpb25zXG4gIGNvbnN0IGNoZWNrS2V5cyA9IHR5cGVvZiBvcHRpb25zLmNoZWNrS2V5cyA9PT0gXCJib29sZWFuXCJcbiAgICA/IG9wdGlvbnMuY2hlY2tLZXlzXG4gICAgOiBmYWxzZTtcbiAgY29uc3Qgc2VyaWFsaXplRnVuY3Rpb25zID0gdHlwZW9mIG9wdGlvbnMuc2VyaWFsaXplRnVuY3Rpb25zID09PSBcImJvb2xlYW5cIlxuICAgID8gb3B0aW9ucy5zZXJpYWxpemVGdW5jdGlvbnNcbiAgICA6IGZhbHNlO1xuICBjb25zdCBpZ25vcmVVbmRlZmluZWQgPSB0eXBlb2Ygb3B0aW9ucy5pZ25vcmVVbmRlZmluZWQgPT09IFwiYm9vbGVhblwiXG4gICAgPyBvcHRpb25zLmlnbm9yZVVuZGVmaW5lZFxuICAgIDogdHJ1ZTtcblxuICAvLyBBdHRlbXB0IHRvIHNlcmlhbGl6ZVxuICBjb25zdCBzZXJpYWxpemF0aW9uSW5kZXggPSBpbnRlcm5hbFNlcmlhbGl6ZShcbiAgICBidWZmZXIsXG4gICAgb2JqZWN0LFxuICAgIGNoZWNrS2V5cyxcbiAgICAwLFxuICAgIDAsXG4gICAgc2VyaWFsaXplRnVuY3Rpb25zLFxuICAgIGlnbm9yZVVuZGVmaW5lZCxcbiAgICBbXSxcbiAgKTtcblxuICAvLyBDcmVhdGUgdGhlIGZpbmFsIGJ1ZmZlclxuICBjb25zdCBmaW5pc2hlZEJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KHNlcmlhbGl6YXRpb25JbmRleCk7XG5cbiAgLy8gQ29weSBpbnRvIHRoZSBmaW5pc2hlZCBidWZmZXJcbiAgYnl0ZXNDb3B5KGZpbmlzaGVkQnVmZmVyLCAwLCBidWZmZXIsIDAsIGZpbmlzaGVkQnVmZmVyLmxlbmd0aCk7XG5cbiAgLy8gUmV0dXJuIHRoZSBidWZmZXJcbiAgcmV0dXJuIGZpbmlzaGVkQnVmZmVyO1xufVxuXG4vKipcbiAqIFNlcmlhbGl6ZSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzaW5nIGEgcHJlZGVmaW5lZCBCdWZmZXIgYW5kIGluZGV4IGludG8gdGhlIGJ1ZmZlcixcbiAqIHVzZWZ1bCB3aGVuIHByZS1hbGxvY2F0aW5nIHRoZSBzcGFjZSBmb3Igc2VyaWFsaXphdGlvbi5cbiAqXG4gKiBAcGFyYW0gb2JqZWN0IC0gdGhlIEphdmFzY3JpcHQgb2JqZWN0IHRvIHNlcmlhbGl6ZS5cbiAqIEBwYXJhbSBmaW5hbEJ1ZmZlciAtIHRoZSBCdWZmZXIgeW91IHByZS1hbGxvY2F0ZWQgdG8gc3RvcmUgdGhlIHNlcmlhbGl6ZWQgQlNPTiBvYmplY3QuXG4gKiBAcmV0dXJucyB0aGUgaW5kZXggcG9pbnRpbmcgdG8gdGhlIGxhc3Qgd3JpdHRlbiBieXRlIGluIHRoZSBidWZmZXIuXG4gKiBAcHVibGljXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVXaXRoQnVmZmVyQW5kSW5kZXgoXG4gIG9iamVjdDogRG9jdW1lbnQsXG4gIGZpbmFsQnVmZmVyOiBVaW50OEFycmF5LFxuICBvcHRpb25zOiBTZXJpYWxpemVPcHRpb25zID0ge30sXG4pOiBudW1iZXIge1xuICAvLyBVbnBhY2sgdGhlIG9wdGlvbnNcbiAgY29uc3QgY2hlY2tLZXlzID0gdHlwZW9mIG9wdGlvbnMuY2hlY2tLZXlzID09PSBcImJvb2xlYW5cIlxuICAgID8gb3B0aW9ucy5jaGVja0tleXNcbiAgICA6IGZhbHNlO1xuICBjb25zdCBzZXJpYWxpemVGdW5jdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucy5zZXJpYWxpemVGdW5jdGlvbnMgPT09IFwiYm9vbGVhblwiXG4gICAgPyBvcHRpb25zLnNlcmlhbGl6ZUZ1bmN0aW9uc1xuICAgIDogZmFsc2U7XG4gIGNvbnN0IGlnbm9yZVVuZGVmaW5lZCA9IHR5cGVvZiBvcHRpb25zLmlnbm9yZVVuZGVmaW5lZCA9PT0gXCJib29sZWFuXCJcbiAgICA/IG9wdGlvbnMuaWdub3JlVW5kZWZpbmVkXG4gICAgOiB0cnVlO1xuICBjb25zdCBzdGFydEluZGV4ID0gdHlwZW9mIG9wdGlvbnMuaW5kZXggPT09IFwibnVtYmVyXCIgPyBvcHRpb25zLmluZGV4IDogMDtcblxuICAvLyBBdHRlbXB0IHRvIHNlcmlhbGl6ZVxuICBjb25zdCBzZXJpYWxpemF0aW9uSW5kZXggPSBpbnRlcm5hbFNlcmlhbGl6ZShcbiAgICBidWZmZXIsXG4gICAgb2JqZWN0LFxuICAgIGNoZWNrS2V5cyxcbiAgICAwLFxuICAgIDAsXG4gICAgc2VyaWFsaXplRnVuY3Rpb25zLFxuICAgIGlnbm9yZVVuZGVmaW5lZCxcbiAgKTtcbiAgYnl0ZXNDb3B5KGZpbmFsQnVmZmVyLCBzdGFydEluZGV4LCBidWZmZXIsIDAsIHNlcmlhbGl6YXRpb25JbmRleCk7XG5cbiAgLy8gUmV0dXJuIHRoZSBpbmRleFxuICByZXR1cm4gc3RhcnRJbmRleCArIHNlcmlhbGl6YXRpb25JbmRleCAtIDE7XG59XG5cbi8qKlxuICogRGVzZXJpYWxpemUgZGF0YSBhcyBCU09OLlxuICpcbiAqIEBwYXJhbSBidWZmZXIgLSB0aGUgYnVmZmVyIGNvbnRhaW5pbmcgdGhlIHNlcmlhbGl6ZWQgc2V0IG9mIEJTT04gZG9jdW1lbnRzLlxuICogQHJldHVybnMgcmV0dXJucyB0aGUgZGVzZXJpYWxpemVkIEphdmFzY3JpcHQgT2JqZWN0LlxuICogQHB1YmxpY1xuICovXG5leHBvcnQgZnVuY3Rpb24gZGVzZXJpYWxpemUoXG4gIGJ1ZmZlcjogVWludDhBcnJheSB8IEFycmF5QnVmZmVyLFxuICBvcHRpb25zOiBEZXNlcmlhbGl6ZU9wdGlvbnMgPSB7fSxcbik6IERvY3VtZW50IHtcbiAgcmV0dXJuIGludGVybmFsRGVzZXJpYWxpemUoXG4gICAgYnVmZmVyIGluc3RhbmNlb2YgVWludDhBcnJheSA/IGJ1ZmZlciA6IG5ldyBVaW50OEFycmF5KGJ1ZmZlciksXG4gICAgb3B0aW9ucyxcbiAgKTtcbn1cblxuLyoqIEBwdWJsaWMgKi9cbmV4cG9ydCB0eXBlIENhbGN1bGF0ZU9iamVjdFNpemVPcHRpb25zID0gUGljazxcbiAgU2VyaWFsaXplT3B0aW9ucyxcbiAgXCJzZXJpYWxpemVGdW5jdGlvbnNcIiB8IFwiaWdub3JlVW5kZWZpbmVkXCJcbj47XG5cbi8qKlxuICogQ2FsY3VsYXRlIHRoZSBic29uIHNpemUgZm9yIGEgcGFzc2VkIGluIEphdmFzY3JpcHQgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSBvYmplY3QgLSB0aGUgSmF2YXNjcmlwdCBvYmplY3QgdG8gY2FsY3VsYXRlIHRoZSBCU09OIGJ5dGUgc2l6ZSBmb3JcbiAqIEByZXR1cm5zIHNpemUgb2YgQlNPTiBvYmplY3QgaW4gYnl0ZXNcbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZU9iamVjdFNpemUoXG4gIG9iamVjdDogRG9jdW1lbnQsXG4gIG9wdGlvbnM6IENhbGN1bGF0ZU9iamVjdFNpemVPcHRpb25zID0ge30sXG4pOiBudW1iZXIge1xuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcblxuICBjb25zdCBzZXJpYWxpemVGdW5jdGlvbnMgPSB0eXBlb2Ygb3B0aW9ucy5zZXJpYWxpemVGdW5jdGlvbnMgPT09IFwiYm9vbGVhblwiXG4gICAgPyBvcHRpb25zLnNlcmlhbGl6ZUZ1bmN0aW9uc1xuICAgIDogZmFsc2U7XG4gIGNvbnN0IGlnbm9yZVVuZGVmaW5lZCA9IHR5cGVvZiBvcHRpb25zLmlnbm9yZVVuZGVmaW5lZCA9PT0gXCJib29sZWFuXCJcbiAgICA/IG9wdGlvbnMuaWdub3JlVW5kZWZpbmVkXG4gICAgOiB0cnVlO1xuXG4gIHJldHVybiBpbnRlcm5hbENhbGN1bGF0ZU9iamVjdFNpemUoXG4gICAgb2JqZWN0LFxuICAgIHNlcmlhbGl6ZUZ1bmN0aW9ucyxcbiAgICBpZ25vcmVVbmRlZmluZWQsXG4gICk7XG59XG5cbi8qKlxuICogRGVzZXJpYWxpemUgc3RyZWFtIGRhdGEgYXMgQlNPTiBkb2N1bWVudHMuXG4gKlxuICogQHBhcmFtIGRhdGEgLSB0aGUgYnVmZmVyIGNvbnRhaW5pbmcgdGhlIHNlcmlhbGl6ZWQgc2V0IG9mIEJTT04gZG9jdW1lbnRzLlxuICogQHBhcmFtIHN0YXJ0SW5kZXggLSB0aGUgc3RhcnQgaW5kZXggaW4gdGhlIGRhdGEgQnVmZmVyIHdoZXJlIHRoZSBkZXNlcmlhbGl6YXRpb24gaXMgdG8gc3RhcnQuXG4gKiBAcGFyYW0gbnVtYmVyT2ZEb2N1bWVudHMgLSBudW1iZXIgb2YgZG9jdW1lbnRzIHRvIGRlc2VyaWFsaXplLlxuICogQHBhcmFtIGRvY3VtZW50cyAtIGFuIGFycmF5IHdoZXJlIHRvIHN0b3JlIHRoZSBkZXNlcmlhbGl6ZWQgZG9jdW1lbnRzLlxuICogQHBhcmFtIGRvY1N0YXJ0SW5kZXggLSB0aGUgaW5kZXggaW4gdGhlIGRvY3VtZW50cyBhcnJheSBmcm9tIHdoZXJlIHRvIHN0YXJ0IGluc2VydGluZyBkb2N1bWVudHMuXG4gKiBAcGFyYW0gb3B0aW9ucyAtIGFkZGl0aW9uYWwgb3B0aW9ucyB1c2VkIGZvciB0aGUgZGVzZXJpYWxpemF0aW9uLlxuICogQHJldHVybnMgbmV4dCBpbmRleCBpbiB0aGUgYnVmZmVyIGFmdGVyIGRlc2VyaWFsaXphdGlvbiAqKngqKiBudW1iZXJzIG9mIGRvY3VtZW50cy5cbiAqIEBwdWJsaWNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplU3RyZWFtKFxuICBkYXRhOiBVaW50OEFycmF5IHwgQXJyYXlCdWZmZXJWaWV3IHwgQXJyYXlCdWZmZXIsXG4gIHN0YXJ0SW5kZXg6IG51bWJlcixcbiAgbnVtYmVyT2ZEb2N1bWVudHM6IG51bWJlcixcbiAgZG9jdW1lbnRzOiBEb2N1bWVudFtdLFxuICBkb2NTdGFydEluZGV4OiBudW1iZXIsXG4gIG9wdGlvbnM/OiBEZXNlcmlhbGl6ZU9wdGlvbnMsXG4pOiBudW1iZXIge1xuICBjb25zdCBpbnRlcm5hbE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgIHsgYWxsb3dPYmplY3RTbWFsbGVyVGhhbkJ1ZmZlclNpemU6IHRydWUsIGluZGV4OiAwIH0sXG4gICAgb3B0aW9ucyxcbiAgKTtcbiAgY29uc3QgYnVmZmVyRGF0YTogVWludDhBcnJheSA9IGRhdGEgaW5zdGFuY2VvZiBVaW50OEFycmF5XG4gICAgPyBkYXRhXG4gICAgOiBkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXJcbiAgICA/IG5ldyBVaW50OEFycmF5KGRhdGEpXG4gICAgOiBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpO1xuXG4gIGxldCBpbmRleCA9IHN0YXJ0SW5kZXg7XG4gIC8vIExvb3Agb3ZlciBhbGwgZG9jdW1lbnRzXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZEb2N1bWVudHM7IGkrKykge1xuICAgIC8vIEZpbmQgc2l6ZSBvZiB0aGUgZG9jdW1lbnRcbiAgICBjb25zdCBzaXplID0gYnVmZmVyRGF0YVtpbmRleF0gfFxuICAgICAgKGJ1ZmZlckRhdGFbaW5kZXggKyAxXSA8PCA4KSB8XG4gICAgICAoYnVmZmVyRGF0YVtpbmRleCArIDJdIDw8IDE2KSB8XG4gICAgICAoYnVmZmVyRGF0YVtpbmRleCArIDNdIDw8IDI0KTtcbiAgICAvLyBVcGRhdGUgb3B0aW9ucyB3aXRoIGluZGV4XG4gICAgaW50ZXJuYWxPcHRpb25zLmluZGV4ID0gaW5kZXg7XG4gICAgLy8gUGFyc2UgdGhlIGRvY3VtZW50IGF0IHRoaXMgcG9pbnRcbiAgICBkb2N1bWVudHNbZG9jU3RhcnRJbmRleCArIGldID0gaW50ZXJuYWxEZXNlcmlhbGl6ZShcbiAgICAgIGJ1ZmZlckRhdGEsXG4gICAgICBpbnRlcm5hbE9wdGlvbnMsXG4gICAgKTtcbiAgICAvLyBBZGp1c3QgaW5kZXggYnkgdGhlIGRvY3VtZW50IHNpemVcbiAgICBpbmRleCArPSBzaXplO1xuICB9XG5cbiAgLy8gUmV0dXJuIG9iamVjdCBjb250YWluaW5nIGVuZCBpbmRleCBvZiBwYXJzaW5nIGFuZCBsaXN0IG9mIGRvY3VtZW50c1xuICByZXR1cm4gaW5kZXg7XG59XG4iXX0=
import { isRouterContext } from "../util.ts";
const FORWARDED_RE = /^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$/;
function createMatcher({ match }) {
    return function matches(ctx) {
        if (!match) {
            return true;
        }
        if (typeof match === "string") {
            return ctx.request.url.pathname.startsWith(match);
        }
        if (match instanceof RegExp) {
            return match.test(ctx.request.url.pathname);
        }
        return match(ctx);
    };
}
async function createRequest(target, ctx, { headers: optHeaders, map, proxyHeaders = true, request: reqFn }) {
    let path = ctx.request.url.pathname;
    let params;
    if (isRouterContext(ctx)) {
        params = ctx.params;
    }
    if (map && typeof map === "function") {
        path = map(path, params);
    }
    else if (map) {
        path = map[path] ?? path;
    }
    const url = new URL(String(target));
    if (url.pathname.endsWith("/") && path.startsWith("/")) {
        url.pathname = `${url.pathname}${path.slice(1)}`;
    }
    else if (!url.pathname.endsWith("/") && !path.startsWith("/")) {
        url.pathname = `${url.pathname}/${path}`;
    }
    else {
        url.pathname = `${url.pathname}${path}`;
    }
    url.search = ctx.request.url.search;
    const body = getBodyInit(ctx);
    const headers = new Headers(ctx.request.headers);
    if (optHeaders) {
        if (typeof optHeaders === "function") {
            optHeaders = await optHeaders(ctx);
        }
        for (const [key, value] of iterableHeaders(optHeaders)) {
            headers.set(key, value);
        }
    }
    if (proxyHeaders) {
        const maybeForwarded = headers.get("forwarded");
        const ip = ctx.request.ip.startsWith("[")
            ? `"${ctx.request.ip}"`
            : ctx.request.ip;
        const host = headers.get("host");
        if (maybeForwarded && FORWARDED_RE.test(maybeForwarded)) {
            let value = `for=${ip}`;
            if (host) {
                value += `;host=${host}`;
            }
            headers.append("forwarded", value);
        }
        else {
            headers.append("x-forwarded-for", ip);
            if (host) {
                headers.append("x-forwarded-host", host);
            }
        }
    }
    const init = {
        body,
        headers,
        method: ctx.request.method,
        redirect: "follow",
    };
    let request = new Request(url.toString(), init);
    if (reqFn) {
        request = await reqFn(request);
    }
    return request;
}
function getBodyInit(ctx) {
    if (!ctx.request.hasBody) {
        return null;
    }
    return ctx.request.body({ type: "stream" }).value;
}
function iterableHeaders(headers) {
    if (headers instanceof Headers) {
        return headers.entries();
    }
    else if (Array.isArray(headers)) {
        return headers.values();
    }
    else {
        return Object.entries(headers).values();
    }
}
async function processResponse(response, ctx, { contentType: contentTypeFn, response: resFn }) {
    if (resFn) {
        response = await resFn(response);
    }
    if (response.body) {
        ctx.response.body = response.body;
    }
    else {
        ctx.response.body = null;
    }
    ctx.response.status = response.status;
    for (const [key, value] of response.headers) {
        ctx.response.headers.append(key, value);
    }
    if (contentTypeFn) {
        const value = await contentTypeFn(response.url, ctx.response.headers.get("content-type") ?? undefined);
        if (value != null) {
            ctx.response.headers.set("content-type", value);
        }
    }
}
export function proxy(target, options = {}) {
    const matches = createMatcher(options);
    return async function proxy(ctx, next) {
        if (!matches(ctx)) {
            return next();
        }
        const request = await createRequest(target, ctx, options);
        const { fetch = globalThis.fetch } = options;
        const response = await fetch(request);
        await processResponse(response, ctx, options);
        return next();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFVQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBNkU3QyxNQUFNLFlBQVksR0FDaEIsZ25CQUFnbkIsQ0FBQztBQUVubkIsU0FBUyxhQUFhLENBS3BCLEVBQUUsS0FBSyxFQUF5QjtJQUVoQyxPQUFPLFNBQVMsT0FBTyxDQUFDLEdBQTJCO1FBQ2pELElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDN0IsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25EO1FBQ0QsSUFBSSxLQUFLLFlBQVksTUFBTSxFQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM3QztRQUNELE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUsxQixNQUFvQixFQUNwQixHQUF3QyxFQUN4QyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFlBQVksR0FBRyxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFDeEM7SUFFdkIsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBYSxDQUFDO0lBQ3pDLElBQUksTUFBcUIsQ0FBQztJQUMxQixJQUFJLGVBQWUsQ0FBVSxHQUFHLENBQUMsRUFBRTtRQUNqQyxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztLQUNyQjtJQUNELElBQUksR0FBRyxJQUFJLE9BQU8sR0FBRyxL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QUUsR0FBRyxPQUFPLENBQUM7UUFDN0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsTUFBTSxlQUFlLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM5QyxPQUFPLElBQUksRUFBRSxDQUFDO0lBQ2hCLENBQUMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgU3RhdGUgfSBmcm9tIFwiLi4vYXBwbGljYXRpb24udHNcIjtcbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgdHlwZSB7IE1pZGRsZXdhcmUgfSBmcm9tIFwiLi4vbWlkZGxld2FyZS50c1wiO1xuaW1wb3J0IHR5cGUge1xuICBSb3V0ZVBhcmFtcyxcbiAgUm91dGVyQ29udGV4dCxcbiAgUm91dGVyTWlkZGxld2FyZSxcbn0gZnJvbSBcIi4uL3JvdXRlci50c1wiO1xuaW1wb3J0IHsgaXNSb3V0ZXJDb250ZXh0IH0gZnJvbSBcIi4uL3V0aWwudHNcIjtcblxuZXhwb3J0IHR5cGUgRmV0Y2ggPSAoaW5wdXQ6IFJlcXVlc3QpID0+IFByb21pc2U8UmVzcG9uc2U+O1xuXG5leHBvcnQgdHlwZSBQcm94eU1hdGNoRnVuY3Rpb248XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPiA9IFJvdXRlUGFyYW1zPFI+LFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuPiA9IChjdHg6IENvbnRleHQ8Uz4gfCBSb3V0ZXJDb250ZXh0PFIsIFAsIFM+KSA9PiBib29sZWFuO1xuXG5leHBvcnQgdHlwZSBQcm94eU1hcEZ1bmN0aW9uPFIgZXh0ZW5kcyBzdHJpbmcsIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPj4gPSAoXG4gIHBhdGg6IFIsXG4gIHBhcmFtcz86IFAsXG4pID0+IFI7XG5cbmV4cG9ydCB0eXBlIFByb3h5SGVhZGVyc0Z1bmN0aW9uPFMgZXh0ZW5kcyBTdGF0ZT4gPSAoXG4gIGN0eDogQ29udGV4dDxTPixcbikgPT4gSGVhZGVyc0luaXQgfCBQcm9taXNlPEhlYWRlcnNJbml0PjtcblxuZXhwb3J0IHR5cGUgUHJveHlSb3V0ZXJIZWFkZXJzRnVuY3Rpb248XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPixcbiAgUyBleHRlbmRzIFN0YXRlLFxuPiA9IChjdHg6IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pID0+IEhlYWRlcnNJbml0IHwgUHJvbWlzZTxIZWFkZXJzSW5pdD47XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJveHlPcHRpb25zPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4gPSBSb3V0ZVBhcmFtczxSPixcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgUyBleHRlbmRzIFN0YXRlID0gUmVjb3JkPHN0cmluZywgYW55Pixcbj4ge1xuICAvKiogQSBjYWxsYmFjayBob29rIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZCB3aGljaCBhbGxvd3NcbiAgICogdGhlIHJlc3BvbnNlIGNvbnRlbnQgdHlwZSB0byBiZSBhZGp1c3RlZC4gVGhpcyBpcyBmb3Igc2l0dWF0aW9ucyB3aGVyZSB0aGVcbiAgICogY29udGVudCB0eXBlIHByb3ZpZGVkIGJ5IHRoZSBwcm94eSBzZXJ2ZXIgbWlnaHQgbm90IGJlIHN1aXRhYmxlIGZvclxuICAgKiByZXNwb25kaW5nIHdpdGguICovXG4gIGNvbnRlbnRUeXBlPyhcbiAgICB1cmw6IHN0cmluZyxcbiAgICBjb250ZW50VHlwZT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAvKiogVGhlIGZldGNoIGZ1bmN0aW9uIHRvIHVzZSB0byBwcm94eSB0aGUgcmVxdWVzdC4gVGhpcyBkZWZhdWx0cyB0byB0aGVcbiAgICogZ2xvYmFsIGBmZXRjaGAgZnVuY3Rpb24uIFRoaXMgaXMgZGVzaWduZWQgZm9yIHRlc3QgbW9ja2luZyBwdXJwb3Nlcy4gKi9cbiAgZmV0Y2g/OiBGZXRjaDtcbiAgLyoqIEFkZGl0aW9uYWwgaGVhZGVycyB0aGF0IHNob3VsZCBiZSBzZXQgaW4gdGhlIHJlc3BvbnNlLiBUaGUgdmFsdWUgY2FuXG4gICAqIGJlIGEgaGVhZGVycyBpbml0IHZhbHVlIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9yIHJlc29sdmVzIHdpdGggYVxuICAgKiBoZWFkZXJzIGluaXQgdmFsdWUuICovXG4gIGhlYWRlcnM/OlxuICAgIHwgSGVhZGVyc0luaXRcbiAgICB8IFByb3h5SGVhZGVyc0Z1bmN0aW9uPFM+XG4gICAgfCBQcm94eVJvdXRlckhlYWRlcnNGdW5jdGlvbjxSLCBQLCBTPjtcbiAgLyoqIEVpdGhlciBhIHJlY29yZCBvciBhIHByb3h5IG1hcCBmdW5jdGlvbiB0aGF0IHdpbGwgYWxsb3cgcHJveGllZCByZXF1ZXN0c1xuICAgKiBiZWluZyBoYW5kbGVkIGJ5IHRoZSBtaWRkbGV3YXJlIHRvIGJlIHJlbWFwcGVkIHRvIGEgZGlmZmVyZW50IHJlbW90ZVxuICAgKiBwYXRoLiAqL1xuICBtYXA/OiBSZWNvcmQ8c3RyaW5nLCBSPiB8IFByb3h5TWFwRnVuY3Rpb248UiwgUD47XG4gIC8qKiBBIHN0cmluZywgcmVndWxhciBleHByZXNzaW9uIG9yIHByb3h5IG1hdGNoIGZ1bmN0aW9uIHdoYXQgZGV0ZXJtaW5lcyBpZlxuICAgKiB0aGUgcHJveHkgbWlkZGxld2FyZSBzaG91bGQgcHJveHkgdGhlIHJlcXVlc3QuXG4gICAqXG4gICAqIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyB0aGUgbWF0Y2ggd2lsbCBiZSB0cnVlIGlmIHRoZSByZXF1ZXN0cyBwYXRobmFtZVxuICAgKiBzdGFydHMgd2l0aCB0aGUgc3RyaW5nLiBJbiB0aGUgY2FzZSBvZiBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgaWYgdGhlXG4gICAqIHBhdGhuYW1lXG4gICAqL1xuICBtYXRjaD86XG4gICAgfCBzdHJpbmdcbiAgICB8IFJlZ0V4cFxuICAgIHwgUHJveHlNYXRjaEZ1bmN0aW9uPFIsIFAsIFM+O1xuICAvKiogQSBmbGFnIHRoYXQgaW5kaWNhdGVzIGlmIHRyYWRpdGlvbmFsIHByb3h5IGhlYWRlcnMgc2hvdWxkIGJlIHNldCBpbiB0aGVcbiAgICogcmVzcG9uc2UuIFRoaXMgZGVmYXVsdHMgdG8gYHRydWVgLlxuICAgKi9cbiAgcHJveHlIZWFkZXJzPzogYm9vbGVhbjtcbiAgLyoqIEEgY2FsbGJhY2sgaG9vayB3aGljaCB3aWxsIGJlIGNhbGxlZCBiZWZvcmUgZWFjaCBwcm94aWVkIGZldGNoIHJlcXVlc3RcbiAgICogdG8gYWxsb3cgdGhlIG5hdGl2ZSBgUmVxdWVzdGAgdG8gYmUgbW9kaWZpZWQgb3IgcmVwbGFjZWQuICovXG4gIHJlcXVlc3Q/KHJlcTogUmVxdWVzdCk6IFJlcXVlc3QgfCBQcm9taXNlPFJlcXVlc3Q+O1xuICAvKiogQSBjYWxsYmFjayBob29rIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGVhY2ggcHJveGllZCBmZXRjaCByZXNwb25zZVxuICAgKiBpcyByZWNlaXZlZCB0byBhbGxvdyB0aGUgbmF0aXZlIGBSZXNwb25zZWAgdG8gYmUgbW9kaWZpZWQgb3IgcmVwbGFjZWQuICovXG4gIHJlc3BvbnNlPyhyZXM6IFJlc3BvbnNlKTogUmVzcG9uc2UgfCBQcm9taXNlPFJlc3BvbnNlPjtcbn1cblxuY29uc3QgRk9SV0FSREVEX1JFID1cbiAgL14oLFsgXFxcXHRdKikqKFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dKz0oWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rfFxcXCIoW1xcXFx0IFxcXFx4MjFcXFxceDIzLVxcXFx4NUJcXFxceDVELVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdfFxcXFxcXFxcW1xcXFx0IFxcXFx4MjEtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl0pKlxcXCIpKT8oOyhbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSs9KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dK3xcXFwiKFtcXFxcdCBcXFxceDIxXFxcXHgyMy1cXFxceDVCXFxcXHg1RC1cXFxceDdFXFxcXHg4MC1cXFxceEZGXXxcXFxcXFxcXFtcXFxcdCBcXFxceDIxLVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdKSpcXFwiKSk/KSooWyBcXFxcdF0qLChbIFxcXFx0XSooWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rPShbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSt8XFxcIihbXFxcXHQgXFxcXHgyMVxcXFx4MjMtXFxcXHg1QlxcXFx4NUQtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl18XFxcXFxcXFxbXFxcXHQgXFxcXHgyMS1cXFxceDdFXFxcXHg4MC1cXFxceEZGXSkqXFxcIikpPyg7KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dKz0oWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rfFxcXCIoW1xcXFx0IFxcXFx4MjFcXFxceDIzLVxcXFx4NUJcXFxceDVELVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdfFxcXFxcXFxcW1xcXFx0IFxcXFx4MjEtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl0pKlxcXCIpKT8pKik/KSokLztcblxuZnVuY3Rpb24gY3JlYXRlTWF0Y2hlcjxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB7IG1hdGNoIH06IFByb3h5T3B0aW9uczxSLCBQLCBTPixcbikge1xuICByZXR1cm4gZnVuY3Rpb24gbWF0Y2hlcyhjdHg6IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pOiBib29sZWFuIHtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBtYXRjaCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGN0eC5yZXF1ZXN0LnVybC5wYXRobmFtZS5zdGFydHNXaXRoKG1hdGNoKTtcbiAgICB9XG4gICAgaWYgKG1hdGNoIGluc3RhbmNlb2YgUmVnRXhwKSB7XG4gICAgICByZXR1cm4gbWF0Y2gudGVzdChjdHgucmVxdWVzdC51cmwucGF0aG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbWF0Y2goY3R4KTtcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUmVxdWVzdDxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxSLCBQLCBTPixcbiAgeyBoZWFkZXJzOiBvcHRIZWFkZXJzLCBtYXAsIHByb3h5SGVhZGVycyA9IHRydWUsIHJlcXVlc3Q6IHJlcUZuIH06XG4gICAgUHJveHlPcHRpb25zPFIsIFAsIFM+LFxuKTogUHJvbWlzZTxSZXF1ZXN0PiB7XG4gIGxldCBwYXRoID0gY3R4LnJlcXVlc3QudXJsLnBhdGhuYW1lIGFzIFI7XG4gIGxldCBwYXJhbXM6IFAgfCB1bmRlZmluZWQ7XG4gIGlmIChpc1JvdXRlckNvbnRleHQ8UiwgUCwgUz4oY3R4KSkge1xuICAgIHBhcmFtcyA9IGN0eC5wYXJhbXM7XG4gIH1cbiAgaWYgKG1hcCAmJiB0eXBlb2YgbWFwID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBwYXRoID0gbWFwKHBhdGgsIHBhcmFtcyk7XG4gIH0gZWxzZSBpZiAobWFwKSB7XG4gICAgcGF0aCA9IG1hcFtwYXRoXSA/PyBwYXRoO1xuICB9XG4gIGNvbnN0IHVybCA9IG5ldyBVUkwoU3RyaW5nKHRhcmdldCkpO1xuICBpZiAodXJsLnBhdGhuYW1lLmVuZHNXaXRoKFwiL1wiKSAmJiBwYXRoLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgdXJsLnBhdGhuYW1lID0gYCR7dXJsLnBhdGhuYW1lfSR7cGF0aC5zbGljZSgxKX1gO1xuICB9IGVsc2UgaWYgKCF1cmwucGF0aG5hbWUuZW5kc1dpdGgoXCIvXCIpICYmICFwYXRoLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgdXJsLnBhdGhuYW1lID0gYCR7dXJsLnBhdGhuYW1lfS8ke3BhdGh9YDtcbiAgfSBlbHNlIHtcbiAgICB1cmwucGF0aG5hbWUgPSBgJHt1cmwucGF0aG5hbWV9JHtwYXRofWA7XG4gIH1cbiAgdXJsLnNlYXJjaCA9IGN0eC5yZXF1ZXN0LnVybC5zZWFyY2g7XG5cbiAgY29uc3QgYm9keSA9IGdldEJvZHlJbml0KGN0eCk7XG4gIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyhjdHgucmVxdWVzdC5oZWFkZXJzKTtcbiAgaWYgKG9wdEhlYWRlcnMpIHtcbiAgICBpZiAodHlwZW9mIG9wdEhlYWRlcnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgb3B0SGVhZGVycyA9IGF3YWl0IG9wdEhlYWRlcnMoY3R4IGFzIFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBpdGVyYWJsZUhlYWRlcnMob3B0SGVhZGVycykpIHtcbiAgICAgIGhlYWRlcnMuc2V0KGtleSwgdmFsdWUpO1xuICAgIH1cbiAgfVxuICBpZiAocHJveHlIZWFkZXJzKSB7XG4gICAgY29uc3QgbWF5YmVGb3J3YXJkZWQgPSBoZWFkZXJzLmdldChcImZvcndhcmRlZFwiKTtcbiAgICBjb25zdCBpcCA9IGN0eC5yZXF1ZXN0LmlwLnN0YXJ0c1dpdGgoXCJbXCIpXG4gICAgICA/IGBcIiR7Y3R4LnJlcXVlc3QuaXB9XCJgXG4gICAgICA6IGN0eC5yZXF1ZXN0LmlwO1xuICAgIGNvbnN0IGhvc3QgPSBoZWFkZXJzLmdldChcImhvc3RcIik7XG4gICAgaWYgKG1heWJlRm9yd2FyZGVkICYmIEZPUldBUkRFRF9SRS50ZXN0KG1heWJlRm9yd2FyZGVkKSkge1xuICAgICAgbGV0IHZhbHVlID0gYGZvcj0ke2lwfWA7XG4gICAgICBpZiAoaG9zdCkge1xuICAgICAgICB2YWx1ZSArPSBgO2hvc3Q9JHtob3N0fWA7XG4gICAgICB9XG4gICAgICBoZWFkZXJzLmFwcGVuZChcImZvcndhcmRlZFwiLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtZm9yXCIsIGlwKTtcbiAgICAgIGlmIChob3N0KSB7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtaG9zdFwiLCBob3N0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBpbml0OiBSZXF1ZXN0SW5pdCA9IHtcbiAgICBib2R5LFxuICAgIGhlYWRlcnMsXG4gICAgbWV0aG9kOiBjdHgucmVxdWVzdC5tZXRob2QsXG4gICAgcmVkaXJlY3Q6IFwiZm9sbG93XCIsXG4gIH07XG4gIGxldCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QodXJsLnRvU3RyaW5nKCksIGluaXQpO1xuICBpZiAocmVxRm4pIHtcbiAgICByZXF1ZXN0ID0gYXdhaXQgcmVxRm4ocmVxdWVzdCk7XG4gIH1cbiAgcmV0dXJuIHJlcXVlc3Q7XG59XG5cbmZ1bmN0aW9uIGdldEJvZHlJbml0PFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIGN0eDogQ29udGV4dDxTPiB8IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4sXG4pOiBCb2R5SW5pdCB8IG51bGwge1xuICBpZiAoIWN0eC5yZXF1ZXN0Lmhhc0JvZHkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gY3R4LnJlcXVlc3QuYm9keSh7IHR5cGU6IFwic3RyZWFtXCIgfSkudmFsdWU7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlSGVhZGVycyhcbiAgaGVhZGVyczogSGVhZGVyc0luaXQsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+IHtcbiAgaWYgKGhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKSB7XG4gICAgcmV0dXJuIGhlYWRlcnMuZW50cmllcygpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaGVhZGVycykpIHtcbiAgICByZXR1cm4gaGVhZGVycy52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhoZWFkZXJzKS52YWx1ZXMoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzUmVzcG9uc2U8XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPixcbiAgUyBleHRlbmRzIFN0YXRlLFxuPihcbiAgcmVzcG9uc2U6IFJlc3BvbnNlLFxuICBjdHg6IENvbnRleHQ8Uz4gfCBSb3V0ZXJDb250ZXh0PFIsIFAsIFM+LFxuICB7IGNvbnRlbnRUeXBlOiBjb250ZW50VHlwZUZuLCByZXNwb25zZTogcmVzRm4gfTogUHJveHlPcHRpb25zPFIsIFAsIFM+LFxuKSB7XG4gIGlmIChyZXNGbikge1xuICAgIHJlc3BvbnNlID0gYXdhaXQgcmVzRm4ocmVzcG9uc2UpO1xuICB9XG4gIGlmIChyZXNwb25zZS5ib2R5KSB7XG4gICAgY3R4LnJlc3BvbnNlLmJvZHkgPSByZXNwb25zZS5ib2R5O1xuICB9IGVsc2Uge1xuICAgIGN0eC5yZXNwb25zZS5ib2R5ID0gbnVsbDtcbiAgfVxuICBjdHgucmVzcG9uc2Uuc3RhdHVzID0gcmVzcG9uc2Uuc3RhdHVzO1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiByZXNwb25zZS5oZWFkZXJzKSB7XG4gICAgY3R4LnJlc3BvbnNlLmhlYWRlcnMuYXBwZW5kKGtleSwgdmFsdWUpO1xuICB9XG4gIGlmIChjb250ZW50VHlwZUZuKSB7XG4gICAgY29uc3QgdmFsdWUgPSBhd2FpdCBjb250ZW50VHlwZUZuKFxuICAgICAgcmVzcG9uc2UudXJsLFxuICAgICAgY3R4LnJlc3BvbnNlLmhlYWRlcnMuZ2V0KFwiY29udGVudC10eXBlXCIpID8/IHVuZGVmaW5lZCxcbiAgICApO1xuICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7XG4gICAgICBjdHgucmVzcG9uc2UuaGVhZGVycy5zZXQoXCJjb250ZW50LXR5cGVcIiwgdmFsdWUpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIE1pZGRsZXdhcmUgdGhhdCBwcm92aWRlcyBhIGJhY2stdG8tYmFjayBwcm94eSBmb3IgcmVxdWVzdHMuXG4gKlxuICogQHBhcmFtIHRhcmdldFxuICogQHBhcmFtIG9wdGlvbnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHByb3h5PFMgZXh0ZW5kcyBTdGF0ZT4oXG4gIHRhcmdldDogc3RyaW5nIHwgVVJMLFxuICBvcHRpb25zPzogUHJveHlPcHRpb25zPHN0cmluZywgUm91dGVQYXJhbXM8c3RyaW5nPiwgUz4sXG4pOiBNaWRkbGV3YXJlPFM+O1xuZXhwb3J0IGZ1bmN0aW9uIHByb3h5PFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIHRhcmdldDogc3RyaW5nIHwgVVJMLFxuICBvcHRpb25zOiBQcm94eU9wdGlvbnM8UiwgUCwgUz4gPSB7fSxcbik6IFJvdXRlck1pZGRsZXdhcmU8UiwgUCwgUz4ge1xuICBjb25zdCBtYXRjaGVzID0gY3JlYXRlTWF0Y2hlcihvcHRpb25zKTtcbiAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uIHByb3h5KGN0eCwgbmV4dCkge1xuICAgIGlmICghbWF0Y2hlcyhjdHgpKSB7XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgY3JlYXRlUmVxdWVzdCh0YXJnZXQsIGN0eCwgb3B0aW9ucyk7XG4gICAgY29uc3QgeyBmZXRjaCA9IGdsb2JhbFRoaXMuZmV0Y2ggfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChyZXF1ZXN0KTtcbiAgICBhd2FpdCBwcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UsIGN0eCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfTtcbn1cbiJdfQ==
import { Database } from "./database.ts";
import { parse } from "./utils/uri.ts";
import { MongoDriverError } from "./error.ts";
import { Cluster } from "./cluster.ts";
import { assert } from "../deps.ts";
export class MongoClient {
    #cluster;
    #defaultDbName = "admin";
    #buildInfo;
    get buildInfo() {
        return this.#buildInfo;
    }
    async connect(options) {
        try {
            const parsedOptions = typeof options === "string"
                ? await parse(options)
                : options;
            this.#defaultDbName = parsedOptions.db;
            const cluster = new Cluster(parsedOptions);
            await cluster.connect();
            await cluster.authenticate();
            await cluster.updateMaster();
            this.#cluster = cluster;
            this.#buildInfo = await this.runCommand(this.#defaultDbName, {
                buildInfo: 1,
            });
        }
        catch (e) {
            throw new MongoDriverError(`Connection failed: ${e.message || e}`);
        }
        return this.database(options.db);
    }
    async listDatabases(options = {}) {
        assert(this.#cluster);
        const { databases } = await this.#cluster.protocol.commandSingle("admin", {
            listDatabases: 1,
            ...options,
        });
        return databases;
    }
    runCommand(db, body) {
        assert(this.#cluster);
        return this.#cluster.protocol.commandSingle(db, body);
    }
    database(name = this.#defaultDbName) {
        assert(this.#cluster);
        return new Database(this.#cluster, name);
    }
    close() {
        if (this.#cluster)
            this.#cluster.close();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFPekMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFcEMsTUFBTSxPQUFPLFdBQVc7SUFDdEIsUUFBUSxDQUFXO0lBQ25CLGNBQWMsR0FBRyxPQUFPLENBQUM7SUFDekIsVUFBVSxDQUFhO0lBRXZCLElBQUksU0FBUztRQUNYLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN6QixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FDWCxPQUFnQztRQUVoQyxJQUFJO1lBQ0YsTUFBTSxhQUFhLEdBQUcsT0FBTyxPQUFPLEtBQUssUUFBUTtnQkFDL0MsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLE9BQU8sQ0FBQztnQkFDdEIsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUVaLElBQUksQ0FBQyxjQUFjLEdBQUcsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUMzQyxNQUFNLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN4QixNQUFNLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUM3QixNQUFNLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUU3QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztZQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUMzRCxTQUFTLEVBQUUsQ0FBQzthQUNiLENBQUMsQ0FBQztTQUNKO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixNQUFNLElBQUksZ0JBQWdCLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNwRTtRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBRSxPQUEwQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUFDLFVBS2hCLEVBQUU7UUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUU7WUFDeEUsYUFBYSxFQUFFLENBQUM7WUFDaEIsR0FBRyxPQUFPO1NBQ1gsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUdELFVBQVUsQ0FBVSxFQUFVLEVBQUUsSUFBYztRQUM1QyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQsUUFBUSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYztRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsS0FBSztRQUNILElBQUksSUFBSSxDQUFDLFFBQVE7WUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzNDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSBcIi4vZGF0YWJhc2UudHNcIjtcbmltcG9ydCB7XG4gIEJ1aWxkSW5mbyxcbiAgQ29ubmVjdE9wdGlvbnMsXG4gIERvY3VtZW50LFxuICBMaXN0RGF0YWJhc2VJbmZvLFxufSBmcm9tIFwiLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgcGFyc2UgfSBmcm9tIFwiLi91dGlscy91cmkudHNcIjtcbmltcG9ydCB7IE1vbmdvRHJpdmVyRXJyb3IgfSBmcm9tIFwiLi9lcnJvci50c1wiO1xuaW1wb3J0IHsgQ2x1c3RlciB9IGZyb20gXCIuL2NsdXN0ZXIudHNcIjtcbmltcG9ydCB7IGFzc2VydCB9IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5cbmV4cG9ydCBjbGFzcyBNb25nb0NsaWVudCB7XG4gICNjbHVzdGVyPzogQ2x1c3RlcjtcbiAgI2RlZmF1bHREYk5hbWUgPSBcImFkbWluXCI7XG4gICNidWlsZEluZm8/OiBCdWlsZEluZm87XG5cbiAgZ2V0IGJ1aWxkSW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy4jYnVpbGRJbmZvO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdChcbiAgICBvcHRpb25zOiBDb25uZWN0T3B0aW9ucyB8IHN0cmluZyxcbiAgKTogUHJvbWlzZTxEYXRhYmFzZT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWRPcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyBhd2FpdCBwYXJzZShvcHRpb25zKVxuICAgICAgICA6IG9wdGlvbnM7XG5cbiAgICAgIHRoaXMuI2RlZmF1bHREYk5hbWUgPSBwYXJzZWRPcHRpb25zLmRiO1xuICAgICAgY29uc3QgY2x1c3RlciA9IG5ldyBDbHVzdGVyKHBhcnNlZE9wdGlvbnMpO1xuICAgICAgYXdhaXQgY2x1c3Rlci5jb25uZWN0KCk7XG4gICAgICBhd2FpdCBjbHVzdGVyLmF1dGhlbnRpY2F0ZSgpO1xuICAgICAgYXdhaXQgY2x1c3Rlci51cGRhdGVNYXN0ZXIoKTtcblxuICAgICAgdGhpcy4jY2x1c3RlciA9IGNsdXN0ZXI7XG4gICAgICB0aGlzLiNidWlsZEluZm8gPSBhd2FpdCB0aGlzLnJ1bkNvbW1hbmQodGhpcy4jZGVmYXVsdERiTmFtZSwge1xuICAgICAgICBidWlsZEluZm86IDEsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgTW9uZ29Ecml2ZXJFcnJvcihgQ29ubmVjdGlvbiBmYWlsZWQ6ICR7ZS5tZXNzYWdlIHx8IGV9YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmRhdGFiYXNlKChvcHRpb25zIGFzIENvbm5lY3RPcHRpb25zKS5kYik7XG4gIH1cblxuICBhc3luYyBsaXN0RGF0YWJhc2VzKG9wdGlvbnM6IHtcbiAgICBmaWx0ZXI/OiBEb2N1bWVudDtcbiAgICBuYW1lT25seT86IGJvb2xlYW47XG4gICAgYXV0aG9yaXplZENvbGxlY3Rpb25zPzogYm9vbGVhbjtcbiAgICBjb21tZW50PzogRG9jdW1lbnQ7XG4gIH0gPSB7fSk6IFByb21pc2U8TGlzdERhdGFiYXNlSW5mb1tdPiB7XG4gICAgYXNzZXJ0KHRoaXMuI2NsdXN0ZXIpO1xuICAgIGNvbnN0IHsgZGF0YWJhc2VzIH0gPSBhd2FpdCB0aGlzLiNjbHVzdGVyLnByb3RvY29sLmNvbW1hbmRTaW5nbGUoXCJhZG1pblwiLCB7XG4gICAgICBsaXN0RGF0YWJhc2VzOiAxLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YWJhc2VzO1xuICB9XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgcnVuQ29tbWFuZDxUID0gYW55PihkYjogc3RyaW5nLCBib2R5OiBEb2N1bWVudCk6IFByb21pc2U8VD4ge1xuICAgIGFzc2VydCh0aGlzLiNjbHVzdGVyKTtcbiAgICByZXR1cm4gdGhpcy4jY2x1c3Rlci5wcm90b2NvbC5jb21tYW5kU2luZ2xlKGRiLCBib2R5KTtcbiAgfVxuXG4gIGRhdGFiYXNlKG5hbWUgPSB0aGlzLiNkZWZhdWx0RGJOYW1lKTogRGF0YWJhc2Uge1xuICAgIGFzc2VydCh0aGlzLiNjbHVzdGVyKTtcbiAgICByZXR1cm4gbmV3IERhdGFiYXNlKHRoaXMuI2NsdXN0ZXIsIG5hbWUpO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgaWYgKHRoaXMuI2NsdXN0ZXIpIHRoaXMuI2NsdXN0ZXIuY2xvc2UoKTtcbiAgfVxufVxuIl19
import { Bson } from "../../deps.ts";
import { MongoDriverError, MongoInvalidArgumentError } from "../error.ts";
import { AggregateCursor } from "./commands/aggregate.ts";
import { FindCursor } from "./commands/find.ts";
import { ListIndexesCursor } from "./commands/list_indexes.ts";
import { update } from "./commands/update.ts";
export class Collection {
    name;
    #protocol;
    #dbName;
    constructor(protocol, dbName, name) {
        this.name = name;
        this.#protocol = protocol;
        this.#dbName = dbName;
    }
    find(filter, options) {
        return new FindCursor({
            filter,
            protocol: this.#protocol,
            collectionName: this.name,
            dbName: this.#dbName,
            options: options ?? {},
        });
    }
    findOne(filter, options) {
        const cursor = this.find(filter, options);
        return cursor.next();
    }
    async findAndModify(filter, options) {
        const result = await this.#protocol.commandSingle(this.#dbName, {
            findAndModify: this.name,
            query: filter,
            ...options,
        });
        if (result.ok === 0) {
            throw new MongoDriverError("Could not execute findAndModify operation");
        }
        return result.value;
    }
    async count(filter, options) {
        const res = await this.#protocol.commandSingle(this.#dbName, {
            count: this.name,
            query: filter,
            ...options,
        });
        const { n, ok } = res;
        if (ok === 1) {
            return n;
        }
        else {
            return 0;
        }
    }
    async countDocuments(filter, options) {
        const pipeline = [];
        if (filter) {
            pipeline.push({ $match: filter });
        }
        if (typeof options?.skip === "number") {
            pipeline.push({ $skip: options.limit });
            delete options.skip;
        }
        if (typeof options?.limit === "number") {
            pipeline.push({ $limit: options.limit });
            delete options.limit;
        }
        pipeline.push({ $group: { _id: 1, n: { $sum: 1 } } });
        const result = await this.aggregate(pipeline, options).next();
        if (result)
            return result.n;
        return 0;
    }
    async estimatedDocumentCount() {
        const pipeline = [
            { $collStats: { count: {} } },
            { $group: { _id: 1, n: { $sum: "$count" } } },
        ];
        const result = await this.aggregate(pipeline).next();
        if (result)
            return result.n;
        return 0;
    }
    async insertOne(doc, options) {
        const { insertedIds } = await this.insertMany([doc], options);
        return insertedIds[0];
    }
    insert(docs, options) {
        docs = Array.isArray(docs) ? docs : [docs];
        return this.insertMany(docs, options);
    }
    async insertMany(docs, options) {
        const insertedIds = docs.map((doc) => {
            if (!doc._id) {
                doc._id = new Bson.ObjectId();
            }
            return doc._id;
        });
        const res = await this.#protocol.commandSingle(this.#dbName, {
            insert: this.name,
            documents: docs,
            ordered: options?.ordered ?? true,
            writeConcern: options?.writeConcern,
            bypassDocumentValidation: options?.bypassDocumentValidation,
            comment: options?.comment,
        });
        const { writeErrors } = res;
        if (writeErrors) {
            const [{ errmsg }] = writeErrors;
            throw new Error(errmsg);
        }
        return {
            insertedIds,
            insertedCount: res.n,
        };
    }
    async updateOne(filter, update, options) {
        const { upsertedIds = [], upsertedCount, matchedCount, modifiedCount, } = await this.updateMany(filter, update, {
            ...options,
            multi: false,
        });
        return {
            upsertedId: upsertedIds?.[0],
            upsertedCount,
            matchedCount,
            modifiedCount,
        };
    }
    updateMany(filter, doc, options) {
        if (!hasAtomicOperators(doc)) {
            throw new MongoInvalidArgumentError("Update document requires atomic operators");
        }
        return update(this.#protocol, this.#dbName, this.name, filter, doc, {
            ...options,
            multi: options?.multi ?? true,
        });
    }
    async replaceOne(filter, replacement, options) {
        if (hasAtomicOperators(replacement)) {
            throw new MongoInvalidArgumentError("Replacement document must not contain atomic operators");
        }
        const { upsertedIds = [], upsertedCount, matchedCount, modifiedCount } = await update(this.#protocol, this.#dbName, this.name, filter, replacement, {
            ...options,
            multi: false,
        });
        return {
            upsertedId: upsertedIds?.[0],
            upsertedCount,
            matchedCount,
            modifiedCount,
        };
    }
    async deleteMany(filter, options) {
        const res = await this.#protocol.commandSingle(this.#dbName, {
            delete: this.name,
            deletes: [
                {
                    q: filter,
                    limit: options?.limit ?? 0,
                    collation: options?.collation,
                    hint: options?.hint,
                    comment: options?.comment,
                },
            ],
            ordered: options?.ordered ?? true,
            writeConcern: options?.writeConcern,
        });
        return res.n;
    }
    delete = this.deleteMany;
    deleteOne(filter, options) {
        return this.delete(filter, { ...options, limit: 1 });
    }
    async drop(options) {
        const _res = await this.#protocol.commandSingle(this.#dbName, {
            drop: this.name,
            ...options,
        });
    }
    async distinct(key, query, options) {
        const { values } = await this.#protocol.commandSingle(this.#dbName, {
            distinct: this.name,
            key,
            query,
            ...options,
        });
        return values;
    }
    aggregate(pipeline, options) {
        return new AggregateCursor({
            pipeline,
            protocol: this.#protocol,
            dbName: this.#dbName,
            collectionName: this.name,
            options,
        });
    }
    async createIndexes(options) {
        const res = await this.#protocol.commandSingle(this.#dbName, {
            createIndexes: this.name,
            ...options,
        });
        return res;
    }
    async dropIndexes(options) {
        const res = await this.#protocol.commandSingle(this.#dbName, {
            dropIndexes: this.name,
            ...options,
        });
        return res;
    }
    listIndexes() {
        return new ListIndexesCursor({
            protocol: this.#protocol,
            dbName: this.#dbName,
            collectionName: this.name,
        });
    }
}
export function hasAtomicOperators(doc) {
    if (Array.isArray(doc)) {
        for (const document of doc) {
            if (hasAtomicOperators(document)) {
                return true;
            }
        }
        return false;
    }
    const keys = Object.keys(doc);
    return keys.length > 0 && keys[0][0] === "$";
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFvQjFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTlDLE1BQU0sT0FBTyxVQUFVO0lBSXdDO0lBSDdELFNBQVMsQ0FBZTtJQUN4QixPQUFPLENBQVM7SUFFaEIsWUFBWSxRQUFzQixFQUFFLE1BQWMsRUFBVyxJQUFZO1FBQVosU0FBSSxHQUFKLElBQUksQ0FBUTtRQUN2RSxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUMxQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBSSxDQUNGLE1BQWtCLEVBQ2xCLE9BQXFCO1FBRXJCLE9BQU8sSUFBSSxVQUFVLENBQUk7WUFDdkIsTUFBTTtZQUNOLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN4QixjQUFjLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDekIsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3BCLE9BQU8sRUFBRSxPQUFPLElBQUksRUFBRTtTQUN2QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxDQUNMLE1BQWtCLEVBQ2xCLE9BQXFCO1FBRXJCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzFD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b24gfSBmcm9tIFwiLi4vLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgTW9uZ29Ecml2ZXJFcnJvciwgTW9uZ29JbnZhbGlkQXJndW1lbnRFcnJvciB9IGZyb20gXCIuLi9lcnJvci50c1wiO1xuaW1wb3J0IHsgV2lyZVByb3RvY29sIH0gZnJvbSBcIi4uL3Byb3RvY29sL21vZC50c1wiO1xuaW1wb3J0IHtcbiAgQWdncmVnYXRlT3B0aW9ucyxcbiAgQWdncmVnYXRlUGlwZWxpbmUsXG4gIENvdW50T3B0aW9ucyxcbiAgQ3JlYXRlSW5kZXhPcHRpb25zLFxuICBEZWxldGVPcHRpb25zLFxuICBEaXN0aW5jdE9wdGlvbnMsXG4gIERvY3VtZW50LFxuICBEcm9wSW5kZXhPcHRpb25zLFxuICBEcm9wT3B0aW9ucyxcbiAgRmlsdGVyLFxuICBGaW5kQW5kTW9kaWZ5T3B0aW9ucyxcbiAgRmluZE9wdGlvbnMsXG4gIEluc2VydERvY3VtZW50LFxuICBJbnNlcnRPcHRpb25zLFxuICBVcGRhdGVGaWx0ZXIsXG4gIFVwZGF0ZU9wdGlvbnMsXG59IGZyb20gXCIuLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgQWdncmVnYXRlQ3Vyc29yIH0gZnJvbSBcIi4vY29tbWFuZHMvYWdncmVnYXRlLnRzXCI7XG5pbXBvcnQgeyBGaW5kQ3Vyc29yIH0gZnJvbSBcIi4vY29tbWFuZHMvZmluZC50c1wiO1xuaW1wb3J0IHsgTGlzdEluZGV4ZXNDdXJzb3IgfSBmcm9tIFwiLi9jb21tYW5kcy9saXN0X2luZGV4ZXMudHNcIjtcbmltcG9ydCB7IHVwZGF0ZSB9IGZyb20gXCIuL2NvbW1hbmRzL3VwZGF0ZS50c1wiO1xuXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvbjxUPiB7XG4gICNwcm90b2NvbDogV2lyZVByb3RvY29sO1xuICAjZGJOYW1lOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJvdG9jb2w6IFdpcmVQcm90b2NvbCwgZGJOYW1lOiBzdHJpbmcsIHJlYWRvbmx5IG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuI3Byb3RvY29sID0gcHJvdG9jb2w7XG4gICAgdGhpcy4jZGJOYW1lID0gZGJOYW1lO1xuICB9XG5cbiAgZmluZChcbiAgICBmaWx0ZXI/OiBGaWx0ZXI8VD4sXG4gICAgb3B0aW9ucz86IEZpbmRPcHRpb25zLFxuICApOiBGaW5kQ3Vyc29yPFQ+IHtcbiAgICByZXR1cm4gbmV3IEZpbmRDdXJzb3I8VD4oe1xuICAgICAgZmlsdGVyLFxuICAgICAgcHJvdG9jb2w6IHRoaXMuI3Byb3RvY29sLFxuICAgICAgY29sbGVjdGlvbk5hbWU6IHRoaXMubmFtZSxcbiAgICAgIGRiTmFtZTogdGhpcy4jZGJOYW1lLFxuICAgICAgb3B0aW9uczogb3B0aW9ucyA/PyB7fSxcbiAgICB9KTtcbiAgfVxuXG4gIGZpbmRPbmUoXG4gICAgZmlsdGVyPzogRmlsdGVyPFQ+LFxuICAgIG9wdGlvbnM/OiBGaW5kT3B0aW9ucyxcbiAgKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgY3Vyc29yID0gdGhpcy5maW5kKGZpbHRlciwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIGN1cnNvci5uZXh0KCk7XG4gIH1cblxuICAvKipcbiAgICogRmluZCBhbmQgbW9kaWZ5IGEgZG9jdW1lbnQgaW4gb25lLCByZXR1cm5pbmcgdGhlIG1hdGNoaW5nIGRvY3VtZW50LlxuICAgKlxuICAgKiBAcGFyYW0gcXVlcnkgVGhlIHF1ZXJ5IHVzZWQgdG8gbWF0Y2ggZG9jdW1lbnRzXG4gICAqIEBwYXJhbSBvcHRpb25zIEFkZGl0aW9uYWwgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbiAoZS5nLiBjb250YWluaW5nIHVwZGF0ZVxuICAgKiBvciByZW1vdmUgcGFyYW1ldGVycylcbiAgICogQHJldHVybnMgVGhlIGRvY3VtZW50IG1hdGNoZWQgYW5kIG1vZGlmaWVkXG4gICAqL1xuICBhc3luYyBmaW5kQW5kTW9kaWZ5KFxuICAgIGZpbHRlcj86IEZpbHRlcjxUPixcbiAgICBvcHRpb25zPzogRmluZEFuZE1vZGlmeU9wdGlvbnM8VD4sXG4gICk6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuI3Byb3RvY29sLmNvbW1hbmRTaW5nbGU8e1xuICAgICAgdmFsdWU6IFQ7XG4gICAgICBvazogbnVtYmVyO1xuICAgICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICAgIGxhc3RFcnJvck9iamVjdDogYW55O1xuICAgIH0+KHRoaXMuI2RiTmFtZSwge1xuICAgICAgZmluZEFuZE1vZGlmeTogdGhpcy5uYW1lLFxuICAgICAgcXVlcnk6IGZpbHRlcixcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG4gICAgaWYgKHJlc3VsdC5vayA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IE1vbmdvRHJpdmVyRXJyb3IoXCJDb3VsZCBub3QgZXhlY3V0ZSBmaW5kQW5kTW9kaWZ5IG9wZXJhdGlvblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdC52YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYGNvdW50RG9jdW1lbnRzYCBvciBgZXN0aW1hdGVkRG9jdW1lbnRDb3VudGAgaW5zdGVhZFxuICAgKi9cbiAgYXN5bmMgY291bnQoXG4gICAgZmlsdGVyPzogRmlsdGVyPFQ+LFxuICAgIG9wdGlvbnM/OiBDb3VudE9wdGlvbnMsXG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy4jcHJvdG9jb2wuY29tbWFuZFNpbmdsZSh0aGlzLiNkYk5hbWUsIHtcbiAgICAgIGNvdW50OiB0aGlzLm5hbWUsXG4gICAgICBxdWVyeTogZmlsdGVyLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9KTtcbiAgICBjb25zdCB7IG4sIG9rIH0gPSByZXM7XG4gICAgaWYgKG9rID09PSAxKSB7XG4gICAgICByZXR1cm4gbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY291bnREb2N1bWVudHMoXG4gICAgZmlsdGVyPzogRmlsdGVyPFQ+LFxuICAgIG9wdGlvbnM/OiBDb3VudE9wdGlvbnMsXG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcGlwZWxpbmU6IEFnZ3JlZ2F0ZVBpcGVsaW5lPFQ+W10gPSBbXTtcbiAgICBpZiAoZmlsdGVyKSB7XG4gICAgICBwaXBlbGluZS5wdXNoKHsgJG1hdGNoOiBmaWx0ZXIgfSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zPy5za2lwID09PSBcIm51bWJlclwiKSB7XG4gICAgICBwaXBlbGluZS5wdXNoKHsgJHNraXA6IG9wdGlvbnMubGltaXQgfSk7XG4gICAgICBkZWxldGUgb3B0aW9ucy5za2lwO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucz8ubGltaXQgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgIHBpcGVsaW5lLnB1c2goeyAkbGltaXQ6IG9wdGlvbnMubGltaXQgfSk7XG4gICAgICBkZWxldGUgb3B0aW9ucy5saW1pdDtcbiAgICB9XG5cbiAgICBwaXBlbGluZS5wdXNoKHsgJGdyb3VwOiB7IF9pZDogMSwgbjogeyAkc3VtOiAxIH0gfSB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYWdncmVnYXRlPHsgbjogbnVtYmVyIH0+KFxuICAgICAgcGlwZWxpbmUsXG4gICAgICBvcHRpb25zIGFzIEFnZ3JlZ2F0ZU9wdGlvbnMsXG4gICAgKS5uZXh0KCk7XG4gICAgaWYgKHJlc3VsdCkgcmV0dXJuIHJlc3VsdC5uO1xuICAgIHJldHVybiAwO1xuICB9XG5cbiAgYXN5bmMgZXN0aW1hdGVkRG9jdW1lbnRDb3VudCgpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHBpcGVsaW5lID0gW1xuICAgICAgeyAkY29sbFN0YXRzOiB7IGNvdW50OiB7fSB9IH0sXG4gICAgICB7ICRncm91cDogeyBfaWQ6IDEsIG46IHsgJHN1bTogXCIkY291bnRcIiB9IH0gfSxcbiAgICBdO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5hZ2dyZWdhdGU8eyBuOiBudW1iZXIgfT4ocGlwZWxpbmUpLm5leHQoKTtcbiAgICBpZiAocmVzdWx0KSByZXR1cm4gcmVzdWx0Lm47XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICBhc3luYyBpbnNlcnRPbmUoZG9jOiBJbnNlcnREb2N1bWVudDxUPiwgb3B0aW9ucz86IEluc2VydE9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGluc2VydGVkSWRzIH0gPSBhd2FpdCB0aGlzLmluc2VydE1hbnkoW2RvY10sIG9wdGlvbnMpO1xuICAgIHJldHVybiBpbnNlcnRlZElkc1swXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYGluc2VydE9uZSwgaW5zZXJ0TWFueWAgb3IgYGJ1bGtXcml0ZWAgaW5zdGVhZC5cbiAgICovXG4gIGluc2VydChcbiAgICBkb2NzOiBJbnNlcnREb2N1bWVudDxUPiB8IEluc2VydERvY3VtZW50PFQ+W10sXG4gICAgb3B0aW9ucz86IEluc2VydE9wdGlvbnMsXG4gICkge1xuICAgIGRvY3MgPSBBcnJheS5pc0FycmF5KGRvY3MpID8gZG9jcyA6IFtkb2NzXTtcbiAgICByZXR1cm4gdGhpcy5pbnNlcnRNYW55KGRvY3MsIG9wdGlvbnMpO1xuICB9XG5cbiAgYXN5bmMgaW5zZXJ0TWFueShcbiAgICBkb2NzOiBJbnNlcnREb2N1bWVudDxUPltdLFxuICAgIG9wdGlvbnM/OiBJbnNlcnRPcHRpb25zLFxuICApOiBQcm9taXNlPFxuICAgIHtcbiAgICAgIGluc2VydGVkSWRzOiAoQnNvbi5PYmplY3RJZCB8IFJlcXVpcmVkPEluc2VydERvY3VtZW50PFQ+PltcIl9pZFwiXSlbXTtcbiAgICAgIGluc2VydGVkQ291bnQ6IG51bWJlcjtcbiAgICB9XG4gID4ge1xuICAgIGNvbnN0IGluc2VydGVkSWRzID0gZG9jcy5tYXAoKGRvYykgPT4ge1xuICAgICAgaWYgKCFkb2MuX2lkKSB7XG4gICAgICAgIGRvYy5faWQgPSBuZXcgQnNvbi5PYmplY3RJZCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZG9jLl9pZDtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuI3Byb3RvY29sLmNvbW1hbmRTaW5nbGUodGhpcy4jZGJOYW1lLCB7XG4gICAgICBpbnNlcnQ6IHRoaXMubmFtZSxcbiAgICAgIGRvY3VtZW50czogZG9jcyxcbiAgICAgIG9yZGVyZWQ6IG9wdGlvbnM/Lm9yZGVyZWQgPz8gdHJ1ZSxcbiAgICAgIHdyaXRlQ29uY2Vybjogb3B0aW9ucz8ud3JpdGVDb25jZXJuLFxuICAgICAgYnlwYXNzRG9jdW1lbnRWYWxpZGF0aW9uOiBvcHRpb25zPy5ieXBhc3NEb2N1bWVudFZhbGlkYXRpb24sXG4gICAgICBjb21tZW50OiBvcHRpb25zPy5jb21tZW50LFxuICAgIH0pO1xuICAgIGNvbnN0IHsgd3JpdGVFcnJvcnMgfSA9IHJlcztcbiAgICBpZiAod3JpdGVFcnJvcnMpIHtcbiAgICAgIGNvbnN0IFt7IGVycm1zZyB9XSA9IHdyaXRlRXJyb3JzO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm1zZyk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBpbnNlcnRlZElkcyxcbiAgICAgIGluc2VydGVkQ291bnQ6IHJlcy5uLFxuICAgIH07XG4gIH1cblxuICBhc3luYyB1cGRhdGVPbmUoXG4gICAgZmlsdGVyOiBGaWx0ZXI8VD4sXG4gICAgdXBkYXRlOiBVcGRhdGVGaWx0ZXI8VD4sXG4gICAgb3B0aW9ucz86IFVwZGF0ZU9wdGlvbnMsXG4gICkge1xuICAgIGNvbnN0IHtcbiAgICAgIHVwc2VydGVkSWRzID0gW10sXG4gICAgICB1cHNlcnRlZENvdW50LFxuICAgICAgbWF0Y2hlZENvdW50LFxuICAgICAgbW9kaWZpZWRDb3VudCxcbiAgICB9ID0gYXdhaXQgdGhpcy51cGRhdGVNYW55KGZpbHRlciwgdXBkYXRlLCB7XG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgbXVsdGk6IGZhbHNlLFxuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICB1cHNlcnRlZElkOiB1cHNlcnRlZElkcz8uWzBdLFxuICAgICAgdXBzZXJ0ZWRDb3VudCxcbiAgICAgIG1hdGNoZWRDb3VudCxcbiAgICAgIG1vZGlmaWVkQ291bnQsXG4gICAgfTtcbiAgfVxuXG4gIHVwZGF0ZU1hbnkoXG4gICAgZmlsdGVyOiBGaWx0ZXI8VD4sXG4gICAgZG9jOiBVcGRhdGVGaWx0ZXI8VD4sXG4gICAgb3B0aW9ucz86IFVwZGF0ZU9wdGlvbnMsXG4gICkge1xuICAgIGlmICghaGFzQXRvbWljT3BlcmF0b3JzKGRvYykpIHtcbiAgICAgIHRocm93IG5ldyBNb25nb0ludmFsaWRBcmd1bWVudEVycm9yKFxuICAgICAgICBcIlVwZGF0ZSBkb2N1bWVudCByZXF1aXJlcyBhdG9taWMgb3BlcmF0b3JzXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB1cGRhdGUodGhpcy4jcHJvdG9jb2wsIHRoaXMuI2RiTmFtZSwgdGhpcy5uYW1lLCBmaWx0ZXIsIGRvYywge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIG11bHRpOiBvcHRpb25zPy5tdWx0aSA/PyB0cnVlLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcmVwbGFjZU9uZShcbiAgICBmaWx0ZXI6IEZpbHRlcjxUPixcbiAgICByZXBsYWNlbWVudDogSW5zZXJ0RG9jdW1lbnQ8VD4sXG4gICAgb3B0aW9ucz86IFVwZGF0ZU9wdGlvbnMsXG4gICkge1xuICAgIGlmIChoYXNBdG9taWNPcGVyYXRvcnMocmVwbGFjZW1lbnQpKSB7XG4gICAgICB0aHJvdyBuZXcgTW9uZ29JbnZhbGlkQXJndW1lbnRFcnJvcihcbiAgICAgICAgXCJSZXBsYWNlbWVudCBkb2N1bWVudCBtdXN0IG5vdCBjb250YWluIGF0b21pYyBvcGVyYXRvcnNcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB1cHNlcnRlZElkcyA9IFtdLCB1cHNlcnRlZENvdW50LCBtYXRjaGVkQ291bnQsIG1vZGlmaWVkQ291bnQgfSA9XG4gICAgICBhd2FpdCB1cGRhdGUoXG4gICAgICAgIHRoaXMuI3Byb3RvY29sLFxuICAgICAgICB0aGlzLiNkYk5hbWUsXG4gICAgICAgIHRoaXMubmFtZSxcbiAgICAgICAgZmlsdGVyLFxuICAgICAgICByZXBsYWNlbWVudCxcbiAgICAgICAge1xuICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgbXVsdGk6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICB1cHNlcnRlZElkOiB1cHNlcnRlZElkcz8uWzBdLFxuICAgICAgdXBzZXJ0ZWRDb3VudCxcbiAgICAgIG1hdGNoZWRDb3VudCxcbiAgICAgIG1vZGlmaWVkQ291bnQsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZU1hbnkoXG4gICAgZmlsdGVyOiBGaWx0ZXI8VD4sXG4gICAgb3B0aW9ucz86IERlbGV0ZU9wdGlvbnMsXG4gICk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy4jcHJvdG9jb2wuY29tbWFuZFNpbmdsZSh0aGlzLiNkYk5hbWUsIHtcbiAgICAgIGRlbGV0ZTogdGhpcy5uYW1lLFxuICAgICAgZGVsZXRlczogW1xuICAgICAgICB7XG4gICAgICAgICAgcTogZmlsdGVyLFxuICAgICAgICAgIGxpbWl0OiBvcHRpb25zPy5saW1pdCA/PyAwLFxuICAgICAgICAgIGNvbGxhdGlvbjogb3B0aW9ucz8uY29sbGF0aW9uLFxuICAgICAgICAgIGhpbnQ6IG9wdGlvbnM/LmhpbnQsXG4gICAgICAgICAgY29tbWVudDogb3B0aW9ucz8uY29tbWVudCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBvcmRlcmVkOiBvcHRpb25zPy5vcmRlcmVkID8/IHRydWUsXG4gICAgICB3cml0ZUNvbmNlcm46IG9wdGlvbnM/LndyaXRlQ29uY2VybixcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzLm47XG4gIH1cblxuICBkZWxldGUgPSB0aGlzLmRlbGV0ZU1hbnk7XG5cbiAgZGVsZXRlT25lKFxuICAgIGZpbHRlcjogRmlsdGVyPFQ+LFxuICAgIG9wdGlvbnM/OiBEZWxldGVPcHRpb25zLFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5kZWxldGUoZmlsdGVyLCB7IC4uLm9wdGlvbnMsIGxpbWl0OiAxIH0pO1xuICB9XG5cbiAgYXN5bmMgZHJvcChvcHRpb25zPzogRHJvcE9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBfcmVzID0gYXdhaXQgdGhpcy4jcHJvdG9jb2wuY29tbWFuZFNpbmdsZSh0aGlzLiNkYk5hbWUsIHtcbiAgICAgIGRyb3A6IHRoaXMubmFtZSxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkaXN0aW5jdChrZXk6IHN0cmluZywgcXVlcnk/OiBGaWx0ZXI8VD4sIG9wdGlvbnM/OiBEaXN0aW5jdE9wdGlvbnMpIHtcbiAgICBjb25zdCB7IHZhbHVlcyB9ID0gYXdhaXQgdGhpcy4jcHJvdG9jb2wuY29tbWFuZFNpbmdsZSh0aGlzLiNkYk5hbWUsIHtcbiAgICAgIGRpc3RpbmN0OiB0aGlzLm5hbWUsXG4gICAgICBrZXksXG4gICAgICBxdWVyeSxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG4gICAgcmV0dXJuIHZhbHVlcztcbiAgfVxuXG4gIGFnZ3JlZ2F0ZTxVID0gVD4oXG4gICAgcGlwZWxpbmU6IEFnZ3JlZ2F0ZVBpcGVsaW5lPFU+W10sXG4gICAgb3B0aW9ucz86IEFnZ3JlZ2F0ZU9wdGlvbnMsXG4gICk6IEFnZ3JlZ2F0ZUN1cnNvcjxVPiB7XG4gICAgcmV0dXJuIG5ldyBBZ2dyZWdhdGVDdXJzb3I8VT4oe1xuICAgICAgcGlwZWxpbmUsXG4gICAgICBwcm90b2NvbDogdGhpcy4jcHJvdG9jb2wsXG4gICAgICBkYk5hbWU6IHRoaXMuI2RiTmFtZSxcbiAgICAgIGNvbGxlY3Rpb25OYW1lOiB0aGlzLm5hbWUsXG4gICAgICBvcHRpb25zLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlSW5kZXhlcyhvcHRpb25zOiBDcmVhdGVJbmRleE9wdGlvbnMpIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLiNwcm90b2NvbC5jb21tYW5kU2luZ2xlPHtcbiAgICAgIG9rOiBudW1iZXI7XG4gICAgICBjcmVhdGVkQ29sbGVjdGlvbkF1dG9tYXRpY2FsbHk6IGJvb2xlYW47XG4gICAgICBudW1JbmRleGVzQmVmb3JlOiBudW1iZXI7XG4gICAgICBudW1JbmRleGVzQWZ0ZXI6IG51bWJlcjtcbiAgICB9Pih0aGlzLiNkYk5hbWUsIHtcbiAgICAgIGNyZWF0ZUluZGV4ZXM6IHRoaXMubmFtZSxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGFzeW5jIGRyb3BJbmRleGVzKG9wdGlvbnM6IERyb3BJbmRleE9wdGlvbnMpIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLiNwcm90b2NvbC5jb21tYW5kU2luZ2xlPHtcbiAgICAgIG9rOiBudW1iZXI7XG4gICAgICBuSW5kZXhlc1dhczogbnVtYmVyO1xuICAgIH0+KFxuICAgICAgdGhpcy4jZGJOYW1lLFxuICAgICAge1xuICAgICAgICBkcm9wSW5kZXhlczogdGhpcy5uYW1lLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGxpc3RJbmRleGVzKCkge1xuICAgIHJldHVybiBuZXcgTGlzdEluZGV4ZXNDdXJzb3I8XG4gICAgICB7IHY6IG51bWJlcjsga2V5OiBEb2N1bWVudDsgbmFtZTogc3RyaW5nOyBucz86IHN0cmluZyB9XG4gICAgPih7XG4gICAgICBwcm90b2NvbDogdGhpcy4jcHJvdG9jb2wsXG4gICAgICBkYk5hbWU6IHRoaXMuI2RiTmFtZSxcbiAgICAgIGNvbGxlY3Rpb25OYW1lOiB0aGlzLm5hbWUsXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0F0b21pY09wZXJhdG9ycyhkb2M6IEJzb24uRG9jdW1lbnQgfCBCc29uLkRvY3VtZW50W10pIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoZG9jKSkge1xuICAgIGZvciAoY29uc3QgZG9jdW1lbnQgb2YgZG9jKSB7XG4gICAgICBpZiAoaGFzQXRvbWljT3BlcmF0b3JzKGRvY3VtZW50KSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhkb2MpO1xuICByZXR1cm4ga2V5cy5sZW5ndGggPiAwICYmIGtleXNbMF1bMF0gPT09IFwiJFwiO1xufVxuIl19
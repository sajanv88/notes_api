import { readerFromStreamReader } from "./deps.ts";
import { httpErrors } from "./httpError.ts";
import { isMediaType } from "./isMediaType.ts";
import { FormDataReader } from "./multipart.ts";
import { assert } from "./util.ts";
const DEFAULT_LIMIT = 10_485_760;
const defaultBodyContentTypes = {
    json: ["json", "application/*+json", "application/csp-report"],
    form: ["urlencoded"],
    formData: ["multipart"],
    text: ["text"],
};
function resolveType(contentType, contentTypes) {
    const contentTypesJson = [
        ...defaultBodyContentTypes.json,
        ...(contentTypes.json ?? []),
    ];
    const contentTypesForm = [
        ...defaultBodyContentTypes.form,
        ...(contentTypes.form ?? []),
    ];
    const contentTypesFormData = [
        ...defaultBodyContentTypes.formData,
        ...(contentTypes.formData ?? []),
    ];
    const contentTypesText = [
        ...defaultBodyContentTypes.text,
        ...(contentTypes.text ?? []),
    ];
    if (contentTypes.bytes && isMediaType(contentType, contentTypes.bytes)) {
        return "bytes";
    }
    else if (isMediaType(contentType, contentTypesJson)) {
        return "json";
    }
    else if (isMediaType(contentType, contentTypesForm)) {
        return "form";
    }
    else if (isMediaType(contentType, contentTypesFormData)) {
        return "form-data";
    }
    else if (isMediaType(contentType, contentTypesText)) {
        return "text";
    }
    return "bytes";
}
const decoder = new TextDecoder();
export class RequestBody {
    #formDataReader;
    #stream;
    #readAllBody;
    #request;
    #type;
    #exceedsLimit(limit) {
        if (!limit || limit === Infinity) {
            return false;
        }
        if (!this.#request.body) {
            return false;
        }
        const contentLength = this.#request.headers.get("content-length");
        if (!contentLength) {
            return true;
        }
        const parsed = parseInt(contentLength, 10);
        if (isNaN(parsed)) {
            return true;
        }
        return parsed > limit;
    }
    #parse(type, limit) {
        switch (type) {
            case "form":
                this.#type = "bytes";
                if (this.#exceedsLimit(limit)) {
                    return () => Promise.reject(new RangeError(`Body exceeds a limit of ${limit}.`));
                }
                return async () => new URLSearchParams(decoder.decode(await this.#valuePromise()).replace(/\+/g, " "));
            case "form-data":
                this.#type = "form-data";
                return () => {
                    const contentType = this.#request.headers.get("content-type");
                    assert(contentType);
                    const readableStream = this.#request.body ?? new ReadableStream();
                    return this.#formDataReader ??
                        (this.#formDataReader = new FormDataReader(contentType, readerFromStreamReader(readableStream.getReader())));
                };
            case "json":
                this.#type = "bytes";
                if (this.#exceedsLimit(limit)) {
                    return () => Promise.reject(new RangeError(`Body exceeds a limit of ${limit}.`));
                }
                return async () => JSON.parse(decoder.decode(await this.#valuePromise()));
            case "bytes":
                this.#type = "bytes";
                if (this.#exceedsLimit(limit)) {
                    return () => Promise.reject(new RangeError(`Body exceeds a limit of ${limit}.`));
                }
                return () => this.#valuePromise();
            case "text":
                this.#type = "bytes";
                if (this.#exceedsLimit(limit)) {
                    return () => Promise.reject(new RangeError(`Body exceeds a limit of ${limit}.`));
                }
                return async () => decoder.decode(await this.#valuePromise());
            default:
                throw new TypeError(`Invalid body type: "${type}"`);
        }
    }
    #validateGetArgs(type, contentTypes) {
        if (type === "reader" && this.#type && this.#type !== "reader") {
            throw new TypeError(`Body already consumed as "${this.#type}" and cannot be returned as a reader.`);
        }
        if (type === "stream" && this.#type && this.#type !== "stream") {
            throw new TypeError(`Body already consumed as "${this.#type}" and cannot be returned as a stream.`);
        }
        if (type === "form-data" && this.#type && this.#type !== "form-data") {
            throw new TypeError(`Body already consumed as "${this.#type}" and cannot be returned as a stream.`);
        }
        if (this.#type === "reader" && type !== "reader") {
            throw new TypeError("Body already consumed as a reader and can only be returned as a reader.");
        }
        if (this.#type === "stream" && type !== "stream") {
            throw new TypeError("Body already consumed as a stream and can only be returned as a stream.");
        }
        if (this.#type === "form-data" && type !== "form-data") {
            throw new TypeError("Body already consumed as form data and can only be returned as form data.");
        }
        if (type && Object.keys(contentTypes).length) {
            throw new TypeError(`"type" and "contentTypes" cannot be specified at the same time`);
        }
    }
    #valuePromise() {
        return this.#readAllBody ??
            (this.#readAllBody = this.#request.arrayBuffer().then((ab) => new Uint8Array(ab)));
    }
    constructor(request) {
        this.#request = request;
    }
    get({ limit = DEFAULT_LIMIT, type, contentTypes = {} } = {}) {
        this.#validateGetArgs(type, contentTypes);
        if (type === "reader") {
            if (!this.#request.body) {
                this.#type = "undefined";
                throw new TypeError(`Body is undefined and cannot be returned as "reader".`);
            }
            this.#type = "reader";
            return {
                type,
                value: readerFromStreamReader(this.#request.body.getReader()),
            };
        }
        if (type === "stream") {
            if (!this.#request.body) {
                this.#type = "undefined";
                throw new TypeError(`Body is undefined and cannot be returned as "stream".`);
            }
            this.#type = "stream";
            const streams = (this.#stream ?? this.#request.body).tee();
            this.#stream = streams[1];
            return { type, value: streams[0] };
        }
        if (!this.has()) {
            this.#type = "undefined";
        }
        else if (!this.#type) {
            const encoding = this.#request.headers.get("content-encoding") ??
                "identity";
            if (encoding !== "identity") {
                throw new httpErrors.UnsupportedMediaType(`Unsupported content-encoding: ${encoding}`);
            }
        }
        if (this.#type === "undefined" && (!type || type === "undefined")) {
            return { type: "undefined", value: undefined };
        }
        if (!type) {
            const contentType = this.#request.headers.get("content-type");
            assert(contentType, "The Content-Type header is missing from the request");
            type = resolveType(contentType, contentTypes);
        }
        assert(type);
        const body = Object.create(null);
        Object.defineProperties(body, {
            type: {
                value: type,
                configurable: true,
                enumerable: true,
            },
            value: {
                get: this.#parse(type, limit),
                configurable: true,
                enumerable: true,
            },
        });
        return body;
    }
    has() {
        return this.#request.body != null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9keS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJvZHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUEwRm5DLE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQztBQUVqQyxNQUFNLHVCQUF1QixHQUFHO0lBQzlCLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSx3QkFBd0IsQ0FBQztJQUM5RCxJQUFJLEVBQUUsQ0FBQyxZQUFZLENBQUM7SUFDcEIsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDO0lBQ3ZCLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQztDQUNmLENBQUM7QUFFRixTQUFTLFdBQVcsQ0FDbEIsV0FBbUIsRUFDbkIsWUFBcUM7SUFFckMsTUFBTSxnQkFBZ0IsR0FBRztRQUN2QixHQUFHLHVCQUF1QixDQUFDLElBQUk7UUFDL0IsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO0tBQzdCLENBQUM7SUFDRixNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLEdBQUcsdUJBQXVCLENBQUMsSUFBSTtRQUMvQixHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7S0FDN0IsQ0FBQztJQUNGLE1BQU0sb0JBQW9CLEdBQUc7UUFDM0IsR0FBRyx1QkFBdUIsQ0FBQyxRQUFRO1FBQ25DLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztLQUNqQyxDQUFDO0lBQ0YsTUFBTSxnQkFBZ0IsR0FBRztR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SSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzlELE1BQU0sQ0FDSixXQUFXLEVBQ1gscURBQXFELENBQ3RELENBQUM7WUFDRixJQUFJLEdBQUcsV0FBVyxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUMvQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNiLE1BQU0sSUFBSSxHQUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRTtZQUM1QixJQUFJLEVBQUU7Z0JBQ0osS0FBSyxFQUFFLElBQUk7Z0JBQ1gsWUFBWSxFQUFFLElBQUk7Z0JBQ2xCLFVBQVUsRUFBRSxJQUFJO2FBQ2pCO1lBQ0QsS0FBSyxFQUFFO2dCQUNMLEdBQUcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7Z0JBQzdCLFlBQVksRUFBRSxJQUFJO2dCQUNsQixVQUFVLEVBQUUsSUFBSTthQUNqQjtTQUNGLENBQUMsQ0FBQztRQUNILE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQVVELEdBQUc7UUFDRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQztJQUNwQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB7IHJlYWRlckZyb21TdHJlYW1SZWFkZXIgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBodHRwRXJyb3JzIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQgeyBpc01lZGlhVHlwZSB9IGZyb20gXCIuL2lzTWVkaWFUeXBlLnRzXCI7XG5pbXBvcnQgeyBGb3JtRGF0YVJlYWRlciB9IGZyb20gXCIuL211bHRpcGFydC50c1wiO1xuaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSBcIi4vdXRpbC50c1wiO1xuXG5leHBvcnQgdHlwZSBCb2R5VHlwZSA9XG4gIHwgXCJieXRlc1wiXG4gIHwgXCJmb3JtXCJcbiAgfCBcImZvcm0tZGF0YVwiXG4gIHwgXCJqc29uXCJcbiAgfCBcInRleHRcIlxuICB8IFwicmVhZGVyXCJcbiAgfCBcInN0cmVhbVwiXG4gIHwgXCJ1bmRlZmluZWRcIjtcblxuZXhwb3J0IHR5cGUgQm9keUJ5dGVzID0ge1xuICByZWFkb25seSB0eXBlOiBcImJ5dGVzXCI7XG4gIHJlYWRvbmx5IHZhbHVlOiBQcm9taXNlPFVpbnQ4QXJyYXk+O1xufTtcbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5leHBvcnQgdHlwZSBCb2R5SnNvbiA9IHsgcmVhZG9ubHkgdHlwZTogXCJqc29uXCI7IHJlYWRvbmx5IHZhbHVlOiBQcm9taXNlPGFueT4gfTtcbmV4cG9ydCB0eXBlIEJvZHlGb3JtID0ge1xuICByZWFkb25seSB0eXBlOiBcImZvcm1cIjtcbiAgcmVhZG9ubHkgdmFsdWU6IFByb21pc2U8VVJMU2VhcmNoUGFyYW1zPjtcbn07XG5leHBvcnQgdHlwZSBCb2R5Rm9ybURhdGEgPSB7XG4gIHJlYWRvbmx5IHR5cGU6IFwiZm9ybS1kYXRhXCI7XG4gIHJlYWRvbmx5IHZhbHVlOiBGb3JtRGF0YVJlYWRlcjtcbn07XG5leHBvcnQgdHlwZSBCb2R5VGV4dCA9IHtcbiAgcmVhZG9ubHkgdHlwZTogXCJ0ZXh0XCI7XG4gIHJlYWRvbmx5IHZhbHVlOiBQcm9taXNlPHN0cmluZz47XG59O1xuZXhwb3J0IHR5cGUgQm9keVVuZGVmaW5lZCA9IHtcbiAgcmVhZG9ubHkgdHlwZTogXCJ1bmRlZmluZWRcIjtcbiAgcmVhZG9ubHkgdmFsdWU6IHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydCB0eXBlIEJvZHlSZWFkZXIgPSB7XG4gIHJlYWRvbmx5IHR5cGU6IFwicmVhZGVyXCI7XG4gIHJlYWRvbmx5IHZhbHVlOiBEZW5vLlJlYWRlcjtcbn07XG5leHBvcnQgdHlwZSBCb2R5U3RyZWFtID0ge1xuICByZWFkb25seSB0eXBlOiBcInN0cmVhbVwiO1xuICByZWFkb25seSB2YWx1ZTogUmVhZGFibGVTdHJlYW08VWludDhBcnJheT47XG59O1xuXG5leHBvcnQgdHlwZSBCb2R5ID1cbiAgfCBCb2R5Qnl0ZXNcbiAgfCBCb2R5SnNvblxuICB8IEJvZHlGb3JtXG4gIHwgQm9keUZvcm1EYXRhXG4gIHwgQm9keVRleHRcbiAgfCBCb2R5VW5kZWZpbmVkO1xuXG50eXBlIEJvZHlWYWx1ZUdldHRlciA9ICgpID0+IEJvZHlbXCJ2YWx1ZVwiXTtcblxuZXhwb3J0IGludGVyZmFjZSBCb2R5T3B0aW9uc0NvbnRlbnRUeXBlcyB7XG4gIC8qKiBDb250ZW50IHR5cGVzIGxpc3RlZCBoZXJlIHdpbGwgYWx3YXlzIHJldHVybiBhbiBVaW50OEFycmF5LiAqL1xuICBieXRlcz86IHN0cmluZ1tdO1xuICAvKiogQ29udGVudCB0eXBlcyBsaXN0ZWQgaGVyZSB3aWxsIGJlIHBhcnNlZCBhcyBhIEpTT04gc3RyaW5nLiAqL1xuICBqc29uPzogc3RyaW5nW107XG4gIC8qKiBDb250ZW50IHR5cGVzIGxpc3RlZCBoZXJlIHdpbGwgYmUgcGFyc2VkIGFzIGZvcm0gZGF0YSBhbmQgcmV0dXJuXG4gICAqIGBVUkxTZWFyY2hQYXJhbWV0ZXJzYCBhcyB0aGUgdmFsdWUgb2YgdGhlIGJvZHkuICovXG4gIGZvcm0/OiBzdHJpbmdbXTtcbiAgLyoqIENvbnRlbnQgdHlwZXMgbGlzdGVkIGhlcmUgd2lsbCBiZSBwYXJzZWQgYXMgZnJvbSBkYXRhIGFuZCByZXR1cm4gYVxuICAgKiBgRm9ybURhdGFCb2R5YCBpbnRlcmZhY2UgYXMgdGhlIHZhbHVlIG9mIHRoZSBib2R5LiAqL1xuICBmb3JtRGF0YT86IHN0cmluZ1tdO1xuICAvKiogQ29udGVudCB0eXBlcyBsaXN0ZWQgaGVyZSB3aWxsIGJlIHBhcnNlZCBhcyB0ZXh0LiAqL1xuICB0ZXh0Pzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQm9keU9wdGlvbnM8VCBleHRlbmRzIEJvZHlUeXBlID0gQm9keVR5cGU+IHtcbiAgLyoqIFdoZW4gcmVhZGluZyBhIG5vbi1zdHJlYW1pbmcgYm9keSwgc2V0IGEgbGltaXQgd2hlcmVieSBpZiB0aGUgY29udGVudFxuICAgKiBsZW5ndGggaXMgZ3JlYXRlciB0aGVuIHRoZSBsaW1pdCBvciBub3Qgc2V0LCByZWFkaW5nIHRoZSBib2R5IHdpbGwgdGhyb3cuXG4gICAqXG4gICAqIFRoaXMgaXMgdG8gcHJldmVudCBtYWxpY2lvdXMgcmVxdWVzdHMgd2hlcmUgdGhlIGJvZHkgZXhjZWVkcyB0aGUgY2FwYWNpdHlcbiAgICogb2YgdGhlIHNlcnZlci4gU2V0IHRoZSBsaW1pdCB0byAwIHRvIGFsbG93IHVuYm91bmRlZCByZWFkcy4gIFRoZSBkZWZhdWx0XG4gICAqIGlzIDEwIE1pYi4gKi9cbiAgbGltaXQ/OiBudW1iZXI7XG4gIC8qKiBJbnN0ZWFkIG9mIHV0aWxpemluZyB0aGUgY29udGVudCB0eXBlIG9mIHRoZSByZXF1ZXN0LCBhdHRlbXB0IHRvIHBhcnNlIHRoZVxuICAgKiBib2R5IGFzIHRoZSB0eXBlIHNwZWNpZmllZC4gKi9cbiAgdHlwZT86IFQ7XG4gIC8qKiBBIG1hcCBvZiBleHRyYSBjb250ZW50IHR5cGVzIHRvIGRldGVybWluZSBob3cgdG8gcGFyc2UgdGhlIGJvZHkuICovXG4gIGNvbnRlbnRUeXBlcz86IEJvZHlPcHRpb25zQ29udGVudFR5cGVzO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJvZHlDb250ZW50VHlwZXMge1xuICBqc29uPzogc3RyaW5nW107XG4gIGZvcm0/OiBzdHJpbmdbXTtcbiAgdGV4dD86IHN0cmluZ1tdO1xufVxuXG5jb25zdCBERUZBVUxUX0xJTUlUID0gMTBfNDg1Xzc2MDsgLy8gMTBtYlxuXG5jb25zdCBkZWZhdWx0Qm9keUNvbnRlbnRUeXBlcyA9IHtcbiAganNvbjogW1wianNvblwiLCBcImFwcGxpY2F0aW9uLyoranNvblwiLCBcImFwcGxpY2F0aW9uL2NzcC1yZXBvcnRcIl0sXG4gIGZvcm06IFtcInVybGVuY29kZWRcIl0sXG4gIGZvcm1EYXRhOiBbXCJtdWx0aXBhcnRcIl0sXG4gIHRleHQ6IFtcInRleHRcIl0sXG59O1xuXG5mdW5jdGlvbiByZXNvbHZlVHlwZShcbiAgY29udGVudFR5cGU6IHN0cmluZyxcbiAgY29udGVudFR5cGVzOiBCb2R5T3B0aW9uc0NvbnRlbnRUeXBlcyxcbik6IEJvZHlUeXBlIHtcbiAgY29uc3QgY29udGVudFR5cGVzSnNvbiA9IFtcbiAgICAuLi5kZWZhdWx0Qm9keUNvbnRlbnRUeXBlcy5qc29uLFxuICAgIC4uLihjb250ZW50VHlwZXMuanNvbiA/PyBbXSksXG4gIF07XG4gIGNvbnN0IGNvbnRlbnRUeXBlc0Zvcm0gPSBbXG4gICAgLi4uZGVmYXVsdEJvZHlDb250ZW50VHlwZXMuZm9ybSxcbiAgICAuLi4oY29udGVudFR5cGVzLmZvcm0gPz8gW10pLFxuICBdO1xuICBjb25zdCBjb250ZW50VHlwZXNGb3JtRGF0YSA9IFtcbiAgICAuLi5kZWZhdWx0Qm9keUNvbnRlbnRUeXBlcy5mb3JtRGF0YSxcbiAgICAuLi4oY29udGVudFR5cGVzLmZvcm1EYXRhID8/IFtdKSxcbiAgXTtcbiAgY29uc3QgY29udGVudFR5cGVzVGV4dCA9IFtcbiAgICAuLi5kZWZhdWx0Qm9keUNvbnRlbnRUeXBlcy50ZXh0LFxuICAgIC4uLihjb250ZW50VHlwZXMudGV4dCA/PyBbXSksXG4gIF07XG4gIGlmIChjb250ZW50VHlwZXMuYnl0ZXMgJiYgaXNNZWRpYVR5cGUoY29udGVudFR5cGUsIGNvbnRlbnRUeXBlcy5ieXRlcykpIHtcbiAgICByZXR1cm4gXCJieXRlc1wiO1xuICB9IGVsc2UgaWYgKGlzTWVkaWFUeXBlKGNvbnRlbnRUeXBlLCBjb250ZW50VHlwZXNKc29uKSkge1xuICAgIHJldHVybiBcImpzb25cIjtcbiAgfSBlbHNlIGlmIChpc01lZGlhVHlwZShjb250ZW50VHlwZSwgY29udGVudFR5cGVzRm9ybSkpIHtcbiAgICByZXR1cm4gXCJmb3JtXCI7XG4gIH0gZWxzZSBpZiAoaXNNZWRpYVR5cGUoY29udGVudFR5cGUsIGNvbnRlbnRUeXBlc0Zvcm1EYXRhKSkge1xuICAgIHJldHVybiBcImZvcm0tZGF0YVwiO1xuICB9IGVsc2UgaWYgKGlzTWVkaWFUeXBlKGNvbnRlbnRUeXBlLCBjb250ZW50VHlwZXNUZXh0KSkge1xuICAgIHJldHVybiBcInRleHRcIjtcbiAgfVxuICByZXR1cm4gXCJieXRlc1wiO1xufVxuXG5jb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5cbmV4cG9ydCBjbGFzcyBSZXF1ZXN0Qm9keSB7XG4gICNmb3JtRGF0YVJlYWRlcj86IEZvcm1EYXRhUmVhZGVyO1xuICAjc3RyZWFtPzogUmVhZGFibGVTdHJlYW08VWludDhBcnJheT47XG4gICNyZWFkQWxsQm9keT86IFByb21pc2U8VWludDhBcnJheT47XG4gICNyZXF1ZXN0OiBSZXF1ZXN0O1xuICAjdHlwZT86IFwiYnl0ZXNcIiB8IFwiZm9ybS1kYXRhXCIgfCBcInJlYWRlclwiIHwgXCJzdHJlYW1cIiB8IFwidW5kZWZpbmVkXCI7XG5cbiAgI2V4Y2VlZHNMaW1pdChsaW1pdDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgaWYgKCFsaW1pdCB8fCBsaW1pdCA9PT0gSW5maW5pdHkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLiNyZXF1ZXN0LmJvZHkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgY29udGVudExlbmd0aCA9IHRoaXMuI3JlcXVlc3QuaGVhZGVycy5nZXQoXCJjb250ZW50LWxlbmd0aFwiKTtcbiAgICBpZiAoIWNvbnRlbnRMZW5ndGgpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBwYXJzZWQgPSBwYXJzZUludChjb250ZW50TGVuZ3RoLCAxMCk7XG4gICAgaWYgKGlzTmFOKHBhcnNlZCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gcGFyc2VkID4gbGltaXQ7XG4gIH1cblxuICAjcGFyc2UodHlwZTogQm9keVR5cGUsIGxpbWl0OiBudW1iZXIpOiBCb2R5VmFsdWVHZXR0ZXIge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcImZvcm1cIjpcbiAgICAgICAgdGhpcy4jdHlwZSA9IFwiYnl0ZXNcIjtcbiAgICAgICAgaWYgKHRoaXMuI2V4Y2VlZHNMaW1pdChsaW1pdCkpIHtcbiAgICAgICAgICByZXR1cm4gKCkgPT5cbiAgICAgICAgICAgIFByb21pc2UucmVqZWN0KG5ldyBSYW5nZUVycm9yKGBCb2R5IGV4Y2VlZHMgYSBsaW1pdCBvZiAke2xpbWl0fS5gKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFzeW5jICgpID0+XG4gICAgICAgICAgbmV3IFVSTFNlYXJjaFBhcmFtcyhcbiAgICAgICAgICAgIGRlY29kZXIuZGVjb2RlKGF3YWl0IHRoaXMuI3ZhbHVlUHJvbWlzZSgpKS5yZXBsYWNlKC9cXCsvZywgXCIgXCIpLFxuICAgICAgICAgICk7XG4gICAgICBjYXNlIFwiZm9ybS1kYXRhXCI6XG4gICAgICAgIHRoaXMuI3R5cGUgPSBcImZvcm0tZGF0YVwiO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gdGhpcy4jcmVxdWVzdC5oZWFkZXJzLmdldChcImNvbnRlbnQtdHlwZVwiKTtcbiAgICAgICAgICBhc3NlcnQoY29udGVudFR5cGUpO1xuICAgICAgICAgIGNvbnN0IHJlYWRhYmxlU3RyZWFtID0gdGhpcy4jcmVxdWVzdC5ib2R5ID8/IG5ldyBSZWFkYWJsZVN0cmVhbSgpO1xuICAgICAgICAgIHJldHVybiB0aGlzLiNmb3JtRGF0YVJlYWRlciA/P1xuICAgICAgICAgICAgKHRoaXMuI2Zvcm1EYXRhUmVhZGVyID0gbmV3IEZvcm1EYXRhUmVhZGVyKFxuICAgICAgICAgICAgICBjb250ZW50VHlwZSxcbiAgICAgICAgICAgICAgcmVhZGVyRnJvbVN0cmVhbVJlYWRlcihyZWFkYWJsZVN0cmVhbS5nZXRSZWFkZXIoKSksXG4gICAgICAgICAgICApKTtcbiAgICAgICAgfTtcbiAgICAgIGNhc2UgXCJqc29uXCI6XG4gICAgICAgIHRoaXMuI3R5cGUgPSBcImJ5dGVzXCI7XG4gICAgICAgIGlmICh0aGlzLiNleGNlZWRzTGltaXQobGltaXQpKSB7XG4gICAgICAgICAgcmV0dXJuICgpID0+XG4gICAgICAgICAgICBQcm9taXNlLnJlamVjdChuZXcgUmFuZ2VFcnJvcihgQm9keSBleGNlZWRzIGEgbGltaXQgb2YgJHtsaW1pdH0uYCkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhc3luYyAoKSA9PlxuICAgICAgICAgIEpTT04ucGFyc2UoZGVjb2Rlci5kZWNvZGUoYXdhaXQgdGhpcy4jdmFsdWVQcm9taXNlKCkpKTtcbiAgICAgIGNhc2UgXCJieXRlc1wiOlxuICAgICAgICB0aGlzLiN0eXBlID0gXCJieXRlc1wiO1xuICAgICAgICBpZiAodGhpcy4jZXhjZWVkc0xpbWl0KGxpbWl0KSkge1xuICAgICAgICAgIHJldHVybiAoKSA9PlxuICAgICAgICAgICAgUHJvbWlzZS5yZWplY3QobmV3IFJhbmdlRXJyb3IoYEJvZHkgZXhjZWVkcyBhIGxpbWl0IG9mICR7bGltaXR9LmApKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKCkgPT4gdGhpcy4jdmFsdWVQcm9taXNlKCk7XG4gICAgICBjYXNlIFwidGV4dFwiOlxuICAgICAgICB0aGlzLiN0eXBlID0gXCJieXRlc1wiO1xuICAgICAgICBpZiAodGhpcy4jZXhjZWVkc0xpbWl0KGxpbWl0KSkge1xuICAgICAgICAgIHJldHVybiAoKSA9PlxuICAgICAgICAgICAgUHJvbWlzZS5yZWplY3QobmV3IFJhbmdlRXJyb3IoYEJvZHkgZXhjZWVkcyBhIGxpbWl0IG9mICR7bGltaXR9LmApKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXN5bmMgKCkgPT4gZGVjb2Rlci5kZWNvZGUoYXdhaXQgdGhpcy4jdmFsdWVQcm9taXNlKCkpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgSW52YWxpZCBib2R5IHR5cGU6IFwiJHt0eXBlfVwiYCk7XG4gICAgfVxuICB9XG5cbiAgI3ZhbGlkYXRlR2V0QXJncyhcbiAgICB0eXBlOiBCb2R5VHlwZSB8IHVuZGVmaW5lZCxcbiAgICBjb250ZW50VHlwZXM6IEJvZHlPcHRpb25zQ29udGVudFR5cGVzLFxuICApIHtcbiAgICBpZiAodHlwZSA9PT0gXCJyZWFkZXJcIiAmJiB0aGlzLiN0eXBlICYmIHRoaXMuI3R5cGUgIT09IFwicmVhZGVyXCIpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIGBCb2R5IGFscmVhZHkgY29uc3VtZWQgYXMgXCIke3RoaXMuI3R5cGV9XCIgYW5kIGNhbm5vdCBiZSByZXR1cm5lZCBhcyBhIHJlYWRlci5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHR5cGUgPT09IFwic3RyZWFtXCIgJiYgdGhpcy4jdHlwZSAmJiB0aGlzLiN0eXBlICE9PSBcInN0cmVhbVwiKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgQm9keSBhbHJlYWR5IGNvbnN1bWVkIGFzIFwiJHt0aGlzLiN0eXBlfVwiIGFuZCBjYW5ub3QgYmUgcmV0dXJuZWQgYXMgYSBzdHJlYW0uYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh0eXBlID09PSBcImZvcm0tZGF0YVwiICYmIHRoaXMuI3R5cGUgJiYgdGhpcy4jdHlwZSAhPT0gXCJmb3JtLWRhdGFcIikge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgYEJvZHkgYWxyZWFkeSBjb25zdW1lZCBhcyBcIiR7dGhpcy4jdHlwZX1cIiBhbmQgY2Fubm90IGJlIHJldHVybmVkIGFzIGEgc3RyZWFtLmAsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodGhpcy4jdHlwZSA9PT0gXCJyZWFkZXJcIiAmJiB0eXBlICE9PSBcInJlYWRlclwiKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBcIkJvZHkgYWxyZWFkeSBjb25zdW1lZCBhcyBhIHJlYWRlciBhbmQgY2FuIG9ubHkgYmUgcmV0dXJuZWQgYXMgYSByZWFkZXIuXCIsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodGhpcy4jdHlwZSA9PT0gXCJzdHJlYW1cIiAmJiB0eXBlICE9PSBcInN0cmVhbVwiKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBcIkJvZHkgYWxyZWFkeSBjb25zdW1lZCBhcyBhIHN0cmVhbSBhbmQgY2FuIG9ubHkgYmUgcmV0dXJuZWQgYXMgYSBzdHJlYW0uXCIsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodGhpcy4jdHlwZSA9PT0gXCJmb3JtLWRhdGFcIiAmJiB0eXBlICE9PSBcImZvcm0tZGF0YVwiKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBcIkJvZHkgYWxyZWFkeSBjb25zdW1lZCBhcyBmb3JtIGRhdGEgYW5kIGNhbiBvbmx5IGJlIHJldHVybmVkIGFzIGZvcm0gZGF0YS5cIixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICh0eXBlICYmIE9iamVjdC5rZXlzKGNvbnRlbnRUeXBlcykubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICBgXCJ0eXBlXCIgYW5kIFwiY29udGVudFR5cGVzXCIgY2Fubm90IGJlIHNwZWNpZmllZCBhdCB0aGUgc2FtZSB0aW1lYCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgI3ZhbHVlUHJvbWlzZSgpIHtcbiAgICByZXR1cm4gdGhpcy4jcmVhZEFsbEJvZHkgPz9cbiAgICAgICh0aGlzLiNyZWFkQWxsQm9keSA9IHRoaXMuI3JlcXVlc3QuYXJyYXlCdWZmZXIoKS50aGVuKChhYikgPT5cbiAgICAgICAgbmV3IFVpbnQ4QXJyYXkoYWIpXG4gICAgICApKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHJlcXVlc3Q6IFJlcXVlc3QpIHtcbiAgICB0aGlzLiNyZXF1ZXN0ID0gcmVxdWVzdDtcbiAgfVxuXG4gIGdldChcbiAgICB7IGxpbWl0ID0gREVGQVVMVF9MSU1JVCwgdHlwZSwgY29udGVudFR5cGVzID0ge30gfTogQm9keU9wdGlvbnMgPSB7fSxcbiAgKTogQm9keSB8IEJvZHlSZWFkZXIgfCBCb2R5U3RyZWFtIHtcbiAgICB0aGlzLiN2YWxpZGF0ZUdldEFyZ3ModHlwZSwgY29udGVudFR5cGVzKTtcbiAgICBpZiAodHlwZSA9PT0gXCJyZWFkZXJcIikge1xuICAgICAgaWYgKCF0aGlzLiNyZXF1ZXN0LmJvZHkpIHtcbiAgICAgICAgdGhpcy4jdHlwZSA9IFwidW5kZWZpbmVkXCI7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgICAgYEJvZHkgaXMgdW5kZWZpbmVkIGFuZCBjYW5ub3QgYmUgcmV0dXJuZWQgYXMgXCJyZWFkZXJcIi5gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy4jdHlwZSA9IFwicmVhZGVyXCI7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0eXBlLFxuICAgICAgICB2YWx1ZTogcmVhZGVyRnJvbVN0cmVhbVJlYWRlcih0aGlzLiNyZXF1ZXN0LmJvZHkuZ2V0UmVhZGVyKCkpLFxuICAgICAgfTtcbiAgICB9XG4gICAgaWYgKHR5cGUgPT09IFwic3RyZWFtXCIpIHtcbiAgICAgIGlmICghdGhpcy4jcmVxdWVzdC5ib2R5KSB7XG4gICAgICAgIHRoaXMuI3R5cGUgPSBcInVuZGVmaW5lZFwiO1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFxuICAgICAgICAgIGBCb2R5IGlzIHVuZGVmaW5lZCBhbmQgY2Fubm90IGJlIHJldHVybmVkIGFzIFwic3RyZWFtXCIuYCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuI3R5cGUgPSBcInN0cmVhbVwiO1xuICAgICAgY29uc3Qgc3RyZWFtcyA9ICh0aGlzLiNzdHJlYW0gPz8gdGhpcy4jcmVxdWVzdC5ib2R5KS50ZWUoKTtcbiAgICAgIHRoaXMuI3N0cmVhbSA9IHN0cmVhbXNbMV07XG4gICAgICByZXR1cm4geyB0eXBlLCB2YWx1ZTogc3RyZWFtc1swXSB9O1xuICAgIH1cbiAgICBpZiAoIXRoaXMuaGFzKCkpIHtcbiAgICAgIHRoaXMuI3R5cGUgPSBcInVuZGVmaW5lZFwiO1xuICAgIH0gZWxzZSBpZiAoIXRoaXMuI3R5cGUpIHtcbiAgICAgIGNvbnN0IGVuY29kaW5nID0gdGhpcy4jcmVxdWVzdC5oZWFkZXJzLmdldChcImNvbnRlbnQtZW5jb2RpbmdcIikgPz9cbiAgICAgICAgXCJpZGVudGl0eVwiO1xuICAgICAgaWYgKGVuY29kaW5nICE9PSBcImlkZW50aXR5XCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuVW5zdXBwb3J0ZWRNZWRpYVR5cGUoXG4gICAgICAgICAgYFVuc3VwcG9ydGVkIGNvbnRlbnQtZW5jb2Rpbmc6ICR7ZW5jb2Rpbmd9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuI3R5cGUgPT09IFwidW5kZWZpbmVkXCIgJiYgKCF0eXBlIHx8IHR5cGUgPT09IFwidW5kZWZpbmVkXCIpKSB7XG4gICAgICByZXR1cm4geyB0eXBlOiBcInVuZGVmaW5lZFwiLCB2YWx1ZTogdW5kZWZpbmVkIH07XG4gICAgfVxuICAgIGlmICghdHlwZSkge1xuICAgICAgY29uc3QgY29udGVudFR5cGUgPSB0aGlzLiNyZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiY29udGVudC10eXBlXCIpO1xuICAgICAgYXNzZXJ0KFxuICAgICAgICBjb250ZW50VHlwZSxcbiAgICAgICAgXCJUaGUgQ29udGVudC1UeXBlIGhlYWRlciBpcyBtaXNzaW5nIGZyb20gdGhlIHJlcXVlc3RcIixcbiAgICAgICk7XG4gICAgICB0eXBlID0gcmVzb2x2ZVR5cGUoY29udGVudFR5cGUsIGNvbnRlbnRUeXBlcyk7XG4gICAgfVxuICAgIGFzc2VydCh0eXBlKTtcbiAgICBjb25zdCBib2R5OiBCb2R5ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhib2R5LCB7XG4gICAgICB0eXBlOiB7XG4gICAgICAgIHZhbHVlOiB0eXBlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICB9LFxuICAgICAgdmFsdWU6IHtcbiAgICAgICAgZ2V0OiB0aGlzLiNwYXJzZSh0eXBlLCBsaW1pdCksXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIGJvZHk7XG4gIH1cblxuICAvKiogUmV0dXJucyBpZiB0aGUgcmVxdWVzdCBtaWdodCBoYXZlIGEgYm9keSBvciBub3QsIHdpdGhvdXQgYXR0ZW1wdGluZyB0b1xuICAgKiBjb25zdW1lIGl0LlxuICAgKlxuICAgKiAqKldBUk5JTkcqKiBUaGlzIGlzIGFuIHVucmVsaWFibGUgQVBJLiBJbiBIVFRQLzIgaXQgaXMgbm90IHBvc3NpYmxlIHRvXG4gICAqIGRldGVybWluZSBpZiBjZXJ0YWluIEhUVFAgbWV0aG9kcyBoYXZlIGEgYm9keSBvciBub3Qgd2l0aG91dCBhdHRlbXB0aW5nIHRvXG4gICAqIHJlYWQgdGhlIGJvZHkuIEFzIG9mIERlbm8gMS4xNi4xIGFuZCBsYXRlciwgZm9yIEhUVFAvMS4xIGFsaWducyB0byB0aGVcbiAgICogSFRUUC8yIGJlaGF2aW91ci5cbiAgICovXG4gIGhhcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC5ib2R5ICE9IG51bGw7XG4gIH1cbn1cbiJdfQ==
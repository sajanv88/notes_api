import { Srv } from "./srv.ts";
export function parse_url(url) {
    const fragments = [
        "protocol",
        "auth",
        "hostname",
        "port",
        "pathname",
        "search",
        "hash",
    ];
    const pattern = /([^:/?#]+:)?(?:(?:\/\/)(?:([^/?#]*:?[^@/]+)@)?([^/:?#]+)(?:(?::)(\d+))?)?(\/?[^?#]*)?(\?[^#]*)?(#[^\s]*)?/;
    const multipleServerPattern = /([^:/?#]+:)?(?:(?:\/\/)(?:([^/?#]*:?[^@/]+)@)?((?:(?:[^/:?#]+)(?:(?::)(?:\d+))?)+))?/;
    function parse_simple(url) {
        const parts = { servers: [], href: url };
        const multiServerMatch = url.match(multipleServerPattern);
        if (multiServerMatch[3].includes(",")) {
            const [first, ...rest] = multiServerMatch[3].split(",");
            const parts = parse_simple(url.replace(multiServerMatch[3], first));
            for (const serverName of rest) {
                const subServer = parse_simple(`temp://${serverName}`);
                parts.servers.push(subServer.servers[0]);
            }
            return parts;
        }
        const matches = url.match(pattern);
        let l = fragments.length;
        while (l--) {
            parts[fragments[l]] = matches[l + 1]
                ? decodeURIComponent(matches[l + 1])
                : matches[l + 1];
        }
        parts["servers"] = [
            { host: parts["hostname"], port: parseInt(parts["port"]) },
        ];
        delete parts["hostname"];
        delete parts["port"];
        parts.path = parts.search
            ? (parts.pathname ? parts.pathname + parts.search : parts.search)
            : parts.pathname;
        return parts;
    }
    function parse(url) {
        const parsed = parse_simple(url);
        if (parsed.auth)
            parsed.auth = decodeAuth(parsed.auth);
        parsed.search = parsed.search ? queryString("?", parsed.search) : {};
        parsed.hash = parsed.hash ? queryString("#", parsed.hash) : {};
        return parsed;
    }
    function decodeAuth(auth) {
        const split = auth.split(":");
        return {
            user: split[0],
            password: split[1],
        };
    }
    function queryString(identifier, qs) {
        const obj = {};
        const params = decodeURI(qs || "").replace(new RegExp("\\" + identifier), "").split(/&amp;|&/);
        for (const param of params) {
            if (params) {
                let index = param.indexOf("=");
                if (index === -1)
                    index = param.length;
                const key = param.substring(0, index);
                const val = param.substring(index + 1);
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    if (!Array.isArray(obj[key]))
                        obj[key] = [obj[key]];
                    obj[key].push(val);
                }
                else {
                    obj[key] = val || true;
                }
            }
        }
        return obj;
    }
    return parse(url);
}
export function isSrvUrl(url) {
    return /^mongodb\+srv/.test(url);
}
export function parseSrvUrl(url) {
    const data = parse_url(url);
    const defaultAuthDb = (data.pathname && (data.pathname.length > 1))
        ? data.pathname.substring(1)
        : null;
    const authSource = new URLSearchParams(data.search).get("authSource");
    const connectOptions = {
        db: defaultAuthDb ?? "test",
    };
    if (data.auth) {
        connectOptions.credential = {
            username: data.auth.user,
            password: data.auth.password,
            db: authSource ?? defaultAuthDb ?? "admin",
            mechanism: data.search.authMechanism || "SCRAM-SHA-256",
        };
    }
    connectOptions.compression = data.search.compressors
        ? data.search.compressors.split(",")
        : [];
    connectOptions.srvServer = data.servers?.[0].host;
    if (data.search.appname) {
        connectOptions.appname = data.search.appname;
    }
    if (data.search.tls) {
        connectOptions.tls = data.search.tls === "true";
    }
    else {
        connectOptions.tls = true;
    }
    if (data.search.tlsCAFile) {
        connectOptions.certFile = data.search.tlsCAFile;
    }
    if (data.search.tlsCertificateKeyFile) {
        connectOptions.keyFile = data.search.tlsCertificateKeyFile;
    }
    if (data.search.tlsCertificateKeyFilePassword) {
        connectOptions.keyFilePassword = data.search.tlsCertificateKeyFilePassword;
    }
    if (data.search.safe) {
        connectOptions.safe = data.search.safe === "true";
    }
    if (data.search.retryWrites) {
        connectOptions.retryWrites = data.search.retryWrites === "true";
    }
    return connectOptions;
}
export function parse(url) {
    return isSrvUrl(url)
        ? new Srv().resolveSrvUrl(url)
        : Promise.resolve(parseNormalUrl(url));
}
function parseNormalUrl(url) {
    const data = parse_url(url);
    const defaultAuthDb = (data.pathname && (data.pathname.length > 1))
        ? data.pathname.substring(1)
        : null;
    const authSource = new URLSearchParams(data.search).get("authSource");
    const connectOptions = {
        servers: data.servers,
        db: defaultAuthDb ?? "test",
    };
    for (const server of connectOptions.servers) {
        if (server.host.includes(".sock")) {
            server.domainSocket = server.host;
        }
        server.port = server.port || 27017;
    }
    if (data.auth) {
        connectOptions.credential = {
            username: data.auth.user,
            password: data.auth.password,
            db: authSource ?? defaultAuthDb ?? "admin",
            mechanism: data.search.authMechanism || "SCRAM-SHA-256",
        };
    }
    connectOptions.compression = data.search.compressors
        ? data.search.compressors.split(",")
        : [];
    if (data.search.appname) {
        connectOptions.appname = data.search.appname;
    }
    if (data.search.tls) {
        connectOptions.tls = data.search.tls === "true";
    }
    if (data.search.tlsCAFile) {
        connectOptions.certFile = data.search.tlsCAFile;
    }
    if (data.search.tlsCertificateKeyFile) {
        connectOptions.keyFile = data.search.tlsCertificateKeyFile;
    }
    if (data.search.tlsCertificateKeyFilePassword) {
        connectOptions.keyFilePassword = data.search.tlsCertificateKeyFilePassword;
    }
    if (data.search.safe) {
        connectOptions.safe = data.search.safe === "true";
    }
    return connectOptions;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidXJpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFpQi9CLE1BQU0sVUFBVSxTQUFTLENBQUMsR0FBVztJQUNuQyxNQUFNLFNBQVMsR0FBRztRQUNoQixVQUFVO1FBQ1YsTUFBTTtRQUNOLFVBQVU7UUFDVixNQUFNO1FBQ04sVUFBVTtRQUNWLFFBQVE7UUFDUixNQUFNO0tBQ1AsQ0FBQztJQUNGLE1BQU0sT0FBTyxHQUNYLDJHQUEyRyxDQUFDO0lBRTlHLE1BQU0scUJBQXFCLEdBQ3pCLHNGQUFzRixDQUFDO0lBR3pGLFNBQVMsWUFBWSxDQUFDLEdBQVc7UUFFL0IsTUFBTSxLQUFLLEdBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUM5QyxNQUFNLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUUxRCxJQUFJLGdCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN0QyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsZ0JBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pELE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FDeEIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxnQkFBaUIsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FDekMsQ0FBQztZQUVGLEtBQUssTUFBTSxVQUFVLElBQUksSUFBSSxFQUFFO2dCQUM3QixNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsVUFBVSxVQUFVLEVBQUUsQ0FBQyxDQUFDO2dCQUN2RCxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENB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LENBQUMsT0FBTyxFQUFFO1FBQ3ZCLGNBQWMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7S0FDOUM7SUFDRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ25CLGNBQWMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEtBQUssTUFBTSxDQUFDO0tBQ2pEO0lBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUN6QixjQUFjLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO0tBQ2pEO0lBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFO1FBQ3JDLGNBQWMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztLQUM1RDtJQUNELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyw2QkFBNkIsRUFBRTtRQUM3QyxjQUFjLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsNkJBQTZCLENBQUM7S0FDNUU7SUFDRCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ3BCLGNBQWMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDO0tBQ25EO0lBQ0QsT0FBTyxjQUFjLENBQUM7QUFDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1vbmdvZGI6Ly91c2VybmFtZTpwYXNzd29yZEBleGFtcGxlLmNvbToyNzAxNyxleGFtcGxlMi5jb206MjcwMTcsLi4uLGV4YW1wbGUuY29tTjoyNzAxNy9kYXRhYmFzZT9rZXk9dmFsdWUma2V5Tj12YWx1ZU5cbmltcG9ydCB7IENvbm5lY3RPcHRpb25zLCBDcmVkZW50aWFsLCBTZXJ2ZXIgfSBmcm9tIFwiLi4vdHlwZXMudHNcIjtcbmltcG9ydCB7IFNydiB9IGZyb20gXCIuL3Nydi50c1wiO1xuXG5pbnRlcmZhY2UgUGFydHMge1xuICBhdXRoPzogeyB1c2VyOiBzdHJpbmc7IHBhc3N3b3JkPzogc3RyaW5nIH07XG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIGhhc2g/OiBhbnk7XG4gIHNlcnZlcnM/OiBTZXJ2ZXJbXTtcbiAgaHJlZj86IHN0cmluZztcbiAgcGF0aD86IHN0cmluZztcbiAgcGF0aG5hbWU/OiBzdHJpbmc7XG4gIHByb3RvY29sPzogc3RyaW5nO1xuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBzZWFyY2g/OiBhbnk7XG59XG5cbi8vYWRhcHRlZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9RdWJpdFByb2R1Y3RzL3VybGl0ZVxuLy8gZGVuby1saW50LWlnbm9yZSBjYW1lbGNhc2VcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZV91cmwodXJsOiBzdHJpbmcpOiBQYXJ0cyB7XG4gIGNvbnN0IGZyYWdtZW50cyA9IFtcbiAgICBcInByb3RvY29sXCIsXG4gICAgXCJhdXRoXCIsXG4gICAgXCJob3N0bmFtZVwiLFxuICAgIFwicG9ydFwiLFxuICAgIFwicGF0aG5hbWVcIixcbiAgICBcInNlYXJjaFwiLFxuICAgIFwiaGFzaFwiLFxuICBdO1xuICBjb25zdCBwYXR0ZXJuID1cbiAgICAvKFteOi8/I10rOik/KD86KD86XFwvXFwvKSg/OihbXi8/I10qOj9bXkAvXSspQCk/KFteLzo/I10rKSg/Oig/OjopKFxcZCspKT8pPyhcXC8/W14/I10qKT8oXFw/W14jXSopPygjW15cXHNdKik/LztcblxuICBjb25zdCBtdWx0aXBsZVNlcnZlclBhdHRlcm4gPVxuICAgIC8oW146Lz8jXSs6KT8oPzooPzpcXC9cXC8pKD86KFteLz8jXSo6P1teQC9dKylAKT8oKD86KD86W14vOj8jXSspKD86KD86OikoPzpcXGQrKSk/KSspKT8vO1xuXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55LCBjYW1lbGNhc2VcbiAgZnVuY3Rpb24gcGFyc2Vfc2ltcGxlKHVybDogc3RyaW5nKTogYW55IHtcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIGNvbnN0IHBhcnRzOiBhbnkgPSB7IHNlcnZlcnM6IFtdLCBocmVmOiB1cmwgfTtcbiAgICBjb25zdCBtdWx0aVNlcnZlck1hdGNoID0gdXJsLm1hdGNoKG11bHRpcGxlU2VydmVyUGF0dGVybik7XG5cbiAgICBpZiAobXVsdGlTZXJ2ZXJNYXRjaCFbM10uaW5jbHVkZXMoXCIsXCIpKSB7XG4gICAgICBjb25zdCBbZmlyc3QsIC4uLnJlc3RdID0gbXVsdGlTZXJ2ZXJNYXRjaCFbM10uc3BsaXQoXCIsXCIpO1xuICAgICAgY29uc3QgcGFydHMgPSBwYXJzZV9zaW1wbGUoXG4gICAgICAgIHVybC5yZXBsYWNlKG11bHRpU2VydmVyTWF0Y2ghWzNdLCBmaXJzdCksXG4gICAgICApO1xuXG4gICAgICBmb3IgKGNvbnN0IHNlcnZlck5hbWUgb2YgcmVzdCkge1xuICAgICAgICBjb25zdCBzdWJTZXJ2ZXIgPSBwYXJzZV9zaW1wbGUoYHRlbXA6Ly8ke3NlcnZlck5hbWV9YCk7XG4gICAgICAgIHBhcnRzLnNlcnZlcnMucHVzaChzdWJTZXJ2ZXIuc2VydmVyc1swXSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBwYXJ0cztcbiAgICB9XG5cbiAgICBjb25zdCBtYXRjaGVzID0gdXJsLm1hdGNoKHBhdHRlcm4pO1xuICAgIGxldCBsID0gZnJhZ21lbnRzLmxlbmd0aDtcbiAgICB3aGlsZSAobC0tKSB7XG4gICAgICBwYXJ0c1tmcmFnbWVudHNbbF1dID0gbWF0Y2hlcyFbbCArIDFdXG4gICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoZXMhW2wgKyAxXSlcbiAgICAgICAgOiBtYXRjaGVzIVtsICsgMV07XG4gICAgfVxuICAgIHBhcnRzW1wic2VydmVyc1wiXSA9IFtcbiAgICAgIHsgaG9zdDogcGFydHNbXCJob3N0bmFtZVwiXSwgcG9ydDogcGFyc2VJbnQocGFydHNbXCJwb3J0XCJdKSB9LFxuICAgIF07XG4gICAgZGVsZXRlIHBhcnRzW1wiaG9zdG5hbWVcIl07XG4gICAgZGVsZXRlIHBhcnRzW1wicG9ydFwiXTtcbiAgICBwYXJ0cy5wYXRoID0gcGFydHMuc2VhcmNoXG4gICAgICA/IChwYXJ0cy5wYXRobmFtZSA/IHBhcnRzLnBhdGhuYW1lICsgcGFydHMuc2VhcmNoIDogcGFydHMuc2VhcmNoKVxuICAgICAgOiBwYXJ0cy5wYXRobmFtZTtcbiAgICByZXR1cm4gcGFydHM7XG4gIH1cblxuICBmdW5jdGlvbiBwYXJzZSh1cmw6IHN0cmluZyk6IFBhcnRzIHtcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIGNvbnN0IHBhcnNlZDogYW55ID0gcGFyc2Vfc2ltcGxlKHVybCk7XG4gICAgaWYgKHBhcnNlZC5hdXRoKSBwYXJzZWQuYXV0aCA9IGRlY29kZUF1dGgocGFyc2VkLmF1dGgpO1xuICAgIHBhcnNlZC5zZWFyY2ggPSBwYXJzZWQuc2VhcmNoID8gcXVlcnlTdHJpbmcoXCI/XCIsIHBhcnNlZC5zZWFyY2gpIDoge307XG4gICAgcGFyc2VkLmhhc2ggPSBwYXJzZWQuaGFzaCA/IHF1ZXJ5U3RyaW5nKFwiI1wiLCBwYXJzZWQuaGFzaCkgOiB7fTtcbiAgICByZXR1cm4gcGFyc2VkO1xuICB9XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgZnVuY3Rpb24gZGVjb2RlQXV0aChhdXRoOiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IHNwbGl0ID0gYXV0aC5zcGxpdChcIjpcIik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXI6IHNwbGl0WzBdLFxuICAgICAgcGFzc3dvcmQ6IHNwbGl0WzFdLFxuICAgIH07XG4gIH1cblxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBmdW5jdGlvbiBxdWVyeVN0cmluZyhpZGVudGlmaWVyOiBzdHJpbmcsIHFzOiBzdHJpbmcpOiBhbnkge1xuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgY29uc3Qgb2JqOiBhbnkgPSB7fTtcbiAgICBjb25zdCBwYXJhbXMgPSBkZWNvZGVVUkkocXMgfHwgXCJcIikucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoXCJcXFxcXCIgKyBpZGVudGlmaWVyKSxcbiAgICAgIFwiXCIsXG4gICAgKS5zcGxpdCgvJmFtcDt8Ji8pO1xuXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiBwYXJhbXMpIHtcbiAgICAgIGlmIChwYXJhbXMpIHtcbiAgICAgICAgbGV0IGluZGV4ID0gcGFyYW0uaW5kZXhPZihcIj1cIik7XG4gICAgICAgIGlmIChpbmRleCA9PT0gLTEpIGluZGV4ID0gcGFyYW0ubGVuZ3RoO1xuXG4gICAgICAgIGNvbnN0IGtleSA9IHBhcmFtLnN1YnN0cmluZygwLCBpbmRleCk7XG4gICAgICAgIGNvbnN0IHZhbCA9IHBhcmFtLnN1YnN0cmluZyhpbmRleCArIDEpO1xuXG4gICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7XG4gICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9ialtrZXldKSkgb2JqW2tleV0gPSBbb2JqW2tleV1dO1xuICAgICAgICAgIG9ialtrZXldLnB1c2godmFsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvYmpba2V5XSA9IHZhbCB8fCB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIHJldHVybiBwYXJzZSh1cmwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTcnZVcmwodXJsOiBzdHJpbmcpIHtcbiAgcmV0dXJuIC9ebW9uZ29kYlxcK3Nydi8udGVzdCh1cmwpO1xufVxuXG5leHBvcnQgdHlwZSBTcnZDb25uZWN0T3B0aW9ucyA9IE9taXQ8Q29ubmVjdE9wdGlvbnMsIFwic2VydmVyc1wiPiAmIHtcbiAgc3J2U2VydmVyPzogc3RyaW5nO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlU3J2VXJsKHVybDogc3RyaW5nKTogU3J2Q29ubmVjdE9wdGlvbnMge1xuICBjb25zdCBkYXRhID0gcGFyc2VfdXJsKHVybCk7XG5cbiAgY29uc3QgZGVmYXVsdEF1dGhEYiA9IChkYXRhLnBhdGhuYW1lICYmIChkYXRhLnBhdGhuYW1lLmxlbmd0aCA+IDEpKVxuICAgID8gZGF0YS5wYXRobmFtZSEuc3Vic3RyaW5nKDEpXG4gICAgOiBudWxsO1xuXG4gIGNvbnN0IGF1dGhTb3VyY2UgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKGRhdGEuc2VhcmNoKS5nZXQoXCJhdXRoU291cmNlXCIpO1xuXG4gIGNvbnN0IGNvbm5lY3RPcHRpb25zOiBTcnZDb25uZWN0T3B0aW9ucyA9IHtcbiAgICBkYjogZGVmYXVsdEF1dGhEYiA/PyBcInRlc3RcIixcbiAgfTtcblxuICBpZiAoZGF0YS5hdXRoKSB7XG4gICAgY29ubmVjdE9wdGlvbnMuY3JlZGVudGlhbCA9IDxDcmVkZW50aWFsPiB7XG4gICAgICB1c2VybmFtZTogZGF0YS5hdXRoLnVzZXIsXG4gICAgICBwYXNzd29yZDogZGF0YS5hdXRoLnBhc3N3b3JkLFxuICAgICAgZGI6IGF1dGhTb3VyY2UgPz8gZGVmYXVsdEF1dGhEYiA/PyBcImFkbWluXCIsXG4gICAgICBtZWNoYW5pc206IGRhdGEuc2VhcmNoLmF1dGhNZWNoYW5pc20gfHwgXCJTQ1JBTS1TSEEtMjU2XCIsXG4gICAgfTtcbiAgfVxuICBjb25uZWN0T3B0aW9ucy5jb21wcmVzc2lvbiA9IGRhdGEuc2VhcmNoLmNvbXByZXNzb3JzXG4gICAgPyBkYXRhLnNlYXJjaC5jb21wcmVzc29ycy5zcGxpdChcIixcIilcbiAgICA6IFtdO1xuICBjb25uZWN0T3B0aW9ucy5zcnZTZXJ2ZXIgPSBkYXRhLnNlcnZlcnM/LlswXS5ob3N0O1xuXG4gIGlmIChkYXRhLnNlYXJjaC5hcHBuYW1lKSB7XG4gICAgY29ubmVjdE9wdGlvbnMuYXBwbmFtZSA9IGRhdGEuc2VhcmNoLmFwcG5hbWU7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnRscykge1xuICAgIGNvbm5lY3RPcHRpb25zLnRscyA9IGRhdGEuc2VhcmNoLnRscyA9PT0gXCJ0cnVlXCI7XG4gIH0gZWxzZSB7XG4gICAgY29ubmVjdE9wdGlvbnMudGxzID0gdHJ1ZTtcbiAgfVxuICBpZiAoZGF0YS5zZWFyY2gudGxzQ0FGaWxlKSB7XG4gICAgY29ubmVjdE9wdGlvbnMuY2VydEZpbGUgPSBkYXRhLnNlYXJjaC50bHNDQUZpbGU7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnRsc0NlcnRpZmljYXRlS2V5RmlsZSkge1xuICAgIGNvbm5lY3RPcHRpb25zLmtleUZpbGUgPSBkYXRhLnNlYXJjaC50bHNDZXJ0aWZpY2F0ZUtleUZpbGU7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnRsc0NlcnRpZmljYXRlS2V5RmlsZVBhc3N3b3JkKSB7XG4gICAgY29ubmVjdE9wdGlvbnMua2V5RmlsZVBhc3N3b3JkID0gZGF0YS5zZWFyY2gudGxzQ2VydGlmaWNhdGVLZXlGaWxlUGFzc3dvcmQ7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnNhZmUpIHtcbiAgICBjb25uZWN0T3B0aW9ucy5zYWZlID0gZGF0YS5zZWFyY2guc2FmZSA9PT0gXCJ0cnVlXCI7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnJldHJ5V3JpdGVzKSB7XG4gICAgY29ubmVjdE9wdGlvbnMucmV0cnlXcml0ZXMgPSBkYXRhLnNlYXJjaC5yZXRyeVdyaXRlcyA9PT0gXCJ0cnVlXCI7XG4gIH1cbiAgcmV0dXJuIGNvbm5lY3RPcHRpb25zO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2UodXJsOiBzdHJpbmcpOiBQcm9taXNlPENvbm5lY3RPcHRpb25zPiB7XG4gIHJldHVybiBpc1NydlVybCh1cmwpXG4gICAgPyBuZXcgU3J2KCkucmVzb2x2ZVNydlVybCh1cmwpXG4gICAgOiBQcm9taXNlLnJlc29sdmUocGFyc2VOb3JtYWxVcmwodXJsKSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlTm9ybWFsVXJsKHVybDogc3RyaW5nKTogQ29ubmVjdE9wdGlvbnMge1xuICBjb25zdCBkYXRhID0gcGFyc2VfdXJsKHVybCk7XG5cbiAgY29uc3QgZGVmYXVsdEF1dGhEYiA9IChkYXRhLnBhdGhuYW1lICYmIChkYXRhLnBhdGhuYW1lLmxlbmd0aCA+IDEpKVxuICAgID8gZGF0YS5wYXRobmFtZSEuc3Vic3RyaW5nKDEpXG4gICAgOiBudWxsO1xuXG4gIGNvbnN0IGF1dGhTb3VyY2UgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKGRhdGEuc2VhcmNoKS5nZXQoXCJhdXRoU291cmNlXCIpO1xuXG4gIGNvbnN0IGNvbm5lY3RPcHRpb25zOiBDb25uZWN0T3B0aW9ucyA9IHtcbiAgICBzZXJ2ZXJzOiBkYXRhLnNlcnZlcnMhLFxuICAgIGRiOiBkZWZhdWx0QXV0aERiID8/IFwidGVzdFwiLFxuICB9O1xuXG4gIGZvciAoY29uc3Qgc2VydmVyIG9mIGNvbm5lY3RPcHRpb25zLnNlcnZlcnMpIHtcbiAgICBpZiAoc2VydmVyLmhvc3QuaW5jbHVkZXMoXCIuc29ja1wiKSkge1xuICAgICAgc2VydmVyLmRvbWFpblNvY2tldCA9IHNlcnZlci5ob3N0O1xuICAgIH1cbiAgICBzZXJ2ZXIucG9ydCA9IHNlcnZlci5wb3J0IHx8IDI3MDE3O1xuICB9XG5cbiAgaWYgKGRhdGEuYXV0aCkge1xuICAgIGNvbm5lY3RPcHRpb25zLmNyZWRlbnRpYWwgPSA8Q3JlZGVudGlhbD4ge1xuICAgICAgdXNlcm5hbWU6IGRhdGEuYXV0aC51c2VyLFxuICAgICAgcGFzc3dvcmQ6IGRhdGEuYXV0aC5wYXNzd29yZCxcbiAgICAgIGRiOiBhdXRoU291cmNlID8/IGRlZmF1bHRBdXRoRGIgPz8gXCJhZG1pblwiLFxuICAgICAgbWVjaGFuaXNtOiBkYXRhLnNlYXJjaC5hdXRoTWVjaGFuaXNtIHx8IFwiU0NSQU0tU0hBLTI1NlwiLFxuICAgIH07XG4gIH1cbiAgY29ubmVjdE9wdGlvbnMuY29tcHJlc3Npb24gPSBkYXRhLnNlYXJjaC5jb21wcmVzc29yc1xuICAgID8gZGF0YS5zZWFyY2guY29tcHJlc3NvcnMuc3BsaXQoXCIsXCIpXG4gICAgOiBbXTtcbiAgaWYgKGRhdGEuc2VhcmNoLmFwcG5hbWUpIHtcbiAgICBjb25uZWN0T3B0aW9ucy5hcHBuYW1lID0gZGF0YS5zZWFyY2guYXBwbmFtZTtcbiAgfVxuICBpZiAoZGF0YS5zZWFyY2gudGxzKSB7XG4gICAgY29ubmVjdE9wdGlvbnMudGxzID0gZGF0YS5zZWFyY2gudGxzID09PSBcInRydWVcIjtcbiAgfVxuICBpZiAoZGF0YS5zZWFyY2gudGxzQ0FGaWxlKSB7XG4gICAgY29ubmVjdE9wdGlvbnMuY2VydEZpbGUgPSBkYXRhLnNlYXJjaC50bHNDQUZpbGU7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnRsc0NlcnRpZmljYXRlS2V5RmlsZSkge1xuICAgIGNvbm5lY3RPcHRpb25zLmtleUZpbGUgPSBkYXRhLnNlYXJjaC50bHNDZXJ0aWZpY2F0ZUtleUZpbGU7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnRsc0NlcnRpZmljYXRlS2V5RmlsZVBhc3N3b3JkKSB7XG4gICAgY29ubmVjdE9wdGlvbnMua2V5RmlsZVBhc3N3b3JkID0gZGF0YS5zZWFyY2gudGxzQ2VydGlmaWNhdGVLZXlGaWxlUGFzc3dvcmQ7XG4gIH1cbiAgaWYgKGRhdGEuc2VhcmNoLnNhZmUpIHtcbiAgICBjb25uZWN0T3B0aW9ucy5zYWZlID0gZGF0YS5zZWFyY2guc2FmZSA9PT0gXCJ0cnVlXCI7XG4gIH1cbiAgcmV0dXJuIGNvbm5lY3RPcHRpb25zO1xufVxuIl19
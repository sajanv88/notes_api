import { BufReader } from "./buf_reader.ts";
import { getFilename } from "./content_disposition.ts";
import { equals, extension, writeAll } from "./deps.ts";
import { readHeaders, toParamRegExp, unquote } from "./headers.ts";
import { httpErrors } from "./httpError.ts";
import { getRandomFilename, skipLWSPChar, stripEol } from "./util.ts";
const decoder = new TextDecoder();
const encoder = new TextEncoder();
const BOUNDARY_PARAM_REGEX = toParamRegExp("boundary", "i");
const DEFAULT_BUFFER_SIZE = 1_048_576;
const DEFAULT_MAX_FILE_SIZE = 10_485_760;
const DEFAULT_MAX_SIZE = 0;
const NAME_PARAM_REGEX = toParamRegExp("name", "i");
function append(a, b) {
    const ab = new Uint8Array(a.length + b.length);
    ab.set(a, 0);
    ab.set(b, a.length);
    return ab;
}
function isEqual(a, b) {
    return equals(skipLWSPChar(a), b);
}
async function readToStartOrEnd(body, start, end) {
    let lineResult;
    while ((lineResult = await body.readLine())) {
        if (isEqual(lineResult.bytes, start)) {
            return true;
        }
        if (isEqual(lineResult.bytes, end)) {
            return false;
        }
    }
    throw new httpErrors.BadRequest("Unable to find multi-part boundary.");
}
async function* parts({ body, customContentTypes = {}, final, part, maxFileSize, maxSize, outPath, prefix, }) {
    async function getFile(contentType) {
        const ext = customContentTypes[contentType.toLowerCase()] ??
            extension(contentType);
        if (!ext) {
            throw new httpErrors.BadRequest(`The form contained content type "${contentType}" which is not supported by the server.`);
        }
        if (!outPath) {
            outPath = await Deno.makeTempDir();
        }
        const filename = `${outPath}/${await getRandomFilename(prefix, ext)}`;
        const file = await Deno.open(filename, { write: true, createNew: true });
        return [filename, file];
    }
    while (true) {
        const headers = await readHeaders(body);
        const contentType = headers["content-type"];
        const contentDisposition = headers["content-disposition"];
        if (!contentDisposition) {
            throw new httpErrors.BadRequest("Form data part missing content-disposition header");
        }
        if (!contentDisposition.match(/^form-data;/i)) {
            throw new httpErrors.BadRequest(`Unexpected content-disposition header: "${contentDisposition}"`);
        }
        const matches = NAME_PARAM_REGEX.exec(contentDisposition);
        if (!matches) {
            throw new httpErrors.BadRequest(`Unable to determine name of form body part`);
        }
        let [, name] = matches;
        name = unquote(name);
        if (contentType) {
            const originalName = getFilename(contentDisposition);
            let byteLength = 0;
            let file;
            let filename;
            let buf;
            if (maxSize) {
                buf = new Uint8Array();
            }
            else {
                const result = await getFile(contentType);
                filename = result[0];
                file = result[1];
            }
            while (true) {
                const readResult = await body.readLine(false);
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                const strippedBytes = stripEol(bytes);
                if (isEqual(strippedBytes, part) || isEqual(strippedBytes, final)) {
                    if (file) {
                        const bytesDiff = bytes.length - strippedBytes.length;
                        if (bytesDiff) {
                            const originalBytesSize = await file.seek(-bytesDiff, Deno.SeekMode.Current);
                            await file.truncate(originalBytesSize);
                        }
                        file.close();
                    }
                    yield [
                        name,
                        {
                            content: buf,
                            contentType,
                            name,
                            filename,
                            originalName,
                        },
                    ];
                    if (isEqual(strippedBytes, final)) {
                        return;
                    }
                    break;
                }
                byteLength += bytes.byteLength;
                if (byteLength > maxFileSize) {
                    if (file) {
                        file.close();
                    }
                    throw new httpErrors.RequestEntityTooLarge(`File size exceeds limit of ${maxFileSize} bytes.`);
                }
                if (buf) {
                    if (byteLength > maxSize) {
                        const result = await getFile(contentType);
                        filename = result[0];
                        file = result[1];
                        await writeAll(file, buf);
                        buf = undefined;
                    }
                    else {
                        buf = append(buf, bytes);
                    }
                }
                if (file) {
                    await writeAll(file, bytes);
                }
            }
        }
        else {
            const lines = [];
            while (true) {
                const readResult = await body.readLine();
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                if (isEqual(bytes, part) || isEqual(bytes, final)) {
                    yield [name, lines.join("\n")];
                    if (isEqual(bytes, final)) {
                        return;
                    }
                    break;
                }
                lines.push(decoder.decode(bytes));
            }
        }
    }
}
export class FormDataReader {
    #body;
    #boundaryFinal;
    #boundaryPart;
    #reading = false;
    constructor(contentType, body) {
        const matches = contentType.match(BOUNDARY_PARAM_REGEX);
        if (!matches) {
            throw new httpErrors.BadRequest(`Content type "${contentType}" does not contain a valid boundary.`);
        }
        let [, boundary] = matches;
        boundary = unquote(boundary);
        this.#boundaryPart = encoder.encode(`--${boundary}`);
        this.#boundaryFinal = encoder.encode(`--${boundary}--`);
        this.#body = body;
    }
    async read(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = DEFAULT_BUFFER_SIZE, customContentTypes, } = options;
        const body = new BufReader(this.#body, bufferSize);
        const result = { fields: {} };
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return result;
        }
        try {
            for await (const part of parts({
                body,
                customContentTypes,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                const [key, value] = part;
                if (typeof value === "string") {
                    result.fields[key] = value;
                }
                else {
                    if (!result.files) {
                        result.files = [];
                    }
                    result.files.push(value);
                }
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
        return result;
    }
    async *stream(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, customContentTypes, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = 32000, } = options;
        const body = new BufReader(this.#body, bufferSize);
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return;
        }
        try {
            for await (const part of parts({
                body,
                customContentTypes,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                yield part;
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({})}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlwYXJ0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibXVsdGlwYXJ0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQWtCLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDbkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXRFLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUVsQyxNQUFNLG9CQUFvQixHQUFHLGFBQWEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDNUQsTUFBTSxtQkFBbUIsR0FBRyxTQUFTLENBQUM7QUFDdEMsTUFBTSxxQkFBcUIsR0FBRyxVQUFVLENBQUM7QUFDekMsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7QUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBMEdwRCxTQUFTLE1BQU0sQ0FBQyxDQUFhLEVBQUUsQ0FBYTtJQUMxQyxNQUFNLEVBQUUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNiLEVBQUUsQ0FBQyxHQUFH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MjAxOC0yMDIyIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB7IEJ1ZlJlYWRlciwgUmVhZExpbmVSZXN1bHQgfSBmcm9tIFwiLi9idWZfcmVhZGVyLnRzXCI7XG5pbXBvcnQgeyBnZXRGaWxlbmFtZSB9IGZyb20gXCIuL2NvbnRlbnRfZGlzcG9zaXRpb24udHNcIjtcbmltcG9ydCB7IGVxdWFscywgZXh0ZW5zaW9uLCB3cml0ZUFsbCB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IHJlYWRIZWFkZXJzLCB0b1BhcmFtUmVnRXhwLCB1bnF1b3RlIH0gZnJvbSBcIi4vaGVhZGVycy50c1wiO1xuaW1wb3J0IHsgaHR0cEVycm9ycyB9IGZyb20gXCIuL2h0dHBFcnJvci50c1wiO1xuaW1wb3J0IHsgZ2V0UmFuZG9tRmlsZW5hbWUsIHNraXBMV1NQQ2hhciwgc3RyaXBFb2wgfSBmcm9tIFwiLi91dGlsLnRzXCI7XG5cbmNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcbmNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcblxuY29uc3QgQk9VTkRBUllfUEFSQU1fUkVHRVggPSB0b1BhcmFtUmVnRXhwKFwiYm91bmRhcnlcIiwgXCJpXCIpO1xuY29uc3QgREVGQVVMVF9CVUZGRVJfU0laRSA9IDFfMDQ4XzU3NjsgLy8gMW1iXG5jb25zdCBERUZBVUxUX01BWF9GSUxFX1NJWkUgPSAxMF80ODVfNzYwOyAvLyAxMG1iXG5jb25zdCBERUZBVUxUX01BWF9TSVpFID0gMDsgLy8gYWxsIGZpbGVzIHdyaXR0ZW4gdG8gZGlzY1xuY29uc3QgTkFNRV9QQVJBTV9SRUdFWCA9IHRvUGFyYW1SZWdFeHAoXCJuYW1lXCIsIFwiaVwiKTtcblxuZXhwb3J0IGludGVyZmFjZSBGb3JtRGF0YUJvZHkge1xuICAvKiogQSByZWNvcmQgb2YgZm9ybSBwYXJ0cyB3aGVyZSB0aGUga2V5IHdhcyB0aGUgYG5hbWVgIG9mIHRoZSBwYXJ0IGFuZCB0aGVcbiAgICogdmFsdWUgd2FzIHRoZSB2YWx1ZSBvZiB0aGUgcGFydC4gVGhpcyByZWNvcmQgZG9lcyBub3QgaW5jbHVkZSBhbnkgZmlsZXNcbiAgICogdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIGZvcm0gZGF0YS5cbiAgICpcbiAgICogKk5vdGUqOiBEdXBsaWNhdGUgbmFtZXMgYXJlIG5vdCBpbmNsdWRlZCBpbiB0aGlzIHJlY29yZCwgaWYgdGhlcmUgYXJlXG4gICAqIGR1cGxpY2F0ZXMsIHRoZSBsYXN0IHZhbHVlIHdpbGwgYmUgdGhlIHZhbHVlIHRoYXQgaXMgc2V0IGhlcmUuICBJZiB0aGVyZVxuICAgKiBpcyBhIHBvc3NpYmlsaXR5IG9mIGR1cGxpY2F0ZSB2YWx1ZXMsIHVzZSB0aGUgYC5zdHJlYW0oKWAgbWV0aG9kIHRvXG4gICAqIGl0ZXJhdGUgb3ZlciB0aGUgdmFsdWVzLiAqL1xuICBmaWVsZHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5cbiAgLyoqIEFuIGFycmF5IG9mIGFueSBmaWxlcyB0aGF0IHdlcmUgcGFydCBvZiB0aGUgZm9ybSBkYXRhLiAqL1xuICBmaWxlcz86IEZvcm1EYXRhRmlsZVtdO1xufVxuXG4vKiogQSByZXByZXNlbnRhdGlvbiBvZiBhIGZpbGUgdGhhdCBoYXMgYmVlbiByZWFkIGZyb20gYSBmb3JtIGRhdGEgYm9keS4gKi9cbmV4cG9ydCB0eXBlIEZvcm1EYXRhRmlsZSA9IHtcbiAgLyoqIFdoZW4gdGhlIGZpbGUgaGFzIG5vdCBiZWVuIHdyaXR0ZW4gb3V0IHRvIGRpc2MsIHRoZSBjb250ZW50cyBvZiB0aGUgZmlsZVxuICAgKiBhcyBhIGBVaW50OEFycmF5YC4gKi9cbiAgY29udGVudD86IFVpbnQ4QXJyYXk7XG5cbiAgLyoqIFRoZSBjb250ZW50IHR5cGUgb2cgdGhlIGZvcm0gZGF0YSBmaWxlLiAqL1xuICBjb250ZW50VHlwZTogc3RyaW5nO1xuXG4gIC8qKiBXaGVuIHRoZSBmaWxlIGhhcyBiZWVuIHdyaXR0ZW4gb3V0IHRvIGRpc2MsIHRoZSBmdWxsIHBhdGggdG8gdGhlIGZpbGUuICovXG4gIGZpbGVuYW1lPzogc3RyaW5nO1xuXG4gIC8qKiBUaGUgYG5hbWVgIHRoYXQgd2FzIGFzc2lnbmVkIHRvIHRoZSBmb3JtIGRhdGEgZmlsZS4gKi9cbiAgbmFtZTogc3RyaW5nO1xuXG4gIC8qKiBUaGUgYGZpbGVuYW1lYCB0aGF0IHdhcyBwcm92aWRlZCBpbiB0aGUgZm9ybSBkYXRhIGZpbGUuICovXG4gIG9yaWdpbmFsTmFtZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBGb3JtRGF0YVJlYWRPcHRpb25zIHtcbiAgLyoqIFRoZSBzaXplIG9mIHRoZSBidWZmZXIgdG8gcmVhZCBmcm9tIHRoZSByZXF1ZXN0IGJvZHkgYXQgYSBzaW5nbGUgdGltZS5cbiAgICogVGhpcyBkZWZhdWx0cyB0byAxbWIuICovXG4gIGJ1ZmZlclNpemU/OiBudW1iZXI7XG5cbiAgLyoqIEEgbWFwcGluZyBvZiBjdXN0b20gbWVkaWEgdHlwZXMgdGhhdCBhcmUgc3VwcG9ydGVkLCBtYXBwZWQgdG8gdGhlaXJcbiAgICogZXh0ZW5zaW9uIHdoZW4gZGV0ZXJtaW5pbmcgdGhlIGV4dGVuc2lvbiBmb3IgYSBmaWxlLiBUaGUga2V5IHNob3VsZCBiZSBhblxuICAgKiBhbGwgbG93ZXJjYXNlIG1lZGlhIHR5cGUgd2l0aCB0aGUgdmFsdWUgYmVpbmcgdGhlIGV4dGVuc2lvbiAod2l0aG91dCBhblxuICAgKiBpbml0aWFsIHBlcmlvZCksIHRvIGJlIHVzZWQgd2hlbiBkZWNvZGluZyB0aGUgZmlsZS5cbiAgICpcbiAgICogIyMjIEV4YW1wbGVcbiAgICpcbiAgICogRm9ybSBkYXRhIHRoYXQgaXMgc2VudCB3aXRoIGNvbnRlbnQgaGF2aW5nIGEgdHlwZSBvZiBgdGV4dC92ZG4uY3VzdG9tYCB3aWxsXG4gICAqIGJlIGRlY29kZWQgYW5kIGFzc2lnbmVkIGEgZmlsZW5hbWUgZW5kaW5nIHdpdGggYC50eHRgOlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICpcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gICAqIGFwcC51c2UoYXN5bmMgKGN0eCkgPT4ge1xuICAgKiAgIGNvbnN0IGJvZHkgPSBjdHgucmVxdWVzdC5ib2R5KCk7XG4gICAqICAgaWYgKGJvZHkudHlwZSA9PT0gXCJmb3JtLWRhdGFcIikge1xuICAgKiAgICAgY29uc3QgZm9ybWF0RGF0YSA9IGF3YWl0IGJvZHkudmFsdWUucmVhZCh7XG4gICAqICAgICAgIGN1c3RvbUNvbnRlbnRUeXBlczoge1xuICAgKiAgICAgICAgIFwidGV4dC92bmQuY3VzdG9tXCI6IFwidHh0XCJcbiAgICogICAgICAgfVxuICAgKiAgICAgfSk7XG4gICAqICAgICBjb25zb2xlLmxvZyhmb3JtRGF0YSk7XG4gICAqICAgfVxuICAgKiB9KTtcbiAgICogYGBgXG4gICAqL1xuICBjdXN0b21Db250ZW50VHlwZXM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qKiBUaGUgbWF4aW11bSBmaWxlIHNpemUgdGhhdCBjYW4gYmUgaGFuZGxlZC4gIFRoaXMgZGVmYXVsdHMgdG8gMTBNQiB3aGVuXG4gICAqIG5vdCBzcGVjaWZpZWQuICBUaGlzIGlzIHRvIHRyeSB0byBhdm9pZCBET1MgYXR0YWNrcyB3aGVyZSBzb21lb25lIHdvdWxkXG4gICAqIGNvbnRpbnVlIHRvIHRyeSB0byBzZW5kIGEgXCJmaWxlXCIgY29udGludW91c2x5IHVudGlsIGEgaG9zdCBsaW1pdCB3YXNcbiAgICogcmVhY2hlZCBjcmFzaGluZyB0aGUgc2VydmVyIG9yIHRoZSBob3N0LiAqL1xuICBtYXhGaWxlU2l6ZT86IG51bWJlcjtcblxuICAvKiogVGhlIG1heGltdW0gc2l6ZSBvZiBhIGZpbGUgdG8gaG9sZCBpbiBtZW1vcnksIGFuZCBub3Qgd3JpdGUgdG8gZGlzay4gVGhpc1xuICAgKiBkZWZhdWx0cyB0byBgMGAsIHNvIHRoYXQgYWxsIG11bHRpcGFydCBmb3JtIGZpbGVzIGFyZSB3cml0dGVuIHRvIGRpc2suXG4gICAqIFdoZW4gc2V0IHRvIGEgcG9zaXRpdmUgaW50ZWdlciwgaWYgdGhlIGZvcm0gZGF0YSBmaWxlIGlzIHNtYWxsZXIsIGl0IHdpbGxcbiAgICogYmUgcmV0YWluZWQgaW4gbWVtb3J5IGFuZCBhdmFpbGFibGUgaW4gdGhlIGAuY29udGVudGAgcHJvcGVydHkgb2YgdGhlXG4gICAqIGBGb3JtRGF0YUZpbGVgIG9iamVjdC4gIElmIHRoZSBmaWxlIGV4Y2VlZHMgdGhlIGBtYXhTaXplYCBpdCB3aWxsIGJlXG4gICAqIHdyaXR0ZW4gdG8gZGlzayBhbmQgdGhlIGBmaWxlbmFtZWAgZmlsZSB3aWxsIGNvbnRhaW4gdGhlIGZ1bGwgcGF0aCB0byB0aGVcbiAgICogb3V0cHV0IGZpbGUuICovXG4gIG1heFNpemU/OiBudW1iZXI7XG5cbiAgLyoqIFdoZW4gd3JpdGluZyBmb3JtIGRhdGEgZmlsZXMgdG8gZGlzaywgdGhlIG91dHB1dCBwYXRoLiAgVGhpcyB3aWxsIGRlZmF1bHRcbiAgICogdG8gYSB0ZW1wb3JhcnkgcGF0aCBnZW5lcmF0ZWQgYnkgYERlbm8ubWFrZVRlbXBEaXIoKWAuICovXG4gIG91dFBhdGg/OiBzdHJpbmc7XG5cbiAgLyoqIFdoZW4gYSBmb3JtIGRhdGEgZmlsZSBpcyB3cml0dGVuIHRvIGRpc2ssIGl0IHdpbGwgYmUgZ2VuZXJhdGVkIHdpdGggYVxuICAgKiByYW5kb20gZmlsZW5hbWUgYW5kIGhhdmUgYW4gZXh0ZW5zaW9uIGJhc2VkIG9mZiB0aGUgY29udGVudCB0eXBlIGZvciB0aGVcbiAgICogZmlsZS4gIGBwcmVmaXhgIGNhbiBiZSBzcGVjaWZpZWQgdGhvdWdoIHRvIHByZXBlbmQgdG8gdGhlIGZpbGUgbmFtZS4gKi9cbiAgcHJlZml4Pzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgUGFydHNPcHRpb25zIHtcbiAgYm9keTogQnVmUmVhZGVyO1xuICBjdXN0b21Db250ZW50VHlwZXM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBmaW5hbDogVWludDhBcnJheTtcbiAgbWF4RmlsZVNpemU6IG51bWJlcjtcbiAgbWF4U2l6ZTogbnVtYmVyO1xuICBvdXRQYXRoPzogc3RyaW5nO1xuICBwYXJ0OiBVaW50OEFycmF5O1xuICBwcmVmaXg/OiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGFwcGVuZChhOiBVaW50OEFycmF5LCBiOiBVaW50OEFycmF5KTogVWludDhBcnJheSB7XG4gIGNvbnN0IGFiID0gbmV3IFVpbnQ4QXJyYXkoYS5sZW5ndGggKyBiLmxlbmd0aCk7XG4gIGFiLnNldChhLCAwKTtcbiAgYWIuc2V0KGIsIGEubGVuZ3RoKTtcbiAgcmV0dXJuIGFiO1xufVxuXG5mdW5jdGlvbiBpc0VxdWFsKGE6IFVpbnQ4QXJyYXksIGI6IFVpbnQ4QXJyYXkpOiBib29sZWFuIHtcbiAgcmV0dXJuIGVxdWFscyhza2lwTFdTUENoYXIoYSksIGIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkVG9TdGFydE9yRW5kKFxuICBib2R5OiBCdWZSZWFkZXIsXG4gIHN0YXJ0OiBVaW50OEFycmF5LFxuICBlbmQ6IFVpbnQ4QXJyYXksXG4pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgbGV0IGxpbmVSZXN1bHQ6IFJlYWRMaW5lUmVzdWx0IHwgbnVsbDtcbiAgd2hpbGUgKChsaW5lUmVzdWx0ID0gYXdhaXQgYm9keS5yZWFkTGluZSgpKSkge1xuICAgIGlmIChpc0VxdWFsKGxpbmVSZXN1bHQuYnl0ZXMsIHN0YXJ0KSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChpc0VxdWFsKGxpbmVSZXN1bHQuYnl0ZXMsIGVuZCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICBcIlVuYWJsZSB0byBmaW5kIG11bHRpLXBhcnQgYm91bmRhcnkuXCIsXG4gICk7XG59XG5cbi8qKiBZaWVsZCB1cCBpbmRpdmlkdWFsIHBhcnRzIGJ5IHJlYWRpbmcgdGhlIGJvZHkgYW5kIHBhcnNpbmcgb3V0IHRoZSBmb3JkXG4gKiBkYXRhIHZhbHVlcy4gKi9cbmFzeW5jIGZ1bmN0aW9uKiBwYXJ0cyhcbiAge1xuICAgIGJvZHksXG4gICAgY3VzdG9tQ29udGVudFR5cGVzID0ge30sXG4gICAgZmluYWwsXG4gICAgcGFydCxcbiAgICBtYXhGaWxlU2l6ZSxcbiAgICBtYXhTaXplLFxuICAgIG91dFBhdGgsXG4gICAgcHJlZml4LFxuICB9OiBQYXJ0c09wdGlvbnMsXG4pOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8W3N0cmluZywgc3RyaW5nIHwgRm9ybURhdGFGaWxlXT4ge1xuICBhc3luYyBmdW5jdGlvbiBnZXRGaWxlKGNvbnRlbnRUeXBlOiBzdHJpbmcpOiBQcm9taXNlPFtzdHJpbmcsIERlbm8uRmlsZV0+IHtcbiAgICBjb25zdCBleHQgPSBjdXN0b21Db250ZW50VHlwZXNbY29udGVudFR5cGUudG9Mb3dlckNhc2UoKV0gPz9cbiAgICAgIGV4dGVuc2lvbihjb250ZW50VHlwZSk7XG4gICAgaWYgKCFleHQpIHtcbiAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgICAgIGBUaGUgZm9ybSBjb250YWluZWQgY29udGVudCB0eXBlIFwiJHtjb250ZW50VHlwZX1cIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBzZXJ2ZXIuYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICghb3V0UGF0aCkge1xuICAgICAgb3V0UGF0aCA9IGF3YWl0IERlbm8ubWFrZVRlbXBEaXIoKTtcbiAgICB9XG4gICAgY29uc3QgZmlsZW5hbWUgPSBgJHtvdXRQYXRofS8ke2F3YWl0IGdldFJhbmRvbUZpbGVuYW1lKHByZWZpeCwgZXh0KX1gO1xuICAgIGNvbnN0IGZpbGUgPSBhd2FpdCBEZW5vLm9wZW4oZmlsZW5hbWUsIHsgd3JpdGU6IHRydWUsIGNyZWF0ZU5ldzogdHJ1ZSB9KTtcbiAgICByZXR1cm4gW2ZpbGVuYW1lLCBmaWxlXTtcbiAgfVxuXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgaGVhZGVycyA9IGF3YWl0IHJlYWRIZWFkZXJzKGJvZHkpO1xuICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXTtcbiAgICBjb25zdCBjb250ZW50RGlzcG9zaXRpb24gPSBoZWFkZXJzW1wiY29udGVudC1kaXNwb3NpdGlvblwiXTtcbiAgICBpZiAoIWNvbnRlbnREaXNwb3NpdGlvbikge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgXCJGb3JtIGRhdGEgcGFydCBtaXNzaW5nIGNvbnRlbnQtZGlzcG9zaXRpb24gaGVhZGVyXCIsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoIWNvbnRlbnREaXNwb3NpdGlvbi5tYXRjaCgvXmZvcm0tZGF0YTsvaSkpIHtcbiAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgICAgIGBVbmV4cGVjdGVkIGNvbnRlbnQtZGlzcG9zaXRpb24gaGVhZGVyOiBcIiR7Y29udGVudERpc3Bvc2l0aW9ufVwiYCxcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IG1hdGNoZXMgPSBOQU1FX1BBUkFNX1JFR0VYLmV4ZWMoY29udGVudERpc3Bvc2l0aW9uKTtcbiAgICBpZiAoIW1hdGNoZXMpIHtcbiAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgICAgIGBVbmFibGUgdG8gZGV0ZXJtaW5lIG5hbWUgb2YgZm9ybSBib2R5IHBhcnRgLFxuICAgICAgKTtcbiAgICB9XG4gICAgbGV0IFssIG5hbWVdID0gbWF0Y2hlcztcbiAgICBuYW1lID0gdW5xdW90ZShuYW1lKTtcbiAgICBpZiAoY29udGVudFR5cGUpIHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsTmFtZSA9IGdldEZpbGVuYW1lKGNvbnRlbnREaXNwb3NpdGlvbik7XG4gICAgICBsZXQgYnl0ZUxlbmd0aCA9IDA7XG4gICAgICBsZXQgZmlsZTogRGVuby5GaWxlIHwgdW5kZWZpbmVkO1xuICAgICAgbGV0IGZpbGVuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgYnVmOiBVaW50OEFycmF5IHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKG1heFNpemUpIHtcbiAgICAgICAgYnVmID0gbmV3IFVpbnQ4QXJyYXkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEZpbGUoY29udGVudFR5cGUpO1xuICAgICAgICBmaWxlbmFtZSA9IHJlc3VsdFswXTtcbiAgICAgICAgZmlsZSA9IHJlc3VsdFsxXTtcbiAgICAgIH1cbiAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGNvbnN0IHJlYWRSZXN1bHQgPSBhd2FpdCBib2R5LnJlYWRMaW5lKGZhbHNlKTtcbiAgICAgICAgaWYgKCFyZWFkUmVzdWx0KSB7XG4gICAgICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcIlVuZXhwZWN0ZWQgRU9GIHJlYWNoZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBieXRlcyB9ID0gcmVhZFJlc3VsdDtcbiAgICAgICAgY29uc3Qgc3RyaXBwZWRCeXRlcyA9IHN0cmlwRW9sKGJ5dGVzKTtcbiAgICAgICAgaWYgKGlzRXF1YWwoc3RyaXBwZWRCeXRlcywgcGFydCkgfHwgaXNFcXVhbChzdHJpcHBlZEJ5dGVzLCBmaW5hbCkpIHtcbiAgICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgLy8gcmVtb3ZlIGV4dHJhIDIgYnl0ZXMgKFtDUiwgTEZdKSBmcm9tIHJlc3VsdCBmaWxlXG4gICAgICAgICAgICBjb25zdCBieXRlc0RpZmYgPSBieXRlcy5sZW5ndGggLSBzdHJpcHBlZEJ5dGVzLmxlbmd0aDtcbiAgICAgICAgICAgIGlmIChieXRlc0RpZmYpIHtcbiAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxCeXRlc1NpemUgPSBhd2FpdCBmaWxlLnNlZWsoXG4gICAgICAgICAgICAgICAgLWJ5dGVzRGlmZixcbiAgICAgICAgICAgICAgICBEZW5vLlNlZWtNb2RlLkN1cnJlbnQsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIGF3YWl0IGZpbGUudHJ1bmNhdGUob3JpZ2luYWxCeXRlc1NpemUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmaWxlLmNsb3NlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHlpZWxkIFtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGNvbnRlbnQ6IGJ1ZixcbiAgICAgICAgICAgICAgY29udGVudFR5cGUsXG4gICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgICBvcmlnaW5hbE5hbWUsXG4gICAgICAgICAgICB9IGFzIEZvcm1EYXRhRmlsZSxcbiAgICAgICAgICBdO1xuICAgICAgICAgIGlmIChpc0VxdWFsKHN0cmlwcGVkQnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBieXRlTGVuZ3RoICs9IGJ5dGVzLmJ5dGVMZW5ndGg7XG4gICAgICAgIGlmIChieXRlTGVuZ3RoID4gbWF4RmlsZVNpemUpIHtcbiAgICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5jbG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5SZXF1ZXN0RW50aXR5VG9vTGFyZ2UoXG4gICAgICAgICAgICBgRmlsZSBzaXplIGV4Y2VlZHMgbGltaXQgb2YgJHttYXhGaWxlU2l6ZX0gYnl0ZXMuYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChidWYpIHtcbiAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCA+IG1heFNpemUpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEZpbGUoY29udGVudFR5cGUpO1xuICAgICAgICAgICAgZmlsZW5hbWUgPSByZXN1bHRbMF07XG4gICAgICAgICAgICBmaWxlID0gcmVzdWx0WzFdO1xuICAgICAgICAgICAgYXdhaXQgd3JpdGVBbGwoZmlsZSwgYnVmKTtcbiAgICAgICAgICAgIGJ1ZiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnVmID0gYXBwZW5kKGJ1ZiwgYnl0ZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgIGF3YWl0IHdyaXRlQWxsKGZpbGUsIGJ5dGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcbiAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgIGNvbnN0IHJlYWRSZXN1bHQgPSBhd2FpdCBib2R5LnJlYWRMaW5lKCk7XG4gICAgICAgIGlmICghcmVhZFJlc3VsdCkge1xuICAgICAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXCJVbmV4cGVjdGVkIEVPRiByZWFjaGVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgYnl0ZXMgfSA9IHJlYWRSZXN1bHQ7XG4gICAgICAgIGlmIChpc0VxdWFsKGJ5dGVzLCBwYXJ0KSB8fCBpc0VxdWFsKGJ5dGVzLCBmaW5hbCkpIHtcbiAgICAgICAgICB5aWVsZCBbbmFtZSwgbGluZXMuam9pbihcIlxcblwiKV07XG4gICAgICAgICAgaWYgKGlzRXF1YWwoYnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBsaW5lcy5wdXNoKGRlY29kZXIuZGVjb2RlKGJ5dGVzKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKiBBIGNsYXNzIHdoaWNoIHByb3ZpZGVzIGFuIGludGVyZmFjZSB0byBhY2Nlc3MgdGhlIGZpZWxkcyBvZiBhXG4gKiBgbXVsdGlwYXJ0L2Zvcm0tZGF0YWAgYm9keS4gKi9cbmV4cG9ydCBjbGFzcyBGb3JtRGF0YVJlYWRlciB7XG4gICNib2R5OiBEZW5vLlJlYWRlcjtcbiAgI2JvdW5kYXJ5RmluYWw6IFVpbnQ4QXJyYXk7XG4gICNib3VuZGFyeVBhcnQ6IFVpbnQ4QXJyYXk7XG4gICNyZWFkaW5nID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoY29udGVudFR5cGU6IHN0cmluZywgYm9keTogRGVuby5SZWFkZXIpIHtcbiAgICBjb25zdCBtYXRjaGVzID0gY29udGVudFR5cGUubWF0Y2goQk9VTkRBUllfUEFSQU1fUkVHRVgpO1xuICAgIGlmICghbWF0Y2hlcykge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgYENvbnRlbnQgdHlwZSBcIiR7Y29udGVudFR5cGV9XCIgZG9lcyBub3QgY29udGFpbiBhIHZhbGlkIGJvdW5kYXJ5LmAsXG4gICAgICApO1xuICAgIH1cbiAgICBsZXQgWywgYm91bmRhcnldID0gbWF0Y2hlcztcbiAgICBib3VuZGFyeSA9IHVucXVvdGUoYm91bmRhcnkpO1xuICAgIHRoaXMuI2JvdW5kYXJ5UGFydCA9IGVuY29kZXIuZW5jb2RlKGAtLSR7Ym91bmRhcnl9YCk7XG4gICAgdGhpcy4jYm91bmRhcnlGaW5hbCA9IGVuY29kZXIuZW5jb2RlKGAtLSR7Ym91bmRhcnl9LS1gKTtcbiAgICB0aGlzLiNib2R5ID0gYm9keTtcbiAgfVxuXG4gIC8qKiBSZWFkcyB0aGUgbXVsdGlwYXJ0IGJvZHkgb2YgdGhlIHJlc3BvbnNlIGFuZCByZXNvbHZlcyB3aXRoIGFuIG9iamVjdCB3aGljaFxuICAgKiBjb250YWlucyBmaWVsZHMgYW5kIGZpbGVzIHRoYXQgd2VyZSBwYXJ0IG9mIHRoZSByZXNwb25zZS5cbiAgICpcbiAgICogKk5vdGUqOiB0aGlzIG1ldGhvZCBoYW5kbGVzIG11bHRpcGxlIGZpbGVzIHdpdGggdGhlIHNhbWUgYG5hbWVgIGF0dHJpYnV0ZVxuICAgKiBpbiB0aGUgcmVxdWVzdCwgYnV0IGJ5IGRlc2lnbiBpdCBkb2VzIG5vdCBoYW5kbGUgbXVsdGlwbGUgZmllbGRzIHRoYXQgc2hhcmVcbiAgICogdGhlIHNhbWUgYG5hbWVgLiAgSWYgeW91IGV4cGVjdCB0aGUgcmVxdWVzdCBib2R5IHRvIGNvbnRhaW4gbXVsdGlwbGUgZm9ybVxuICAgKiBkYXRhIGZpZWxkcyB3aXRoIHRoZSBzYW1lIG5hbWUsIGl0IGlzIGJldHRlciB0byB1c2UgdGhlIGAuc3RyZWFtKClgIG1ldGhvZFxuICAgKiB3aGljaCB3aWxsIGl0ZXJhdGUgb3ZlciBlYWNoIGZvcm0gZGF0YSBmaWVsZCBpbmRpdmlkdWFsbHkuICovXG4gIGFzeW5jIHJlYWQob3B0aW9uczogRm9ybURhdGFSZWFkT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxGb3JtRGF0YUJvZHk+IHtcbiAgICBpZiAodGhpcy4jcmVhZGluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQm9keSBpcyBhbHJlYWR5IGJlaW5nIHJlYWQuXCIpO1xuICAgIH1cbiAgICB0aGlzLiNyZWFkaW5nID0gdHJ1ZTtcbiAgICBjb25zdCB7XG4gICAgICBvdXRQYXRoLFxuICAgICAgbWF4RmlsZVNpemUgPSBERUZBVUxUX01BWF9GSUxFX1NJWkUsXG4gICAgICBtYXhTaXplID0gREVGQVVMVF9NQVhfU0laRSxcbiAgICAgIGJ1ZmZlclNpemUgPSBERUZBVUxUX0JVRkZFUl9TSVpFLFxuICAgICAgY3VzdG9tQ29udGVudFR5cGVzLFxuICAgIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgQnVmUmVhZGVyKHRoaXMuI2JvZHksIGJ1ZmZlclNpemUpO1xuICAgIGNvbnN0IHJlc3VsdDogRm9ybURhdGFCb2R5ID0geyBmaWVsZHM6IHt9IH07XG4gICAgaWYgKFxuICAgICAgIShhd2FpdCByZWFkVG9TdGFydE9yRW5kKGJvZHksIHRoaXMuI2JvdW5kYXJ5UGFydCwgdGhpcy4jYm91bmRhcnlGaW5hbCkpXG4gICAgKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgZm9yIGF3YWl0IChcbiAgICAgICAgY29uc3QgcGFydCBvZiBwYXJ0cyh7XG4gICAgICAgICAgYm9keSxcbiAgICAgICAgICBjdXN0b21Db250ZW50VHlwZXMsXG4gICAgICAgICAgcGFydDogdGhpcy4jYm91bmRhcnlQYXJ0LFxuICAgICAgICAgIGZpbmFsOiB0aGlzLiNib3VuZGFyeUZpbmFsLFxuICAgICAgICAgIG1heEZpbGVTaXplLFxuICAgICAgICAgIG1heFNpemUsXG4gICAgICAgICAgb3V0UGF0aCxcbiAgICAgICAgfSlcbiAgICAgICkge1xuICAgICAgICBjb25zdCBba2V5LCB2YWx1ZV0gPSBwYXJ0O1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgcmVzdWx0LmZpZWxkc1trZXldID0gdmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCFyZXN1bHQuZmlsZXMpIHtcbiAgICAgICAgICAgIHJlc3VsdC5maWxlcyA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXN1bHQuZmlsZXMucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBEZW5vLmVycm9ycy5QZXJtaXNzaW9uRGVuaWVkKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrID8gZXJyLnN0YWNrIDogYCR7ZXJyLm5hbWV9OiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gaXRlcmF0b3Igd2hpY2ggd2lsbCBhc3luY2hyb25vdXNseSB5aWVsZCBlYWNoIHBhcnQgb2YgdGhlIGZvcm1cbiAgICogZGF0YS4gIFRoZSB5aWVsZGVkIHZhbHVlIGlzIGEgdHVwbGUsIHdoZXJlIHRoZSBmaXJzdCBlbGVtZW50IGlzIHRoZSBuYW1lXG4gICAqIG9mIHRoZSBwYXJ0IGFuZCB0aGUgc2Vjb25kIGVsZW1lbnQgaXMgYSBgc3RyaW5nYCBvciBhIGBGb3JtRGF0YUZpbGVgXG4gICAqIG9iamVjdC4gKi9cbiAgYXN5bmMgKnN0cmVhbShcbiAgICBvcHRpb25zOiBGb3JtRGF0YVJlYWRPcHRpb25zID0ge30sXG4gICk6IEFzeW5jSXRlcmFibGVJdGVyYXRvcjxbc3RyaW5nLCBzdHJpbmcgfCBGb3JtRGF0YUZpbGVdPiB7XG4gICAgaWYgKHRoaXMuI3JlYWRpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJvZHkgaXMgYWxyZWFkeSBiZWluZyByZWFkLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jcmVhZGluZyA9IHRydWU7XG4gICAgY29uc3Qge1xuICAgICAgb3V0UGF0aCxcbiAgICAgIGN1c3RvbUNvbnRlbnRUeXBlcyxcbiAgICAgIG1heEZpbGVTaXplID0gREVGQVVMVF9NQVhfRklMRV9TSVpFLFxuICAgICAgbWF4U2l6ZSA9IERFRkFVTFRfTUFYX1NJWkUsXG4gICAgICBidWZmZXJTaXplID0gMzIwMDAsXG4gICAgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgYm9keSA9IG5ldyBCdWZSZWFkZXIodGhpcy4jYm9keSwgYnVmZmVyU2l6ZSk7XG4gICAgaWYgKFxuICAgICAgIShhd2FpdCByZWFkVG9TdGFydE9yRW5kKGJvZHksIHRoaXMuI2JvdW5kYXJ5UGFydCwgdGhpcy4jYm91bmRhcnlGaW5hbCkpXG4gICAgKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKFxuICAgICAgICBjb25zdCBwYXJ0IG9mIHBhcnRzKHtcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIGN1c3RvbUNvbnRlbnRUeXBlcyxcbiAgICAgICAgICBwYXJ0OiB0aGlzLiNib3VuZGFyeVBhcnQsXG4gICAgICAgICAgZmluYWw6IHRoaXMuI2JvdW5kYXJ5RmluYWwsXG4gICAgICAgICAgbWF4RmlsZVNpemUsXG4gICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICBvdXRQYXRoLFxuICAgICAgICB9KVxuICAgICAgKSB7XG4gICAgICAgIHlpZWxkIHBhcnQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBbU3ltYm9sLmZvcihcIkRlbm8uY3VzdG9tSW5zcGVjdFwiKV0oaW5zcGVjdDogKHZhbHVlOiB1bmtub3duKSA9PiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSAke2luc3BlY3Qoe30pfWA7XG4gIH1cbn1cbiJdfQ==
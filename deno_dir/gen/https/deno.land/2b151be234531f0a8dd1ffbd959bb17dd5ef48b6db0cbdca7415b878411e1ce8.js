import { AuthPlugin } from "./base.ts";
import { driverMetadata } from "../protocol/mod.ts";
export class X509AuthPlugin extends AuthPlugin {
    constructor() {
        super();
    }
    prepare(authContext) {
        const handshakeDoc = {
            ismaster: true,
            client: driverMetadata,
            compression: authContext.options.compression,
            speculativeAuthenticate: x509AuthenticateCommand(authContext.credentials),
        };
        return handshakeDoc;
    }
    auth(authContext) {
        if (authContext.response.speculativeAuthenticate) {
            return Promise.resolve(authContext.response);
        }
        return authContext.protocol.commandSingle("$external", x509AuthenticateCommand(authContext.credentials));
    }
}
function x509AuthenticateCommand(credentials) {
    const command = { authenticate: 1, mechanism: "MONGODB-X509" };
    if (credentials) {
        command.user = credentials.username;
    }
    return command;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieDUwOS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIng1MDkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFlLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVwRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFRcEQsTUFBTSxPQUFPLGNBQWUsU0FBUSxVQUFVO0lBQzVDO1FBQ0UsS0FBSyxFQUFFLENBQUM7SUFDVixDQUFDO0lBQ0QsT0FBTyxDQUFDLFdBQXdCO1FBQzlCLE1BQU0sWUFBWSxHQUF1QjtZQUN2QyxRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxjQUFjO1lBQ3RCLFdBQVcsRUFBRSxXQUFXLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDNUMsdUJBQXVCLEVBQUUsdUJBQXVCLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQztTQUMxRSxDQUFDO1FBQ0YsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELElBQUksQ0FBQyxXQUF3QjtRQUMzQixJQUFJLFdBQVcsQ0FBQyxRQUFTLENBQUMsdUJBQXVCLEVBQUU7WUFDakQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFTLENBQUMsQ0FBQztTQUMvQztRQUNELE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQ3ZDLFdBQVcsRUFDWCx1QkFBdUIsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQ2pELENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFFRCxTQUFTLHVCQUF1QixDQUFDLFdBQXdCO0lBQ3ZELE1BQU0sT0FBTyxHQUFnQixFQUFFLFlBQVksRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxDQUFDO0lBQzVFLElBQUksV0FBVyxFQUFFO1FBQ2YsT0FBTyxDQUFDLElBQUksR0FBRyxXQUFZLENBQUMsUUFBUSxDQUFDO0tBQ3RDO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENyZWRlbnRpYWwsIERvY3VtZW50IH0gZnJvbSBcIi4uL3R5cGVzLnRzXCI7XG5pbXBvcnQgeyBBdXRoQ29udGV4dCwgQXV0aFBsdWdpbiB9IGZyb20gXCIuL2Jhc2UudHNcIjtcbmltcG9ydCB7IEhhbmRzaGFrZURvY3VtZW50IH0gZnJvbSBcIi4uL3Byb3RvY29sL2hhbmRzaGFrZS50c1wiO1xuaW1wb3J0IHsgZHJpdmVyTWV0YWRhdGEgfSBmcm9tIFwiLi4vcHJvdG9jb2wvbW9kLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgWDUwOUNvbW1hbmQgZXh0ZW5kcyBEb2N1bWVudCB7XG4gIGF1dGhlbnRpY2F0ZTogbnVtYmVyO1xuICBtZWNoYW5pc206IHN0cmluZztcbiAgdXNlcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFg1MDlBdXRoUGx1Z2luIGV4dGVuZHMgQXV0aFBsdWdpbiB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gIH1cbiAgcHJlcGFyZShhdXRoQ29udGV4dDogQXV0aENvbnRleHQpOiBEb2N1bWVudCB7XG4gICAgY29uc3QgaGFuZHNoYWtlRG9jID0gPEhhbmRzaGFrZURvY3VtZW50PiB7XG4gICAgICBpc21hc3RlcjogdHJ1ZSxcbiAgICAgIGNsaWVudDogZHJpdmVyTWV0YWRhdGEsXG4gICAgICBjb21wcmVzc2lvbjogYXV0aENvbnRleHQub3B0aW9ucy5jb21wcmVzc2lvbixcbiAgICAgIHNwZWN1bGF0aXZlQXV0aGVudGljYXRlOiB4NTA5QXV0aGVudGljYXRlQ29tbWFuZChhdXRoQ29udGV4dC5jcmVkZW50aWFscyksXG4gICAgfTtcbiAgICByZXR1cm4gaGFuZHNoYWtlRG9jO1xuICB9XG5cbiAgYXV0aChhdXRoQ29udGV4dDogQXV0aENvbnRleHQpOiBQcm9taXNlPERvY3VtZW50PiB7XG4gICAgaWYgKGF1dGhDb250ZXh0LnJlc3BvbnNlIS5zcGVjdWxhdGl2ZUF1dGhlbnRpY2F0ZSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdXRoQ29udGV4dC5yZXNwb25zZSEpO1xuICAgIH1cbiAgICByZXR1cm4gYXV0aENvbnRleHQucHJvdG9jb2wuY29tbWFuZFNpbmdsZShcbiAgICAgIFwiJGV4dGVybmFsXCIsXG4gICAgICB4NTA5QXV0aGVudGljYXRlQ29tbWFuZChhdXRoQ29udGV4dC5jcmVkZW50aWFscyksXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB4NTA5QXV0aGVudGljYXRlQ29tbWFuZChjcmVkZW50aWFscz86IENyZWRlbnRpYWwpOiBEb2N1bWVudCB7XG4gIGNvbnN0IGNvbW1hbmQ6IFg1MDlDb21tYW5kID0geyBhdXRoZW50aWNhdGU6IDEsIG1lY2hhbmlzbTogXCJNT05HT0RCLVg1MDlcIiB9O1xuICBpZiAoY3JlZGVudGlhbHMpIHtcbiAgICBjb21tYW5kLnVzZXIgPSBjcmVkZW50aWFscyEudXNlcm5hbWU7XG4gIH1cbiAgcmV0dXJuIGNvbW1hbmQ7XG59XG4iXX0=
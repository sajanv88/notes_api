import { assert, Bson } from "../../deps.ts";
import { checkIndexes } from "./indexes.ts";
import { createUploadStream } from "./upload.ts";
export class GridFSBucket {
    #chunksCollection;
    #filesCollection;
    #chunkSizeBytes;
    #checkedIndexes = false;
    getBucketData = () => ({
        filesCollection: this.#filesCollection,
        chunksCollection: this.#chunksCollection,
        chunkSizeBytes: this.#chunkSizeBytes,
    });
    constructor(db, options = {}) {
        const newLocal = options.bucketName ?? "fs";
        this.#chunksCollection = db.collection(`${newLocal}.chunks`);
        this.#filesCollection = db.collection(`${newLocal}.files`);
        this.#chunkSizeBytes = options.chunkSizeBytes ?? 255 * 1024;
    }
    openUploadStream(filename, options) {
        return this.openUploadStreamWithId(new Bson.ObjectId(), filename, options);
    }
    async openUploadStreamWithId(id, filename, options) {
        if (!this.#checkedIndexes)
            await this.#checkIndexes();
        return createUploadStream(this.getBucketData(), filename, id, options);
    }
    async uploadFromStream(filename, source, options) {
        const objectid = new Bson.ObjectId();
        await source.pipeTo(await this.openUploadStreamWithId(objectid, filename, options));
        return objectid;
    }
    async uploadFromStreamWithId(id, filename, source, options) {
        await source.pipeTo(await this.openUploadStreamWithId(id, filename, options));
    }
    async openDownloadStream(id) {
        if (!this.#checkedIndexes)
            await this.#checkIndexes();
        return new ReadableStream({
            start: async (controller) => {
                const collection = this.#chunksCollection.find({ files_id: id });
                await collection.forEach((value) => controller.enqueue(value?.data.buffer));
                controller.close();
            },
        });
    }
    async downloadToStream(id, destination) {
        await (await this.openDownloadStream(id)).pipeTo(destination);
    }
    async delete(id) {
        await this.#filesCollection.deleteOne({ _id: id });
        const response = await this.#chunksCollection.deleteMany({ files_id: id });
        assert(response, `File not found for id ${id}`);
    }
    find(filter, options = {}) {
        return this.#filesCollection.find(filter ?? {}, options);
    }
    async drop() {
        await this.#filesCollection.drop();
        await this.#chunksCollection.drop();
    }
    #checkIndexes = () => checkIndexes(this.#filesCollection, this.#chunksCollection, (value) => (this.#checkedIndexes = value));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBYTdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRWpELE1BQU0sT0FBTyxZQUFZO0lBQ3ZCLGlCQUFpQixDQUFvQjtJQUNyQyxnQkFBZ0IsQ0FBbUI7SUFDbkMsZUFBZSxDQUFTO0lBQ3hCLGVBQWUsR0FBRyxLQUFLLENBQUM7SUFFUCxhQUFhLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN0QyxlQUFlLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtRQUN0QyxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsaUJBQWlCO1FBQ3hDLGNBQWMsRUFBRSxJQUFJLENBQUMsZUFBZTtLQUNyQyxDQUFDLENBQUM7SUFLSCxZQUFZLEVBQVksRUFBRSxVQUErQixFQUFFO1FBQ3pELE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsUUFBUSxTQUFTLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLFFBQVEsUUFBUSxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxPQUFPLENBQUMsY0FBYyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7SUFDOUQsQ0FBQztJQVlELGdCQUFnQixDQUFDLFFBQWdCLEVBQUUsT0FBNkI7UUFDOUQsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQ2hDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUNuQixRQUFRLEVBQ1IsT0FBTyxD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QUFDLGdCQUFnQixFQUNyQixJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDLENBQzFDLENBQUM7Q0FDTCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydCwgQnNvbiB9IGZyb20gXCIuLi8uLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBDb2xsZWN0aW9uIH0gZnJvbSBcIi4uL2NvbGxlY3Rpb24vY29sbGVjdGlvbi50c1wiO1xuaW1wb3J0IHsgRmluZEN1cnNvciB9IGZyb20gXCIuLi9jb2xsZWN0aW9uL2NvbW1hbmRzL2ZpbmQudHNcIjtcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSBcIi4uL2RhdGFiYXNlLnRzXCI7XG5pbXBvcnQgeyBGaWx0ZXIgfSBmcm9tIFwiLi4vdHlwZXMudHNcIjtcbmltcG9ydCB7XG4gIENodW5rLFxuICBGaWxlLFxuICBGaWxlSWQsXG4gIEdyaWRGU0J1Y2tldE9wdGlvbnMsXG4gIEdyaWRGU0ZpbmRPcHRpb25zLFxuICBHcmlkRlNVcGxvYWRPcHRpb25zLFxufSBmcm9tIFwiLi4vdHlwZXMvZ3JpZGZzLnRzXCI7XG5pbXBvcnQgeyBjaGVja0luZGV4ZXMgfSBmcm9tIFwiLi9pbmRleGVzLnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVVcGxvYWRTdHJlYW0gfSBmcm9tIFwiLi91cGxvYWQudHNcIjtcblxuZXhwb3J0IGNsYXNzIEdyaWRGU0J1Y2tldCB7XG4gICNjaHVua3NDb2xsZWN0aW9uOiBDb2xsZWN0aW9uPENodW5rPjtcbiAgI2ZpbGVzQ29sbGVjdGlvbjogQ29sbGVjdGlvbjxGaWxlPjtcbiAgI2NodW5rU2l6ZUJ5dGVzOiBudW1iZXI7XG4gICNjaGVja2VkSW5kZXhlcyA9IGZhbHNlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgZ2V0QnVja2V0RGF0YSA9ICgpID0+ICh7XG4gICAgZmlsZXNDb2xsZWN0aW9uOiB0aGlzLiNmaWxlc0NvbGxlY3Rpb24sXG4gICAgY2h1bmtzQ29sbGVjdGlvbjogdGhpcy4jY2h1bmtzQ29sbGVjdGlvbixcbiAgICBjaHVua1NpemVCeXRlczogdGhpcy4jY2h1bmtTaXplQnl0ZXMsXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgR3JpZEZTQnVja2V0IG9iamVjdCBvbiBAZGIgd2l0aCB0aGUgZ2l2ZW4gQG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihkYjogRGF0YWJhc2UsIG9wdGlvbnM6IEdyaWRGU0J1Y2tldE9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IG5ld0xvY2FsID0gb3B0aW9ucy5idWNrZXROYW1lID8/IFwiZnNcIjtcbiAgICB0aGlzLiNjaHVua3NDb2xsZWN0aW9uID0gZGIuY29sbGVjdGlvbihgJHtuZXdMb2NhbH0uY2h1bmtzYCk7XG4gICAgdGhpcy4jZmlsZXNDb2xsZWN0aW9uID0gZGIuY29sbGVjdGlvbihgJHtuZXdMb2NhbH0uZmlsZXNgKTtcbiAgICB0aGlzLiNjaHVua1NpemVCeXRlcyA9IG9wdGlvbnMuY2h1bmtTaXplQnl0ZXMgPz8gMjU1ICogMTAyNDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyBhIFN0cmVhbSB0aGF0IHRoZSBhcHBsaWNhdGlvbiBjYW4gd3JpdGUgdGhlIGNvbnRlbnRzIG9mIHRoZSBmaWxlIHRvLlxuICAgKiBUaGUgZHJpdmVyIGdlbmVyYXRlcyB0aGUgZmlsZSBpZC5cbiAgICpcbiAgICogUmV0dXJucyBhIFN0cmVhbSB0byB3aGljaCB0aGUgYXBwbGljYXRpb24gd2lsbCB3cml0ZSB0aGUgY29udGVudHMuXG4gICAqXG4gICAqIE5vdGU6IHRoaXMgbWV0aG9kIGlzIHByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LiBJbiBsYW5ndWFnZXNcbiAgICogdGhhdCB1c2UgZ2VuZXJpYyB0eXBlIHBhcmFtZXRlcnMsIHRoaXMgbWV0aG9kIG1heSBiZSBvbWl0dGVkIHNpbmNlXG4gICAqIHRoZSBURmlsZUlkIHR5cGUgbWlnaHQgbm90IGJlIGFuIE9iamVjdElkLlxuICAgKi9cbiAgb3BlblVwbG9hZFN0cmVhbShmaWxlbmFtZTogc3RyaW5nLCBvcHRpb25zPzogR3JpZEZTVXBsb2FkT3B0aW9ucykge1xuICAgIHJldHVybiB0aGlzLm9wZW5VcGxvYWRTdHJlYW1XaXRoSWQoXG4gICAgICBuZXcgQnNvbi5PYmplY3RJZCgpLFxuICAgICAgZmlsZW5hbWUsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgYSBTdHJlYW0gdGhhdCB0aGUgYXBwbGljYXRpb24gY2FuIHdyaXRlIHRoZSBjb250ZW50cyBvZiB0aGUgZmlsZSB0by5cbiAgICogVGhlIGFwcGxpY2F0aW9uIHByb3ZpZGVzIGEgY3VzdG9tIGZpbGUgaWQuXG4gICAqXG4gICAqIFJldHVybnMgYSBTdHJlYW0gdG8gd2hpY2ggdGhlIGFwcGxpY2F0aW9uIHdpbGwgd3JpdGUgdGhlIGNvbnRlbnRzLlxuICAgKi9cbiAgYXN5bmMgb3BlblVwbG9hZFN0cmVhbVdpdGhJZChcbiAgICBpZDogRmlsZUlkLFxuICAgIGZpbGVuYW1lOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEdyaWRGU1VwbG9hZE9wdGlvbnMsXG4gICkge1xuICAgIGlmICghdGhpcy4jY2hlY2tlZEluZGV4ZXMpIGF3YWl0IHRoaXMuI2NoZWNrSW5kZXhlcygpO1xuICAgIHJldHVybiBjcmVhdGVVcGxvYWRTdHJlYW0odGhpcy5nZXRCdWNrZXREYXRhKCksIGZpbGVuYW1lLCBpZCwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogVXBsb2FkcyBhIHVzZXIgZmlsZSB0byBhIEdyaWRGUyBidWNrZXQuIFRoZSBkcml2ZXIgZ2VuZXJhdGVzIHRoZSBmaWxlIGlkLlxuICAgKlxuICAgKiBSZWFkcyB0aGUgY29udGVudHMgb2YgdGhlIHVzZXIgZmlsZSBmcm9tIHRoZSBAc291cmNlIFN0cmVhbSBhbmQgdXBsb2FkcyBpdFxuICAgKiBhcyBjaHVua3MgaW4gdGhlIGNodW5rcyBjb2xsZWN0aW9uLiBBZnRlciBhbGwgdGhlIGNodW5rcyBoYXZlIGJlZW4gdXBsb2FkZWQsXG4gICAqIGl0IGNyZWF0ZXMgYSBmaWxlcyBjb2xsZWN0aW9uIGRvY3VtZW50IGZvciBAZmlsZW5hbWUgaW4gdGhlIGZpbGVzIGNvbGxlY3Rpb24uXG4gICAqXG4gICAqIFJldHVybnMgdGhlIGlkIG9mIHRoZSB1cGxvYWRlZCBmaWxlLlxuICAgKlxuICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyBwcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gSW4gbGFuZ3VhZ2VzXG4gICAqIHRoYXQgdXNlIGdlbmVyaWMgdHlwZSBwYXJhbWV0ZXJzLCB0aGlzIG1ldGhvZCBtYXkgYmUgb21pdHRlZCBzaW5jZVxuICAgKiB0aGUgVEZpbGVJZCB0eXBlIG1pZ2h0IG5vdCBiZSBhbiBPYmplY3RJZC5cbiAgICovXG4gIGFzeW5jIHVwbG9hZEZyb21TdHJlYW0oXG4gICAgZmlsZW5hbWU6IHN0cmluZyxcbiAgICBzb3VyY2U6IFJlYWRhYmxlU3RyZWFtLFxuICAgIG9wdGlvbnM/OiBHcmlkRlNVcGxvYWRPcHRpb25zLFxuICApOiBQcm9taXNlPEJzb24uT2JqZWN0SWQ+IHtcbiAgICBjb25zdCBvYmplY3RpZCA9IG5ldyBCc29uLk9iamVjdElkKCk7XG4gICAgYXdhaXQgc291cmNlLnBpcGVUbyhcbiAgICAgIGF3YWl0IHRoaXMub3BlblVwbG9hZFN0cmVhbVdpdGhJZChvYmplY3RpZCwgZmlsZW5hbWUsIG9wdGlvbnMpLFxuICAgICk7XG4gICAgcmV0dXJuIG9iamVjdGlkO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwbG9hZHMgYSB1c2VyIGZpbGUgdG8gYSBHcmlkRlMgYnVja2V0LiBUaGUgYXBwbGljYXRpb24gc3VwcGxpZXMgYSBjdXN0b20gZmlsZSBpZC5cbiAgICpcbiAgICogUmVhZHMgdGhlIGNvbnRlbnRzIG9mIHRoZSB1c2VyIGZpbGUgZnJvbSB0aGUgQHNvdXJjZSBTdHJlYW0gYW5kIHVwbG9hZHMgaXRcbiAgICogYXMgY2h1bmtzIGluIHRoZSBjaHVua3MgY29sbGVjdGlvbi4gQWZ0ZXIgYWxsIHRoZSBjaHVua3MgaGF2ZSBiZWVuIHVwbG9hZGVkLFxuICAgKiBpdCBjcmVhdGVzIGEgZmlsZXMgY29sbGVjdGlvbiBkb2N1bWVudCBmb3IgQGZpbGVuYW1lIGluIHRoZSBmaWxlcyBjb2xsZWN0aW9uLlxuICAgKlxuICAgKiBOb3RlOiB0aGVyZSBpcyBubyBuZWVkIHRvIHJldHVybiB0aGUgaWQgb2YgdGhlIHVwbG9hZGVkIGZpbGUgYmVjYXVzZSB0aGUgYXBwbGljYXRpb25cbiAgICogYWxyZWFkeSBzdXBwbGllZCBpdCBhcyBhIHBhcmFtZXRlci5cbiAgICovXG4gIGFzeW5jIHVwbG9hZEZyb21TdHJlYW1XaXRoSWQoXG4gICAgaWQ6IEZpbGVJZCxcbiAgICBmaWxlbmFtZTogc3RyaW5nLFxuICAgIHNvdXJjZTogUmVhZGFibGVTdHJlYW0sXG4gICAgb3B0aW9uczogR3JpZEZTVXBsb2FkT3B0aW9ucyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgc291cmNlLnBpcGVUbyhcbiAgICAgIGF3YWl0IHRoaXMub3BlblVwbG9hZFN0cmVhbVdpdGhJZChpZCwgZmlsZW5hbWUsIG9wdGlvbnMpLFxuICAgICk7XG4gIH1cblxuICAvKiogT3BlbnMgYSBTdHJlYW0gZnJvbSB3aGljaCB0aGUgYXBwbGljYXRpb24gY2FuIHJlYWQgdGhlIGNvbnRlbnRzIG9mIHRoZSBzdG9yZWQgZmlsZVxuICAgKiBzcGVjaWZpZWQgYnkgQGlkLlxuICAgKlxuICAgKiBSZXR1cm5zIGEgU3RyZWFtLlxuICAgKi9cbiAgYXN5bmMgb3BlbkRvd25sb2FkU3RyZWFtKGlkOiBGaWxlSWQpIHtcbiAgICBpZiAoIXRoaXMuI2NoZWNrZWRJbmRleGVzKSBhd2FpdCB0aGlzLiNjaGVja0luZGV4ZXMoKTtcblxuICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW08VWludDhBcnJheT4oe1xuICAgICAgc3RhcnQ6IGFzeW5jIChjb250cm9sbGVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLiNjaHVua3NDb2xsZWN0aW9uLmZpbmQoeyBmaWxlc19pZDogaWQgfSk7XG4gICAgICAgIGF3YWl0IGNvbGxlY3Rpb24uZm9yRWFjaCgodmFsdWUpID0+XG4gICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKHZhbHVlPy5kYXRhLmJ1ZmZlcilcbiAgICAgICAgKTtcbiAgICAgICAgY29udHJvbGxlci5jbG9zZSgpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEb3dubG9hZHMgdGhlIGNvbnRlbnRzIG9mIHRoZSBzdG9yZWQgZmlsZSBzcGVjaWZpZWQgYnkgQGlkIGFuZCB3cml0ZXNcbiAgICogdGhlIGNvbnRlbnRzIHRvIHRoZSBAZGVzdGluYXRpb24gU3RyZWFtLlxuICAgKi9cbiAgYXN5bmMgZG93bmxvYWRUb1N0cmVhbShpZDogRmlsZUlkLCBkZXN0aW5hdGlvbjogV3JpdGFibGVTdHJlYW08VWludDhBcnJheT4pIHtcbiAgICBhd2FpdCAoYXdhaXQgdGhpcy5vcGVuRG93bmxvYWRTdHJlYW0oaWQpKS5waXBlVG8oZGVzdGluYXRpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdpdmVuIGEgQGlkLCBkZWxldGUgdGhpcyBzdG9yZWQgZmlsZeKAmXMgZmlsZXMgY29sbGVjdGlvbiBkb2N1bWVudCBhbmRcbiAgICogYXNzb2NpYXRlZCBjaHVua3MgZnJvbSBhIEdyaWRGUyBidWNrZXQuXG4gICAqL1xuICBhc3luYyBkZWxldGUoaWQ6IEZpbGVJZCkge1xuICAgIGF3YWl0IHRoaXMuI2ZpbGVzQ29sbGVjdGlvbi5kZWxldGVPbmUoeyBfaWQ6IGlkIH0pO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy4jY2h1bmtzQ29sbGVjdGlvbi5kZWxldGVNYW55KHsgZmlsZXNfaWQ6IGlkIH0pO1xuICAgIGFzc2VydChyZXNwb25zZSwgYEZpbGUgbm90IGZvdW5kIGZvciBpZCAke2lkfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbmQgYW5kIHJldHVybiB0aGUgZmlsZXMgY29sbGVjdGlvbiBkb2N1bWVudHMgdGhhdCBtYXRjaCBAZmlsdGVyLlxuICAgKi9cbiAgZmluZChcbiAgICBmaWx0ZXI6IEZpbHRlcjxGaWxlPixcbiAgICBvcHRpb25zOiBHcmlkRlNGaW5kT3B0aW9ucyA9IHt9LFxuICApOiBGaW5kQ3Vyc29yPEZpbGU+IHtcbiAgICByZXR1cm4gdGhpcy4jZmlsZXNDb2xsZWN0aW9uLmZpbmQoZmlsdGVyID8/IHt9LCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEcm9wcyB0aGUgZmlsZXMgYW5kIGNodW5rcyBjb2xsZWN0aW9ucyBhc3NvY2lhdGVkIHdpdGhcbiAgICogdGhpcyBidWNrZXQuXG4gICAqL1xuICBhc3luYyBkcm9wKCkge1xuICAgIGF3YWl0IHRoaXMuI2ZpbGVzQ29sbGVjdGlvbi5kcm9wKCk7XG4gICAgYXdhaXQgdGhpcy4jY2h1bmtzQ29sbGVjdGlvbi5kcm9wKCk7XG4gIH1cblxuICAjY2hlY2tJbmRleGVzID0gKCkgPT5cbiAgICBjaGVja0luZGV4ZXMoXG4gICAgICB0aGlzLiNmaWxlc0NvbGxlY3Rpb24sXG4gICAgICB0aGlzLiNjaHVua3NDb2xsZWN0aW9uLFxuICAgICAgKHZhbHVlKSA9PiAodGhpcy4jY2hlY2tlZEluZGV4ZXMgPSB2YWx1ZSksXG4gICAgKTtcbn1cbiJdfQ==
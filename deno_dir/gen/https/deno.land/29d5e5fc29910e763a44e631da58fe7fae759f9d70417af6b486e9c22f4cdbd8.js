import { assert } from "./util.ts";
const encoder = new TextEncoder();
const DEFAULT_KEEP_ALIVE_INTERVAL = 30_000;
class CloseEvent extends Event {
    constructor(eventInit) {
        super("close", eventInit);
    }
}
export class ServerSentEvent extends Event {
    #data;
    #id;
    #type;
    constructor(type, data, { replacer, space, ...eventInit } = {}) {
        super(type, eventInit);
        this.#type = type;
        try {
            this.#data = typeof data === "string"
                ? data
                : JSON.stringify(data, replacer, space);
        }
        catch (e) {
            assert(e instanceof Error);
            throw new TypeError(`data could not be coerced into a serialized string.\n  ${e.message}`);
        }
        const { id } = eventInit;
        this.#id = id;
    }
    get data() {
        return this.#data;
    }
    get id() {
        return this.#id;
    }
    toString() {
        const data = `data: ${this.#data.split("\n").join("\ndata: ")}\n`;
        return `${this.#type === "__message" ? "" : `event: ${this.#type}\n`}${this.#id ? `id: ${String(this.#id)}\n` : ""}${data}\n`;
    }
}
const responseHeaders = new Headers([
    ["Connection", "Keep-Alive"],
    ["Content-Type", "text/event-stream"],
    ["Cache-Control", "no-cache"],
    ["Keep-Alive", `timeout=${Number.MAX_SAFE_INTEGER}`],
]);
export class SSEStreamTarget extends EventTarget {
    #closed = false;
    #context;
    #controller;
    #keepAliveId;
    #error(error) {
        console.log("error", error);
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
        const errorEvent = new ErrorEvent("error", { error });
        this.dispatchEvent(errorEvent);
        this.#context.app.dispatchEvent(errorEvent);
    }
    #push(payload) {
        if (!this.#controller) {
            this.#error(new Error("The controller has not been set."));
            return;
        }
        if (this.#closed) {
            return;
        }
        this.#controller.enqueue(encoder.encode(payload));
    }
    get closed() {
        return this.#closed;
    }
    constructor(context, { headers, keepAlive = false } = {}) {
        super();
        this.#context = context;
        context.response.body = new ReadableStream({
            start: (controller) => {
                this.#controller = controller;
            },
            cancel: (error) => {
                if (error instanceof Error && error.message.includes("connection closed")) {
                    this.close();
                }
                else {
                    this.#error(error);
                }
            },
        });
        if (headers) {
            for (const [key, value] of headers) {
                context.response.headers.set(key, value);
            }
        }
        for (const [key, value] of responseHeaders) {
            context.response.headers.set(key, value);
        }
        this.addEventListener("close", () => {
            this.#closed = true;
            if (this.#keepAliveId != null) {
                clearInterval(this.#keepAliveId);
                this.#keepAliveId = undefined;
            }
            if (this.#controller) {
                try {
                    this.#controller.close();
                }
                catch {
                }
            }
        });
        if (keepAlive) {
            const interval = typeof keepAlive === "number"
                ? keepAlive
                : DEFAULT_KEEP_ALIVE_INTERVAL;
            this.#keepAliveId = setInterval(() => {
                this.dispatchComment("keep-alive comment");
            }, interval);
        }
    }
    close() {
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
        return Promise.resolve();
    }
    dispatchComment(comment) {
        this.#push(`: ${comment.split("\n").join("\n: ")}\n\n`);
        return true;
    }
    dispatchMessage(data) {
        const event = new ServerSentEvent("__message", data);
        return this.dispatchEvent(event);
    }
    dispatchEvent(event) {
        const dispatched = super.dispatchEvent(event);
        if (dispatched && event instanceof ServerSentEvent) {
            this.#push(String(event));
        }
        return dispatched;
    }
    [Symbol.for("Deno.customInspect")](inspect) {
        return `${this.constructor.name} ${inspect({ "#closed": this.#closed, "#context": this.#context })}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyX3NlbnRfZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXJ2ZXJfc2VudF9ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRW5DLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFFbEMsTUFBTSwyQkFBMkIsR0FBRyxNQUFNLENBQUM7QUErQjNDLE1BQU0sVUFBVyxTQUFRLEtBQUs7SUFDNUIsWUFBWSxTQUFvQjtRQUM5QixLQUFLLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7Q0FDRjtBQUlELE1BQU0sT0FBTyxlQUFnQixTQUFRLEtBQUs7SUFDeEMsS0FBSyxDQUFTO0lBQ2QsR0FBRyxDQUFVO0lBQ2IsS0FBSyxDQUFTO0lBRWQsWUFDRSxJQUFZLEVBRVosSUFBUyxFQUNULEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFHLFNBQVMsS0FBMEIsRUFBRTtRQUUzRCxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUk7WUFDRixJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sSUFBSSxLQUFLLFFBQVE7Z0JBQ25DLENBQUMsQ0FBQyxJQUFJO2dCQUNOLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2xFO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixNQUFNLENBQUMsQ0FBQyxZQUFZLEtBQUssQ0FBQyxDQUFDO1lBQzNCLE1BQU0sSUFBSSxTQUFTLENBQ2pCLDBEQUEwRCxDQUFDLENBQUMsT0FBTyxFQUFFLENBQ3RFLENBQUM7U0FDSDtRQUNELE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFDekIsSUFBSSxD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RUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUNoRSxFQUFFLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIxIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuL2NvbnRleHQudHNcIjtcbmltcG9ydCB7IGFzc2VydCB9IGZyb20gXCIuL3V0aWwudHNcIjtcblxuY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuXG5jb25zdCBERUZBVUxUX0tFRVBfQUxJVkVfSU5URVJWQUwgPSAzMF8wMDA7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmVyU2VudEV2ZW50SW5pdCBleHRlbmRzIEV2ZW50SW5pdCB7XG4gIC8qKiBBbiBvcHRpb25hbCBgaWRgIHdoaWNoIHdpbGwgYmUgc2VudCB3aXRoIHRoZSBldmVudCBhbmQgZXhwb3NlZCBpbiB0aGVcbiAgICogY2xpZW50IGBFdmVudFNvdXJjZWAuICovXG4gIGlkPzogbnVtYmVyO1xuXG4gIC8qKiBUaGUgcmVwbGFjZXIgaXMgcGFzc2VkIHRvIGBKU09OLnN0cmluZ2lmeWAgd2hlbiBjb252ZXJ0aW5nIHRoZSBgZGF0YWBcbiAgICogcHJvcGVydHkgdG8gYSBKU09OIHN0cmluZy4gKi9cbiAgcmVwbGFjZXI/OlxuICAgIHwgKHN0cmluZyB8IG51bWJlcilbXVxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgfCAoKHRoaXM6IGFueSwga2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpID0+IGFueSk7XG5cbiAgLyoqIFNwYWNlIGlzIHBhc3NlZCB0byBgSlNPTi5zdHJpbmdpZnlgIHdoZW4gY29udmVydGluZyB0aGUgYGRhdGFgIHByb3BlcnR5XG4gICAqIHRvIGEgSlNPTiBzdHJpbmcuICovXG4gIHNwYWNlPzogc3RyaW5nIHwgbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZlclNlbnRFdmVudFRhcmdldE9wdGlvbnMge1xuICAvKiogQWRkaXRpb25hbCBoZWFkZXJzIHRvIHNlbmQgdG8gdGhlIGNsaWVudCBkdXJpbmcgc3RhcnR1cC4gIFRoZXNlIGhlYWRlcnNcbiAgICogd2lsbCBvdmVyd3JpdGUgYW55IG9mIHRoZSBkZWZhdWx0IGhlYWRlcnMgaWYgdGhlIGtleSBpcyBkdXBsaWNhdGVkLiAqL1xuICBoZWFkZXJzPzogSGVhZGVycztcbiAgLyoqIEtlZXAgY2xpZW50IGNvbm5lY3Rpb25zIGFsaXZlIGJ5IHNlbmRpbmcgYSBjb21tZW50IGV2ZW50IHRvIHRoZSBjbGllbnRcbiAgICogYXQgYSBzcGVjaWZpZWQgaW50ZXJ2YWwuICBJZiBgdHJ1ZWAsIHRoZW4gaXQgcG9sbHMgZXZlcnkgMzAwMDAgbWlsbGlzZWNvbmRzXG4gICAqICgzMCBzZWNvbmRzKS4gSWYgc2V0IHRvIGEgbnVtYmVyLCB0aGVuIGl0IHBvbGxzIHRoYXQgbnVtYmVyIG9mXG4gICAqIG1pbGxpc2Vjb25kcy4gIFRoZSBmZWF0dXJlIGlzIGRpc2FibGVkIGlmIHNldCB0byBgZmFsc2VgLiAgSXQgZGVmYXVsdHMgdG9cbiAgICogYGZhbHNlYC4gKi9cbiAga2VlcEFsaXZlPzogYm9vbGVhbiB8IG51bWJlcjtcbn1cblxuY2xhc3MgQ2xvc2VFdmVudCBleHRlbmRzIEV2ZW50IHtcbiAgY29uc3RydWN0b3IoZXZlbnRJbml0OiBFdmVudEluaXQpIHtcbiAgICBzdXBlcihcImNsb3NlXCIsIGV2ZW50SW5pdCk7XG4gIH1cbn1cblxuLyoqIEFuIGV2ZW50IHdoaWNoIGNvbnRhaW5zIGluZm9ybWF0aW9uIHdoaWNoIHdpbGwgYmUgc2VudCB0byB0aGUgcmVtb3RlXG4gKiBjb25uZWN0aW9uIGFuZCBiZSBtYWRlIGF2YWlsYWJsZSBpbiBhbiBgRXZlbnRTb3VyY2VgIGFzIGFuIGV2ZW50LiAqL1xuZXhwb3J0IGNsYXNzIFNlcnZlclNlbnRFdmVudCBleHRlbmRzIEV2ZW50IHtcbiAgI2RhdGE6IHN0cmluZztcbiAgI2lkPzogbnVtYmVyO1xuICAjdHlwZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAgIGRhdGE6IGFueSxcbiAgICB7IHJlcGxhY2VyLCBzcGFjZSwgLi4uZXZlbnRJbml0IH06IFNlcnZlclNlbnRFdmVudEluaXQgPSB7fSxcbiAgKSB7XG4gICAgc3VwZXIodHlwZSwgZXZlbnRJbml0KTtcbiAgICB0aGlzLiN0eXBlID0gdHlwZTtcbiAgICB0cnkge1xuICAgICAgdGhpcy4jZGF0YSA9IHR5cGVvZiBkYXRhID09PSBcInN0cmluZ1wiXG4gICAgICAgID8gZGF0YVxuICAgICAgICA6IEpTT04uc3RyaW5naWZ5KGRhdGEsIHJlcGxhY2VyIGFzIChzdHJpbmcgfCBudW1iZXIpW10sIHNwYWNlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhc3NlcnQoZSBpbnN0YW5jZW9mIEVycm9yKTtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIGBkYXRhIGNvdWxkIG5vdCBiZSBjb2VyY2VkIGludG8gYSBzZXJpYWxpemVkIHN0cmluZy5cXG4gICR7ZS5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCB7IGlkIH0gPSBldmVudEluaXQ7XG4gICAgdGhpcy4jaWQgPSBpZDtcbiAgfVxuXG4gIC8qKiBUaGUgZGF0YSBhc3NvY2lhdGVkIHdpdGggdGhlIGV2ZW50LCB3aGljaCB3aWxsIGJlIHNlbnQgdG8gdGhlIGNsaWVudCBhbmRcbiAgICogYmUgbWFkZSBhdmFpbGFibGUgaW4gdGhlIGBFdmVudFNvdXJjZWAuICovXG4gIGdldCBkYXRhKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI2RhdGE7XG4gIH1cblxuICAvKiogVGhlIG9wdGlvbmFsIElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXZlbnQgdGhhdCB3aWxsIGJlIHNlbnQgdG8gdGhlIGNsaWVudFxuICAgKiBhbmQgYmUgbWFkZSBhdmFpbGFibGUgaW4gdGhlIGBFdmVudFNvdXJjZWAuICovXG4gIGdldCBpZCgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNpZDtcbiAgfVxuXG4gIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgY29uc3QgZGF0YSA9IGBkYXRhOiAke3RoaXMuI2RhdGEuc3BsaXQoXCJcXG5cIikuam9pbihcIlxcbmRhdGE6IFwiKX1cXG5gO1xuICAgIHJldHVybiBgJHt0aGlzLiN0eXBlID09PSBcIl9fbWVzc2FnZVwiID8gXCJcIiA6IGBldmVudDogJHt0aGlzLiN0eXBlfVxcbmB9JHtcbiAgICAgIHRoaXMuI2lkID8gYGlkOiAke1N0cmluZyh0aGlzLiNpZCl9XFxuYCA6IFwiXCJcbiAgICB9JHtkYXRhfVxcbmA7XG4gIH1cbn1cblxuY29uc3QgcmVzcG9uc2VIZWFkZXJzID0gbmV3IEhlYWRlcnMoXG4gIFtcbiAgICBbXCJDb25uZWN0aW9uXCIsIFwiS2VlcC1BbGl2ZVwiXSxcbiAgICBbXCJDb250ZW50LVR5cGVcIiwgXCJ0ZXh0L2V2ZW50LXN0cmVhbVwiXSxcbiAgICBbXCJDYWNoZS1Db250cm9sXCIsIFwibm8tY2FjaGVcIl0sXG4gICAgW1wiS2VlcC1BbGl2ZVwiLCBgdGltZW91dD0ke051bWJlci5NQVhfU0FGRV9JTlRFR0VSfWBdLFxuICBdLFxuKTtcblxuZXhwb3J0IGludGVyZmFjZSBTZXJ2ZXJTZW50RXZlbnRUYXJnZXQgZXh0ZW5kcyBFdmVudFRhcmdldCB7XG4gIC8qKiBJcyBzZXQgdG8gYHRydWVgIGlmIGV2ZW50cyBjYW5ub3QgYmUgc2VudCB0byB0aGUgcmVtb3RlIGNvbm5lY3Rpb24uXG4gICAqIE90aGVyd2lzZSBpdCBpcyBzZXQgdG8gYGZhbHNlYC5cbiAgICpcbiAgICogKk5vdGUqOiBUaGlzIGZsYWcgaXMgbGF6aWx5IHNldCwgYW5kIG1pZ2h0IG5vdCByZWZsZWN0IGEgY2xvc2VkIHN0YXRlIHVudGlsXG4gICAqIGFub3RoZXIgZXZlbnQsIGNvbW1lbnQgb3IgbWVzc2FnZSBpcyBhdHRlbXB0ZWQgdG8gYmUgcHJvY2Vzc2VkLiAqL1xuICByZWFkb25seSBjbG9zZWQ6IGJvb2xlYW47XG5cbiAgLyoqIENsb3NlIHRoZSB0YXJnZXQsIHJlZnVzaW5nIHRvIGFjY2VwdCBhbnkgbW9yZSBldmVudHMuICovXG4gIGNsb3NlKCk6IFByb21pc2U8dm9pZD47XG5cbiAgLyoqIFNlbmQgYSBjb21tZW50IHRvIHRoZSByZW1vdGUgY29ubmVjdGlvbi4gIENvbW1lbnRzIGFyZSBub3QgZXhwb3NlZCB0byB0aGVcbiAgICogY2xpZW50IGBFdmVudFNvdXJjZWAgYnV0IGFyZSB1c2VkIGZvciBkaWFnbm9zdGljcyBhbmQgaGVscGluZyBlbnN1cmUgYVxuICAgKiBjb25uZWN0aW9uIGlzIGtlcHQgYWxpdmUuXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oKTtcbiAgICpcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgIGNvbnN0IHNzZSA9IGN0eC5nZXRTU0VUYXJnZXQoKTtcbiAgICogICAgc3NlLmRpc3BhdGNoQ29tbWVudChcInRoaXMgaXMgYSBjb21tZW50XCIpO1xuICAgKiB9KTtcbiAgICpcbiAgICogYXdhaXQgYXBwLmxpc3RlbigpO1xuICAgKiBgYGBcbiAgICovXG4gIGRpc3BhdGNoQ29tbWVudChjb21tZW50OiBzdHJpbmcpOiBib29sZWFuO1xuXG4gIC8qKiBEaXNwYXRjaCBhIG1lc3NhZ2UgdG8gdGhlIGNsaWVudC4gIFRoaXMgbWVzc2FnZSB3aWxsIGNvbnRhaW4gYGRhdGE6IGAgb25seVxuICAgKiBhbmQgYmUgYXZhaWxhYmxlIG9uIHRoZSBjbGllbnQgYEV2ZW50U291cmNlYCBvbiB0aGUgYG9ubWVzc2FnZWAgb3IgYW4gZXZlbnRcbiAgICogbGlzdGVuZXIgb2YgdHlwZSBgXCJtZXNzYWdlXCJgLiAqL1xuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBkaXNwYXRjaE1lc3NhZ2UoZGF0YTogYW55KTogYm9vbGVhbjtcblxuICAvKiogRGlzcGF0Y2ggYSBzZXJ2ZXIgc2VudCBldmVudCB0byB0aGUgY2xpZW50LiAgVGhlIGV2ZW50IGB0eXBlYCB3aWxsIGJlXG4gICAqIHNlbnQgYXMgYGV2ZW50OiBgIHRvIHRoZSBjbGllbnQgd2hpY2ggd2lsbCBiZSByYWlzZWQgYXMgYSBgTWVzc2FnZUV2ZW50YFxuICAgKiBvbiB0aGUgYEV2ZW50U291cmNlYCBpbiB0aGUgY2xpZW50LlxuICAgKlxuICAgKiBBbnkgbG9jYWwgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSBkaXNwYXRjaGVkIHRvIGZpcnN0LCBhbmQgaWYgdGhlIGV2ZW50XG4gICAqIGlzIGNhbmNlbGxlZCwgaXQgd2lsbCBub3QgYmUgc2VudCB0byB0aGUgY2xpZW50LlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiwgU2VydmVyU2VudEV2ZW50IH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKlxuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oKTtcbiAgICpcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgIGNvbnN0IHNzZSA9IGN0eC5nZXRTU0VUYXJnZXQoKTtcbiAgICogICAgY29uc3QgZXZ0ID0gbmV3IFNlcnZlclNlbnRFdmVudChcInBpbmdcIiwgXCJoZWxsb1wiKTtcbiAgICogICAgc3NlLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICogfSk7XG4gICAqXG4gICAqIGF3YWl0IGFwcC5saXN0ZW4oKTtcbiAgICogYGBgXG4gICAqL1xuICBkaXNwYXRjaEV2ZW50KGV2ZW50OiBTZXJ2ZXJTZW50RXZlbnQpOiBib29sZWFuO1xuXG4gIC8qKiBEaXNwYXRjaCBhIHNlcnZlciBzZW50IGV2ZW50IHRvIHRoZSBjbGllbnQuICBUaGUgZXZlbnQgYHR5cGVgIHdpbGwgYmVcbiAgICogc2VudCBhcyBgZXZlbnQ6IGAgdG8gdGhlIGNsaWVudCB3aGljaCB3aWxsIGJlIHJhaXNlZCBhcyBhIGBNZXNzYWdlRXZlbnRgXG4gICAqIG9uIHRoZSBgRXZlbnRTb3VyY2VgIGluIHRoZSBjbGllbnQuXG4gICAqXG4gICAqIEFueSBsb2NhbCBldmVudCBoYW5kbGVycyB3aWxsIGJlIGRpc3BhdGNoZWQgdG8gZmlyc3QsIGFuZCBpZiB0aGUgZXZlbnRcbiAgICogaXMgY2FuY2VsbGVkLCBpdCB3aWxsIG5vdCBiZSBzZW50IHRvIHRoZSBjbGllbnQuXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIGltcG9ydCB7IEFwcGxpY2F0aW9uLCBTZXJ2ZXJTZW50RXZlbnQgfSBmcm9tIFwiaHR0cHM6Ly9kZW5vLmxhbmQveC9vYWsvbW9kLnRzXCI7XG4gICAqXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKlxuICAgKiBhcHAudXNlKChjdHgpID0+IHtcbiAgICogICAgY29uc3Qgc3NlID0gY3R4LmdldFNTRVRhcmdldCgpO1xuICAgKiAgICBjb25zdCBldnQgPSBuZXcgU2VydmVyU2VudEV2ZW50KFwicGluZ1wiLCBcImhlbGxvXCIpO1xuICAgKiAgICBzc2UuZGlzcGF0Y2hFdmVudChldnQpO1xuICAgKiB9KTtcbiAgICpcbiAgICogYXdhaXQgYXBwLmxpc3RlbigpO1xuICAgKiBgYGBcbiAgICovXG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IENsb3NlRXZlbnQgfCBFcnJvckV2ZW50KTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIFNTRVN0cmVhbVRhcmdldCBleHRlbmRzIEV2ZW50VGFyZ2V0XG4gIGltcGxlbWVudHMgU2VydmVyU2VudEV2ZW50VGFyZ2V0IHtcbiAgI2Nsb3NlZCA9IGZhbHNlO1xuICAjY29udGV4dDogQ29udGV4dDtcbiAgI2NvbnRyb2xsZXI/OiBSZWFkYWJsZVN0cmVhbURlZmF1bHRDb250cm9sbGVyPFVpbnQ4QXJyYXk+O1xuICAja2VlcEFsaXZlSWQ/OiBudW1iZXI7XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgI2Vycm9yKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZyhcImVycm9yXCIsIGVycm9yKTtcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IENsb3NlRXZlbnQoeyBjYW5jZWxhYmxlOiBmYWxzZSB9KSk7XG4gICAgY29uc3QgZXJyb3JFdmVudCA9IG5ldyBFcnJvckV2ZW50KFwiZXJyb3JcIiwgeyBlcnJvciB9KTtcbiAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXJyb3JFdmVudCk7XG4gICAgdGhpcy4jY29udGV4dC5hcHAuZGlzcGF0Y2hFdmVudChlcnJvckV2ZW50KTtcbiAgfVxuXG4gICNwdXNoKHBheWxvYWQ6IHN0cmluZykge1xuICAgIGlmICghdGhpcy4jY29udHJvbGxlcikge1xuICAgICAgdGhpcy4jZXJyb3IobmV3IEVycm9yKFwiVGhlIGNvbnRyb2xsZXIgaGFzIG5vdCBiZWVuIHNldC5cIikpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy4jY2xvc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuI2NvbnRyb2xsZXIuZW5xdWV1ZShlbmNvZGVyLmVuY29kZShwYXlsb2FkKSk7XG4gIH1cblxuICBnZXQgY2xvc2VkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLiNjbG9zZWQ7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIHsgaGVhZGVycywga2VlcEFsaXZlID0gZmFsc2UgfTogU2VydmVyU2VudEV2ZW50VGFyZ2V0T3B0aW9ucyA9IHt9LFxuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy4jY29udGV4dCA9IGNvbnRleHQ7XG5cbiAgICBjb250ZXh0LnJlc3BvbnNlLmJvZHkgPSBuZXcgUmVhZGFibGVTdHJlYW08VWludDhBcnJheT4oe1xuICAgICAgc3RhcnQ6IChjb250cm9sbGVyKSA9PiB7XG4gICAgICAgIHRoaXMuI2NvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xuICAgICAgfSxcbiAgICAgIGNhbmNlbDogKGVycm9yKSA9PiB7XG4gICAgICAgIC8vIGNvbm5lY3Rpb25zIGNsb3NpbmcgYXJlIGNvbnNpZGVyZWQgXCJub3JtYWxcIiBmb3IgU1NFIGV2ZW50cyBhbmQganVzdFxuICAgICAgICAvLyBtZWFuIHRoZSBmYXIgc2lkZSBoYXMgY2xvc2VkLlxuICAgICAgICBpZiAoXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5tZXNzYWdlLmluY2x1ZGVzKFwiY29ubmVjdGlvbiBjbG9zZWRcIilcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuI2Vycm9yKGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChoZWFkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBoZWFkZXJzKSB7XG4gICAgICAgIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHJlc3BvbnNlSGVhZGVycykge1xuICAgICAgY29udGV4dC5yZXNwb25zZS5oZWFkZXJzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICB0aGlzLiNjbG9zZWQgPSB0cnVlO1xuICAgICAgaWYgKHRoaXMuI2tlZXBBbGl2ZUlkICE9IG51bGwpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLiNrZWVwQWxpdmVJZCk7XG4gICAgICAgIHRoaXMuI2tlZXBBbGl2ZUlkID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuI2NvbnRyb2xsZXIpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLiNjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIC8vIHdlIGlnbm9yZSBhbnkgZXJyb3JzIGhlcmUsIGFzIGl0IGlzIGxpa2VseSB0aGF0IHRoZSBjb250cm9sbGVyXG4gICAgICAgICAgLy8gaXMgYWxyZWFkeSBjbG9zZWRcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGtlZXBBbGl2ZSkge1xuICAgICAgY29uc3QgaW50ZXJ2YWwgPSB0eXBlb2Yga2VlcEFsaXZlID09PSBcIm51bWJlclwiXG4gICAgICAgID8ga2VlcEFsaXZlXG4gICAgICAgIDogREVGQVVMVF9LRUVQX0FMSVZFX0lOVEVSVkFMO1xuICAgICAgdGhpcy4ja2VlcEFsaXZlSWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hDb21tZW50KFwia2VlcC1hbGl2ZSBjb21tZW50XCIpO1xuICAgICAgfSwgaW50ZXJ2YWwpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgQ2xvc2VFdmVudCh7IGNhbmNlbGFibGU6IGZhbHNlIH0pKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICBkaXNwYXRjaENvbW1lbnQoY29tbWVudDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgdGhpcy4jcHVzaChgOiAke2NvbW1lbnQuc3BsaXQoXCJcXG5cIikuam9pbihcIlxcbjogXCIpfVxcblxcbmApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgZGlzcGF0Y2hNZXNzYWdlKGRhdGE6IGFueSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGV2ZW50ID0gbmV3IFNlcnZlclNlbnRFdmVudChcIl9fbWVzc2FnZVwiLCBkYXRhKTtcbiAgICByZXR1cm4gdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgfVxuXG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IFNlcnZlclNlbnRFdmVudCk6IGJvb2xlYW47XG4gIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IENsb3NlRXZlbnQgfCBFcnJvckV2ZW50KTogYm9vbGVhbjtcbiAgZGlzcGF0Y2hFdmVudChldmVudDogU2VydmVyU2VudEV2ZW50IHwgQ2xvc2VFdmVudCB8IEVycm9yRXZlbnQpOiBib29sZWFuIHtcbiAgICBjb25zdCBkaXNwYXRjaGVkID0gc3VwZXIuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gICAgaWYgKGRpc3BhdGNoZWQgJiYgZXZlbnQgaW5zdGFuY2VvZiBTZXJ2ZXJTZW50RXZlbnQpIHtcbiAgICAgIHRoaXMuI3B1c2goU3RyaW5nKGV2ZW50KSk7XG4gICAgfVxuICAgIHJldHVybiBkaXNwYXRjaGVkO1xuICB9XG5cbiAgW1N5bWJvbC5mb3IoXCJEZW5vLmN1c3RvbUluc3BlY3RcIildKGluc3BlY3Q6ICh2YWx1ZTogdW5rbm93bikgPT4gc3RyaW5nKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuY29uc3RydWN0b3IubmFtZX0gJHtcbiAgICAgIGluc3BlY3QoeyBcIiNjbG9zZWRcIjogdGhpcy4jY2xvc2VkLCBcIiNjb250ZXh0XCI6IHRoaXMuI2NvbnRleHQgfSlcbiAgICB9YDtcbiAgfVxufVxuIl19
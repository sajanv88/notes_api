import { WireProtocol } from "./protocol/mod.ts";
import { AuthContext, ScramAuthPlugin, X509AuthPlugin } from "./auth/mod.ts";
import { MongoDriverError } from "./error.ts";
import { assert } from "../deps.ts";
export class Cluster {
    #options;
    #connections;
    #protocols;
    #masterIndex;
    constructor(options) {
        this.#options = options;
        this.#connections = [];
        this.#protocols = [];
        this.#masterIndex = -1;
    }
    async connect() {
        const options = this.#options;
        this.#connections = await Promise.all(options.servers.map((server) => this.connectToServer(server, options)));
    }
    connectToServer(server, options) {
        const denoConnectOps = {
            hostname: server.host,
            port: server.port,
        };
        if (!options.tls)
            return Deno.connect(denoConnectOps);
        if (options.certFile) {
            denoConnectOps.caCerts = [Deno.readTextFileSync(options.certFile)];
        }
        if (options.keyFile) {
            if (options.keyFilePassword) {
                throw new MongoDriverError("Tls keyFilePassword not implemented in Deno driver");
            }
            throw new MongoDriverError("Tls keyFile not implemented in Deno driver");
        }
        return Deno.connectTls(denoConnectOps);
    }
    async authenticate() {
        const options = this.#options;
        this.#protocols = await Promise.all(this.#connections.map((conn) => this.authenticateToServer(conn, options)));
    }
    async authenticateToServer(conn, options) {
        const protocol = new WireProtocol(conn);
        if (options.credential) {
            const authContext = new AuthContext(protocol, options.credential, options);
            const mechanism = options.credential.mechanism;
            let authPlugin;
            if (mechanism === "SCRAM-SHA-256") {
                authPlugin = new ScramAuthPlugin("sha256");
            }
            else if (mechanism === "SCRAM-SHA-1") {
                authPlugin = new ScramAuthPlugin("sha1");
            }
            else if (mechanism === "MONGODB-X509") {
                authPlugin = new X509AuthPlugin();
            }
            else {
                throw new MongoDriverError(`Auth mechanism not implemented in Deno driver: ${mechanism}`);
            }
            const request = authPlugin.prepare(authContext);
            authContext.response = await protocol.commandSingle("admin", request);
            await authPlugin.auth(authContext);
        }
        else {
            await protocol.connect();
        }
        return protocol;
    }
    async updateMaster() {
        const results = await Promise.all(this.#protocols.map((protocol) => {
            return protocol.commandSingle("admin", { isMaster: 1 });
        }));
        const masterIndex = results.findIndex((result) => result.isWritablePrimary || result.ismaster);
        if (masterIndex === -1)
            throw new Error(`Could not find a master node`);
        this.#masterIndex = masterIndex;
    }
    getMaster() {
        return {
            protocol: this.#protocols[this.#masterIndex],
            conn: this.#connections[this.#masterIndex],
        };
    }
    get protocol() {
        const protocol = this.getMaster().protocol;
        assert(protocol);
        return protocol;
    }
    close() {
        for (const conn of this.#connections) {
            try {
                conn.close();
            }
            catch (error) {
                console.error(`Error closing connection: ${error}`);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2x1c3Rlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNsdXN0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWpELE9BQU8sRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDOUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUdwQyxNQUFNLE9BQU8sT0FBTztJQUNsQixRQUFRLENBQWlCO0lBQ3pCLFlBQVksQ0FBYztJQUMxQixVQUFVLENBQWlCO0lBQzNCLFlBQVksQ0FBUztJQUVyQixZQUFZLE9BQXVCO1FBQ2pDLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5QixJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDbkMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQ3ZFLENBQUM7SUFDSixDQUFDO0lBRUQsZUFBZSxDQUFDLE1BQWMsRUFBRSxPQUF1QjtRQUNyRCxNQUFNLGNBQWMsR0FBMkI7WUFDN0MsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1lBQ3JCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSTtTQUNs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LGlCQUFpQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQzVDLENBQUM7UUFDRixJQUFJLFdBQVcsS0FBSyxDQUFDLENBQUM7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUM7SUFDbEMsQ0FBQztJQUVPLFNBQVM7UUFDZixPQUFPO1lBQ0wsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztZQUM1QyxJQUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1NBQzNDLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQztRQUMzQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakIsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELEtBQUs7UUFDSCxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDcEMsSUFBSTtnQkFDRixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDZDtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEtBQUssRUFBRSxDQUFDLENBQUM7YUFDckQ7U0FDRjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFdpcmVQcm90b2NvbCB9IGZyb20gXCIuL3Byb3RvY29sL21vZC50c1wiO1xuaW1wb3J0IHsgQ29ubmVjdE9wdGlvbnMgfSBmcm9tIFwiLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgQXV0aENvbnRleHQsIFNjcmFtQXV0aFBsdWdpbiwgWDUwOUF1dGhQbHVnaW4gfSBmcm9tIFwiLi9hdXRoL21vZC50c1wiO1xuaW1wb3J0IHsgTW9uZ29Ecml2ZXJFcnJvciB9IGZyb20gXCIuL2Vycm9yLnRzXCI7XG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgU2VydmVyIH0gZnJvbSBcIi4vdHlwZXMudHNcIjtcblxuZXhwb3J0IGNsYXNzIENsdXN0ZXIge1xuICAjb3B0aW9uczogQ29ubmVjdE9wdGlvbnM7XG4gICNjb25uZWN0aW9uczogRGVuby5Db25uW107XG4gICNwcm90b2NvbHM6IFdpcmVQcm90b2NvbFtdO1xuICAjbWFzdGVySW5kZXg6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBDb25uZWN0T3B0aW9ucykge1xuICAgIHRoaXMuI29wdGlvbnMgPSBvcHRpb25zO1xuICAgIHRoaXMuI2Nvbm5lY3Rpb25zID0gW107XG4gICAgdGhpcy4jcHJvdG9jb2xzID0gW107XG4gICAgdGhpcy4jbWFzdGVySW5kZXggPSAtMTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QoKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuI29wdGlvbnM7XG4gICAgdGhpcy4jY29ubmVjdGlvbnMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIG9wdGlvbnMuc2VydmVycy5tYXAoKHNlcnZlcikgPT4gdGhpcy5jb25uZWN0VG9TZXJ2ZXIoc2VydmVyLCBvcHRpb25zKSksXG4gICAgKTtcbiAgfVxuXG4gIGNvbm5lY3RUb1NlcnZlcihzZXJ2ZXI6IFNlcnZlciwgb3B0aW9uczogQ29ubmVjdE9wdGlvbnMpIHtcbiAgICBjb25zdCBkZW5vQ29ubmVjdE9wczogRGVuby5Db25uZWN0VGxzT3B0aW9ucyA9IHtcbiAgICAgIGhvc3RuYW1lOiBzZXJ2ZXIuaG9zdCxcbiAgICAgIHBvcnQ6IHNlcnZlci5wb3J0LFxuICAgIH07XG5cbiAgICBpZiAoIW9wdGlvbnMudGxzKSByZXR1cm4gRGVuby5jb25uZWN0KGRlbm9Db25uZWN0T3BzKTtcblxuICAgIGlmIChvcHRpb25zLmNlcnRGaWxlKSB7XG4gICAgICBkZW5vQ29ubmVjdE9wcy5jYUNlcnRzID0gW0Rlbm8ucmVhZFRleHRGaWxlU3luYyhvcHRpb25zLmNlcnRGaWxlKV07XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMua2V5RmlsZSkge1xuICAgICAgLy9UT0RPOiBuZWVkIHNvbWV0aGluZyBsaWtlIGNvbnN0IGtleSA9IGRlY3J5cHQob3B0aW9ucy5rZXlGaWxlKSAuLi5cbiAgICAgIGlmIChvcHRpb25zLmtleUZpbGVQYXNzd29yZCkge1xuICAgICAgICB0aHJvdyBuZXcgTW9uZ29Ecml2ZXJFcnJvcihcbiAgICAgICAgICBcIlRscyBrZXlGaWxlUGFzc3dvcmQgbm90IGltcGxlbWVudGVkIGluIERlbm8gZHJpdmVyXCIsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgTW9uZ29Ecml2ZXJFcnJvcihcIlRscyBrZXlGaWxlIG5vdCBpbXBsZW1lbnRlZCBpbiBEZW5vIGRyaXZlclwiKTtcbiAgICAgIC8vVE9ETzogbmVlZCBEZW5vLmNvbm5lY3RUbHMgd2l0aCBzb21ldGhpbmcgbGlrZSBrZXkgb3Iga2V5RmlsZSBvcHRpb24uXG4gICAgfVxuXG4gICAgcmV0dXJuIERlbm8uY29ubmVjdFRscyhkZW5vQ29ubmVjdE9wcyk7XG4gIH1cblxuICBhc3luYyBhdXRoZW50aWNhdGUoKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuI29wdGlvbnM7XG4gICAgdGhpcy4jcHJvdG9jb2xzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICB0aGlzLiNjb25uZWN0aW9ucy5tYXAoKGNvbm4pID0+IHRoaXMuYXV0aGVudGljYXRlVG9TZXJ2ZXIoY29ubiwgb3B0aW9ucykpLFxuICAgICk7XG4gIH1cblxuICBhc3luYyBhdXRoZW50aWNhdGVUb1NlcnZlcihjb25uOiBEZW5vLkNvbm4sIG9wdGlvbnM6IENvbm5lY3RPcHRpb25zKSB7XG4gICAgY29uc3QgcHJvdG9jb2wgPSBuZXcgV2lyZVByb3RvY29sKGNvbm4pO1xuICAgIGlmIChvcHRpb25zLmNyZWRlbnRpYWwpIHtcbiAgICAgIGNvbnN0IGF1dGhDb250ZXh0ID0gbmV3IEF1dGhDb250ZXh0KFxuICAgICAgICBwcm90b2NvbCxcbiAgICAgICAgb3B0aW9ucy5jcmVkZW50aWFsLFxuICAgICAgICBvcHRpb25zLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IG1lY2hhbmlzbSA9IG9wdGlvbnMuY3JlZGVudGlhbCEubWVjaGFuaXNtO1xuICAgICAgbGV0IGF1dGhQbHVnaW47XG4gICAgICBpZiAobWVjaGFuaXNtID09PSBcIlNDUkFNLVNIQS0yNTZcIikge1xuICAgICAgICBhdXRoUGx1Z2luID0gbmV3IFNjcmFtQXV0aFBsdWdpbihcInNoYTI1NlwiKTsgLy9UT0RPIEFKVVNUIHNoYTI1NlxuICAgICAgfSBlbHNlIGlmIChtZWNoYW5pc20gPT09IFwiU0NSQU0tU0hBLTFcIikge1xuICAgICAgICBhdXRoUGx1Z2luID0gbmV3IFNjcmFtQXV0aFBsdWdpbihcInNoYTFcIik7XG4gICAgICB9IGVsc2UgaWYgKG1lY2hhbmlzbSA9PT0gXCJNT05HT0RCLVg1MDlcIikge1xuICAgICAgICBhdXRoUGx1Z2luID0gbmV3IFg1MDlBdXRoUGx1Z2luKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgTW9uZ29Ecml2ZXJFcnJvcihcbiAgICAgICAgICBgQXV0aCBtZWNoYW5pc20gbm90IGltcGxlbWVudGVkIGluIERlbm8gZHJpdmVyOiAke21lY2hhbmlzbX1gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVxdWVzdCA9IGF1dGhQbHVnaW4ucHJlcGFyZShhdXRoQ29udGV4dCk7XG4gICAgICBhdXRoQ29udGV4dC5yZXNwb25zZSA9IGF3YWl0IHByb3RvY29sLmNvbW1hbmRTaW5nbGUoXG4gICAgICAgIFwiYWRtaW5cIiwgLy8gVE9ETzogU2hvdWxkIGdldCB0aGUgYXV0aCBkYiBmcm9tIGNvbm5lY3Rpb25PcHRpb25zP1xuICAgICAgICByZXF1ZXN0LFxuICAgICAgKTtcbiAgICAgIGF3YWl0IGF1dGhQbHVnaW4uYXV0aChhdXRoQ29udGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHByb3RvY29sLmNvbm5lY3QoKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb3RvY29sO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlTWFzdGVyKCkge1xuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLiNwcm90b2NvbHMubWFwKChwcm90b2NvbCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3RvY29sLmNvbW1hbmRTaW5nbGUoXG4gICAgICAgIFwiYWRtaW5cIixcbiAgICAgICAgeyBpc01hc3RlcjogMSB9LFxuICAgICAgKTtcbiAgICB9KSk7XG4gICAgY29uc3QgbWFzdGVySW5kZXggPSByZXN1bHRzLmZpbmRJbmRleCgocmVzdWx0KSA9PlxuICAgICAgcmVzdWx0LmlzV3JpdGFibGVQcmltYXJ5IHx8IHJlc3VsdC5pc21hc3RlclxuICAgICk7XG4gICAgaWYgKG1hc3RlckluZGV4ID09PSAtMSkgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCBhIG1hc3RlciBub2RlYCk7XG4gICAgdGhpcy4jbWFzdGVySW5kZXggPSBtYXN0ZXJJbmRleDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TWFzdGVyKCkge1xuICAgIHJldHVybiB7XG4gICAgICBwcm90b2NvbDogdGhpcy4jcHJvdG9jb2xzW3RoaXMuI21hc3RlckluZGV4XSxcbiAgICAgIGNvbm46IHRoaXMuI2Nvbm5lY3Rpb25zW3RoaXMuI21hc3RlckluZGV4XSxcbiAgICB9O1xuICB9XG5cbiAgZ2V0IHByb3RvY29sKCkge1xuICAgIGNvbnN0IHByb3RvY29sID0gdGhpcy5nZXRNYXN0ZXIoKS5wcm90b2NvbDtcbiAgICBhc3NlcnQocHJvdG9jb2wpO1xuICAgIHJldHVybiBwcm90b2NvbDtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIGZvciAoY29uc3QgY29ubiBvZiB0aGlzLiNjb25uZWN0aW9ucykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29ubi5jbG9zZSgpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgY2xvc2luZyBjb25uZWN0aW9uOiAke2Vycm9yfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19